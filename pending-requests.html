<!DOCTYPE html>
<html>
<head>
<title>Geoportal - View Pending Requests</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">

<link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico" />
<link rel="stylesheet" href="./lib/calcite-bootstrap/css/calcite-bootstrap.css">
<link rel="stylesheet" href="https://mpa.esrisg.dev/arcgis_js_api/library/3.25/3.25/esri/themes/calcite/dijit/calcite.css">
<link rel="stylesheet" href="https://mpa.esrisg.dev/arcgis_js_api/library/3.25/3.25/esri/themes/calcite/esri/esri.css">
<link rel="stylesheet" href="https://mpa.esrisg.dev/arcgis_js_api/library/3.25/3.25/esri/dijit/metadata/css/gxe.css"/>
<link rel="stylesheet" href="https://mpa.esrisg.dev/arcgis_js_api/library/3.25/3.25/esri/dijit/metadata/css/gxe-calcite.css"/>
<link rel="stylesheet" href="./app/style/main.css">
<link rel="stylesheet" href="./lib/typeahead.css">
<link rel="stylesheet" href="./custom/custom.css">
<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script type="text/javascript">
  var dojoConfig = {
    locale: "en",
    async: true,
    parseOnLoad: true,
    packages: [
      {
        name: 'app',
        location: location.pathname.replace(/\/[^/]*$/, '') + '/app',
      }
    ]
  };
</script>
<script src="./lib/d3-3.5.5.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<script src="./lib/jquery-3.2.1.min.js"></script>
<script src="./lib/bootstrap-3.3.7.min.js"></script>
<script src="./lib/typeahead.js"></script>
<script src="https://mpa.esrisg.dev/arcgis_js_api/library/3.25/3.25/init.js"></script>
<script src="./custom/custom.js"></script>

<script>
  var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        callback(null, xhr.response);
      } else {
        callback(status);
      }
    };

    xhr.send();
  };

  getJSON('https://mpa.esrisg.dev/arcgis/rest/services/Hosted/ConfidentialTable/FeatureServer/0/query?f=json&where=1%3D1&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&orderByFields=objectid%20ASC&resultOffset=0&resultRecordCount=50', function(err, data) {
    if (err != null) {
      console.error(err);
    } else {
      drawHeader(data.fields);
      drawTable(data.features);
    }
  });

  function drawHeader(data) {
    var row = $("<tr />");
    $("#pendingRequestsTable").append(row);

    for (var i = 0; i < data.length; i++) {
      if (data[i].alias != "OBJECTID") {
        row.append($("<th>" + data[i].alias + "</th>"));
      }
    }
    row.append($("<th>Approve</th>"));
  }

  function drawTable(data) {
    for (var i = 0; i < data.length; i++) {
      drawRow(data[i]);
    }
  }

  function drawRow(rowData) {
    var row = $("<tr />");
    $("#pendingRequestsTable").append(row);
    // row.append($("<td>" + rowData.attributes.objectid + "</td>"));
    row.append($("<td>" + rowData.attributes.requestor + "</td>"));
    row.append($("<td>" + rowData.attributes.item + "</td>"));
    row.append($("<td>" + rowData.attributes.status + "</td>"));
    if (rowData.attributes.request_date != null || rowData.attributes.request_date != undefined) {
      row.append($("<td>" + Date(rowData.attributes.request_date) + "</td>"));
    } else {
      row.append($("<td></td>"));
    }

    if (rowData.attributes.approve_date != null || rowData.attributes.approve_date != undefined) {
      row.append($("<td>" + Date(rowData.attributes.approve_date) + "</td>"));
    } else {
      row.append($("<td></td>"));
    }

    if (rowData.attributes.status == 'pending') {
      row.append($('<td><button class="btn" onclick="confirmApproveRequest(\'' + 
        rowData.attributes.requestor + '\', \'' + rowData.attributes.file_id + '\')"><i class="fa fa-thumbs-up"></i></button></td>'));
    } else {
      row.append($("<td></td>"));
    }
  }

  function confirmApproveRequest(requestor, fileId) {
    require(["app"],function() {
      require(["app/content/ApproveRequest", "app/context/AppClient"],
        function(ApproveRequest, AppClient) {
          // (new ApproveRequest({requestor: requestor, fileId: fileId})).show();
          var client = new AppClient();
          var response = client.createRequest(requestor, fileId, "approved");
          var action = confirm("Are you sure you want to approve the request?");
          if (action == true) {
            alert("Request submitted successfully.");
            setTimeout(function() {
              window.location.reload();
            }, 1500);    
          }
        }
      );
    });
  } 
</script>

</head>
<body class="calcite">
  <div style="margin:20px;">
      <h1>Geoportal - View Pending Requests</h1>
  </div>

  <div style="margin:20px;">
    <table id="pendingRequestsTable" style="width:100%">
    </table>
  </div>
</body>
</html>