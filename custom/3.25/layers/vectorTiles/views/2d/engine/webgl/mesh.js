// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["require","exports","dojo/has","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/gl-matrix/mat2d","../../../../core/libs/gl-matrix/vec2","../../../../core/libs/libtess/libtess","./color","./enums","./lineMeshUtil","./MeshData","./number","./TileClipper","./Utils","./visualVariablesUtils"],function(e,t,i,n,r,l,s,o,a,u,h,c,p,g,d,v){function y(e,t,i,r,o,u,h,g){var y,f,_,b,x,m,S,E,w,V=new c,M=0,k=0,C=t.heatmapInfo;if(C){var G=Math.round(t.heatmapInfo.radius);y=0,f=0,_=G,b=G,x=[1,1,1,1],m=[0,0,0,0],S=G,E=G,w=0}else{var U=r.spriteMosaicItem;y=Math.round(U.rect.x/4),f=Math.round(U.rect.y/4),_=y+Math.round(U.rect.width/4),b=f+Math.round(U.rect.height/4),M=Math.round(o*n.pt2px(0|h.xoffset)),k=Math.round(o*n.pt2px(0|h.yoffset));var P=h.color?h.color:[0,0,0,0];x=d.isPictureSymbol(h)?[255,255,255,255]:a.copyAndPremultiply(P),S=Math.round(o*n.pt2px(h.width||h.size)),E=Math.round(o*n.pt2px(h.height||h.size)),h.outline?(m=null!=h.outline.color?a.copyAndPremultiply(h.outline.color):[0,0,0,0],w=null!=h.outline.width?Math.round(n.pt2px(h.outline.width)):0):(m=[0,0,0,0],w=0)}l.identity(N),h.angle&&l.rotate(N,N,T*h.angle),l.translate(N,N,new Float32Array([-M,-k]));var L=[],R=p.i8888to32(x[0],x[1],x[2],x[3]),z=p.i8888to32(m[0],m[1],m[2],m[3]),A=p.i8888to32(S,E,w,0),O=p.numTo32(e),D=0,F=0,W=0,B=0,H=0,j=i.vvColor||i.vvOpacity||i.vvRotation||i.vvSizeMinMaxValue||i.vvSizeScaleStops||i.vvSizeFieldStops||i.vvSizeUnitValue;if(j){var q=t.vvFields,K=q.rotation?t.getValue(u,q.rotation):0,X=q.opacity?t.getValue(u,q.opacity):0,J=q.color?t.getValue(u,q.color):0,Q=q.size&&!i.vvSizeScaleStops?t.getValue(u,q.size):0;i.vvSizeUnitValue&&(Q=v.getVisualVariableSizeValueRepresentationRatio(Q,t.vvRanges.size.unitValue.valueRepresentation)),(null===Q||isNaN(Q))&&(Q=NaN),(null===K||isNaN(K))&&(K=NaN),(null===J||isNaN(J))&&(J=NaN),(null===X||isNaN(X))&&(X=NaN),D=p.toUint32(Q),F=p.toUint32(X),W=p.toUint32(K),B=p.toUint32(J)}var Y=[D,B,F,W];C&&(H=p.toUint32(t.heatmapInfo.getIntensity(u)));var Z,$=u.centroid||u.geometry;switch(g){case"esriGeometryPoint":Z=[[$.x,$.y]];break;case"esriGeometryMultipoint":Z=$.points;break;case"esriGeometryPolyline":Z=$.paths[0];break;case"esriGeometryPolygon":Z=u.centroid?[[$.x,$.y]]:$.rings[0]}for(var ee,te=0,ie=0,ne=0,re=new Array(4*Z.length),le=0;le<Z.length;le++){var se=Z[le],oe=se[0],ae=se[1],ue=p.i1616to32(oe+ie,ae+ne);ie+=oe,ne+=ae,I.set([-.5*S,-.5*E]),s.transformMat2d(I,I,N),L.push(ue),L.push(p.i8888to32(I[0],I[1],y,f)),L.push(O),L.push(R),L.push(z),L.push(A),j?L.push.apply(L,Y):C&&L.push(H),I.set([.5*S,-.5*E]),s.transformMat2d(I,I,N),L.push(ue),L.push(p.i8888to32(I[0],I[1],_,f)),L.push(O),L.push(R),L.push(z),L.push(A),j?L.push.apply(L,Y):C&&L.push(H),I.set([-.5*S,.5*E]),s.transformMat2d(I,I,N),L.push(ue),L.push(p.i8888to32(I[0],I[1],y,b)),L.push(O),L.push(R),L.push(z),L.push(A),j?L.push.apply(L,Y):C&&L.push(H),I.set([.5*S,.5*E]),s.transformMat2d(I,I,N),L.push(ue),L.push(p.i8888to32(I[0],I[1],_,b)),L.push(O),L.push(R),L.push(z),L.push(A),j?L.push.apply(L,Y):C&&L.push(H),ee=6*le,re[ee+0]=te+0,re[ee+1]=te+1,re[ee+2]=te+2,re[ee+3]=te+1,re[ee+4]=te+3,re[ee+5]=te+2,te+=4}return V.update({geometry:L},te,re),V}function f(e,t,i,n,r,l,s){var o,u=null!=n?n.spriteMosaicItem:null,h=r.geometry,v=d.isPictureSymbol(l);o=v?a.premultiplyAlphaUint32(a.white):l.color?a.premultiplyAlphaUint32(l.color):0;var y=i.vvColor||i.vvOpacity,f=new c,_=0,T=0,I=0,N=0;if(u){var V=u.rect,M=V.x,C=V.y,G=u.width,U=u.height;_=M+1,T=C+1,I=M+1+G,N=C+1+U}var P=v&&l.width&&l.height?p.i8888to32(p.nextHighestPowerOfTwo(l.width),p.nextHighestPowerOfTwo(l.height),0,0):p.i8888to32(p.nextHighestPowerOfTwo(I-_),p.nextHighestPowerOfTwo(N-T),0,0),L=[p.numTo32(e),o,p.i1616to32(_,T),p.i1616to32(I,N),P];if(y){var R=t.vvFields,z=R.opacity?t.getValue(r,R.opacity):0,A=R.color?t.getValue(r,R.color):0;(s||null===A||isNaN(A))&&(A=NaN),(s||null===z||isNaN(z))&&(z=NaN),L.push(p.toUint32(A),p.toUint32(z))}for(var O=!1,D=0,F=h.rings;D<F.length;D++){var W=F[D],B=W.length;if(!(B<3)){var H=W[0][0],j=W[0][1];if(H<-8||H>520||j<-8||j>520){O=!0;break}for(var q=1;q<B;++q)if(H+=W[q][0],j+=W[q][1],H<-8||H>520||j<-8||j>520){O=!0;break}if(O)break}}var K,X,J;if(O){x||(x=new g.TileClipper(0,0,0,1,8),x.setExtent(512)),x.reset(3);for(var Q=0,Y=h.rings;Q<Y.length;Q++){var W=Y[Q],B=W.length;if(!(B<3)){X=W[0][0],J=W[0][1],x.moveTo(X,J);for(var q=1;q<B;++q)X+=W[q][0],J+=W[q][1],x.lineTo(X,J);x.close()}}if(K={rings:x.result(!k)},!K.rings||0===K.rings.length)return null}else K=h;var Z,$,ee=[],te=[];if(k){m||(m=new w),m.beginPolygon(S,te);for(var ie=0,ne=K.rings;ie<ne.length;ie++){var W=ne[ie];if(!(W.length<3)){m.beginContour(),Z=$=0,O?(X=W[0].x,J=W[0].y):(ve=W[0],X=ve[0],J=ve[1]);var re=[X,J,0];m.addVertex(re,re);for(var q=1;q<W.length-1;q++){O?(X=W[q].x,J=W[q].y):(ye=W[q],Z=ye[0],$=ye[1],X+=Z,J+=$);var le=[X,J,0];m.addVertex(le,le)}m.endContour()}}m.endPolygon();for(var se=0;se<S.length;se+=2)ee.push(p.i1616to32(S[se],S[se+1])),ee.push.apply(ee,L)}else{for(var oe=0,ae=0,ue=void 0,he=void 0,ce=0,pe=K.rings;ce<pe.length;ce++){var W=pe[ce],ge=ae;O?(X=W[0].x,J=W[0].y):(fe=W[0],X=fe[0],J=fe[1]),S[ae++]=X,S[ae++]=J;var de=0;Z=$=0;for(var q=1;q<W.length;++q)O?(ue=W[q].x,he=W[q].y,Z=ue-X,$=he-J,de-=Z*(J+J+$),X=ue,J=he):(_e=W[q],Z=_e[0],$=_e[1],de-=Z*(J+J+$),X+=Z,J+=$),S[ae++]=X,S[ae++]=J;de>0?(ge-oe>0&&(b(ee,te,S,oe,ge,E,L),oe=ge),E.length=0):de<0&&ge-oe>0?E.push(.5*(ge-oe)):ae=ge}ae-oe>0&&b(ee,te,S,oe,ae,E,L)}return S.length=E.length=0,f.update({geometry:ee},ee.length/(L.length+1),te),f;var ve,ye,fe,_e}function _(e,t,i,n,r,l,s,o,a,c){switch(r){case u.WGLGeometryType.MARKER:return y(e,t,i,n,s,o,a,l);case u.WGLGeometryType.FILL:return f(e,t,i,n,o,a,c);case u.WGLGeometryType.LINE:return h.createLineMeshData(e,t,i,n,s,o,a)}return null}function b(e,t,i,n,l,s,o){var a=i.slice(n,l),u=e.length/(o.length+1),h=r(a,s,2),c=h.length;if(c<=0)return 0;for(var g=0;g<a.length;)e.push(p.i1616to32(a[g++],a[g++])),e.push.apply(e,o);for(var d=0;d<c;)t.push(h[d++]+u,h[d++]+u,h[d++]+u)}Object.defineProperty(t,"__esModule",{value:!0});var x,m,T=3.14159265359/180,I=s.create(),N=l.create(),S=[],E=[],w=function(){function e(){this._currentVertexIndex=0,this._indexCounter=0,this._triangleIndices=[-1,-1,-1],this.glu=new o.GluTesselator,this.glu.gluTessCallback(o.gluEnum.GLU_TESS_BEGIN,this._begincallback.bind(this)),this.glu.gluTessCallback(o.gluEnum.GLU_TESS_VERTEX_DATA,this._vertexCallback.bind(this)),this.glu.gluTessCallback(o.gluEnum.GLU_TESS_END,this._endcallback.bind(this)),this.glu.gluTessCallback(o.gluEnum.GLU_TESS_COMBINE,this._combinecallback.bind(this)),this.glu.gluTessCallback(o.gluEnum.GLU_TESS_ERROR,this._errorcallback.bind(this)),this.glu.gluTessCallback(o.gluEnum.GLU_TESS_EDGE_FLAG,this._edgeCallback.bind(this)),this.glu.gluTessProperty(o.gluEnum.GLU_TESS_WINDING_RULE,o.windingRule.GLU_TESS_WINDING_ODD)}return e.prototype.beginPolygon=function(e,t){this._triangleIndices[0]=-1,this._triangleIndices[1]=-1,this._triangleIndices[2]=-1,this._currentVertexIndex=0,this._indexCounter=0,this.glu.gluTessBeginPolygon(e),this._indices=t},e.prototype.endPolygon=function(){this.glu.gluTessEndPolygon()},e.prototype.beginContour=function(){this.glu.gluTessBeginContour()},e.prototype.endContour=function(){this.glu.gluTessEndContour()},e.prototype.addVertex=function(e,t){this.glu.gluTessVertex(e,t)},e.prototype._vertexCallback=function(e,t){if(t[t.length]=e[0],t[t.length]=e[1],this._triangleIndices[this._currentVertexIndex]=-1,this._currentVertexIndex>=2){for(var i=0;i<3;i++)-1===this._triangleIndices[i]&&(this._triangleIndices[i]=this._indexCounter++),this._indices[this._indices.length]=this._triangleIndices[i];this._currentVertexIndex=0}else this._currentVertexIndex++},e.prototype._begincallback=function(e){this._triangleIndices[0]=-1,this._triangleIndices[1]=-1,this._triangleIndices[2]=-1,this._currentVertexIndex=0},e.prototype._endcallback=function(){this._currentVertexIndex=0},e.prototype._errorcallback=function(e){},e.prototype._combinecallback=function(e,t,i){return[e[0],e[1],e[2]]},e.prototype._edgeCallback=function(e){},e}(),V=i("esri-featurelayer-webgl"),M=V&&V.tesselator||"libtess",k="libtess"===M;t.createMesh=_});