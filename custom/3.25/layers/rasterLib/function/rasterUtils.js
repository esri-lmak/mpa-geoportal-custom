// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/lang"],function(e){return{mask:function(e,l){if(e&&e.pixels&&e.pixels.length){var n=this._clonePixelBlock(e),t=l.includedRanges,i=l.noDataInterpretation,r=l.noDataValues;if(null===t&&null===r)return n;var s,a,o=n.pixels,f=n.mask,u=n.width*n.height,h=o.length;if(null!==r&&r.length!==h)throw"expect "+h+" elements in noDataValues";if(null!==t&&t.length!==2*h)throw"expect "+2*h+" elements in IncludeRanges";var c,m,x,p,g;if(null==f){for(f=new Uint8Array(u),a=0;a<u;a++)f[a]=1;n.mask=f}if(0===i)for(s=0;s<h;s++)if(x=o[s],c=null===t?null:t[2*s],m=null===t?null:t[2*s+1],p=null===r?null:parseFloat(r[s]),null===c||null===m)for(a=0;a<u;a++)f[a]&&(g=x[a])===p&&(f[a]=0);else if(null===p)for(a=0;a<u;a++)f[a]&&((g=x[a])<c||g>m)&&(f[a]=0);else for(a=0;a<u;a++)f[a]&&((g=x[a])<c||g>m||g===p)&&(f[a]=0);else{var d=new Uint8Array(u);for(a=0;a<u;a++)d[a]=f[a];for(s=0;s<h;s++)if(x=o[s],c=null===t?null:t[2*s],m=null===t?null:t[2*s+1],p=null===r?null:parseFloat(r[s]),null===c||null===m)for(a=0;a<u;a++)d[a]&&(g=x[a])!==p&&(d=0);else if(null===p)for(a=0;a<u;a++)d[a]&&(g=x[a])<=c&&g<=m&&(d=0);else for(a=0;a<u;a++)d[a]&&(g=x[a])<=c&&g<=m&&g!==p&&(d=0);for(a=0;a<u;a++)f[a]&&d[a]&&(f[a]=0)}return n}},calculateStatisticsHistograms:function(e,l){var n,t,i,r,s,a,o,f,u,h,c,m,x,p,g,d,k=this._clonePixelBlock(e),w=k.pixelType,v=k.pixels,y=k.mask,U=v.length,_=[];for(r=0;r<U;r++){if(a={min:-.5,max:255.5,size:256,counts:new Uint32Array(256)},o=a.counts,u=v[r],"U8"===w)if(y)for(s=0;s<k.width*k.height;s++)y[s]&&o[u[s]]++;else for(s=0;s<k.width*k.height;s++)o[u[s]]++;else{if(n=k.statistics[r].minValue,t=k.statistics[r].maxValue,a.min=n,a.max=t,i=(t-n)/256,f=new Uint32Array(257),y)for(s=0;s<k.width*k.height;s++)y[s]&&f[Math.floor((u[s]-n)/i)]++;else for(s=0;s<k.width*k.height;s++)f[Math.floor((u[s]-n)/i)]++;for(s=0;s<255;s++)o[s]=f[s];o[255]=f[255]+f[256]}for(_.push(a),[],n=k.statistics[r].minValue,t=k.statistics[r].maxValue,h=0,c=0,p=0,s=0;s<a.size;s++)h+=o[s],c+=s*o[s];for(g=c/h,s=0;s<a.size;s++)p+=o[s]*Math.pow(s-g,2);d=Math.sqrt(p/(h-1)),m=(g+.5)*(a.max-a.min)/a.size+a.min,x=d*(a.max-a.min)/a.size,k.statistics[r]={min:n,minValue:n,max:t,maxValue:t,mean:m,stddev:x}}return k.histograms=_,k},buildIndexedColormap:function(e,l){if(!e)return null;var n=0;e[0][0]<0&&(n=e[0][0]);var t=Math.max(256,e[e.length-1][0]-n);if(t>65536)return null;var i,r=new Uint8Array(4*t),s=[],a=0,o=5===e[0].length;if(l)for(s=e[a],i=s[0]-n;i<t;i++)r[4*i]=s[1],r[4*i+1]=s[2],r[4*i+2]=s[3],r[4*i+3]=o?s[4]:255,i===s[0]-n&&(s=a===e.length-1?s:e[++a]);else for(i=0;i<e.length;i++)s=e[i],a=4*(s[0]-n),r[a]=s[1],r[a+1]=s[2],r[a+2]=s[3],r[a+3]=o?s[4]:255;return{indexedColormap:r,offset:n,alphaSpecified:o}},colorize:function(e,l){if(null!==e&&null!==e.pixels){var n,t=this._clonePixelBlock(e),i=t.pixels,r=t.width*t.height,s=i.length,a=t.mask,o=l.indexedColormap,f=l.indexedColormapOffset,u=o&&o.length-1,h=l.indexed2DColormap,c=l.alphaSpecified;if(s>=3)throw"colormap only works on single band image";var m,x=i[0],p=new Uint8Array(x.length),g=new Uint8Array(x.length),d=new Uint8Array(x.length),k=0;if(o)if(a)for(n=0;n<r;n++)a[n]&&(k=4*(x[n]-f),k<f||k>u?a[n]=0:(p[n]=o[k],g[n]=o[k+1],d[n]=o[k+2],a[n]=o[k+3]));else{for(a=new Uint8Array(r),n=0;n<r;n++)k=4*(x[n]-f),k<f||k>u?a[n]=0:(p[n]=o[k],g[n]=o[k+1],d[n]=o[k+2],a[n]=o[k+3]);t.mask=a}else if(a)for(n=0;n<r;n++)a[n]&&(m=h[x[n]],p[n]=m[0],g[n]=m[1],d[n]=m[2],a[n]=m[3]);else{for(a=new Uint8Array(r),n=0;n<r;n++)m=h[x[n]],p[n]=m[0],g[n]=m[1],d[n]=m[2],a[n]=m[3];t.mask=a}return t.pixels=[p,g,d],t.statistics=null,t.pixelType="U8",t.maskIsAlpha=c,t}},convolute:function(e,l){var n,t,i,r,s,a,o,f,u=this._clonePixelBlock(e),h=u.pixels,c=u.width,m=u.height,x=c*m,p=h.length,g=[],d=[],k=l.normalizedKernel,w=l.kernelRows,v=l.kernelCols;for(n=0;n<p;n++){for(r=h[n],s=new Float32Array(x),s.set(r),a=1;a<m-1;a++)for(f=a*c,o=1;o<c-1;o++){for(d=0,t=0;t<w;t++)for(i=0;i<v;i++)d+=r[f+o+(t-1)*c+i-1]*k[t*v+i];s[f+o]=d}g.push(s)}return u.pixels=g,u},contrastBrightnessStretch:function(e,l){if(null!==e&&null!==e.pixels){var n,t,i=this._clonePixelBlock(e),r=i.pixels,s=i.mask,a=i.width*i.height,o=r.length,f=l&&l.contrastOffset,u=l&&l.brightnessOffset;if("U8"!==i.pixelType)throw"the contrast and brightness function only supports 8 bit unsigned integer data";var h=this._createContrastBrightnessLUT(f,u);if(null==s)for(t=0;t<a;t++)for(n=0;n<o;n++)r[n][t]=h[r[n][t]];else for(t=0;t<a;t++)if(s[t])for(n=0;n<o;n++)r[n][t]=h[r[n][t]];return i.pixelType="U8",i}},isNull:function(e,l){if(null!==e&&null!==e.pixels){var n,t=this._clonePixelBlock(e),i=t.mask,r=t.pixels[0],s=r.length;if(i){for(n=0;n<s;n++)r[n]=i[n]?0:1;t.mask=null}else if(r.fill)r.fill(0);else for(n=0;n<s;n++)r[n]=0;return t}},setNull:function(e){if(null!==n&&null!==n.pixels){var l,n=this._clonePixelBlock(e),t=n.mask,i=n.pixels[0],r=i.length;for(t=t||new Uint8Array(r),l=0;l<r;l++)t[l]=i[l]?0:1;return n.mask=t,n}},local:function(e,l){if(!l)return e[0];var n=l.rasterCountNeeded,t=l.functor,i=this._clonePixelBlock(e[0]);if(null!==i&&null!==i.pixels){var r,s=i.width*i.height,a=e[1],o=a&&a.pixels[0],f=a&&a.mask,u=i.mask,h=i.pixels[0];if(2===n)if(!u&&f)u=f;else if(u&&f)for(r=0;r<s;r++)u[r]=u[r]&&f[r]?1:0;if(i.mask=u,1===n)if(null==u)for(r=0;r<s;r++)h[r]=t(h[r]);else for(r=0;r<s;r++)u[r]&&(h[r]=t(h[r]));else if(2===n)if(null==u)for(r=0;r<s;r++)h[r]=t(h[r],o[r]);else for(r=0;r<s;r++)u[r]&&(h[r]=t(h[r],o[r]));return i.mask=u,i.calculateStatistics(),i}},_clonePixelBlock:function(l){return l.clone?l.clone():e.clone(l)},_createContrastBrightnessLUT:function(e,l){if(this._contrastCache&&this._contrastCache.contrastOffset===e&&this._contrastCache.brightnessOffset===l)return this._contrastCache.lut;var n,t,i=Math.min(Math.max(e,-100),100),r=Math.min(Math.max(l,-100),100),s=new Uint8Array(256);for(n=0;n<256;n++)i>0&&i<100?t=(200*n-25500+510*r)/(2*(100-i))+128:i<=0&&i>-100?t=(200*n-25500+510*r)*(100+i)/2e4+128:100===i?(t=200*n-25500+256*(100-i)+510*r,t=t>0?255:0):-100===i&&(t=128),s[n]=t>255?255:t<0?0:t;return this._contrastCache={contrastOffset:e,brightnessOffset:l,lut:s},s}}});