// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/config","dojo/_base/json","dojo/sniff","dojo/DeferredList","dojo/when","../../../kernel","../../../Evented","../../../request","../../../geometry/Extent","../../../geometry/Point","../../../SpatialReference","../../../deferredUtils","../../../urlUtils","../../MosaicRule","../../ImageServiceParameters","../../PixelBlock","./RasterInfo","./BasicRaster","../../rasterFormats/rasterCodec","../tile/RasterTileInfo"],function(e,t,n,i,r,a,s,o,l,c,u,h,d,f,m,p,g,I,v,_,b,x,R,j,y){var P=t([R],{declaredClass:"esri.layers.rasterLib.raster.ImageServiceRaster",sourceType:"ImageService",constructor:function(e){e&&(this._imageServiceParams=e.imageServiceParameters,this._commonReqParams=e._commonReqParams,this._imageServiceParams||(this._imageServiceParams={interpolation:e.interpolation,pixelType:e.pixelType,format:e.format||"lerc",compressionQuality:e.compressionQuality,bandIds:e.bandIds,noDataInterpretation:e.noDataInterpretation,adjustAspectRatio:e.adjustAspectRatio,mosaicRule:e.mosaicRule,renderingRule:e.interpolation}))},open:function(){var e=new i;if(this.serviceInfo&&this.rasterInfo)return this.loaded=!0,this._findCredential(),this.setFetchParameters(this._imageServiceParams),e.resolve(this),e.promise;var t=this.serviceInfo||this._generateServiceInfo(this._imageServiceParams&&this._imageServiceParams.renderingRule),r=n.hitch(this,function(t){this.serviceInfo=t,this._findCredential();var i=this._parseRasterInfo(t),r={};t.defaultMosaicMethod?(r.method=t.defaultMosaicMethod,r.operation=t.mosaicOperator,r.sortField=t.sortField,r.sortValue=t.sortValue):r.method=v.METHOD_NONE,this.serviceInfo.defaultMosaicRule=new v(r),this.serviceInfo.defaultMosaicRule.ascending=!0;var a=this._getColormap(this),s=this._getHistograms(this),o=this._getRasterAttributeTable(this),c=this._getKeyProperties(this),u=this._getMultidimensionalInfo();new l([a,s,o,c,u]).then(n.hitch(this,function(t){t[0][0]&&(i.colormap=t[0][1]),t[1][0]&&(i.histograms=t[1][1]),t[2][0]&&(i.vat=t[2][1]),t[3][0]&&(i.keyProperties=t[3][1]),t[4][0]&&(i.multidimensionalInfo=t[4][1]),this.loaded=!0,this.rasterInfo=i,this.setFetchParameters(this._imageServiceParams),e.resolve(this)}))}),a=n.hitch(this,function(t){this.loaded=!0,e.reject(t)});return c(t,r,a),e.promise},setFetchParameters:function(e,t){if(t)this.imageServiceParams=e;else{var n=this.imageServiceParameters;n&&e?Object.keys(e).forEach(function(t){n[t]=e[t]}):this.imageServiceParams=e}this._constructGetImageParams(),this._getRasterIdentifier(!0)},read:function(e){if(e.pixelBlock||e.texture){var t=new i;return t.resolve(e),t.promise}if(!1===e.virtual&&this.tileInfo&&!this.tileInfo.virtual)return this.readTile(e);var r=e.extent,a=r.spatialReference.wkid||s.toJson(r.spatialReference.toJson(!1)),o=e.timeExtent?e.timeExtent.toJson().join(","):null,l=this.url+"/exportImage",c=n.mixin({},this._commonReqParams,{bbox:r.xmin+","+r.ymin+","+r.xmax+","+r.ymax,imageSR:a,bboxSR:a,size:e.width+","+e.height,time:o},this.disableClientCaching?{_ts:(new Date).getTime()}:{}),u={width:e.width,height:e.height,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:!1};return this._requestPixels({url:l,payload:c,decodeParams:u,tileOptions:e})},readTile:function(e){var t=this.url+"/tile/"+e.level+"/"+e.row+"/"+e.col,n={},i={width:this.tileInfo.cols,height:this.tileInfo.rows,planes:null,pixelType:null,format:null,decodeFunc:null,isPoint:"elevation"===e.tileType.toLowerCase()};return this._requestPixels({url:t+(this.disableClientCaching?"?_ts= "+(new Date).getTime():""),payload:n,decodeParams:i,tileOptions:e})},getProjectedFullExtent:function(e,t){var r=this.url,a=new i;if(t&&(this.projectedFullExtent=null),this.projectedFullExtent)return a.resolve(this.projectedFullExtent),a.promise;var s=e?e.wkid||e.wkt:null;return null===s||e.equals(new p(this.rasterInfo.spatialReference))?(this.projectedFullExtent=new f(this.rasterInfo.extent),a.resolve(new f(this.rasterInfo.extent)),a.promise):(d({url:r,content:{f:"json",option:"footprints",outSR:s},handleAs:"json",callbackParamName:"callback"}).then(n.hitch(this,function(e){var t,n=e&&e.featureCollection?e.featureCollection.layers[0].layerDefinition.extent:null;n&&(t=new f(n)),this.projectedFullExtent=t,a.resolve(t)}),function(e){a.reject(e)}),a.promise)},toJson:function(){return{url:this.url,tileInfo:this.tileInfo,rasterInfo:this.rasterInfo,serviceInfo:this.serviceInfo,sourceType:this.sourceType,_commonReqParams:this._commonReqParams,_rasterId:this._rasterId}},_generateServiceInfo:function(e){var t=this.url,n=new i(g._dfdCanceller);return n._pendingDfd=d({url:t,content:{f:"json",renderingRule:e?s.toJson(e.toJson()):null},handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)}),n},_parseRasterInfo:function(e){var t=new x;t.bandCount=e.bandCount,t.extent=new f(e.fullExtent),t.spatialReference=e.spatialReference,t.pixelType=e.pixelType,t.width=Math.floor((e.fullExtent.xmax-e.fullExtent.xmin)/e.pixelSizeX+.5),t.height=Math.floor((e.fullExtent.ymax-e.fullExtent.ymin)/e.pixelSizeY+.5),t.cellSize=new m({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:e.spatialReference});var n,i;if(e.minValues&&e.minValues.length>0&&e.maxValues&&e.stdvValues&&e.meanValues){for(n=[],i=0;i<e.minValues.length;i++)n.push({min:e.minValues[i],max:e.maxValues[i],mean:e.meanValues[i],stddev:e.stdvValues[i]});e.bandCount!==n.length&&(n=null)}return this.dataType=e.serviceDataType.replace("esriImageServiceDataType",""),t.statistics=n,e.objectIdField&&e.fields&&(t.catalogInfo={objectIdField:e.objectIdField,fields:e.fields}),t.timeInfo=e.timeInfo,e.tileInfo&&(this.tileInfo=new y(e.tileInfo),this.tileInfo.tileType=e.cacheType||"Map",t.tileInfo=this.tileInfo),t},_getColormap:function(e){var t=this.url+"/colormap",n=new i(g._dfdCanceller),r={f:"json"},a=this.serviceInfo.hasColormap||this.rasterInfo&&this.rasterInfo.hasColormap;return this.serviceInfo.currentVersion>10&&a?(n._pendingDfd=d({url:t,content:r,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e.colormap)},function(e){n.errback(e)})):n.callback(null),n},_getHistograms:function(e){var t=this.url+"/histograms",n=new i(g._dfdCanceller),r={f:"json"},a=this.serviceInfo.hasHistograms||this.rasterInfo&&this.rasterInfo.hasHistograms;return e&&e.renderingRule&&(r.renderingRule=s.toJson(e.renderingRule.toJson()),a=!0),this.serviceInfo.currentVersion>10&&a?(n._pendingDfd=d({url:t,content:r,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e.histograms)},function(e){n.errback(e)})):n.callback(null),n},_getRasterAttributeTable:function(e){var t=this.url+"/rasterAttributeTable",n=new i(g._dfdCanceller),r={f:"json"},a=this.serviceInfo.hasRasterAttributeTable;return e&&e.renderingRule&&(r.renderingRule=s.toJson(e.renderingRule.toJson()),a=!0),this.serviceInfo.currentVersion>10&&a?(n._pendingDfd=d({url:t,content:r,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)})):n.callback(null),n},_getKeyProperties:function(e){var t=this.url+"/keyProperties",n=new i(g._dfdCanceller),r={f:"json"};return e&&e.renderingRule&&(r.renderingRule=s.toJson(e.renderingRule.toJson())),this.serviceInfo.currentVersion>10?(n._pendingDfd=d({url:t,content:r,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)})):n.callback(null),n},_getMultidimensionalInfo:function(){var e=this.url+"/multidimensionalInfo",t=new i(g._dfdCanceller);return this.serviceInfo.currentVersion>=10.3&&this.serviceInfo.hasMultidimensions?(t._pendingDfd=d({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then(n.hitch(this,function(e){t.callback(e.multidimensionalInfo)}),function(e){t.errback(e)})):t.callback(null),t},_initializationFailed:function(){},_constructGetImageParams:function(){var e=this.imageServiceParams||{},t=n.mixin({},this._query,{f:"image",interpolation:e.interpolation,pixelType:e.pixelType,format:e.format||"lerc",compressionQuality:e.compressionQuality,bandIds:e.bandIds?e.bandIds.join(","):null,noData:null!=e.noData?e.noData.join(","):null,noDataInterpretation:e.noDataInterpretation,adjustAspectRatio:null==e.adjustAspectRatio?null:e.adjustAspectRatio,mosaicRule:e.mosaicRule?s.toJson(e.mosaicRule.toJson()):null,renderingRule:e.renderingRule?s.toJson(e.renderingRule.toJson()):null,token:this.credential&&this.credential.token||null});"lerc"===t.format.toLowerCase()?(t.compressionTolerance=e.compressionTolerance,this.serviceInfo.currentVersion>=10.5&&(t.lercVersion=e.lercVersion||2)):"tiff"===t.format.toLowerCase()?t.compression=e.compression:["jpg","jpeg","jpg","jpgpng"].indexOf(t.format.toLowerCase())>-1&&(t.compression=e.compression),this._commonReqParams=t},_getRasterIdentifier:function(e){if(this._rasterId)return this._rasterId;var t=this.url.replace("http:","").replace("https:",""),n=[],i=this.imageServiceParams||{};n.push(t),n.push(i.interpolation),n.push(i.pixelType),n.push(i.compressionQuality),n.push(i.bandIds?i.bandIds.join(","):""),n.push(i.mosaicRule?s.toJson(i.mosaicRule.toJson()):""),n.push(i.renderingRule?s.toJson(i.renderingRule.toJson()):"");var r=n.join("|");return this._rasterId=this._computeSignature(r),this._rasterId},_wrapExtent:function(e){var t,n=e.spatialReference._getInfo();if(n){var i=n.valid[0],r=n.valid[1];(e.xmin<i-this.resolution.x||e.xmax>r+this.resolution.y)&&(t=new f((e.xmin-i)%(r-i),e.ymin,(e.xmax-r)%(r-i),e.ymax,e.spatialReference),t.xmax<t.xmin&&(t=null))}return t||e}});return o("extend-esri")&&n.setObject("layers.rasterLib.raster.ImageServiceRaster",P,u),P});