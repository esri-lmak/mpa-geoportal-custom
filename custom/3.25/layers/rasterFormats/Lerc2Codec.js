// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define([],function(){"use strict";var e={unstuff:function(e,t,r,a,i,n,s,f){var l,o,u,c,h,d=(1<<r)-1,p=0,g=0,m=4*e.length-Math.ceil(r*a/8);if(e[e.length-1]<<=8*m,i)for(l=0;l<a;l++)0===g&&(u=e[p++],g=32),g>=r?(o=u>>>g-r&d,g-=r):(c=r-g,o=(u&d)<<c&d,u=e[p++],g=32-c,o+=u>>>g),t[l]=i[o];else for(h=Math.ceil((f-n)/s),l=0;l<a;l++)0===g&&(u=e[p++],g=32),g>=r?(o=u>>>g-r&d,g-=r):(c=r-g,o=(u&d)<<c&d,u=e[p++],g=32-c,o+=u>>>g),t[l]=o<h?n+o*s:f},unstuffLUT:function(e,t,r,a,i,n){var s,f=(1<<t)-1,l=0,o=0,u=0,c=0,h=0,d=[],p=4*e.length-Math.ceil(t*r/8);e[e.length-1]<<=8*p;var g=Math.ceil((n-a)/i);for(o=0;o<r;o++)0===c&&(s=e[l++],c=32),c>=t?(h=s>>>c-t&f,c-=t):(u=t-c,h=(s&f)<<u&f,s=e[l++],c=32-u,h+=s>>>c),d[o]=h<g?a+h*i:n;return d.unshift(a),d},unstuff2:function(e,t,r,a,i,n,s,f){var l,o,u,c,h=(1<<r)-1,d=0,p=0,g=0;if(i)for(l=0;l<a;l++)0===p&&(u=e[d++],p=32,g=0),p>=r?(o=u>>>g&h,p-=r,g+=r):(c=r-p,o=u>>>g&h,u=e[d++],p=32-c,o|=(u&(1<<c)-1)<<r-c,g=c),t[l]=i[o];else{var m=Math.ceil((f-n)/s);for(l=0;l<a;l++)0===p&&(u=e[d++],p=32,g=0),p>=r?(o=u>>>g&h,p-=r,g+=r):(c=r-p,o=u>>>g&h,u=e[d++],p=32-c,o|=(u&(1<<c)-1)<<r-c,g=c),t[l]=o<m?n+o*s:f}return t},unstuffLUT2:function(e,t,r,a,i,n){var s,f=(1<<t)-1,l=0,o=0,u=0,c=0,h=0,d=0,p=[],g=Math.ceil((n-a)/i);for(o=0;o<r;o++)0===c&&(s=e[l++],c=32,d=0),c>=t?(h=s>>>d&f,c-=t,d+=t):(u=t-c,h=s>>>d&f,s=e[l++],c=32-u,h|=(s&(1<<u)-1)<<t-u,d=u),p[o]=h<g?a+h*i:n;return p.unshift(a),p},originalUnstuff:function(e,t,r,a){var i,n,s,f,l=(1<<r)-1,o=0,u=0,c=4*e.length-Math.ceil(r*a/8);for(e[e.length-1]<<=8*c,i=0;i<a;i++)0===u&&(s=e[o++],u=32),u>=r?(n=s>>>u-r&l,u-=r):(f=r-u,n=(s&l)<<f&l,s=e[o++],u=32-f,n+=s>>>u),t[i]=n;return t},originalUnstuff2:function(e,t,r,a){var i,n,s,f,l=(1<<r)-1,o=0,u=0,c=0;for(i=0;i<a;i++)0===u&&(s=e[o++],u=32,c=0),u>=r?(n=s>>>c&l,u-=r,c+=r):(f=r-u,n=s>>>c&l,s=e[o++],u=32-f,n|=(s&(1<<f)-1)<<r-f,c=f),t[i]=n;return t}},t={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(e){for(var t=65535,r=65535,a=e.length,i=Math.floor(a/2),n=0;i;){var s=i>=359?359:i;i-=s;do{t+=e[n++]<<8,r+=t+=e[n++]}while(--s);t=(65535&t)+(t>>>16),r=(65535&r)+(r>>>16)}return 1&a&&(r+=t+=e[n]<<8),t=(65535&t)+(t>>>16),((r=(65535&r)+(r>>>16))<<16|t)>>>0},readHeaderInfo:function(e,t){var r=t.ptr,a=new Uint8Array(e,r,6),i={};if(i.fileIdentifierString=String.fromCharCode.apply(null,a),0!==i.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+i.fileIdentifierString;r+=6;var n=new DataView(e,r,8),s=n.getInt32(0,!0);i.fileVersion=s,r+=4,s>=3&&(i.checksum=n.getUint32(4,!0),r+=4),n=new DataView(e,r,12),i.height=n.getUint32(0,!0),i.width=n.getUint32(4,!0),r+=8,s>=4?(i.numDims=n.getUint32(8,!0),r+=4):i.numDims=1,n=new DataView(e,r,40),i.numValidPixel=n.getUint32(0,!0),i.microBlockSize=n.getInt32(4,!0),i.blobSize=n.getInt32(8,!0),i.imageType=n.getInt32(12,!0),i.maxZError=n.getFloat64(16,!0),i.zMin=n.getFloat64(24,!0),i.zMax=n.getFloat64(32,!0),r+=40,t.headerInfo=i,t.ptr=r;var f;if(s>=3&&(f=s>=4?52:48,this.computeChecksumFletcher32(new Uint8Array(e,r-f,i.blobSize-14))!==i.checksum))throw"Checksum failed.";return!0},checkMinMaxRanges:function(e,t){var r=t.headerInfo,a=this.getDataTypeArray(r.imageType),i=r.numDims*this.getDataTypeSize(r.imageType),n=this.readSubArray(e,t.ptr,a,i),s=this.readSubArray(e,t.ptr+i,a,i);t.ptr+=2*i;var f,l=!0;for(f=0;f<r.numDims;f++)if(n[f]!==s[f]){l=!1;break}return r.minValues=n,r.maxValues=s,l},readSubArray:function(e,t,r,a){var i;if(r===Uint8Array)i=new Uint8Array(e,t,a);else{var n=new ArrayBuffer(a);new Uint8Array(n).set(new Uint8Array(e,t,a)),i=new r(n)}return i},readMask:function(e,t){var r=t.ptr,a=t.headerInfo,i=a.width*a.height,n=a.numValidPixel,s=new DataView(e,r,4),f={};if(f.numBytes=s.getUint32(0,!0),r+=4,(0===n||i===n)&&0!==f.numBytes)throw"invalid mask";var l,o;if(0===n)l=new Uint8Array(Math.ceil(i/8)),f.bitset=l,o=new Uint8Array(i),t.pixels.resultMask=o,r+=f.numBytes;else if(f.numBytes>0){l=new Uint8Array(Math.ceil(i/8)),s=new DataView(e,r,f.numBytes);var u=s.getInt16(0,!0),c=2,h=0,d=0;do{if(u>0)for(;u--;)l[h++]=s.getUint8(c++);else for(d=s.getUint8(c++),u=-u;u--;)l[h++]=d;u=s.getInt16(c,!0),c+=2}while(c<f.numBytes);if(-32768!==u||h<l.length)throw"Unexpected end of mask RLE encoding";o=new Uint8Array(i);var p=0,g=0;for(g=0;g<i;g++)7&g?(p=l[g>>3],p<<=7&g):p=l[g>>3],128&p&&(o[g]=1);t.pixels.resultMask=o,f.bitset=l,r+=f.numBytes}return t.ptr=r,t.mask=f,!0},readDataOneSweep:function(e,r,a){var i,n=r.ptr,s=r.headerInfo,f=s.numDims,l=s.width*s.height,o=s.imageType,u=s.numValidPixel*t.getDataTypeSize(o)*f,c=r.pixels.resultMask;if(a===Uint8Array)i=new Uint8Array(e,n,u);else{var h=new ArrayBuffer(u);new Uint8Array(h).set(new Uint8Array(e,n,u)),i=new a(h)}if(i.length===l*f)r.pixels.resultPixels=i;else{r.pixels.resultPixels=new a(l*f);var d=0,p=0,g=0,m=0;if(f>1)for(g=0;g<f;g++)for(m=g*l,p=0;p<l;p++)c[p]&&(r.pixels.resultPixels[m+p]=i[d++]);else for(p=0;p<l;p++)c[p]&&(r.pixels.resultPixels[p]=i[d++])}return n+=u,r.ptr=n,!0},readHuffmanTree:function(e,a){var i=this.HUFFMAN_LUT_BITS_MAX,n=new DataView(e,a.ptr,16);if(a.ptr+=16,n.getInt32(0,!0)<2)throw"unsupported Huffman version";var s=n.getInt32(4,!0),f=n.getInt32(8,!0),l=n.getInt32(12,!0);if(f>=l)return!1;var o=new Uint32Array(l-f);t.decodeBits(e,a,o);var u,c,h,d,p=[];for(u=f;u<l;u++)c=u-(u<s?0:s),p[c]={first:o[u-f],second:null};var g=e.byteLength-a.ptr,m=Math.ceil(g/4),w=new ArrayBuffer(4*m);new Uint8Array(w).set(new Uint8Array(e,a.ptr,g));var y,x=new Uint32Array(w),k=0,b=0;for(y=x[0],u=f;u<l;u++)c=u-(u<s?0:s),(d=p[c].first)>0&&(p[c].second=y<<k>>>32-d,32-k>=d?32===(k+=d)&&(k=0,b++,y=x[b]):(k+=d-32,b++,y=x[b],p[c].second|=y>>>32-k));var U=0,I=0,v=new r;for(u=0;u<p.length;u++)void 0!==p[u]&&(U=Math.max(U,p[u].first));I=U>=i?i:U,U>=30&&console.log("WARning, large NUM LUT BITS IS "+U);var M,A,D,T,V,S,B=[];for(u=f;u<l;u++)if(c=u-(u<s?0:s),(d=p[c].first)>0)if(M=[d,c],d<=I)for(A=p[c].second<<I-d,D=1<<I-d,h=0;h<D;h++)B[A|h]=M;else for(A=p[c].second,S=v,T=d-1;T>=0;T--)V=A>>>T&1,V?(S.right||(S.right=new r),S=S.right):(S.left||(S.left=new r),S=S.left),0!==T||S.val||(S.val=M[1]);return{decodeLut:B,numBitsLUTQick:I,numBitsLUT:U,tree:v,stuffedData:x,srcPtr:b,bitPos:k}},readHuffman:function(e,t,r){var a,i,n,s,f,l,o,u,c,h,d=t.headerInfo,p=d.numDims,g=t.headerInfo.height,m=t.headerInfo.width,w=m*g,y=this.readHuffmanTree(e,t),x=y.decodeLut,k=y.tree,b=y.stuffedData,U=y.srcPtr,I=y.bitPos,v=y.numBitsLUTQick,M=y.numBitsLUT,A=0===t.headerInfo.imageType?128:0,D=t.pixels.resultMask,T=0;I>0&&(U++,I=0);var V,S=b[U],B=1===t.encodeMode,P=new r(w*p),z=P;for(V=0;V<d.numDims;V++){if(p>1&&(z=new r(P.buffer,w*V,w),T=0),t.headerInfo.numValidPixel===m*g)for(c=0,o=0;o<g;o++)for(u=0;u<m;u++,c++){if(i=0,s=S<<I>>>32-v,f=s,32-I<v&&(s|=b[U+1]>>>64-I-v,f=s),x[f])i=x[f][1],I+=x[f][0];else for(s=S<<I>>>32-M,f=s,32-I<M&&(s|=b[U+1]>>>64-I-M,f=s),a=k,h=0;h<M;h++)if(l=s>>>M-h-1&1,a=l?a.right:a.left,!a.left&&!a.right){i=a.val,I=I+h+1;break}I>=32&&(I-=32,U++,S=b[U]),n=i-A,B?(n+=u>0?T:o>0?z[c-m]:T,n&=255,z[c]=n,T=n):z[c]=n}else for(c=0,o=0;o<g;o++)for(u=0;u<m;u++,c++)if(D[c]){if(i=0,s=S<<I>>>32-v,f=s,32-I<v&&(s|=b[U+1]>>>64-I-v,f=s),x[f])i=x[f][1],I+=x[f][0];else for(s=S<<I>>>32-M,f=s,32-I<M&&(s|=b[U+1]>>>64-I-M,f=s),a=k,h=0;h<M;h++)if(l=s>>>M-h-1&1,a=l?a.right:a.left,!a.left&&!a.right){i=a.val,I=I+h+1;break}I>=32&&(I-=32,U++,S=b[U]),n=i-A,B?(u>0&&D[c-1]?n+=T:o>0&&D[c-m]?n+=z[c-m]:n+=T,n&=255,z[c]=n,T=n):z[c]=n}t.ptr=t.ptr+4*(U+1)+(I>0?4:0)}t.pixels.resultPixels=P},decodeBits:function(t,r,a,i,n){var s=r.headerInfo,f=s.fileVersion,l=0,o=t.byteLength-r.ptr>=5?5:t.byteLength-r.ptr,u=new DataView(t,r.ptr,o),c=u.getUint8(0);l++;var h=c>>6,d=0===h?4:3-h,p=(32&c)>0,g=31&c,m=0;if(1===d)m=u.getUint8(l),l++;else if(2===d)m=u.getUint16(l,!0),l+=2;else{if(4!==d)throw"Invalid valid pixel count type";m=u.getUint32(l,!0),l+=4}var w,y,x,k,b,U,I,v,M,A=2*s.maxZError,D=s.numDims>1?s.maxValues[n]:s.zMax;if(p){for(r.counter.lut++,v=u.getUint8(l),g,l++,k=Math.ceil((v-1)*g/8),b=Math.ceil(k/4),y=new ArrayBuffer(4*b),x=new Uint8Array(y),r.ptr+=l,x.set(new Uint8Array(t,r.ptr,k)),I=new Uint32Array(y),r.ptr+=k,M=0;v-1>>>M;)M++;k=Math.ceil(m*M/8),b=Math.ceil(k/4),y=new ArrayBuffer(4*b),x=new Uint8Array(y),x.set(new Uint8Array(t,r.ptr,k)),w=new Uint32Array(y),r.ptr+=k,U=f>=3?e.unstuffLUT2(I,g,v-1,i,A,D):e.unstuffLUT(I,g,v-1,i,A,D),f>=3?e.unstuff2(w,a,M,m,U):e.unstuff(w,a,M,m,U)}else r.counter.bitstuffer++,M=g,r.ptr+=l,M>0&&(k=Math.ceil(m*M/8),b=Math.ceil(k/4),y=new ArrayBuffer(4*b),x=new Uint8Array(y),x.set(new Uint8Array(t,r.ptr,k)),w=new Uint32Array(y),r.ptr+=k,f>=3?null==i?e.originalUnstuff2(w,a,M,m):e.unstuff2(w,a,M,m,!1,i,A,D):null==i?e.originalUnstuff(w,a,M,m):e.unstuff(w,a,M,m,!1,i,A,D))},readTiles:function(e,r,a){var i=r.headerInfo,n=i.width,s=i.height,f=i.microBlockSize,l=i.imageType,o=t.getDataTypeSize(l),u=Math.ceil(n/f),c=Math.ceil(s/f);r.pixels.numBlocksY=c,r.pixels.numBlocksX=u,r.pixels.ptr=0;var h,d,p,g,m,w,y,x,k,b=0,U=0,I=0,v=0,M=0,A=0,D=0,T=0,V=0,S=0,B=0,P=0,z=0,L=0,F=0,O=new a(f*f),C=s%f||f,H=n%f||f,E=i.numDims,_=r.pixels.resultMask,X=r.pixels.resultPixels;for(I=0;I<c;I++)for(M=I!==c-1?f:C,v=0;v<u;v++)for(A=v!==u-1?f:H,S=I*n*f+v*f,B=n-A,k=0;k<E;k++){if(E>1&&(X=new a(r.pixels.resultPixels.buffer,n*s*k*o,n*s)),D=e.byteLength-r.ptr,h=new DataView(e,r.ptr,Math.min(10,D)),d={},F=0,T=h.getUint8(0),F++,V=T>>6&255,(T>>2&15)!==(v*f>>3&15))throw"integrity issue";if((w=3&T)>3)throw r.ptr+=F,"Invalid block encoding ("+w+")";if(2!==w)if(0===w){if(r.counter.uncompressed++,r.ptr+=F,P=M*A*o,z=e.byteLength-r.ptr,P=P<z?P:z,p=new ArrayBuffer(P%o==0?P:P+o-P%o),g=new Uint8Array(p),g.set(new Uint8Array(e,r.ptr,P)),m=new a(p),L=0,_)for(b=0;b<M;b++){for(U=0;U<A;U++)_[S]&&(X[S]=m[L++]),S++;S+=B}else for(b=0;b<M;b++){for(U=0;U<A;U++)X[S++]=m[L++];S+=B}r.ptr+=L*o}else if(y=t.getDataTypeUsed(l,V),x=t.getOnePixel(d,F,y,h),F+=t.getDataTypeSize(y),3===w)if(r.ptr+=F,r.counter.constantoffset++,_)for(b=0;b<M;b++){for(U=0;U<A;U++)_[S]&&(X[S]=x),S++;S+=B}else for(b=0;b<M;b++){for(U=0;U<A;U++)X[S++]=x;S+=B}else if(r.ptr+=F,t.decodeBits(e,r,O,x,k),F=0,_)for(b=0;b<M;b++){for(U=0;U<A;U++)_[S]&&(X[S]=O[F++]),S++;S+=B}else for(b=0;b<M;b++){for(U=0;U<A;U++)X[S++]=O[F++];S+=B}else r.counter.constant++,r.ptr+=F}},formatFileInfo:function(e){return{fileIdentifierString:e.headerInfo.fileIdentifierString,fileVersion:e.headerInfo.fileVersion,imageType:e.headerInfo.imageType,height:e.headerInfo.height,width:e.headerInfo.width,numValidPixel:e.headerInfo.numValidPixel,microBlockSize:e.headerInfo.microBlockSize,blobSize:e.headerInfo.blobSize,maxZError:e.headerInfo.maxZError,pixelType:t.getPixelType(e.headerInfo.imageType),eofOffset:e.eofOffset,mask:e.mask?{numBytes:e.mask.numBytes}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,maxValue:e.headerInfo.zMax,minValue:e.headerInfo.zMin,noDataValue:e.noDataValue}}},constructConstantSurface:function(e){var t=e.headerInfo.zMax,r=e.headerInfo.numDims,a=e.headerInfo.height*e.headerInfo.width,i=a*r,n=0,s=0,f=0,l=e.pixels.resultMask;if(l)if(r>1)for(n=0;n<r;n++)for(f=n*a,s=0;s<a;s++)l[s]&&(e.pixels.resultPixels[f+s]=t);else for(s=0;s<a;s++)l[s]&&(e.pixels.resultPixels[s]=t);else if(e.pixels.resultPixels.fill)e.pixels.resultPixels.fill(t);else for(s=0;s<i;s++)e.pixels.resultPixels[s]=t},getDataTypeArray:function(e){var t;switch(e){case 0:t=Int8Array;break;case 1:t=Uint8Array;break;case 2:t=Int16Array;break;case 3:t=Uint16Array;break;case 4:t=Int32Array;break;case 5:t=Uint32Array;break;case 6:t=Float32Array;break;case 7:t=Float64Array;break;default:t=Float32Array}return t},getPixelType:function(e){var t;switch(e){case 0:t="S8";break;case 1:t="U8";break;case 2:t="S16";break;case 3:t="U16";break;case 4:t="S32";break;case 5:t="U32";break;case 6:t="F32";break;case 7:t="F64";break;default:t="F32"}return t},isValidPixelValue:function(e,t){if(null==t)return!1;var r;switch(e){case 0:r=t>=-128&&t<=127;break;case 1:r=t>=0&&t<=255;break;case 2:r=t>=-32768&&t<=32767;break;case 3:r=t>=0&&t<=65536;break;case 4:r=t>=-2147483648&&t<=2147483647;break;case 5:r=t>=0&&t<=4294967296;break;case 6:r=t>=-3.4027999387901484e38&&t<=3.4027999387901484e38;break;case 7:r=t>=5e-324&&t<=1.7976931348623157e308;break;default:r=!1}return r},getDataTypeSize:function(e){var t=0;switch(e){case 0:case 1:t=1;break;case 2:case 3:t=2;break;case 4:case 5:case 6:t=4;break;case 7:t=8;break;default:t=e}return t},getDataTypeUsed:function(e,t){var r=e;switch(e){case 2:case 4:r=e-t;break;case 3:case 5:r=e-2*t;break;case 6:r=0===t?e:1===t?2:1;break;case 7:r=0===t?e:e-2*t+1;break;default:r=e}return r},getOnePixel:function(e,t,r,a){var i=0;switch(r){case 0:i=a.getInt8(t);break;case 1:i=a.getUint8(t);break;case 2:i=a.getInt16(t,!0);break;case 3:i=a.getUint16(t,!0);break;case 4:i=a.getInt32(t,!0);break;case 5:i=a.getUInt32(t,!0);break;case 6:i=a.getFloat32(t,!0);break;case 7:i=a.getFloat64(t,!0);break;default:throw"the decoder does not understand this pixel type"}return i}},r=function(e,t,r){this.val=e,this.left=t,this.right=r};return{decode:function(e,r){r=r||{};var a=r.noDataValue,i=0,n={};if(n.ptr=r.inputOffset||0,n.pixels={},t.readHeaderInfo(e,n)){var s=n.headerInfo,f=s.fileVersion,l=t.getDataTypeArray(s.imageType);t.readMask(e,n),s.numValidPixel===s.width*s.height||n.pixels.resultMask||(n.pixels.resultMask=r.maskData);var o=s.width*s.height;if(n.pixels.resultPixels=new l(o*s.numDims),n.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0},0!==s.numValidPixel)if(s.zMax===s.zMin)t.constructConstantSurface(n);else if(f>=4&&t.checkMinMaxRanges(e,n))t.constructConstantSurface(n);else{var u=new DataView(e,n.ptr,2),c=u.getUint8(0);if(n.ptr++,c)t.readDataOneSweep(e,n,l);else if(f>1&&s.imageType<=1&&Math.abs(s.maxZError-.5)<1e-5){var h=u.getUint8(1);if(n.ptr++,n.encodeMode=h,h>2||f<4&&h>1)throw"Invalid Huffman flag "+h;h?t.readHuffman(e,n,l):t.readTiles(e,n,l)}else t.readTiles(e,n,l)}n.eofOffset=n.ptr;var d;r.inputOffset?(d=n.headerInfo.blobSize+r.inputOffset-n.ptr,Math.abs(d)>=1&&(n.eofOffset=r.inputOffset+n.headerInfo.blobSize)):(d=n.headerInfo.blobSize-n.ptr,Math.abs(d)>=1&&(n.eofOffset=n.headerInfo.blobSize));var p={width:s.width,height:s.height,pixelData:n.pixels.resultPixels,minValue:s.zMin,maxValue:s.zMax,validPixelCount:s.numValidPixel,dimCount:s.numDims,dimStats:{minValues:s.minValues,maxValues:s.maxValues},maskData:n.pixels.resultMask};if(n.pixels.resultMask&&t.isValidPixelValue(s.imageType,a)){var g=n.pixels.resultMask;for(i=0;i<o;i++)g[i]||(p.pixelData[i]=a);p.noDataValue=a}return n.noDataValue=a,r.returnFileInfo&&(p.fileInfo=t.formatFileInfo(n)),p}},getBandCount:function(e){var r=0,a=0,i={};for(i.ptr=0,i.pixels={};a<e.byteLength-58;)t.readHeaderInfo(e,i),a+=i.headerInfo.blobSize,r++,i.ptr=a;return r}}});