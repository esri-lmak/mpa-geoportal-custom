// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/has","dojo/string","dojo/_base/lang","dojo/_base/array","../../kernel","../../geometry/Point","../../geometry/Extent","../../SpatialReference","../../geometry/webMercatorUtils"],function(n,e,r,t,o,a,i,u,s){function l(n){var e=n.spatialReference;if(!e)return{x:n.x,y:n.y};var r,t=e.isWebMercator(),o=4326===e.wkid;return o?r={x:n.x,y:n.y}:t&&(r={x:n.getLongitude(),y:n.getLatitude()}),r}function x(n){var e,r=n.spatialReference,t=!(!r||!r.isWebMercator()),o=!(!r||4326!==r.wkid);return o?e=new i(n.toJson()):t&&(e=s.webMercatorToGeographic(n,!0)),e}function h(n,e){var r=u.prototype._info[4326];return e.x=a.prototype._normalizeX(n.x,r),e.y=n.y,e}function c(n){var r=I.decimals[n],t=r.toString(2);return e.pad(t,I.bitsPerBase32Char,"0")}function f(n){for(var e=[],r=0;r<n.length;r++)e.push(c(n[r]));return e.join("")}function g(n){for(var e=[],r=[],t=0;t<n.length;t++)t%2==0?e.push(n[t]):r.push(n[t]);return e=e.join(""),r=r.join(""),[e,r]}function m(n,e){var r;e=e.slice(),e.splice(1,0,0);for(var t=e[0],o=e[2],a=0;a<n.length;a++){Number(n[a])?e[0]=e[1]:e[2]=e[1],r=e[1]=(e[0]+e[2])/2,t=e[0],o=e[2]}return{value:r,min:t,max:o}}function v(n){var e=m(n[0],I.longitudeRange),r=m(n[1],I.latitudeRange);return{x:e.value,y:r.value,extent:{xmin:e.min,xmax:e.max,ymin:r.min,ymax:r.max}}}function y(n){var e=f(n),r=g(e),t=v(r);return{point:{x:t.x,y:t.y},extent:t.extent,geohash:n}}function p(n,e,r){var t=[];e=e.slice(),e.splice(1,0,0);for(var o=e[0],a=e[2],i=0;i<r;i++){var u;n>=e[1]?(e[0]=e[1],u=1):(e[2]=e[1],u=0),e[1]=(e[0]+e[2])/2,t.push(u),o=e[0],a=e[2]}return{value:t.join(""),min:o,max:a}}function b(n){var e,r,t=n*I.bitsPerBase32Char;return t%2==0?e=r=t/2:(e=(t+1)/2,r=t-e),{lon:e,lat:r}}function d(n,e){var r=b(e),t=p(n.x,I.longitudeRange,r.lon),o=p(n.y,I.latitudeRange,r.lat);return{x:t.value,y:o.value,extent:{xmin:t.min,xmax:t.max,ymin:o.min,ymax:o.max}}}function w(n,e){for(var r=[],t=n.length+e.length,o=Math.ceil(t/I.bitsPerBase32Char),a=0,i=0,u=0;u<o*I.bitsPerBase32Char;u++){var s=u%2==0?n[a++]:e[i++];null==s&&(s=0),r.push(s)}return r.join("")}function j(n){var e=0;n=n.split("").reverse().join("");for(var r=0;r<n.length;r++){e+=Number(n[r])*Math.pow(2,r)}return I.base32[e]}function T(n){for(var e=n.length,r=I.bitsPerBase32Char,t=e/r,o=[],a=0;a<t;a++){var i=n.substr(a*r,r);o.push(j(i))}return o.join("")}function z(n,e){var r=d(n,e),t=w(r.x,r.y),o=T(t);return{point:n,extent:r.extent,geohash:o}}function C(n,e){var r={x:n.xmin,y:n.ymin},t={x:n.xmin,y:n.ymax},o={x:n.xmax,y:n.ymin},a={x:n.xmax,y:n.ymax};return{sw:O.pointToGeohash(r,e),nw:O.pointToGeohash(t,e),se:O.pointToGeohash(o,e),ne:O.pointToGeohash(a,e)}}function M(n,e,r,t,o){var a,i=n;do{o[i]||(o[i]=!0,t.push(i)),(a=i===e)||(i=_(i,r))}while(!a)}function G(n,e,r,t){var o=C(n,e),a=[];M(o.sw,o.nw,"n",a,{});var i=[];M(o.se,o.ne,"n",i,{});for(var u=0;u<a.length;u++)M(a[u],i[u],"e",r,t)}function k(n,e,r){var t=O.geohashToCell(n.sw).extent,o=O.geohashToCell(n.ne).extent,a=null!=e?e:t.xmin,i=null!=r?r:o.xmax;return{xmin:a,ymin:t.ymin,xmax:i,ymax:o.ymax}}function R(n){return t.filter(n,function(n){return 180===n.xmax})[0]}function q(n){return t.filter(n,function(n){return-180===n.xmin})[0]}function P(n,e,r,t){var o=O.geographicToWebMercator(n),a=o.y+e,u=o.y-e,s=o.x+e,l=o.x-e,x={x:s,y:a},h={x:l,y:u},c=O.webMercatorToGeographic(x,!0),f=O.webMercatorToGeographic(h,!0),g=null!=r?r:f.x,m=null!=t?t:c.x;return new i(g,f.y,m,c.y)}function E(n,e,r,t){var o,a,u=C(n,e);"min"===t?a=180:"max"===t&&(o=-180);var s=k(u,o,a),l={x:s.xmin,y:s.ymin},x=P(l,r,o,a),h={x:s.xmax,y:s.ymax},c=P(h,r,o,a);return new i(x.xmin,x.ymin,c.xmax,c.ymax)}function L(n,e,r){var t,o,a=R(n),u=q(n),s=E(a,e,r,"min"),l=E(u,e,r,"max");return s.getWidth()+l.getWidth()>=360?(t=-180,o=180):(t=s.xmin,o=l.xmax),new i(t,s.ymin,o,s.ymax)}function W(n,e,r){var t,o=n,a=0;do{a++,(t=o===e)||(o=_(o,r))}while(!t);return a}function B(n,e){var r=C(n,e),t=W(r.nw,r.ne,"e");return{rows:W(r.nw,r.sw,"s"),cols:t}}function S(n,e,r){return n=h(n,{}),e=h(e,{}),O.pointToGeohash(n,r)===O.pointToGeohash(e,r)}function N(n,e){var r=R(n),t=q(n),o=B(r,e),a=B(t,e),i=o.rows,u=o.cols+a.cols;return S({x:r.xmin,y:r.ymax},{x:t.xmax,y:t.ymax},e)&&u--,{rows:i,cols:u}}function _(n,e){var r=n.length%2,t=n.slice(-1),o=I.decimals[t],a=n.slice(0,-1);return-1!=I.borders[e][r].indexOf(t)&&a&&(a=_(a,e)),a+I.neighbors[e][r][o]}var D="0123456789bcdefghjkmnpqrstuvwxyz",I={base32:D,decimals:function(){for(var n={},e=0;e<D.length;e++)n[D[e]]=e;return n}(),neighbors:{n:[null,"238967debc01fg45kmstqrwxuvhjyznp"],s:[null,"bc01fg45238967deuvhjyznpkmstqrwx"],e:[null,"14365h7k9dcfesgujnmqp0r2twvyx8zb"],w:[null,"p0r21436x8zb9dcf5h7kjnmqesgutwvy"]},borders:{n:[null,"bcfguvyz"],s:[null,"0145hjnp"],e:[null,"prxz"],w:[null,"028b"]},bitsPerBase32Char:5,maxGeohashLength:12,longitudeRange:[-180,180],latitudeRange:[-90,90]};I.neighbors.n[0]="14365h7k9dcfesgujnmqp0r2twvyx8zb",I.neighbors.s[0]="p0r21436x8zb9dcf5h7kjnmqesgutwvy",I.neighbors.e[0]="238967debc01fg45kmstqrwxuvhjyznp",I.neighbors.w[0]="bc01fg45238967deuvhjyznpkmstqrwx",I.borders.n[0]="prxz",I.borders.s[0]="028b",I.borders.e[0]="bcfguvyz",I.borders.w[0]="0145hjnp";var O={geographicToWebMercator:function(n){var e=a.lngLatToXY(n.x,n.y);return{x:e[0],y:e[1]}},webMercatorToGeographic:function(n,e){var r=a.xyToLngLat(n.x,n.y,e);return{x:r[0],y:r[1]}},geohashToCell:function(n){return y(n)},pointToCell:function(n,e){e=e||I.maxGeohashLength;var r=l(n);if(r)return r=h(r,r),z(r,e)},geohashToPoint:function(n){return O.geohashToCell(n).point},pointToGeohash:function(n,e){var r=O.pointToCell(n,e);return r&&r.geohash},getCells:function(n){return t.map(n,function(n){return O.geohashToCell(n)})},getCellSize:function(n){n=n||1;var e=I.longitudeRange,r=I.latitudeRange,t=Math.abs(e[1]-e[0]),o=Math.abs(r[1]-r[0]),a=b(n);return{width:t/Math.pow(2,a.lon),height:o/Math.pow(2,a.lat)}},getCellSizeInMeters:function(n){var e=O.getCellSize(n),r=s.metersPerDegree;return e.width*=r,e.height*=r,e},getIntersecting:function(n,e,r){e=e||1,r=r||0;var o=[],a=x(n);if(a){r&&(a=O.expandExtent(n,e,r));var i=a.normalize(),u={};t.forEach(i,function(n){G(n,e,o,u)})}return o},countIntersecting:function(n,e,r){e=e||1,r=r||0;var t=0,o=x(n);if(o){r&&(o=O.expandExtent(n,e,r));var a,i=o.normalize();2===i.length?(a=N(i,e),t=a.cols*a.rows):(a=B(i[0],e),t=a.cols*a.rows)}return t},getChildren:function(n){n=n||"";var e=[];for(var r in I.decimals)e.push(n+r);return e},getNeighbors:function(n){var e=_(n,"n"),r=_(n,"s");return[e,_(e,"e"),_(e,"w"),r,_(r,"e"),_(r,"w"),_(n,"e"),_(n,"w")]},getExtentFromDistance:function(n,e){e=e||1e3;var r,t=l(n);return t&&(r=P(t,e)),r},expandExtent:function(n,e,r){e=e||1,r=r||0;var t=x(n);if(t){if(r){var o=t.normalize();return 2===o.length?L(o,e,r):E(o[0],e,r)}return t}},getNeighborsWithinDistance:function(n,e,r){r=r||1e3,e=e||1;var o=[],a=l(n);if(a){var i=P(a,r),u=i.normalize(),s={};t.forEach(u,function(n){G(n,e,o,s)})}return o}};return n("extend-esri")&&r.setObject("layers.clustering.geohashUtils",O,o),O});