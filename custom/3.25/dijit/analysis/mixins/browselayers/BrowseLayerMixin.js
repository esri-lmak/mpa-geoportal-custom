// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/query","../../../../kernel","../../../../request","../../../../arcgis/Portal","../../../../SpatialReference","../../ProjectExtent","dojo/Deferred","../../ItemTypes","../../utils","./configs/AGOLBrowseItem","./configs/EnterpriseBrowseItem","dojo/i18n!../../nls/BrowseLayerMixin"],function(e,t,i,s,o,r,a,n,l,h,c,m,d,u,p){var y=e([],{tableSupportedTools:["JoinFeatures","SummarizeAttributes","ExtractData","GeocodeLocationsfromTable","CopyToDataStore","AppendData","CalculateField","MergeLayers","DescribeDataset","DetectIncidents"],allowedItemTypes:[],defaultItemTypes:[c.MS,c.FS],availableItemTypeFilters:["layers","featureLayers"],_createBrowseItems:function(e,t,i){var s=e||{},o=s.browseValue||{},r=t||{},a=this.defaultItemTypes.concat(this.get("allowedItemTypes"));if(this.useArcGISComponents)this.setUpItemBrowser(s,r,i).then(function(){this.map&&this._chopExtentAtDateLine(this.map.extent).then(this._projectExtentAndDispatch.bind(this))}.bind(this));else{var n,l=[];a.forEach(function(e){l.push('type:"'+e+'"')}),"browse"===o?(n=this._browsedlg.browseItems.get("query"),n.custom=this._queryTagsForLivingAtlasBrowseItems(r),this._browsedlg.browseItems.set("extent",this.get("map").extent),this._browsedlg.browseItems.set("query",n),this._browsedlg.show()):(this.showGeoAnalyticsParams&&l.push('type:"'+c.BIGDATA+'"'),n=this._browseLyrsdlg.browseItems.get("query"),n.types=l,this._browseLyrsdlg.browseItems.set("query",n),r.geometryTypes?(this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!0,r.geometryTypes.length>0&&(this._browseLyrsdlg.browseItems.plugIn.geometryTypes=r.geometryTypes)):this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,r.layerTypes?(this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0,r.layerTypes.length>0&&(this._browseLyrsdlg.browseItems.plugIn.layerTypes=r.layerTypes)):this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!1,r.customCheck?(this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=r.customCheck.customCheckHandler,this._browseLyrsdlg.browseItems.plugIn.customCheckFailureMessage=r.customCheck.customCheckFailureMessage):this._browseLyrsdlg.browseItems.plugIn.customCheckHandler=void 0,this._browseLyrsdlg.show())}},setUpItemBrowser:function(e,i,s){var o=new h;return window.require(["arcgis-components/wrappers/ItemBrowser","esri/arcgis/Portal"],function(a,n){if(!this.ib){var l=document.createElement("div");!e.isDialog&&document.body.appendChild(l);var h=new n.Portal(this.portalSelf&&this.portalSelf.urlKey&&this.portalSelf.customBaseUrl?location.protocol+"//"+this.portalSelf.urlKey+"."+this.portalSelf.customBaseUrl+"/sharing/rest":(this.portalSelf&&this.portalSelf.portalHostname?location.protocol+"//"+this.portalSelf.portalHostname:this.portalUrl)+"/sharing/rest"),m=this.defaultItemTypes.concat(this.get("allowedItemTypes")),p=function(){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this._resetSelectBox(s),!e.isDialog&&this._removeDOMfromBody(l)},y=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),t[0]&&t[0].type===c.RFT?this.onSelectRFTTool.bind(this)(t[0],h):this.onBrowseItemSelect.bind(this)(t[0],h),!e.isDialog&&this._removeDOMfromBody(l)},g=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this.onSelectGPTool.bind(this)(t),!e.isDialog&&this._removeDOMfromBody(l)},b=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this.onEditRFTTool.bind(this)(t,h),!e.isDialog&&this._removeDOMfromBody(l)},w=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),this.onBrowseItemSelect.bind(this)(t,h),!e.isDialog&&this._removeDOMfromBody(l)},f=function(t){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),e.isDialog&&this._closeDialog(),t&&t.type===c.RFT?this.onEditRFTTool.bind(this)(t,h):this.onBrowseItemSelect.bind(this)(t,h,!0),!e.isDialog&&this._removeDOMfromBody(l)};this.tableSupportedTools.indexOf(this.helpFileName)>-1&&(m=m.concat([this.showGeoAnalyticsParams?c.TABLE:c.BTABLE])),h.signIn().then(function(){this._fetchGroupForRFT(h).then(function(s){m.indexOf(c.IS)>-1?this.availableItemTypeFilters=["layers","featureLayers","mapImageLayers","imageryLayers"]:-1===m.indexOf(c.GPSERVICE)&&-1===m.indexOf(c.RFT)&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["layers","featureLayers"])),this.tableSupportedTools.indexOf(this.helpFileName)>-1&&(this.availableItemTypeFilters=this.availableItemTypeFilters.concat(["tables"]));var n={allowedItemTypes:this.showGeoAnalyticsParams?[c.BIGDATA].concat(m):m,availableItemTypeFilters:this.showGeoAnalyticsParams?this.availableItemTypeFilters.concat(["bigDataFileShares"]):this.availableItemTypeFilters,customQueryTags:i,portal:h,isPortal:this.isSingleTenant,onSelectSubLayer:w.bind(this),onActionSubLayer:f.bind(this),onSelectGPTool:g.bind(this),onEditRFT:b.bind(this),rftGroupId:s,disableLAAL:e.disableLAAL,disableBoundary:e.disableBoundary,title:e.title,disabledSubResources:this._getDisableResources(e.disabledSubResources)},T=t.mixin(a.initialState.settings.config,this.isSingleTenant?u.getConfig(n):d.getConfig(n));this.ib=new a.ItemBrowserWrapper(l,{apiVersion:3,portal:h,request:r,initialState:t.mixin(a.initialState,{settings:t.mixin(a.initialState.settings,{config:t.mixin(T,{onBack:p.bind(this),onSelect:y.bind(this)})}),ui:t.mixin(a.initialState.ui,{expanded:t.mixin(a.initialState.ui.expanded,{filters:!0})})}),parameters:t.mixin(a.initialState.parameters,{section:"myContent",filter:t.mixin(a.initialState.parameters.filter,{searchMapArea:!1})})}),e.isDialog&&this._createDialog(l,h),o.resolve()}.bind(this))}.bind(this))}}.bind(this)),o},_queryTagsForLivingAtlasBrowseItems:function(e){var t=e&&e.tags;if(t&&0!==t.length)return 1===t.length?['tags:"'+t[0]+'"']:(s=[],t.forEach(function(e){s.push('tags:"'+e+'"')}),s)},onBrowseItemSelect:function(e,t,i){var s={selection:this._getPortalItem(e,t),dialog:this._browseLyrsdlg||this._browsedlg};this._handleBrowseItemsSelect(s,i)},onSelectGPTool:function(e){e.resource.url=e.url,this._handleSelectGpTool(e.resource)},onSelectRFTTool:function(e,t){this._handleSelectRFTTool(this._getPortalItem(e,t))},onEditRFTTool:function(e,t){this._handleEditRFTTool(this._getPortalItem(e,t))},_getPortalItem:function(e,i){var s;return e.resource&&e.item?(s=new a.PortalItem(t.mixin(e.item,{portal:i})),s.selectedLayer=e.resource,s.selectedLayer.url=e.url):(s=new a.PortalItem(t.mixin(e,{portal:i})),e.type&&[c.CSV,c.XLS].indexOf(e.type)>-1&&(s.selectedLayer=s)),s},_createDialog:function(e,t){window.require(["dijit/Dialog","esri/dijit/analysis/mixins/browselayers/configs/Common"],function(t,i){this.itemBrowserDialog||(this.itemBrowserDialog=new t({style:"width: 900px; height:900px; overflow: auto",id:"itemBrowserDialog",closable:!1,title:p.customAnalysisLayerTitle})),this.itemBrowserDialog.set("content",e),this.itemBrowserDialog.show()}.bind(this))},_closeDialog:function(){this.itemBrowserDialog.hide(),this.itemBrowserDialog.destroy(),delete this.itemBrowserDialog,delete this.ib},_setAllowedItemTypesAttr:function(e){this.allowedItemTypes=e},_setAvailableItemTypeFiltersAttr:function(e){this.availableItemTypeFilters=e},_getDisableResources:function(e){var t={};return e&&e.length&&e.forEach(function(e){e&&e.url&&(t[e.url]=!0)},this),t},_projectExtentAndDispatch:function(e){this.sr||(this.sr=new n(4326)),l(e,this.sr,function(e){var t=e[0];this._dispatchExtentToItemBrowser(t)}.bind(this),function(e){console.error(e)}.bind(this))},_chopExtentAtDateLine:function(e){var t=new h;return window.esri.geometry.normalizeCentralMeridian([e],null,function(i){if(i[0].rings){var s=new window.esri.geometry.Polygon(e.spatialReference).addRing(i[0].rings[0]).getExtent(),o=new window.esri.geometry.Polygon(e.spatialReference).addRing(i[0].rings[1]).getExtent();t.resolve(s.getWidth()>o.getWidth()?s:o)}else t.resolve(i[0])},function(e){t.reject(e)}),t},_dispatchExtentToItemBrowser:function(e){window.require(["arcgis-components/wrappers/ItemBrowser"],function(t){this.ib.dispatch(t.updateExtent({minx:e.xmin,miny:e.ymin,maxx:e.xmax,maxy:e.ymax}))}.bind(this))},_fetchGroupForRFT:function(e){var t=new h;return-1===this.allowedItemTypes.indexOf(c.RFT)&&t.resolve(),this._systemRFTsGroup&&t.resolve(this._systemRFTsGroup),m.fetchGroupForRFT(e).then(function(e){this._systemRFTsGroup=e,t.resolve(e)}.bind(this)),t},_removeDOMfromBody:function(e){setTimeout(function(){document.body.removeChild(e)},300),delete this.ib},_resetSelectBox:function(e){e&&e.reset()}});return i("extend-esri")&&t.setObject("dijit.analysis.mixins.browselayers.BrowseLayerMixin",y,o),y});