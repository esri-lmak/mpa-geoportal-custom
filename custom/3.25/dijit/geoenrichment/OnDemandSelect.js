// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/store/Memory","dijit/_WidgetBase","dijit/_TemplatedMixin","./lists/FlowList","./lists/_FlowListHoverSupport","./utils/DeviceUtil","./utils/DomUtil","./utils/MouseUtil","./utils/PopupUtil","dojo/text!./templates/OnDemandSelect.html"],function(e,t,o,s,i,n,r,l,p,u,h,a,c,d,m,_){var v=e([u,h]),P={_currentSelect:null,_keyHandler:null,_mouseMoveHandler:null,setFocusedSelect:function(e){this._currentSelect=e,this._updateHandlers()},_updateHandlers:function(){var e=this;this._keyHandler&&this._keyHandler.remove(),this._keyHandler=null,this._mouseMoveHandler&&this._mouseMoveHandler.remove(),this._mouseMoveHandler=null,this._currentItemIndex=-1,this._currentSearchLetter=null,this._setNodeFocused(null),this._currentSelect&&(this._keyHandler=t(document.body,"keyup",function(t){var o=String.fromCharCode(t.keyCode);1===o.length&&(o=o.toLowerCase(),e._tryHighlightNextItemForKey(o))}),this._mouseMoveHandler=t(this._currentSelect.popupList.domNode,"mousemove",function(){e._setNodeFocused(null)}))},_currentItemIndex:-1,_currentSearchLetter:null,_tryHighlightNextItemForKey:function(e){e===this._currentSearchLetter?this._currentItemIndex++:this._currentItemIndex=0,this._currentSearchLetter=e;var t=this,o=this._currentSelect.store.query(function(o){var s=o[t._currentSelect.labelProperty];return s&&s.toLowerCase().charAt(0)===e});if(o.length){this._currentItemIndex>o.length-1&&(this._currentItemIndex=0);var s=o[this._currentItemIndex],i=s&&this._currentSelect.popupList.getItemNode(s);s&&this._currentSelect.popupList.scrollToItem(s),this._setNodeFocused(i)}},_currentFocusedNode:null,_setNodeFocused:function(e){this._currentFocusedNode&&(s.remove(this._currentFocusedNode,"listItemFocused"),this._currentFocusedNode=null),e&&(s.add(e,"listItemFocused"),this._currentFocusedNode=e)}},L=e([l,p],{templateString:_,value:null,popupList:null,listClass:null,placeHolderClass:"placeHolder",idProperty:"value",labelProperty:"label",options:null,store:null,itemRenderer:null,itemClass:null,placeHolder:null,requireSelection:!0,renderSelectionAsItem:!1,makePopupListWidthMatchOpenButtonWidth:!0,orient:null,noPopupOverflow:!1,stopOpenEventPropagation:!1,stopPopupInteractionEventPropagation:!0,onClickComponent:null,clearPopupOnClose:!0,detectItemHover:!1,hasSelectableItems:!0,allowRepetitiveSelection:!0,labelTextToKeep:null,nodeToKeepAsSelected:null,openMouseEvent:null,toggleOnClick:!0,supportsKeyNavigation:!0,_closePopupOnChangeFunc:null,_lastPopupListScrollTop:0,postCreate:function(){var e=this;this.inherited(arguments),this._normalizeValue(),this.labelTextToKeep?this.selectedLabel.innerHTML=this.labelTextToKeep:this.requireSelection||this._tryAssignPlaceholder(),this.nodeToKeepAsSelected?this._updateSelection():c.hide(this.selectedItemHolder),this._createPopupList(),this.own(this.popupList),this.listClass&&s.add(this.popupList.domNode,this.listClass),this._popupCreationHandler=t(this.openButton,this.openMouseEvent||a.click,function(t){e.stopOpenEventPropagation&&("function"==typeof e.stopOpenEventPropagation?e.stopOpenEventPropagation(t):t.stopPropagation()),e.openPopup()}),this.popupList.startup(),this._trySelectValue(),t(this.popupList.domNode,a.clickOrRelease,function(t){e.stopPopupInteractionEventPropagation&&t.stopPropagation()}),t(this.popupList.domNode,"scroll",function(t){e._lastPopupListScrollTop=e.popupList.domNode.scrollTop})},_createPopupList:function(){var e=this,t=this.itemRenderer||new u.itemRenderers.DefaultItemRenderer;this.popupList=new(this.detectItemHover?v:u)({class:"esriGEOnDemandSelectFlowList",idProperty:this.idProperty,labelProperty:this.labelProperty,itemRenderer:t,itemClass:this.itemClass,stopMouseEventPropagation:this.stopPopupInteractionEventPropagation,hasSelectableItems:this.hasSelectableItems,allowRepetitiveSelection:this.allowRepetitiveSelection,onChange:function(){e._processOnChangeEvent()},onItemHovered:function(t){e.onItemHovered(t)}})},_processOnChangeEvent:function(){if(this.popupList.selectedItem){var e=this.value;this.value=this.popupList.selectedItem[this.idProperty],this._updateSelection(),this.onChange&&this.onChange({type:"change",value:this.value,previousValue:e})}(!this._closePopupOnChangeFunc||this._closePopupOnChangeFunc(this.value))&&m.close(this.popupList)},_makePopup:function(){if(this._popupCreationHandler){this._popupCreationHandler.remove(),delete this._popupCreationHandler;var e=this;m.makePopup(this.popupList,this,this.openButton,{openMouseEvent:this.openMouseEvent,stopEventPropagation:this.stopOpenEventPropagation,toggleOnClick:this.toggleOnClick,wrapperClass:this.listClass?this.listClass.split(" ").map(function(e){return e+"Popup"}).join(" "):null,orient:this.orient,allowAutoOrientation:this.allowAutoOrientation,noOverflow:this.noPopupOverflow,onClickComponent:this.onClickComponent,onPreShow:function(){e.onPopupListPreBuild(),e.makePopupListWidthMatchOpenButtonWidth&&i.set(e.popupList.domNode,"minWidth",n.getContentBox(e.domNode).w+"px"),e._updatePopupListStore(),e.onPopupPreOpened()},onShow:function(){e.onPopupOpened(),P.setFocusedSelect(e)},onClose:function(){e.onPopupClosed(),P.setFocusedSelect(null),e.clearPopupOnClose&&e._clearPopup()},isMouseOver:function(){return e.isMouseOverList()}})}},_clearPopup:function(){this.popupList&&this.popupList.clear&&this.popupList.clear()},_tryAssignPlaceholder:function(){return this.placeHolder&&null===this.value?(this.selectedLabel.innerHTML=this.placeHolder,s.add(this.selectedLabel,this.placeHolderClass),!0):(s.remove(this.selectedLabel,this.placeHolderClass),!1)},_normalizeValue:function(){if(null!==this.value){if(void 0===this.value)return void(this.value=null);"string"==typeof this.value&&(this.value=this.value.trim()),String(this.value)||(this.value=null)}},_trySelectValue:function(){var e=this;if(null!==this.value&&this._setValueAttr(this.value,!0));else if(this.requireSelection){var t=this.store&&this.store.query();t&&t.length&&(this.value&&t.some(function(t){return e.value===t[e.idProperty]})?this._setValueAttr(this.value,!0):this._setValueAttr(t[0][this.idProperty],!0))}},_setValueAttr:function(e,t){if(this.value=e,this._normalizeValue(),!this.store||!this.popupList)return!1;var o=this,s=this.store.query(function(e){return e[o.idProperty]===o.value})[0];return s&&this.popupList.setSelectedItem(s),this._updateSelection(s),!!s},_setOptionsAttr:function(e){this.options=e,this.store=this._createStore(e),this._updatePopupListStore(),this._trySelectValue()},_setStoreAttr:function(e){this.store=this._createStore(e),this.options=this.store&&this.store.query(),e.idProperty&&(this.idProperty=e.idProperty),this._updatePopupListStore(),this._trySelectValue()},_createStore:function(e){return e instanceof Array?new r({data:e,idProperty:this.idProperty}):e},_updatePopupListStore:function(){this.popupList&&(this.popupList.store&&this.popupList.store===this.store&&!this.clearPopupOnClose||this.popupList.setStore(this.store,!0),this.popupList.setSelectedItem(this.getSelectedItem()),this._lastPopupListScrollTop&&(this.popupList.domNode.scrollTop=this._lastPopupListScrollTop))},getSelectedItem:function(){if(!this.store)return null;var e=this.get("value"),t=this;return void 0!==e&&this.store.query(function(o){return o[t.idProperty]===e})[0]},setSelectedItem:function(e){this.store&&this.popupList&&e&&this._setValueAttr(e[this.idProperty],!0)},getSelectedIndex:function(){var e=this,t=-1;if(this.store){var o=this.get("value");void 0!==o&&this.store.query().some(function(s,i){if(s[e.idProperty]==o)return t=i,!0})}return t},setSelectedIndex:function(e){var t=this.store&&this.store.data[e];this.setSelectedItem(t)},_nodeToKeepAsSelectedPlacedFlag:!1,_updateSelection:function(e){e=e||this.getSelectedItem(),this.nodeToKeepAsSelected?this._nodeToKeepAsSelectedPlacedFlag||(c.hide(this.selectedLabel),c.show(this.selectedItemHolder),o.empty(this.selectedItemHolder),o.place(this.nodeToKeepAsSelected,this.selectedItemHolder),this._nodeToKeepAsSelectedPlacedFlag=!0):this.renderSelectionAsItem?(c.hide(this.selectedLabel),c.show(this.selectedItemHolder),o.empty(this.selectedItemHolder),e&&this.popupList.itemRenderer.createPresentation(e,!1,this.selectedItemHolder,this.popupList)):(c.hide(this.selectedItemHolder),this.labelTextToKeep?this.selectedLabel.innerHTML=this.labelTextToKeep:(this.selectedLabel.innerHTML=e?e[this.labelProperty]:"",this.selectedLabel.innerHTML&&s.remove(this.selectedLabel,this.placeHolderClass),c[this.selectedLabel.innerHTML||this._tryAssignPlaceholder()?"show":"hide"](this.selectedLabel)))},refresh:function(){this.popupList.refresh(),this._updateSelection()},isPopupOpen:function(){return m.isOpen(this.popupList)},openPopup:function(){this.isPopupOpen()||(this._makePopup(),m.open(this.popupList))},closePopup:function(){this._popupCreationHandler||m.close(this.popupList)},refreshPopup:function(){this.isPopupOpen()&&m.refresh(this.popupList)},isMouseOver:function(){return d.isMouseOver(this.domNode)||this.isMouseOverList()},isMouseOverList:function(){return this.popupList&&d.isMouseOver(this.popupList.domNode)},onPopupListPreBuild:function(){},onPopupPreOpened:function(){},onPopupOpened:function(){},onPopupClosed:function(){},onChange:function(e){},onItemHovered:function(e){},destroy:function(){this._popupCreationHandler&&this._popupCreationHandler.remove(),this.closePopup(this.popupList),this.popupList.destroy(),this.inherited(arguments)}});return L.itemRenderers=u.itemRenderers,L});