// COPYRIGHT © 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","./tasks/EnrichAreasTask","./tasks/RunReportTask","./AreaDataUtil","./AreaCalculatorsUtil","./CustomReportsManager","./VariablesUtil","esri/dijit/geoenrichment/utils/DateUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldLibrary","../../core/infographics/simpleInfographic/dataDrilling/EnrichUtil","../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil","../../core/infographics/utils/InfographicJsonUtil"],function(e,a,r,t,n,i,o,s,l,u,c,f,d,p){return{populateReportDataFromAttachmentsStore:function(r,t){var n=[];return t.setCurrentAnalysisAreaIndex&&t.setCurrentAnalysisAreaIndex(0),n.push(e(t.getNotes(),function(e){e&&e.length&&(r.fieldData.metadata[c.SITENOTE_FIELD_NAME]=e[0].text,r.fieldData.metadata[c.SITENOTES_FIELD_NAME]=e.map(function(e){return e.text}).join("<br/><br/>"))})),n.push(e(t.getAttributes(),function(e){if(!e||!e.length)return null;var a={attributes:{}};e.forEach(function(e){a.attributes[e.name]=e}),r.analysisAreas.forEach(function(e,t){var n=r.fieldData.areaData[t];n&&o.addFeatureAttributesCalculator(a,n)})})),a(n)},runReportAndGetData:function(a){return e(s.getCustomReportByID(a),function(e){function t(e){return a.fieldData.errors.push(e),(new r).reject(e)}return(new n).execute({portalUrl:a.portalUrl,analysisAreas:a.analysisAreas,combinedAreasInfo:a.combinedAreasInfo,countryID:a.countryID,hierarchy:a.hierarchy,report:{reportID:e.reportID,portalUrl:e.templateData.getPortalUrl(!0),modified:e.modified,isMultiFeature:e.isMultiFeature},cacheResult:!0}).then(function(a){return{taskID:a.taskID,selectedReport:e,areaData:a.areaData}},t)})},runReportFromVariables:function(e){function a(a){return e.fieldData.errors.push(a),(new r).reject(a)}var n={};return e.variables.fullNames.forEach(function(e){var a=d.createFieldNameFromVariable(e);n[e.substr(e.indexOf(".")+1)]=a}),(new t).enrichAreas({portalUrl:e.portalUrl,analysisAreas:e.analysisAreas,countryID:e.countryID,hierarchy:e.hierarchy,fields:l.convertForEnrich(e.variables),comparisonLevels:e.comparisonLevels||p.getDefaultLevels()}).then(function(a){var r=e.analysisAreas.map(function(){return{}});return o.addEnrichFeatures(a,n,d.DATA_COLLECTIONS_CALCULATOR_NAME,r),{areaData:r}},a)},applyRunReportAndGetDataResults:function(e,a){e&&e.areaData&&(a.fieldData.runReportTaskID=e.taskID,a.fieldData.areaData=e.areaData,a.analysisAreas&&this._reportDataFromAreas(a.analysisAreas,a.fieldData.areaData),e.selectedReport&&this._reportDataFromReport(e.selectedReport,a.fieldData,a.combinedAreasInfo))},_reportDataFromAreas:function(e,a){e.forEach(function(e,r){var t=e.feature,n=a[r];n&&(o.addFeatureAttributesCalculator(t,n),o.addAreaInfoCalculator(e,n))})},_reportDataFromReport:function(e,a,r){var t=a.metadata;e&&!t.Title&&(t.Title=e.title),t.Source="Esri",t.Date=u.getReportFooterDate(),t.Copyright="©"+u.getFullYear()+" Esri",t.ProductLabel="",t.ProductUrl="",t.PhoneNumber="",t.TrialUrlText="",e.isMultiFeature&&(t.SITE_NAME=r.locationName||r.name,t.STORE_NAME=r.locationName||r.name,t.AREA_DESC2=r.description||r.name,t.STORE_ADDR=r.address)},enrichFieldData:function(r,n){function l(e,a,r){function t(e){return n.fieldData.areaData.every(function(a,t){return void 0!==i.getAreaDataValue({fieldName:e,fieldData:n.fieldData,calculatorName:r,featureIndex:t,ignoreMetadata:!0})})}r=r||d.ENRICHED_DATA_NO_LEVELS;var o=[],s={};return e.forEach(function(e){t(e.fieldName)||(o.push(e.mapTo),s[e.mapTo]=e.fieldName,s[e.mapTo.substr(e.mapTo.indexOf(".")+1)]=e.fieldName)}),o.length?{fields:o,fieldsMap:s,comparisonLevels:a,calculatorName:r}:null}var u=[];if(r=f.optimizeInfos(r),r.forEach(function(e){var a;(e.isGeneral||e.isChart)&&(a=l(e.fields,e.levels,e.calculatorName)),a&&u.push(a)}),u.length)return e(s.getCustomReportByID(n),function(e){function r(e){n.fieldData.errors.push(e)}return a(u.map(function(e){return(new t).enrichAreas({portalUrl:n.portalUrl,analysisAreas:n.analysisAreas,countryID:n.countryID,hierarchy:n.hierarchy,fields:e.fields,comparisonLevels:e.comparisonLevels}).then(function(a){o.addEnrichFeatures(a,e.fieldsMap,e.calculatorName,n.fieldData.areaData)},r)}))})}}});