// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","dojo/on","dojo/keys","dojo/dom-class","dijit/_WidgetBase","dijit/_TemplatedMixin","./config","./playerSupports/_CommandSupport","./playerSupports/_LogoSupport","./playerSupports/_MapSupport","./playerSupports/_PageNavigationSupport","./playerSupports/_PrintSupport","./playerSupports/_ReportContainersSwitcher","./playerSupports/_SmartLayoutSupport","./playerSupports/_ZoomSupport","./playerSupports/_WaitingSupport","./supportClasses/PlayerConfigurator","./supportClasses/PlayerToFullScreenAnimator","./PlayerToolbar","./ReportPlayerViewModel","./PlayerResizeModes","./PlayerThemes","./ReportPlayerState","./DataProviderGE","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/InvokeUtil","esri/dijit/geoenrichment/utils/async/AsyncQueue","dojo/text!./templates/ReportPlayer.html","dojo/i18n!esri/nls/jsapi","./_devConfig"],function(e,t,r,i,o,n,a,s,l,h,p,d,u,_,g,c,f,m,y,D,C,w,v,P,A,S,R,T,b,M,I,E,F,z,j,x){return j=j.geoenrichment.dijit.ReportPlayer.ReportPlayer,e([l,h,d,u,_,c,f,m,y,g,D],{templateString:z,nls:j,dataProvider:null,exportCommands:null,config:null,theme:void 0,viewMode:void 0,enableDataDrilling:void 0,showDataDrillingInsidePanel:void 0,showToolbarInPopup:void 0,showAreaTitle:void 0,scaleSlidesToFitWindow:void 0,showCloseButton:!1,showToFullScreenAnimation:!1,allowAutoOrientation:!0,mobileLandscapeViewMode:void 0,resizeMode:void 0,isPlayerOnServer:!1,printConfig:{subtitle:j.preparedByEsri,printDialogClass:"esri/dijit/geoenrichment/ReportPlayer/printing/PageOptionsDialog/PageOptionsDialog"},showProgressBar:!0,defaultZoomBehavior:void 0,isDataDrillingPlayer:!1,_viewModel:null,_reportData:null,_analysisAreaIndex:0,playerToolbar:null,postCreate:function(){this.config=t.mixin(p,this.config),this._viewModel=new(this._getViewModelClass()),this._setUpDataProvider(),C.configurePlayer(this),this._initToolbar(),this._initContainerSwither(),this._initSmartLayout(),this._initCommands(),this._initPageNavigationControls(),this._initZoomControls(),this._applyTheme(),this._showError(!1),this._initProgressController(),M.isMobileDevice()&&(s.add(this.domNode,"esriGEReportPlayerMobile"),this._setUpMobileOrientationHandling())},_setUpDataProvider:function(){this.dataProvider=this.dataProvider||new T,this.exportCommands&&this.exportCommands.forEach(function(e){this.dataProvider.registerCommand(e)},this)},_orientationDfd:null,_setUpMobileOrientationHandling:function(){var e=this;this.allowAutoOrientation&&this.own(n(window,"orientationchange",function(){e._orientationDfd&&e._orientationDfd.resolve("cancel");var t=e._orientationDfd=new i;e._showWaiting(t.promise),t.promise.then(function(t){"cancel"!==t&&(C.configurePlayer(e),e._refreshZoomControls(),e.refresh())}),o(e.getRenderPromise(),function(){b.delay(500).then(t.resolve,t.resolve)})}))},_getViewModelClass:function(){return P},_initToolbar:function(){var e=this;this.playerToolbar=new v({popupButtonDiv:this.playerAfterToolbarDiv,showToolbarInPopup:this.showToolbarInPopup,showAreaTitle:this.showAreaTitle,stretchToolbarNode:!this.showToolbarInPopup&&(this.resizeMode===A.FIT_WINDOW?document.body:this.domNode),showCloseButton:this.showCloseButton,isMobileDevice:M.isMobileDevice(),isScrollShown:function(){var t=e.getCurrentReportContainer();return t&&t.isScrollShown&&t.isScrollShown()},onClose:function(){e._onClose()}}).placeAt(this.playerToolbarDiv),this.own(this.playerToolbar),this.playerToolbar.onShowAnalysisAreaAt=function(t){e.showAnalysisAreaAt(t)},this.showCloseButton&&this.own(n(window,"keyup",function(t){e.getWaitingPromise()||R.isViewingDataDrillingZoom||t.keyCode===a.ESCAPE&&e._onClose()})),I.hide(this.playerToolbarDiv)},_applyTheme:function(){s.remove(this.domNode,"playerThemeDark playerThemeLight"),s.add(this.domNode,this.theme===S.DARK?"playerThemeDark":"playerThemeLight"),this.playerToolbar.setTheme(this.theme)},playReport:function(e,t){return this._callAfterRendering("_doPlayReport",[e,t])},_doPlayReport:function(e,t){this.playerToolbar.closePopup();var r=this;return this._showError(!1),this._progressController&&this._progressController.reset(),this.showToFullScreenAnimation&&this.resizeMode===A.FIT_WINDOW&&w.animateTo(this),this.dataProvider._onCreateReportStarted=function(){r._viewModel.preInitialize()},this._viewModel.reset(),this._showWaiting(o(this.dataProvider.getReportData(e,{progressCallback:function(e){r._progressController&&r._progressController.setLoadDataProgress(e)}}),function(e){return r.setReportData(e,t)},function(e){r._showError(e)}))},_isDataBeingSetFlag:!1,setReportData:function(e,t){return this._callAfterRendering("_doSetReportData",[e,t])},_doSetReportData:function(e,t){var r=this;if(t=t||{},this._reportData=e,I.show(this.playerToolbarDiv),!e)return void this._showError(!0);this._isDataBeingSetFlag=!0,R.isAnimationSuspended=!0,this.onSetReportDataStart();var o=new i;this._viewModel.animationAllowed=!t.disableAnimation,this._configureViewModel(e),b.delay(0).then(function(){function i(){if(n<0)return void o.resolve();r._applyReportData({analysisAreaIndex:n--,rerenderContent:!1}).then(function(){setTimeout(i,100)},o.reject)}if(1===e.analysisAreas.length||e.isMultiFeature)r._destroyAllContainers(),r._resetMapBuilder(),r._applyReportData({analysisAreaIndex:0,rerenderContent:!0}).then(o.resolve,o.reject);else{!1!==t._resetLoadedContents&&(r._destroyAllContainers(),r._resetMapBuilder());var n=e.analysisAreas.length-1;i()}}),this._progressController&&this._progressController.setNumAreas(e.analysisAreas.length),this._progressController&&this._progressController.setLoadDataProgress(1);var n=o.promise.then(function(){return r._progressController&&r._progressController.finalize()}).otherwise(function(e){r._showError(e)});return this._showWaiting(n),n.always(function(){var e=r.getCurrentReportContainer();if(e&&e.domNode)return s.add(e.domNode,"esriGEReportPlayer_fadeIn1000"),b.delay(1e3).then(function(){e.domNode&&s.remove(e.domNode,"esriGEReportPlayer_fadeIn1000")}),b.delay(300).then(function(){if(r._isDataBeingSetFlag=!1,R.isAnimationSuspended=!1,r.onSetReportDataEnd(),r._emitPendingResizedEvent(),e.notifyShown(),r._progressController&&r._progressController.reset(),t.waitUntilAllContentIsReady)return r.getRenderPromise()})})},refresh:function(e){return this._reportData&&o(this.setReportData(this._reportData,{waitUntilAllContentIsReady:!(!e||!e.waitUntilAllContentIsReady)}),function(){return this.showPageAt(0),this.resize()}.bind(this))},showAnalysisAreaAt:function(e){return this._callAfterRendering("_doShowAnalysisAreaAt",[e])},_doShowAnalysisAreaAt:function(e){return this._applyReportData({analysisAreaIndex:e,rerenderContent:!1})},_applyReportData:function(e){var t=this;e=e||{};var r=this._reportData&&this._reportData.isMultiFeature?0:e.analysisAreaIndex||0,i=!1!==e.rerenderContent;if(this._analysisAreaIndex=r,this._showError(!this._reportData),this._reportData)return o(this._viewModel.initialize(this._reportData.isClassic,this.viewMode),function(){return t.playerToolbar.updateAreaSelect(t._reportData.analysisAreas,t._reportData.combinedAreasInfo,t.getCurrentAnalysisAreaIndex(),t._reportData.isMultiFeature),o(t._setReportContainer(i),function(e){return e&&t._doApplyTemplateJson({analysisAreaIndex:r})})})},_doApplyTemplateJson:function(e){var r=this,i=this.getCurrentReportContainer(),n=i.fromJson(t.clone(this._reportData.templateJson),{waitUntilAllContentIsReady:!0,progressCallback:function(t){r._progressController&&r._progressController.setProgressForAreaAt(t,e.analysisAreaIndex)}}),a=i.getPagePromise?i.getPagePromise():n,s=i.getContentPromise?i.getContentPromise():n;return this._registerContainerLoadPromise(s||a),o(a,function(){return r._setCurrentContainerLoaded(),r.showPageAt(r._currentPageIndex),r.resize()})},getReportData:function(){return this._reportData},getReportTitle:function(){return this._reportData&&this._reportData.reportTitle||""},getCurrentAnalysisAreaIndex:function(){return this._analysisAreaIndex},getCurrentAnalysisArea:function(){return this._reportData&&this._reportData.analysisAreas[this._analysisAreaIndex]},getAnalysisAreas:function(){return this._reportData&&this._reportData.analysisAreas},reportDataToJson:function(e){return this._showWaiting(this.dataProvider.reportDataToJson(this.getReportData(),e))},reportDataFromJson:function(e,t){var r=this;return this._showError(!1),this._showWaiting(o(this.dataProvider.reportDataFromJson(e),function(e){return r.setReportData(e,t)}))},_configureViewModel:function(e){var r=this;this._viewModel.setTheme(this._reportData.templateJson.theme),this._viewModel.enableDataDrilling=this.enableDataDrilling,this._viewModel.showDataDrillingInsidePanel=this.showDataDrillingInsidePanel,this._viewModel.setDynamicReportInfo({fieldData:this._reportData.fieldData,analysisAreas:this._reportData.analysisAreas,combinedAreasInfo:this._reportData.combinedAreasInfo,infographicOptions:this._reportData.infographicOptions,attachmentsStore:this._reportData.attachmentsStore,createMapFunc:t.hitch(this,this._createMap),reportType:this._reportData.reportType,isClassic:this._reportData.isClassic,isMultiFeature:this._reportData.isMultiFeature,isFixedDataMode:!this._reportData.config.geoenrichmentUrl,geClient:this._reportData.geClient,templateVariableProvider:this._reportData.templateVariableProvider,countryID:this._reportData.config.countryID,hierarchy:this._reportData.config.hierarchy}),this._viewModel.getDynamicImageFunc=t.hitch(this,this._getReportLogo),this._viewModel.enrichFieldData=function(e){return r.dataProvider.enrichFieldData(e,t.mixin({analysisAreas:r._reportData.analysisAreas,fieldData:r._reportData.fieldData},r._reportData.config))}},getNumberOfPages:function(){return this.getCurrentReportContainer()&&this.getCurrentReportContainer().getNumberOfPages()},notifyShown:function(){this._isDataBeingSetFlag||this.getCurrentReportContainer()&&this.getCurrentReportContainer().notifyShown()},_isErrorShown:!1,_showError:function(e){x.emulateErrors.playerError&&(e=!0),I[e?"hide":"show"](this.printableDivContainer),I[e?"show":"hide"](this.errorViewDiv),s[e?"add":"remove"](this.domNode,"esriGEReportPlayerError"),this._isErrorShown=!!e,e&&I.hide(this.sidePageNavigator),this.playerToolbar.setErrorShown(!!e),e&&(this._progressController&&this._progressController.reset(),console.log(e),this.onError(e))},isErrorShown:function(){return this._isErrorShown},setPrintMode:function(e){s[e?"add":"remove"](this.domNode,"esriGEReportPlayerInPrinting")},resize:function(e,t){return o(this._resize({width:e,height:t}),function(){this._updatePageNavigator(),this._updateZoomControls(),this.playerToolbar.update()}.bind(this))},_pendingResizeEvent:null,_emitResizedEvent:function(e){this._pendingResizeEvent={isPaginating:!!e},this._isDataBeingSetFlag||this._emitPendingResizedEvent()},_emitPendingResizedEvent:function(){this._pendingResizeEvent&&(this.onResized(this._pendingResizeEvent.isPaginating),this._pendingResizeEvent=null)},_onClose:function(){var e;this.showToFullScreenAnimation&&this.resizeMode===A.FIT_WINDOW&&(e=w.animateFrom(this)),o(e,function(){this.onClose()}.bind(this))},getVisualState:function(){return{type:"reportPlayer",viewMode:this.viewMode,reportContainers:this.getAllReportContainers().map(function(e){return e.getVisualState&&e.getVisualState()})}},setVisualState:function(e){return this._callAfterRendering("_doSetVisualState",[e])},_doSetVisualState:function(e){var t=e&&this.getAllReportContainers().map(function(t,r){return t.setVisualState&&t.setVisualState(e.reportContainers[r])});return r(t)},_renderQueue:null,getRenderPromise:function(){return this._renderQueue&&this._renderQueue.getPromise()},_registerContainerLoadPromise:function(e){this._renderQueue=this._renderQueue||new F,this._renderQueue.add(e),this.playerToolbar.setContentLoadPromise(this.getRenderPromise())},_safeFuncCaller:null,_callAfterRendering:function(e,t){var r=this;return this._safeFuncCaller=this._safeFuncCaller||{},this._safeFuncCaller[e]=function(){return r[e].apply(r,t)},o(this.getRenderPromise(),function(){return E.invoke(r._safeFuncCaller,e)})},onSetReportDataStart:function(){},onSetReportDataEnd:function(){},onResized:function(e){},onClose:function(){},onError:function(e){}})});