// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/dom-class","dojo/dom-construct","./GridRowStyler","../GridDataUtil","../GridQueryUtil","../gridLayoutCalcUtils/GridLayoutCalculatorQueryUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(r,o,t,e,n,l,a,i,d,f){f=f.geoenrichment.dijit.ReportPlayer.Grid;var s={};return s.ORDER_ASC="asc",s.ORDER_DES="desc",s.isGridSortable=function(r){return!(!r.allowSorting||r.isEmptyTable()||r.store.data.length<3||!r.viewModel.dynamicReportInfo||!s._collectHeaderRowInfoFromData(r))},s.getSorting=function(r){return r._sortInfo&&{field:r._sortInfo.field,order:r._sortInfo.order}},s.applySortingToStoreData=function(r){s.isGridSortable(r)&&s._applySortingToStoreData(r)},s.setSorting=function(r,o,t){if(s.isGridSortable(r)&&o){if(r._sortInfo={field:o.field,order:o.order},!t||!t.doNotRefresh)return r.refresh();s._makeSortable(r)}},s.buildSortControls=function(r){s.isGridSortable(r)&&s._makeSortable(r)},s.getSortRowIndexMapping=function(r){if(!r._sortInfo||!r._sortInfo.order)return null;var o={},t={};return r._getOriginalData().forEach(function(r,o){t[r.id]=o}),r.store.data.forEach(function(r,e){o[e]=t[r.id]}),o},s.getSortableDataInfo=function(o){function t(t){for(var e=[],n=s._collectHeaderRowInfoFromData(o,t),l=t?o._getOriginalData().slice():r.clone(o.store.data),a=0;a<n.headerRowIndex+1;a++)e.push(l.shift());return{topData:e,sortableData:l}}var n=t();return n.styleInfo=e.getStyleInfo(t(!0).sortableData,o.columns),n},s._applySortingToStoreData=function(r){if(r._sortInfo&&r._sortInfo.order){r._saveOriginalData();var o=s.getSortableDataInfo(r),t=r._sortInfo.field,l=r.columns.filter(function(r){return r.field===t})[0];o.sortableData.sort(function(o,t){function e(o){var t=n.getRenderedValue(r,o,l);return"number"==typeof t.numericValue?t.numericValue:t.formattedValue}var a,i=e(o),d=e(t),f=r._sortInfo.order===s.ORDER_DES,u="number"==typeof i||"number"==typeof d;return u?(i=Number(i),d=Number(d),a=i>d?1:i<d?-1:0,f?-a:a):(i=String(i),d=String(d),a=i.localeCompare(d),f?-a:a)}),o.styleInfo&&e.setAlternatingColors(o.sortableData,r.columns,o.styleInfo),r.store.data=o.topData.concat(o.sortableData)}},s._collectHeaderRowInfoFromData=function(r,o){function t(o){return e(o)===r.columns.length}function e(o){for(var t=l[o],e=0,n=0;n<r.columns.length;n++){var i=a.getColumnSpannedFields(r,t,r.columns[n].field);n+=i&&i.length?i.length-1:0,e++}return e}for(var n,l=o?r._getOriginalData():r.store.data,i=l.length-2,d=0;d<i;d++)if(t(d)){n=d;break}if(!(n>=0))return null;for(d=n+1;d<l.length;d++)if(!t(d))return null;return{headerRowIndex:n}},s._makeSortable=function(r){var e=s._collectHeaderRowInfoWithCells(r);e.cells.forEach(function(e){if(!e._sortArrow){var n=t.create("div",{class:"sortArrow sortArrowHoverIndicator"},e.domNode),l=e.getFullStyle();n.style[l&&"left"===l.horizontalAlign?"right":"left"]="5px",e._sortArrow=n,o.add(e.domNode,"esriGEClickable"),i.addNoDragClickHandler(e.contentBlock,function(o){r&&r.canSortCellFunc&&!r.canSortCellFunc(e)||s._checkCanSortOnHeaderClick(o)&&s._toggleSortForCell(e)}),i.addNoDragClickHandler(n,function(r){s._toggleSortForCell(e)})}}),s._updateArrows(r,e)},s._collectHeaderRowInfoWithCells=function(r){function o(o){return o&&o.length===r.columns.length}for(var t,e,n=r.store.data.length-2,a=0;a<n;a++){var i=l.queryCells(r,{rowIndex:a});if(o(i)){t=i,e=a;break}}if(!t)return null;for(a=e+1;a<r.store.data.length;a++)if(i=l.queryCells(r,{rowIndex:a}),!o(i))return null;return{cells:t,headerRowIndex:e}},s._toggleSortForCell=function(r){var o=r.parentGrid,t=o._sortInfo&&o._sortInfo.field===r.column.field?o._sortInfo.order:null;o._sortInfo={field:r.column.field,order:null},t?t===s.ORDER_DES?o._sortInfo.order=s.ORDER_ASC:t===s.ORDER_ASC&&(o._sortInfo.order=null):o._sortInfo.order=s.ORDER_DES,o.refresh(),o.onSortingChanged(s.getSorting(o))},s._checkCanSortOnHeaderClick=function(r){if(r&&r.path){if(r.path.some(function(r){return"A"===r.nodeName}))return!1}else if(r&&r.srcElement&&r.srcElement.parentNode&&"A"===r.srcElement.parentNode.nodeName)return!1;return!0},s._updateArrows=function(r,t){t.cells.forEach(function(t){var e=t._sortArrow;e&&(o.remove(e,"sortArrowHoverIndicator sortArrowUp sortArrowDown"),d.setTooltipToNode(e,null),r._sortInfo&&r._sortInfo.field===t.column.field?r._sortInfo.order===s.ORDER_ASC?o.add(e,"sortArrowUp"):r._sortInfo.order===s.ORDER_DES?o.add(e,"sortArrowDown"):(d.setTooltipToNode(e,f.sortTable),o.add(e,"sortArrowHoverIndicator")):(d.setTooltipToNode(e,f.sortTable),o.add(e,"sortArrowHoverIndicator")),setTimeout(function(){e.style.top=(t.getHeight()-e.clientHeight)/2+"px"},100))})},s});