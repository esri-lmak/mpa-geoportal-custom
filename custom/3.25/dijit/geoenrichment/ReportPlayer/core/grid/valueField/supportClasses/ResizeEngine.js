// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/on","dojo/dom-style","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/KeyboardUtil","esri/dijit/geoenrichment/utils/MathUtil","esri/dijit/geoenrichment/utils/MouseUtil"],function(e,t,o,n,r,a){var c={};return c.ALL_DIRECTIONS=["e","se","s","sw","w","nw","n","ne"],c.trackSizer=function(t){var o,i=c._getSizerInfo(t),s={x:a.getCursorPosition().clientX,y:a.getCursorPosition().clientY,w:t.w,h:t.h},h={x:0,y:0},l=e(document.body,"mousemove",function(e){e.preventDefault(),e.stopPropagation(),t.applyShift(-h.x,-h.y),h={x:0,y:0};var l,u,d=a.getCursorPosition().clientX,p=a.getCursorPosition().clientY,g=d-s.x,f=p-s.y,V=[0,0,g,f],y=0,x=0,v=t.supportsCtrlShift&&e.shiftKey,P=t.supportsCtrlShift&&n.isCtrl(e);if(i.changeWVector&&i.changeHVector&&v){var w=r.normalizeVector(i.vector),b=r.calcDotProduct(V,w);V=[0,0,w[2]*b,w[3]*b]}if(t.onSnapped(null),i.changeWVector){var D=r.calcAngleBetweenVectors(i.changeWVector,V);y=r.calcVectorLength(V)*Math.cos(D)||0}if(i.changeHVector){var m=r.calcAngleBetweenVectors(i.changeHVector,V);x=r.calcVectorLength(V)*Math.cos(m)||0}y=y&&c._restricVectorDelta(y,i.changeWVector,t),x=x&&c._restricVectorDelta(x,i.changeHVector,t),l=y&&c._snapVectorDelta(y,i.calcBoundaryWVectors(s.w,s.h,x),t),u=x&&c._snapVectorDelta(x,i.calcBoundaryHVectors(s.w,s.h,y),t),l&&l.canSnap&&u&&u.canSnap&&(l.canSnap=Math.abs(l.minDelta)<=Math.abs(u.minDelta),u.canSnap=Math.abs(u.minDelta)<Math.abs(l.minDelta)),l&&l.canSnap&&(t.onSnapped(l.snapInfo),y=l.snappedDelta),u&&u.canSnap&&(t.onSnapped(u.snapInfo),x=u.snappedDelta),P&&(y*=2,x*=2),o||!y&&!x||(t.onPreChange(),o=!0);var L=y||x,S=s.w+y,k=s.h+x;if(L){if(P)h={x:s.w/2-S/2,y:s.h/2-k/2};else{var C=i.calcOppositePoint(S,k);h={x:i.oppositePoint[0]-C[0],y:i.oppositePoint[1]-C[1]}}t.applyShift(h.x,h.y),t.setWidth(S),t.setHeight(k)}L&&t.onSizeChanged(e),y&&t.onWidthChanged(e),x&&t.onHeightChanged(e)}),u=e.once(document.body,"mouseup, click",function(e){e.preventDefault(),e.stopPropagation(),u.remove(),l.remove(),t.onEnd()})},c._getSizerInfo=function(e){function t(e,t){var a,c,i,s,h,l;switch(o){case"e":a=[e,t/2],c=i=[0,t/2],h=[[0,0,e,0],[0,t,e,t]];break;case"se":a=[e,t],c=[0,0],i=[0,t],s=[e,0],h=[[0,t,e,t],[0,0,e,0]],l=[[e,0,e,t],[0,0,0,t]];break;case"s":a=[e/2,t],c=s=[e/2,0],l=[[0,0,0,t],[e,0,e,t]];break;case"sw":a=[0,t],c=[e,0],i=[e,t],s=[0,0],h=[[e,t,0,t],[e,0,0,0]],l=[[0,0,0,t],[e,0,e,t]];break;case"w":a=[0,t/2],c=i=[e,t/2],h=[[e,0,0,0],[e,t,0,t]];break;case"nw":a=[0,0],c=[e,t],i=[e,0],s=[0,t],h=[[e,0,0,0],[e,t,0,t]],l=[[0,t,0,0],[e,t,e,0]];break;case"n":a=[e/2,0],c=s=[e/2,t],l=[[0,t,0,0],[e,t,e,0]];break;case"ne":a=[e,0],c=[0,t],i=[0,0],s=[e,t],h=[[0,0,e,0],[0,t,e,t]],l=[[e,t,e,0],[0,t,0,0]]}var u=[e/2,t/2];a=r.rotatePointAroundPoint(u,a,n),c=r.rotatePointAroundPoint(u,c,n),i=i&&r.rotatePointAroundPoint(u,i,n),s=s&&r.rotatePointAroundPoint(u,s,n);var d=[c[0],c[1],a[0],a[1]],p=i&&[i[0],i[1],a[0],a[1]],g=s&&[s[0],s[1],a[0],a[1]];return h=h&&h.map(function(e){return r.rotateVectorAroundPoint(e,u,n)}),l=l&&l.map(function(e){return r.rotateVectorAroundPoint(e,u,n)}),{sizerPoint:a,oppositePoint:c,vector:d,changeWVector:p,changeHVector:g,boundaryWVectors:h,boundaryHVectors:l}}var o=e.dir,n=e.angle,a=e.w,c=e.h,i=t(a,c);return{oppositePoint:i.oppositePoint,vector:i.vector,changeWVector:i.changeWVector,changeHVector:i.changeHVector,calcOppositePoint:function(e,o){return t(e,o).oppositePoint},calcBoundaryWVectors:function(e,o,n){var a=t(e,o).boundaryWVectors;if(n){var c=r.addLengthToVector(r.normalizeVector(i.changeHVector),n);a[0]=r.addPointToVector(a[0],[c[2],c[3]])}return a},calcBoundaryHVectors:function(e,o,n){var a=t(e,o).boundaryHVectors;if(n){var c=r.addLengthToVector(r.normalizeVector(i.changeWVector),n);a[0]=r.addPointToVector(a[0],[c[2],c[3]])}return a}}},c._restricVectorDelta=function(e,t,o){var n=o.getRestrictNodeBox();if(!n||e<=0||!e)return e;var a=o.getThisBox(),c=r.calcVectorLength(t);t=r.addLengthToVector(t,e),t=r.addPointToVector(t,[a.x,a.y]);var i=[n.x,n.y,n.x,n.y+n.h],s=[n.x+n.w,n.y,n.x+n.w,n.y+n.h],h=[n.x,n.y,n.x+n.w,n.y],l=[n.x,n.y+n.h,n.x+n.w,n.y+n.h],u=r.intersect2Lines(t,i),d=r.intersect2Lines(t,s),p=r.intersect2Lines(t,h),g=r.intersect2Lines(t,l),f=r.calcVectorLength(t),V=t;return[u,d,p,g].forEach(function(e){if(e){var o=[t[0],t[1],e[0],e[1]];if(r.calcDotProduct(t,o)>0){var n=r.calcVectorLength(o);n<f&&(f=n,V=o)}}}),V=r.subtractPointFromVector(V,[a.x,a.y]),r.calcVectorLength(V)-c},c._snapVectorDelta=function(e,t,o){var n=o.getSnapNodeBoxes()||[];if(!n.length||!e)return e;var a,c,i,s=o.getThisBox(),h=1/0;return t.forEach(function(t){t=r.addLengthToVector(t,e),t=r.addPointToVector(t,[s.x,s.y]);var o=r.calcVectorLength(t);n.forEach(function(e){var n=e.box,s=e.tolerance;[[n.x,n.y,n.x,n.y+n.h],[n.x+n.w,n.y,n.x+n.w,n.y+n.h],[n.x+n.w/2,n.y,n.x+n.w/2,n.y+n.h],[n.x,n.y,n.x+n.w,n.y],[n.x,n.y+n.h,n.x+n.w,n.y+n.h],[n.x,n.y+n.h/2,n.x+n.w,n.y+n.h/2]].forEach(function(e,l){var u=r.intersect2Lines(t,e);if(u){var d=[t[0],t[1],u[0],u[1]];if(r.calcDotProduct(t,d)>0){var p=r.calcVectorLength(d),g=p-o;Math.abs(g)<=Math.abs(h)&&Math.abs(g)<=s&&(h=g,a=e,i=n,c=l>2)}}})})}),{canSnap:!!a,snapInfo:a&&{elementBox:o.getThisFullBox(),snapBox:i,to:c?a[1]:a[0],isHorizontal:c},minDelta:a?h:NaN,snappedDelta:a?e+h:NaN}},c.positionSizer=function(e){var n,a,i=e.sizer;i.style.display="block";var s=e.dir,h=e.w,l=e.h,u=e.angle,d=i.offsetWidth||12,p=i.offsetHeight||12;switch(s){case"e":n=h,a=l/2;break;case"se":n=h,a=l;break;case"s":n=h/2,a=l;break;case"sw":n=0,a=l;break;case"w":n=0,a=l/2;break;case"nw":n=0,a=0;break;case"n":n=h/2,a=0;break;case"ne":n=h,a=0}if(u){var g=r.rotatePointAroundPoint({x:h/2,y:l/2},{x:n,y:a},u);n=g.x,a=g.y}n-=d/2,a-=p/2,t.set(i,{left:n+"px",top:a+"px",cursor:c._getCursorDirection(s,u)+"-resize"}),"w"!==s&&"e"!==s||o[l<30?"hide":"show"](i),"s"!==s&&"n"!==s||o[h<30?"hide":"show"](i),i.style.display=""},c._getCursorDirection=function(e,t){if(!t)return e;t=r.angleTo0_360Range(t);var o=Math.round(t/45),n=c.ALL_DIRECTIONS.indexOf(e)+o;return c.ALL_DIRECTIONS[n%c.ALL_DIRECTIONS.length]},c});