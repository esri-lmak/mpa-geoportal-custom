// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/dom-construct","dojo/dom-geometry","../dom-style","./TextStyleBuilder","../TransformUtil","./FlowCalculator","./ReplaceUtil","./SiblingsUtil"],function(e,i,n,t,r,o,s,l){var a={_linesNode:null,_wordNode:null,createTempLinesNode:function(e){return this._linesNode=this._linesNode||this._createTempNode(),this._styleNode(this._linesNode,e,!0)},createTempWordNode:function(e){return this._wordNode=this._wordNode||this._createTempNode(),this._styleNode(this._wordNode,e)},_createTempNode:function(){var i=e.create("div",null,document.body);return n.set(i,{position:"absolute",display:"inline-block"}),i},_styleNode:function(e,i,r){return t.resetTextStyle(e),n.set(e,"width",r?i.style.cw+"px":""),n.set(e,"display","inline-block"),n.set(e,i.style.getTextStyleObject()),e},dispose:function(e){e&&n.set(e,"display","none")},cleanUp:function(){this._linesNode&&e.destroy(this._linesNode),this._linesNode=null,this._wordNode&&e.destroy(this._wordNode),this._wordNode=null}},d={getParagraphs:function(e,i){function n(e){return s.collapseMultipleSpaces(e.trim())}var t=i.style.getTextStyle("whiteSpace"),r="pre-wrap"===t||"pre"===t||"pre-line"===t;r||(e=s.removeReturns(e));var o="pre-wrap"===t||"pre"===t;o||(e=n(e));var l=r?e.split(String.fromCharCode(10)):[e];return l.length>1&&!o&&(l=l.map(n)),l}},h={measureWidth:function(e,i){return i.innerHTML=e,n.get(i,"width")}},c={getLinesForWords:function(e,n,t,r){function o(){var e=t.innerHTML;t.innerHTML="";var i=e.split("");return c.getLinesForWords(i,n,t,{checkBreaking:!1,separator:""}).lines}function s(e){var i=e.split("");return c.getLinesForWords(i,n,t,{checkBreaking:!1,separator:"",clearLinesNodeBeforeMeasure:!r.isBreakAll}).lines}var l,a,d=0;r.checkBreaking&&(t.innerHTML="a",a=i.position(t).h);var u=0,p="";r.clearLinesNodeBeforeMeasure&&(t.innerHTML=""),e.some(function(e){if(l){var c;r.checkBreaking&&(c=t.innerHTML),t.innerHTML+=r.separator+e;var g=i.position(t).h;if(u>0&&g>u){l.push({text:p,w:h.measureWidth(p,n),lineHeight:d});var f;if(r.checkBreaking&&(g-u>1.2*a||r.isBreakAll)){t.innerHTML=p+r.separator;var T=s(e);t.innerHTML=c+r.separator+e,T.length>1&&(f=!0,T.forEach(function(e,i){if(i<T.length-1)if(0===i&&r.isBreakAll){var t=l[l.length-1];t.text+=r.separator+e.text,t.w=h.measureWidth(t.text,n)}else l.push(e);else d=e.lineHeight,p=e.text}),u=g)}f||(p=e,d=g-u,u=g)}else p+=r.separator+e,0===u&&(u=i.position(t).h,d=u)}else if(l=[],r.clearLinesNodeBeforeMeasure?t.innerHTML=e:t.innerHTML+=e,p=e,u=i.position(t).h,d=u,r.checkBreaking&&u>1.2*a){var L=o();L.length>1&&L.forEach(function(e,i){i<L.length-1?l.push(e):(d=e.lineHeight,p=e.text)})}}),l.push({text:p,w:h.measureWidth(p,n),lineHeight:d});var g=i.position(t).w;return{lines:l,textWidth:g,lineHeight:d}}},u={getLinesForParagraph:function(e,i,n,t){var r=e.split(" "),o="break-word"===i.style.getTextStyle("overflowWrap")||"break-word"===i.style.getTextStyle("wordWrap"),s="break-all"===i.style.getTextStyle("wordBreak");return c.getLinesForWords(r,n,t,{checkBreaking:o||s,isBreakAll:s,clearLinesNodeBeforeMeasure:!0,separator:" "})}},p={_node:null,_originalInnerHTML:null,_nextSiblingsHideInfo:null,setNode:function(e){this._node=e,this._originalInnerHTML=null,this._nextSiblingsHideInfo=null},doPresets:function(){this._originalInnerHTML=this._node.innerHTML,this.hideNextSibling()},undoPresets:function(){this.showNextSibling(),this._node.innerHTML=this._originalInnerHTML},hideNextSibling:function(){this._nextSiblingsHideInfo||(this._nextSiblingsHideInfo=l.hideNextSiblings(this._node))},showNextSibling:function(){l.showNextSiblings(this._nextSiblingsHideInfo),this._nextSiblingsHideInfo=null}};return{getLines:function(e,n,t){if(e.innerHTML&&e.innerHTML.trim()){var o=r.disableTransform(e,n.parentVs);p.setNode(e),p.doPresets();var s,l=n.isSpanLike?e:a.createTempLinesNode(n),h=a.createTempWordNode(n),c=d.getParagraphs(e.innerHTML,n),g=[];if(c.forEach(function(e){var i=u.getLinesForParagraph(e,n,h,l);s=i.textWidth,g=g.concat(i.lines)}),n.isSpanLike){l.innerHTML=p._originalInnerHTML;var f=i.position(l).h;p.showNextSibling();var T=i.position(l).h;if(T>f){var L=(T-f)/2;g[g.length-1].lineHeight+=L}p.hideNextSibling()}return p.undoPresets(),a.dispose(h),!n.isSpanLike&&a.dispose(l),r.restoreTransform(o),{lines:g,textWidth:s}}},getSpanFlowOffsets:function(e,i){return o.getSpanFlowOffsets(e,i)},cleanUp:function(){a.cleanUp()}}});