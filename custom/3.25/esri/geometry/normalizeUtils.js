// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","dojo/has","../kernel","../config","../deferredUtils","./Extent","./Polyline","./Polygon","./webMercatorUtils","./jsonUtils"],function(e,n,r,t,a,i,o,s,f,c,u,l){function h(e,n){return Math.ceil((e-n)/(2*n))}function p(e,n){var r,t,a,i=e.paths||e.rings,o=i.length;for(r=0;r<o;r++){var s=i[r];for(a=s.length,t=0;t<a;t++){var f=e.getPoint(r,t);e.setPoint(r,t,f.offset(n,0))}}return e}function g(n,r){if(!(n instanceof f||n instanceof c)){var t="_straightLineDensify: the input geometry is neither polyline nor polygon";throw console.error(t),new Error(t)}var a,i=n instanceof f,o=i?n.paths:n.rings,s=[];return e.forEach(o,function(e){s.push(a=[]),a.push([e[0][0],e[0][1]]);var n,t,i,o,f,c,u,l,h,p,g,d;for(f=0;f<e.length-1;f++){if(n=e[f][0],t=e[f][1],i=e[f+1][0],o=e[f+1][1],u=Math.sqrt((i-n)*(i-n)+(o-t)*(o-t)),l=(o-t)/u,h=(i-n)/u,(p=u/r)>1){for(c=1;c<=p-1;c++){var v=c*r;g=h*v+n,d=l*v+t,a.push([g,d])}var m=(u+Math.floor(p-1)*r)/2;g=h*m+n,d=l*m+t,a.push([g,d])}a.push([i,o])}}),i?new f({paths:s,spatialReference:n.spatialReference}):new c({rings:s,spatialReference:n.spatialReference})}function d(e,n,r){if(n){var t=g(e,1e6);e=u.webMercatorToGeographic(t,!0)}return r&&(e=p(e,r)),e}function v(e,n,r){var t,a=e.x||e[0];return a>n?(t=h(a,n),e.x?e=e.offset(t*(-2*n),0):e[0]=a+t*(-2*n)):a<r&&(t=h(a,r),e.x?e=e.offset(t*(-2*r),0):e[0]=a+t*(-2*r)),e}function m(n,r){var t=-1;return e.forEach(r.cutIndexes,function(a,i){var o=r.geometries[i],s=o.rings||o.paths;e.forEach(s,function(n,r){e.some(n,function(e){if(e[0]<180)return!0;var t,a,i=0,s=n.length;for(t=0;t<s;t++)a=n[t][0],i=a>i?a:i;i=Number(i.toFixed(9));var f,c=h(i,180),u=-360*c,l=n.length;for(f=0;f<l;f++){var p=o.getPoint(r,f);o.setPoint(r,f,p.offset(u,0))}return!0})}),a===t?o.rings?e.forEach(o.rings,function(e){n[a]=n[a].addRing(e)}):e.forEach(o.paths,function(e){n[a]=n[a].addPath(e)}):(t=a,n[a]=o)}),n}function x(n,t,a,o){var s=new r;s.addCallbacks(a,o),t=t||i.defaults.geometryService;var g,x,y,b,_,E,w,M,k=[],O=[],j=0;e.forEach(n,function(n){if(!n)return void k.push(n);if(g||(g=n.spatialReference,x=g._getInfo(),y=g._isWebMercator(),b=y?20037508.342788905:180,_=y?-20037508.342788905:-180,E=y?102100:4326,w=new f({paths:[[[b,_],[b,b]]],spatialReference:{wkid:E}}),M=new f({paths:[[[_,_],[_,b]]],spatialReference:{wkid:E}})),!x)return void k.push(n);var r=l.fromJson(n.toJson()),t=n.getExtent();if("point"===n.type)k.push(v(r,b,_));else if("multipoint"===n.type)r.points=e.map(r.points,function(e){return v(e,b,_)}),k.push(r);else if("extent"===n.type){var a=t._normalize(null,null,x);k.push(a.rings?new c(a):a)}else if(t){var i=h(t.xmin,_),o=i*(2*b);r=0===o?r:p(r,o),t=t.offset(o,0),t.intersects(w)&&t.xmax!==b?(j=t.xmax>j?t.xmax:j,r=d(r,y),O.push(r),k.push("cut")):t.intersects(M)&&t.xmin!==_?(j=t.xmax*(2*b)>j?t.xmax*(2*b):j,r=d(r,y,360),O.push(r),k.push("cut")):k.push(r)}else k.push(r)});for(var R=new f,C=h(j,b),P=-90,D=C;C>0;){var W=360*C-180;R.addPath([[W,P],[W,-1*P]]),P*=-1,C--}return O.length>0&&D>0?t?t.cut(O,R,function(r){O=m(O,r);var a=[];e.forEach(k,function(e,r){if("cut"===e){var t=O.shift();n[r].rings&&n[r].rings.length>1&&t.rings.length>=n[r].rings.length?(k[r]="simplify",a.push(t)):k[r]=!0===y?u.geographicToWebMercator(t):t}}),a.length>0?t.simplify(a,function(n){e.forEach(k,function(e,r){"simplify"===e&&(k[r]=!0===y?u.geographicToWebMercator(n.shift()):n.shift())}),s.callback(k)},function(e){s.errback(e)}):s.callback(k)},function(e){s.errback(e)}):s.errback(new Error("esri.geometry.normalizeCentralMeridian: 'geometryService' argument is missing.")):(e.forEach(k,function(e,n){if("cut"===e){var r=O.shift();k[n]=!0===y?u.geographicToWebMercator(r):r}}),s.callback(k)),s}function y(r,t,a,i){var o,s=!1;n.isObject(r)&&r&&(n.isArray(r)?r.length&&(o=r[0]&&r[0].declaredClass,o&&-1!==o.indexOf("Graphic")?(r=e.map(r,function(e){return e.geometry}),s=!!r.length):o&&-1!==o.indexOf("esri.geometry.")&&(s=!0)):(o=r.declaredClass,o&&-1!==o.indexOf("FeatureSet")?(r=e.map(r.features||[],function(e){return e.geometry}),s=!!r.length):o&&-1!==o.indexOf("esri.geometry.")&&(s=!0))),s&&t.push({index:a,property:i,value:r})}function b(r,t){var a=[];return e.forEach(t,function(t){var i,o=t.i,s=r[o],f=t.p;if(n.isObject(s)&&s)if(f)if("*"===f[0])for(i in s)s.hasOwnProperty(i)&&y(s[i],a,o,i);else e.forEach(f,function(e){y(n.getObject(e,!1,s),a,o,e)});else y(s,a,o)}),a}function _(r,t){var a=0,i={};return e.forEach(t,function(e){var t=e.index,o=e.property,s=e.value,f=s.length||1,c=r.slice(a,a+f);n.isArray(s)||(c=c[0]),a+=f,delete e.value,o?(i[t]=i[t]||{},i[t][o]=c):i[t]=c}),i}function E(t){var a=n.isObject(t)?t.prototype:n.getObject(t+".prototype");e.forEach(a.__msigns,function(n){var t=a[n.n];a[n.n]=function(){var a,i=this,s=[],f=new r(o._dfdCanceller);for(n.f&&o._fixDfd(f),a=0;a<n.c;a++)s[a]=arguments[a];var c={dfd:f};s.push(c);var u,l,h=[];return i.normalization&&!i._isTable&&(u=b(s,n.a),e.forEach(u,function(e){h=h.concat(e.value)}),h.length&&(l=x(h))),l?(f._pendingDfd=l,l.addCallbacks(function(e){f.canceled||(c.assembly=_(e,u),f._pendingDfd=t.apply(i,s))},function(e){var r=i.declaredClass;r&&-1!==r.indexOf("FeatureLayer")?i._resolve([e],null,s[n.e],f,!0):i._errorHandler(e,s[n.e],f)})):f._pendingDfd=t.apply(i,s),f}})}function w(e){if(!e)return null;var n=e.getExtent();if(!n)return null;var r=e.spatialReference&&e.spatialReference._getInfo();if(!r)return n;var t=r.valid[0],a=r.valid[1],i=2*a,o=n.getWidth(),f=n.xmax,c=n.xmin;if("extent"===e.type||0===o||o<=a||o>i||f<t||c>a)return n;var u;switch(e.type){case"polygon":if(!(e.rings.length>1))return n;u=M(e.rings);break;case"polyline":if(!(e.paths.length>1))return n;u=M(e.paths);break;case"multipoint":u=e.points}for(var l=Math.min,h=Math.max,p=new s(n.toJson()),g=0;g<u.length;g++){var d=u[g][0];d<0?(d+=a,c=h(d,c)):(d-=a,f=l(d,f))}return p.xmin=f,p.xmax=c,p.getWidth()<o?(p.xmin-=a,p.xmax-=a,p):n}function M(e){for(var n=[],r=0,t=0,a=Math.min,i=Math.max,o=0;o<e.length;o++){for(var s=e[o],f=null,c=0;c<s.length;c++)f=s[c],n.push(f),0===c?(r=f[0],t=r):(r=a(r,f[0]),t=i(t,f[0]));f&&n.push([(r+t)/2,0])}return n}var k={normalizeCentralMeridian:x,_foldCutResults:m,_prepareGeometryForCut:d,_offsetMagnitude:h,_pointNormalization:v,_updatePolyGeometry:p,_straightLineDensify:g,_createWrappers:E,_disassemble:b,_addToBucket:y,_reassemble:_,getDenormalizedExtent:w};return t("extend-esri")&&n.mixin(n.getObject("geometry",!0,a),k),k});