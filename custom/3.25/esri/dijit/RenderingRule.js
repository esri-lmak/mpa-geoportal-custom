// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/i18n!../nls/jsapi","dojo/text!./templates/RenderingRule.html","dojo/store/Memory","dojo/store/Observable","dojo/data/ObjectStore","dojo/has","dojo/on","dojo/io-query","dojo/Deferred","../kernel","../lang","../layers/RasterFunction","../geometry/Extent","../geometry/Point","./ColorRampSelector","../renderers/colorUtils","./ColorPicker","../tasks/generateRenderer","../tasks/AlgorithmicColorRamp","../tasks/MultipartColorRamp","../symbols/SimpleFillSymbol","../Color","../renderers/StretchRenderer","../renderers/UniqueValueRenderer","../renderers/ClassBreaksRenderer","../renderers/colorRampUtils","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/popup","dijit/Tooltip","dgrid/OnDemandGrid","dgrid/editor","dgrid/Keyboard","dijit/form/NumberTextBox","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","dijit/form/FilteringSelect","dijit/TooltipDialog"],function(e,t,s,i,a,n,r,l,o,h,u,d,c,m,y,f,g,_,p,R,b,v,S,C,V,L,I,T,B,F,M,x,k,w,N,D,q,A,G,P,U,H,O,j){var E=e([w,N,D],{declaredClass:"esri.dijit.RenderingRule",templateString:o,widgetsInTemplate:!0,layer:null,map:null,hideApplyButton:!1,_renderingRuleObject:null,_rasterFunctionData:[],_rasterFunctionStore:null,_cachedFunctionList:[],_cachedkeyProperties:{},_cachedHistogramsList:{},_cachedRATList:{},_pendingDfds:{},_redBandIdStore:null,_greenBandIdStore:null,_blueBandIdStore:null,_donotSaveChanges:!1,_resetBandCombination:!1,_serviceBandCount:3,_defaultBandCombinationFncName:"User Defined Renderer",_firstFncInRenderingRuleList:null,_gammaSliderTooltip:null,_symbologyTypes:{classify:"classify",stretch:"stretch",uniqueValues:"uniqueValues"},_defaultNClasses:5,_defaultMaxClasses:16,_classifyMethods:{naturalBreaks:"natural-breaks",equalInterval:"equal-interval",quantile:"quantile",definedInterval:"defined-interval",manualInterval:"manual-interval"},constructor:function(t){e.safeMixin(this,t),this._i18n=l,this._defaultBandCombinationFncName=this._i18n.widgets.renderingRule.userDefinedRendererTitle,this._renderingRuleObject=new p},startup:function(){this.inherited(arguments),s.connect(this.rasterFunctionList,"onChange",t.hitch(this,"_onRasterFunctionChange")),s.connect(this.stretchMethodList,"onChange",t.hitch(this,"_onStretchMethodChange")),s.connect(this.gammaSlider,"onChange",t.hitch(this,"_onGammaChange")),s.connect(this.gammaSlider,"onMouseLeave",t.hitch(this,"_onGammaMouseLeave")),s.connect(this._apply,"onclick",t.hitch(this,"_onClickApplyRenderingRule")),s.subscribe("onRenderingRuleApply",t.hitch(this,"_onClickApplyRenderingRule")),s.subscribe("onRenderingRuleReset",t.hitch(this,"_onClickResetRenderingRule")),this.own(m(this.vectorWarningIcon,"mouseover",t.hitch(this,this._showVectorWarning))),this._onRasterFunctionChange(this.rasterFunctionList.value),this.hideApplyButton&&(this._apply.style.display="none"),this._setupUniqueValuesGrid(),this._setupClassifyGrid(),this._setupStretchStatsGrid(),this._setupClassifyMethodStore(),this._symbologyBlocks=[this.stretchBlock,this.colorRampBlock,this.classifyBlock,this.classifyGridBlock,this.uniqueValuesBlock,this.uniqueValuesGridBlock],this._startupCalled=!0},_getColorMapFunction:function(e){var t=new p;return this.colorRampSelect.colorRampName?t.functionArguments={colorRamp:this.colorRampSelect.colorRampName}:t.functionArguments={Colormap:this.colorRampSelect.colorMap},t.variableName="Raster",t.functionName="Colormap",t},destroy:function(){this._pendingDfds=null,this._gammaSliderTooltip&&(this._gammaSliderTooltip.destroy(),this._gammaSliderTooltip=null),this.inherited(arguments)},_setLayerAttr:function(e){if(e){e!==this.layer&&(this._vectorWarningShown=!1),this.inherited(arguments),this.layer=e,this._donotSaveChanges=!0,this._firstFncInRenderingRuleList=null,this._stretchReadFromRenderingRule=!1,this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._uniqueValuesColorRamp=null,this._customColorRamp=null,this._fillStretchMethodList(),this._hideStretch();var i=t.hitch(this,"_setupDefaults");this.layer.loaded?this._setupDefaults():s.connect(this.layer,"onLoad",i),this._donotSaveChanges=!1}},_setupDefaults:function(){this._setDefaultNoneFunctionName(),this._setupBandIdDefaults(),this._setupStretchDefaults(),this._setupRenderingRuleDefaults(),this._setupColorRampDefaults(),this._setupSymbologyDefaults(),this._setupClassifyDefaults(),this._setupUniqueValuesDefaults()},_setDefaultNoneFunctionName:function(){var e;this.layer.rasterFunctionInfos.some(t.hitch(this,function(t){if("none"===t.name.toLowerCase())return e=t.name,!0})),this._defaultNoneFunctionName=e||"None"},_setupRFTDefaults:function(){this._setupColorRampDefaults(),this._setupStretchDefaults(),this._setupSymbologyDefaults(),this._setupClassifyDefaults(),this._setupUniqueValuesDefaults()},_setupRenderingRuleDefaults:function(){if(this.layer){this._rasterFunctionData=[];var e,t=new f;for(e=0;e<this._cachedFunctionList.length;e++){var s=this._cachedFunctionList[e];if(s&&this.layer===s.layer)return this._rasterFunctionData=s.data,this._setupFunctionStore(),t.resolve(),t}return this._fillRasterFunctionList(this.layer)}},_clearClassifyGrid:function(){this._classifyGrid&&this._classifyGrid.set("store",new d(new h({data:[]})))},_setupClassifyDefaults:function(){if(this.layer&&this.symbologyTypeSelect.store.get(this._symbologyTypes.classify)){this._showClassifyLoadingMsg(),this._clearClassifyGrid(),this._setupClassifyMethodStore(),this._setupClassifyGridDefaults(),this._setupClassifyFieldStore();var e=this.layer,s=this.layer.id,i=this._rasterFunctionStore.get(this.rasterFunctionList.value),a=i.name,n=i&&i.serviceInfo,r=n?n.hasRasterAttributeTable:this.layer.hasRasterAttributeTable,l=n?n.hasHistograms:this.layer.hasHistograms,o=a===this._defaultBandCombinationFncName?this._defaultNoneFunctionName:a;o=new p({functionName:o}),this._cachedRATList[s]&&this._cachedRATList[s][a]?this._handleRasterAttributeTableClassify(this._cachedRATList[s][a]):r?this.rasterFunctionList.value===this._defaultBandCombinationFncName?e.getRasterAttributeTable().then(t.hitch(this,this._handleRasterAttributeTableClassify)):e.getRenderingRuleAttributeTable({renderingRule:o}).then(t.hitch(this,this._handleRasterAttributeTableClassify)):this._cachedHistogramsList&&this._cachedHistogramsList[s]&&this._cachedHistogramsList[s][a]?this._handleHistogramsResultClassify(this._cachedHistogramsList[this.layer.id][a]):l&&this.rasterFunctionList.value===this._defaultBandCombinationFncName?this._getHistograms(t.hitch(this,this._handleHistogramsResultClassify)):(e.currentVersion>10.1||this._isSingleBitRaster(e.pixelType))&&this._getComputeHistograms(t.hitch(this,this._handleHistogramsResultClassify),{renderingRule:o,pixelSize:this._getOverviewPixelSize()})}},_getComputeHistograms:function(e,t){if(this.layer)return this._computeHistogramsTask&&!this._computeHistogramsTask.isResolved()?this._computeHistogramsTask:(this._computeHistogramsTask=this.layer.computeHistograms(t).then(e),this._computeHistogramsTask)},_getHistograms:function(e){if(this.layer)return this._getHistogramsTask&&!this._getHistogramsTask.isResolved()?this._getHistogramsTask:(this._getHistogramsTask=this.layer.getHistograms().then(e),this._getHistogramsTask)},_getOverviewPixelSize:function(){var e=this.layer.extent,t=this.map.width,s=this.map.height,i=(e.xmax-e.xmin)/t,a=(e.ymax-e.ymin)/s,n=e.spatialReference;return new b(i,a,n)},_addUniqueValuesColorRamp:function(e){var t={},s=e&&e.features;s&&s.length&&this._ratContainsColormap(e)&&(this._uniqueValuesColorRampName=this._i18n.widgets.renderingRule.uniqueValuesDefaultColorRamp,t.id=this._uniqueValuesColorRampName,t.name=this._uniqueValuesColorRampName,t.type="multipart",t.colorRamps=[],i.forEach(s,function(e){var s=e.attributes,i=this._getFeatureRGBValue(s);t.colorRamps.push({fromColor:i,toColor:i})},this),this._uniqueValuesColorRamp=t,this._setColorRampSelectValue())},_addCustomColorRamp:function(e){if(e){if(this._customColorRamp)return this.colorRampSelect.setSelected(this._customColorRamp);this._customColorRamp=e.toJson(),this._customColorRampName=this._i18n.widgets.renderingRule.customColorRampName,this._customColorRamp.id=this._customColorRampName,this._customColorRamp.name=this._customColorRampName,this.colorRampSelect.addColorRamp(this._customColorRamp),this.colorRampSelect.setSelected(this._customColorRamp)}},_getFeatureRGBValue:function(e){if(e){var t,s,i;return t=this._getCaseInsensitiveFieldValue("red",e),s=this._getCaseInsensitiveFieldValue("green",e),i=this._getCaseInsensitiveFieldValue("blue",e),t=t>1?t:Math.round(255*t),s=s>1?s:Math.round(255*s),i=i>1?i:Math.round(255*i),[t,s,i]}},_getCaseInsensitiveFieldValue:function(e,t){if(t&&e){var s=e.toLowerCase();for(var i in t)if(t.hasOwnProperty(i)&&i.toLowerCase()===s)return t[i]}},_ratContainsColormap:function(e){if(!e||!e.fields)return!1;var t,s,a;return i.some(e.fields,function(e){if(e&&e.name){var i=e.name.toLowerCase();"red"===i&&(t=!0),"green"===i&&(s=!0),"blue"===i&&(a=!0)}return t&&s&&a})},_handleRasterAttributeTableClassify:function(e){if(e&&e.features&&e.features.length){var t=this.rasterFunctionList.value;this._cachedRATList[this.layer.id]=this._cachedRATList[this.layer.id]||{},this._cachedRATList[this.layer.id][t]=e,this._setupClassifyNClassesInput(e.features.length),this._setDefaultIntervalSize(),this._addUniqueValuesColorRamp(e),this._setupClassifyFieldStore(),this._setupUniqueValuesFieldStore(),this.symbologyTypeSelect.set("value",this._getDefaultSymbologyType()),this._isClassBreaksRenderer(this.layer.renderer)||this._updateClassifyGrid(),this._isUniqueValueRenderer(this.layer.renderer)||this._updateUniqueValuesGrid()}},_handleHistogramsResultClassify:function(e){if(e&&e.histograms&&e.histograms.length){var t=e.histograms,s=this.rasterFunctionList.value;this._cachedHistogramsList[this.layer.id]=this._cachedHistogramsList[this.layer.id]||{},this._cachedHistogramsList[this.layer.id][s]=t,this._setupClassifyNClassesInput(t[0].counts&&t[0].counts.length),this._setDefaultIntervalSize(),this._setupUniqueValuesFieldStore(),this._getServiceMinAndMax();var i,a,n,r=0,l=[];if(t&&t.length&&t[0].size){for(i=t[0].counts,a=this.minValues.length?this.minValues[0]:t[0].min,n=this.maxValues.length?this.maxValues[0]:t[0].max,r=0;r<i.length-1;r++)l.push(a+(n-a)*r/i.length);l.push(n),t[0].dataPoints=l}this._isClassBreaksRenderer(this.layer.renderer)||this._updateClassifyGrid(),this._isUniqueValueRenderer(this.layer.renderer)||this._updateUniqueValuesGrid()}},_setDefaultIntervalSize:function(){if(this.layer){var e,t,s,a,n,r,l,o,h,u,d,c=this.layer,m=c.id,y=c.renderer,f=this.rasterFunctionList.value,g=this.classifyFieldSelect.value;this._getServiceMinAndMax(),this._isSelectedRenderingRule(c.renderingRule)&&this._isClassBreaksRenderer(y)&&y.infos&&y.infos.length&&y.attributeField===g&&(s=y.infos.length,e=y.infos[0],t=y.infos[s-1],r=(t.maxValue-e.minValue)/s),r||(this._cachedRATList&&this._cachedRATList[m]&&this._cachedRATList[m][f]?(a=this._cachedRATList[m][f],o=h=a.features[0].attributes[g],d=a.features.length,i.forEach(a.features,function(e){u=e.attributes[g],u<o&&(o=u),u>h&&(h=u)})):this._cachedHistogramsList&&this._cachedHistogramsList[m]&&this._cachedHistogramsList[m][f]&&(n=this._cachedHistogramsList[m][f],o=this.minValues.length?this.minValues[0]:n[0].min,h=this.maxValues.length?this.maxValues[0]:n[0].max,d=n[0].counts&&n[0].counts.length),l=this.classifyNClassesInput&&this.classifyNClassesInput.value||this._getDefaultNClasses(d),r=(h-o)/l),this.classifyIntervalInput.attr("value",r,!1)}},_setupUniqueValuesDefaults:function(){this.layer&&this.symbologyTypeSelect.store.get(this._symbologyTypes.uniqueValues)&&(this._showUniqueValuesLoadingMsg(),this._setupUniqueValuesGridDefaults())},_setupSymbologyDefaults:function(){this._setupSymbologyStore(),this._setSymbologySelectVisibility()},_setSymbologySelectVisibility:function(){var e=this._canApplyRenderer();n.toggle(this.symbologyTypeBlock,"esriRenderingRuleHidden",!e),n.toggle(this.symbologyTypeBlock,"esriRenderingRuleVisible",e)},_isSingleBitRaster:function(e){return e.replace(/^\D+/g,"")<=8},_setupSymbologyStore:function(){if(this.layer){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value),t=e&&e.serviceInfo?e.serviceInfo:null,s=this.layer.renderer,a=[],n=this.layer,r=t?t.bandCount:n.bandCount,l=t?t.hasRasterAttributeTable:n.hasRasterAttributeTable,o=t?t.pixelType:n.pixelType;this._canApplyRenderer()&&(a.push({name:this._symbologyTypes.stretch}),r&&1===r&&(l?(a.push({name:this._symbologyTypes.uniqueValues}),a.push({name:this._symbologyTypes.classify})):(n.currentVersion>=10.3&&a.push({name:this._symbologyTypes.classify}),this._isSingleBitRaster(o)&&this._hasServiceMinMax(n)&&a.push({name:this._symbologyTypes.uniqueValues})))),this._isSelectedRenderingRule(n.renderingRule)&&(this._isUniqueValueRenderer(s)&&!i.some(a,function(e){return e.name===this._symbologyTypes.uniqueValues},this)&&a.push({name:this._symbologyTypes.uniqueValues}),this._isClassBreaksRenderer(s)&&!i.some(a,function(e){return e.name===this._symbologyTypes.classify},this)&&a.push({name:this._symbologyTypes.classify})),i.forEach(a,function(e){e.label=this._i18n.widgets.renderingRule[e.name+"Label"],e.id=e.name},this),this.symbologyTypeSelect.set("store",new h({data:a})),this.symbologyType=this._getDefaultSymbologyType(),this.symbologyType&&this.symbologyTypeSelect.set("value",this.symbologyType),this._onSymbologyTypeChange(this.symbologyType)}},_canApplyRenderer:function(){if(this.layer){var e=this.layer.currentVersion,t=this.rasterFunctionList.value;return e>=10.3||t===this._defaultBandCombinationFncName}},_getDefaultUniqueValuesField:function(e){var t,s=["classname","class_name","class_names"];return i.some(e,function(e){var a,n=e&&e.name;if(n){if(a=n.toLowerCase(),i.indexOf(s,a)>-1)return t=n,!0;"value"===a&&(t=n)}}),t},_setupUniqueValuesFieldStore:function(){if(this.layer){var e,t=this._i18n.widgets.renderingRule.valueLabel;e=this._getRasterAttributeTableFields(),e||(e=[{name:t,alias:t,id:"Value"}]);var s=new h({data:e});s&&this.uniqueValuesFieldSelect&&this.uniqueValuesFieldSelect.set("store",s);var i;i=this._isUniqueValueRenderer(this.layer.renderer)?this.layer.renderer.attributeField:this._getDefaultUniqueValuesField(s.data),this.uniqueValuesFieldSelect.attr("value",i,!1)}},_setupStretchStatsGrid:function(){var s=this._i18n.widgets.renderingRule,i={sortable:!1,editor:H,editOn:"click",autoSave:!0,renderCell:t.hitch(this,this._stretchStatsRenderCell),canEdit:t.hitch(this,function(){return"6"!==this.stretchMethodList.value})};this._stretchStatsGrid=new(e([G,U]))({selectionMode:"single",className:"dgrid-autoheight",columns:[P(t.mixin({field:"esriRenderingRuleStretchMin",label:s.minLabel},i)),P(t.mixin({field:"esriRenderingRuleStretchMax",label:s.maxLabel},i)),P(t.mixin({field:"esriRenderingRuleStretchMean",label:s.meanLabel},i)),P(t.mixin({field:"esriRenderingRuleStretchStdv",label:s.stdDevLabel},i))]},this.stretchStatsGrid),this._stretchStatsGrid.startup()},_stretchStatsRenderCell:function(e,t,s){if(null===t||void 0===t||isNaN(t))return void(s.innerHTML="");s.innerHTML=Math.round(1e4*t)/1e4},_setupUniqueValuesGrid:function(){this._uniqueValuesGrid=new(e([G,U]))({selectionMode:"single",columns:[{field:"esriRenderingRuleUniqueValuesSymbol",sortable:!1,renderCell:t.hitch(this,function(e,s,i){var a=r.toDom('<div class = esriRenderingRuleSymbolCell style = "background: rgba( '+e.esriRenderingRuleUniqueValuesSymbol.r+", "+e.esriRenderingRuleUniqueValuesSymbol.g+", "+e.esriRenderingRuleUniqueValuesSymbol.b+","+255*e.esriRenderingRuleUniqueValuesSymbol.a+') " id = EsriRenderingRuleUniqueValuesGrid'+e.id+"></div>");r.place(a,i),a.onclick=t.hitch(this,function(e){this._openColorPickerPopup(e)})}),label:this._i18n.widgets.renderingRule.symbolLabel},{field:"esriRenderingRuleUniqueValuesValue",label:this._i18n.widgets.renderingRule.valueLabel},P({field:"esriRenderingRuleUniqueValuesLabel",sortable:!1,label:this._i18n.widgets.renderingRule.labelLabel,editor:O,editOn:"click",autoSave:!0})]},this.uniqueValuesGrid),this._uniqueValuesGrid.startup()},_setupClassifyGrid:function(){this._classifyGrid=new(e([G,U]))({className:"dgrid-autoheight",columns:[{field:"esriRenderingRuleClassifySymbol",sortable:!1,renderCell:t.hitch(this,function(e,s,i){var a=r.toDom('<div class = esriRenderingRuleSymbolCell style = "background: rgba( '+e.esriRenderingRuleClassifySymbol.r+", "+e.esriRenderingRuleClassifySymbol.g+", "+e.esriRenderingRuleClassifySymbol.b+","+255*e.esriRenderingRuleClassifySymbol.a+') " id = EsriRenderingRuleEditorClassifyGrid'+e.id+"></div>");r.place(a,i),a.onclick=t.hitch(this,function(e){this._openColorPickerPopup(e)})}),label:this._i18n.widgets.renderingRule.symbolLabel},P({field:"esriRenderingRuleClassifyValue",label:this._i18n.widgets.renderingRule.upperValueLabel,sortable:!1,editor:j,editOn:"click",autoSave:!0,autoSelect:!0,get:function(e){return this.editorInstance.constraints={maxValue:e.serviceMaxValue?e.serviceMaxValue:e.maxValue,minValue:e.minValue},"â¤ "+Math.floor(1e3*e.maxValue)/1e3},editorArgs:{required:!0,invalidMessage:this._i18n.widgets.renderingRule.outOfRangeMessage,notANumberMessage:this._i18n.widgets.renderingRule.notANumberMessage,blankMessage:this._i18n.widgets.renderingRule.blankMessage,validator:function(e,t){var s=!0;return e=e.replace("â¤","").trim(),null!==e&&" "!==e&&""!==e?isNaN(e)?(s=!1,this.promptMessage=this.params.notANumberMessage):(e<=t.minValue||e>=t.maxValue)&&(s=!1,this.promptMessage=this.params.invalidMessage):(s=!1,this.promptMessage=this.params.blankMessage),s}},set:t.hitch(this,this._setManualClassBreak)}),P({field:"esriRenderingRuleClassifyLabel",label:this._i18n.widgets.renderingRule.labelLabel,editor:O,editOn:"click",autoSave:!0,sortable:!1})]},this.classifyGrid),this._classifyGrid.startup()},_setManualClassBreak:function(e){if(e.esriRenderingRuleClassifyValue){this.classifyMethodSelect.set("value",this._classifyMethods.manualInterval);var t=this._getIntegerValue(e.esriRenderingRuleClassifyValue.replace("â¤","").trim()),s=e.maxValue;e.maxValue=t,e.esriRenderingRuleClassifyLabel=this._createLabelString(e.minValue,e.maxValue),i.some(this._classifySymbolData,function(e,i){e.minValue===s&&(e.minValue=t,e.esriRenderingRuleClassifyLabel=this._createLabelString(e.minValue,e.maxValue)),e.serviceMaxValue===s&&i!=this._classifySymbolData.length-1&&(e.serviceMaxValue=t)},this),this._classifyGrid.refresh()}},_createLabelString:function(e,t){return this._getIntegerValue(e)+" "+this._i18n.widgets.renderingRule.toLabel+" "+this._getIntegerValue(t)},_getIntegerValue:function(e){return Math.floor(1e3*e)/1e3},_setupClassifyGridDefaults:function(){if(this.layer&&this._isClassBreaksRenderer(this.layer.renderer)){var e=[],t=this.layer.renderer.infos;i.forEach(t,function(t){e.push({minValue:t.minValue,maxValue:t.maxValue,esriRenderingRuleClassifySymbol:t.symbol.color,esriRenderingRuleClassifyLabel:t.label})}),this._updateClassifyGrid(e)}},_setupUniqueValuesGridDefaults:function(){if(this.layer&&this._isUniqueValueRenderer(this.layer.renderer)){var e=[],t=this.layer.renderer.infos;i.forEach(t,function(t){e.push({esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesSymbol:t.symbol.color,esriRenderingRuleUniqueValuesLabel:t.label||t.value})}),this._updateUniqueValuesGrid(e)}},_setupClassifyNClassesInput:function(e){if(this.layer){var t=this._getDefaultMaxClasses(e),s=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.infos.length:this._getDefaultNClasses(e);this.classifyNClassesInput.attr("value",s,!1),this.classifyNClassesInput.set("constraints",{min:0,max:t})}},_getDefaultNClasses:function(e){return void 0===e?this._defaultNClasses:Math.min(this._defaultNClasses,e)},_getDefaultMaxClasses:function(e){return void 0===e?this._defaultMaxClasses:Math.min(this._defaultMaxClasses,e)},_isSelectedRenderingRule:function(e){var t,s=this._getStretchRenderingRule(e),i=this.rasterFunctionList.value;if(!e||this._isNoneRenderingRule(e)){if(this.rasterFunctionList.value===this._defaultBandCombinationFncName)return!0}else if(s){if((t=s.functionArguments)&&this._isSelectedRenderingRule(t.Raster))return!0}else if(i&&e.functionName.toLowerCase()===i.toLowerCase())return!0},_isUniqueValueRenderer:function(e){return e&&"esri.renderer.UniqueValueRenderer"===e.declaredClass},_isClassBreaksRenderer:function(e){return e&&"esri.renderer.ClassBreaksRenderer"===e.declaredClass},_isStretchRenderer:function(e){return e&&"esri.renderer.StretchRenderer"===e.declaredClass},_isNoneRenderingRule:function(e){return e&&e.functionName&&"none"===e.functionName.toLowerCase()},_getStretchRenderingRule:function(e){if(e)return e&&e.functionName&&"stretch"===e.functionName.toLowerCase()?e:e&&e.functionName&&"colormap"===e.functionName.toLowerCase()&&e.functionArguments&&e.functionArguments.Raster&&e.functionArguments.Raster.functionName&&"stretch"===e.functionArguments.Raster.functionName.toLowerCase()?e.functionArguments.Raster:void 0},_setupClassifyMethodStore:function(){if(this.layer){var e=[],t=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.classificationMethod:this._classifyMethods.equalInterval;for(var s in this._classifyMethods)this._classifyMethods.hasOwnProperty(s)&&e.push({label:"<div class= 'esriRenderingRuleFilteringSelectLabel'><h4 style='font-weight:bold;'>"+this._i18n.widgets.renderingRule[s]+"</h4><br/><i>"+this._i18n.widgets.renderingRule[s+"Desc"]+"</i></div>",id:this._classifyMethods[s],name:this._i18n.widgets.renderingRule[s]});this.classifyMethodSelect.set("store",new h({data:e})),this.classifyMethodSelect.set("labelType","html"),this.classifyMethodSelect.set("labelAttr","label"),this.classifyMethodSelect.attr("value",t,!1),this._handleClassifyIntervalVisibility(t)}},_setupClassifyFieldStore:function(){if(this.layer){var e,t=this._i18n.widgets.renderingRule.valueLabel,s=this._isClassBreaksRenderer(this.layer.renderer)?this.layer.renderer.attributeField:"Value";e=this.layer&&this.layer.rasterAttributeTable?this._getRasterAttributeTableFields(!0):[{name:t,alias:t,id:"Value"}],this.classifyFieldSelect.set("store",new h({data:e})),this.classifyFieldSelect.attr("value",s,!1)}},_getRasterAttributeTableFields:function(e){if(this.layer){var s=this.layer.id,a=this.rasterFunctionList.value,n=this._cachedRATList[s]&&this._cachedRATList[s][a],r=n||this.layer.rasterAttributeTable;if(r){var l,o=t.clone(r.fields);return l=i.filter(o,function(t){if("esriFieldTypeOID"!==t.type&&(!e||"esriFieldTypeString"!==t.type))return!0}),l=i.map(l,function(e){return e.id=e.name,e})}}},_setupFunctionStore:function(){if(!this.layer)return void console.log("Could not populate renderers as the layer does not exists");this._rasterFunctionStore=new h({data:this._rasterFunctionData,idProperty:"name"}),this.rasterFunctionList.set("store",this._rasterFunctionStore),this.rasterFunctionList.set("labelAttr","label"),this.rasterFunctionList.set("labelType","html");var e=this.layer.rasterFunctionInfos;e&&e.length>0&&e[0].name&&(this._firstFncInRenderingRuleList=e[0].name);var t=this.layer.renderingRule,s="";(s=t&&t.functionName&&!this._isNoneRenderingRule(t)?"stretch"!==t.functionName.toLowerCase()&&"colormap"!==t.functionName.toLowerCase()?t.functionName:this._getRenderingRuleNameFromStretchFunction(t)||this._defaultBandCombinationFncName:this._firstFncInRenderingRuleList&&"none"!==this._firstFncInRenderingRuleList.toLowerCase()&&!this.layer.bandIds?this._firstFncInRenderingRuleList:this._defaultBandCombinationFncName)&&(this._rasterFunctionStore.get(s)||"Colormap"===s)&&(this.rasterFunctionList.set("value",s),this._onRasterFunctionChange())},_fillRasterFunctionList:function(e){if(this.layer&&(this._rasterFunctionData=[],null!==e&&null!==e.extent)){var s=new R(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax,e.extent.spatialReference),a=s.getWidth(),n=s.getHeight();if(a/n>=2||n/a>=2){var r=Math.min(a,n)/2,l=s.getCenter();s.update(l.x-r,l.y-r,l.x+r,l.y+r,e.extent.spatialReference)}var o=s.xmin+","+s.ymin+","+s.xmax+","+s.ymax,h=e._getToken(),u="";h&&(u="&token="+h);var d=this.layer.url+"/exportImage?bbox="+o+u+"&imageSize=400,400&f=image",c=this.layer.bandIds,m=d+"&"+y.objectToQuery({renderingRule:'{"rasterFunction":"none"}'});c&&c.length>=3&&(m=m+"&bandIds="+c[0]+","+c[1]+","+c[2]),this._addFunctionItemToList(this._defaultBandCombinationFncName,this._defaultBandCombinationFncName,this._i18n.widgets.renderingRule.userDefinedRendererDesc,m,""),e.rasterFunctionInfos&&e.rasterFunctionInfos.length>0&&i.forEach(e.rasterFunctionInfos,t.hitch(this,function(e){if("none"!==e.name.toLowerCase()){if(e.thumbnail&&e.thumbnail.length>0)var t=e.thumbnail;else{var s='{"rasterFunction":"'+e.name+'"}';t=d+"&"+y.objectToQuery({renderingRule:s})}this._addFunctionItemToList(e.name,e.name,e.description,t)}}));var f={};f.layer=this.layer,f.data=this._rasterFunctionData,this._cachedFunctionList.push(f);var g;i.forEach(this.layer.rasterFunctionInfos,function(e){g=new p({rasterFunction:e.name}),this.layer.getRenderingRuleServiceInfo(g).then(t.hitch(this,function(t){i.some(this._rasterFunctionData,function(s,i){if(s.name===e.name)return this._rasterFunctionData[i].serviceInfo=t,e.name===this.rasterFunctionList.value&&(this._isVectorData(t)&&this._showVectorWarningIcon(),this._setupRFTDefaults()),!0},this)}))},this),this._setupFunctionStore()}},_addFunctionItemToList:function(e,t,s,i){var a={};a.name=e,a.id=t;var n=s;n.length>200&&(n=n.substring(0,200)+"..."),a.description=n,a.label="<html><body><section><h4>"+e+":</h4><table cellspacing='5'><tr><td><img src='"+i+"' height='100' width='100'></td><td><p style='white-space:pre-wrap;width:40ex'><i>"+n+"</i></p></td></tr></table></section></body></html>",this._rasterFunctionData.push(a)},_setupColorRampDefaults:function(){if(this.layer){var e=(this.layer.pixelType,this.layer.renderingRule);e&&(e.outputPixelType||this.layer.pixelType,e.functionName),this._setColorRampVisibility()}},_setColorRampVisibility:function(){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value),t=e?e.serviceInfo:null;if(!this._canApplyRenderer())return this._hideColorRampSelector();if(this.symbologyType===this._symbologyTypes.stretch){var s=t&&t.bandCount?t.bandCount:this.layer.bandCount,i=t&&t.pixelType?t.pixelType:this.layer.pixelType,a=this.layer.renderer,n=this.layer.renderingRule,r=this._getStretchRenderingRule(n);if(this._isSelectedRenderingRule(this.layer.renderingRule)){if(this._isStretchRenderer(a)&&a.colorRamp&&a.stretchType==this.stretchMethodList.value)return this._showColorRampSelector();if(n&&n.functionName&&"colormap"===n.functionName.toLowerCase()&&(r&&r.StretchType)===this.stretchMethodList.value)return this._showColorRampSelector()}s>1||this.layer.currentVersion<10.3||"u8"!==i.toLowerCase()&&"0"===this.stretchMethodList.value?this._hideColorRampSelector():this._showColorRampSelector()}else this._showColorRampSelector()},_setColorRampSelectValue:function(){if(this.layer){var e=this.layer.renderer,s=this.layer.renderingRule;if(this.symbologyType===this._symbologyTypes.stretch)this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._isStretchRenderer(e)&&this._isSelectedRenderingRule(this.layer.renderingRule)?this._setRendererColorRamp(e.colorRamp):s&&s.functionName&&"colormap"===s.functionName.toLowerCase()&&s.functionArguments&&s.functionArguments.colorRamp?this.colorRampSelect.setSelected(s.functionArguments.colorRamp):this._setStretchColorRamp();else{var i=e&&e.authoringInfo&&e.authoringInfo.colorRamp?k.fromJson(t.clone(e.authoringInfo.colorRamp)):null;this.symbologyTypeSelect.value===this._symbologyTypes.uniqueValues?(this._uniqueValuesColorRamp&&this.colorRampSelect.addColorRamp(this._uniqueValuesColorRamp),this._isUniqueValueRenderer(e)&&i?this._setRendererColorRamp(i):this._setUniqueValuesColorRamp()):this.symbologyTypeSelect.value===this._symbologyTypes.classify&&(this.colorRampSelect.removeColorRamp(this._uniqueValuesColorRamp),this._isClassBreaksRenderer(e)&&i?this._setRendererColorRamp(i):this._setClassifyColorRamp())}}},_setRendererColorRamp:function(e){if(!e||!this.layer)return void this.colorRampSelect.reset();this.colorRampSelect.setSelected(e)||this._addCustomColorRamp(e)},_hideColorRampSelector:function(){a.set(this.colorRampBlock,"display","none"),a.set(this.colorRampLabelBlock,"display","none"),this._colorRampVisible=!1},_showColorRampSelector:function(){this.layer&&(this._setColorRampSelectValue(),a.set(this.colorRampBlock,"display","table-row"),a.set(this.colorRampLabelBlock,"display","table-row"),this._colorRampVisible=!0)},_getDefaultSymbologyType:function(){if(this.layer){if(this._isSelectedRenderingRule(this.layer.renderingRule)){if(this.layer.renderer&&this.layer.renderer.declaredClass){var e=this.layer.renderer.declaredClass;if("esri.renderer.StretchRenderer"===e)return this._symbologyTypes.stretch;if("esri.renderer.ClassBreaksRenderer"===e)return this._symbologyTypes.classify;if("esri.renderer.UniqueValueRenderer"===e)return this._symbologyTypes.uniqueValues}if(this.layer.renderingRule){var t=this.layer.renderingRule;if(t&&t.functionName&&"stretch"===t.functionName.toLowerCase())return this._symbologyTypes.stretch;if(t&&t.functionName&&"colormap"===t.functionName.toLowerCase()&&t.functionArguments&&t.functionArguments.Raster&&t.functionArguments.Raster.functionName&&"stretch"===t.functionArguments.Raster.functionName.toLowerCase())return this._symbologyTypes.stretch}}if(this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][this.rasterFunctionList.value]){var s=this._cachedRATList[this.layer.id][this.rasterFunctionList.value];if(s.features.length&&this._ratContainsColormap(s))return this._symbologyTypes.uniqueValues}return this._canApplyRenderer()?this._symbologyTypes.stretch:void 0}},_setupBandIdDefaults:function(){if(this.layer){var e=3;e=this.layer.bandCount;var s=this.layer.id,i=this._cachedkeyProperties[s];if(!i&&e>1){this.msgLabel.style.display="",this.msgLabel.innerHTML="<i>"+this._i18n.widgets.renderingRule.bandNamesRequestMsg+"</i>";var a=this.layer.getKeyProperties();this._pendingDfds[s]=1,a.addBoth(t.partial(this._fillBandIdList,this,this.layer))}else this._fillBandIdList(this,this.layer,i);e<3?this._hideBandIds():this._showBandIds()}},_fillBandIdList:function(e,t,s){if(e.layer&&e.layer===t){var i=e._pendingDfds,a=e.layer.id;i&&i[a]&&delete i[a],e.msgLabel.style.display="none",e.msgLabel.innerHTML="";var n=3;n=e.layer.bandCount;var r;s&&s.BandProperties&&s.BandProperties.length>0&&(r=s.BandProperties);var l=e._getBandIdList(n,r,"");e._redBandIdStore=new h({data:l,idProperty:"name"}),e.bandIdsRedList.set("store",e._redBandIdStore),e.bandIdsRedList.set("labelAttr","label"),e.bandIdsRedList.set("labelType","html");var o=e._getBandIdList(n,r,"");e._greenBandIdStore=new h({data:o,idProperty:"name"}),e.bandIdsGreenList.set("store",e._greenBandIdStore),e.bandIdsGreenList.set("labelAttr","label"),e.bandIdsGreenList.set("labelType","html");var u=e._getBandIdList(n,r,"");e._blueBandIdStore=new h({data:u,idProperty:"name"}),e.bandIdsBlueList.set("store",e._blueBandIdStore),e.bandIdsBlueList.set("labelAttr","label"),e.bandIdsBlueList.set("labelType","html");var d=e.layer.bandIds;if(d&&d.length>2)e.bandIdsRedList.attr("value",e._getBandName(e._redBandIdStore,d[0]),!1),e.bandIdsGreenList.attr("value",e._getBandName(e._greenBandIdStore,d[1]),!1),e.bandIdsBlueList.attr("value",e._getBandName(e._blueBandIdStore,d[2]),!1);else if(e._redBandIdStore.data.length>0&&e._greenBandIdStore.data.length>1&&e._blueBandIdStore.data.length>2){var c=e._getRedBandIndex(r),m=e._getGreenBandIndex(r),y=e._getBlueBandIndex(r);e.bandIdsRedList.attr("value",e._redBandIdStore.data[c].name,!1),
e.bandIdsGreenList.attr("value",e._greenBandIdStore.data[m].name,!1),e.bandIdsBlueList.attr("value",e._blueBandIdStore.data[y].name,!1)}e._cachedkeyProperties[a]=s;e.rasterFunctionList.get("value")===e._defaultBandCombinationFncName&&e._enableBandIds()}},_getRedBandIndex:function(e){if(!this.layer||!e)return 0;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"red"===e[t].BandName.toLowerCase())return t;return 0},_getGreenBandIndex:function(e){if(!this.layer||!e)return 1;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"green"===e[t].BandName.toLowerCase())return t;return 1},_getBlueBandIndex:function(e){if(!this.layer||!e)return 2;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"blue"===e[t].BandName.toLowerCase())return t;return 2},_getBandIdList:function(e,t,s){if(this.layer){var i=[];s||(s="Black");var a=!1;t&&e===t.length&&(a=!0);var n;for(n=0;n<e;n++){var r=n,l=n;a&&t[n]&&t[n].BandName?r=t[n].BandName:r++;var o={};o.name=r,o.index=l,o.label="<html><body><span value="+l+"><font color="+s+">"+r+"</font></span></body></html>",i.push(o)}return i}},_showVectorWarningIcon:function(){a.set(this.vectorWarningIcon,"display","inline-block"),this._vectorWarningShown||this._showVectorWarning()},_showVectorWarning:function(){this._startupCalled&&(q.open({popup:this._vectorTooltipDlg,around:this.vectorWarningIcon,orient:["below"],onCancel:this._hideVectorWarning}),this._vectorWarningShown=!0)},_hideVectorWarning:function(){q.close(this._vectorTooltipDlg)},_hideVectorWarningIcon:function(){a.set(this.vectorWarningIcon,"display","none"),q.close(this._vectorTooltipDlg)},_showClassifyLoadingMsg:function(){a.set(this.classifyLoadingMsg,"display","block")},_hideClassifyLoadingMsg:function(){a.set(this.classifyLoadingMsg,"display","none")},_showUniqueValuesLoadingMsg:function(){a.set(this.uniqueValuesLoadingMsg,"display","block")},_hideUniqueValuesLoadingMsg:function(){a.set(this.uniqueValuesLoadingMsg,"display","none")},_createVectorLayer:function(){this.emit("vector-rft-select",{layer:this.layer,rasterFunctionTemplate:this.rasterFunctionList.value}),this._hideVectorWarning()},_getBandName:function(e,t){if(e&&e.data){var s;for(s=0;s<e.data.length;s++){var i=e.data[s];if(i.index===t)return i.name}return""}},_setupStretchDefaults:function(){if(this.layer){var e=this.layer.renderingRule,t=this._getStretchRenderingRule(e);this._isSelectedRenderingRule(this.layer.renderingRule)&&(this._isStretchRenderer(this.layer.renderer)||t)?this._isStretchRenderer(this.layer.renderer)?this._loadStretchRenderer(this.layer.renderer):t&&this._loadStretchFunction(t):(this.stretchMethodList.attr("value","0",!1),this._onStretchMethodChange(),this.numStdDevText.set("value",2),this.minPercentText.set("value",2),this.maxPercentText.set("value",2),this.gammaSlider.setValue(0),this._updateStretchStatsGrid(),this._getServiceMinAndMax(),this.minValues&&this.minValues.length>0&&this.maxValues&&this.maxValues.length>0?this.draCheckbox.checked=!1:this.draCheckbox.checked=!0),this._gammaSliderTooltip||(this._gammaSliderTooltip=new A({connectId:["gammaSliderID"],position:["below","above"],id:"gammaSliderTooltipID"}))}},_hasServiceMinMax:function(e){return e.minValues&&e.minValues.length>0&&e.maxValues&&e.maxValues.length>0},_getServiceMinAndMax:function(){var e=this._getCurrentServiceInfo();this.minValues=e&&e.minValues,this.maxValues=e&&e.maxValues},_loadStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){this._stretchReadFromRenderingRule=!0;var t=e.functionArguments,s=t.StretchType;if(this.stretchMethodList.attr("value",s.toString(),!1),this._onStretchMethodChange(),t.NumberOfStandardDeviations&&this.numStdDevText.set("value",t.NumberOfStandardDeviations),this.draCheckbox.checked=!!t.DRA,t.UseGamma){var i=t.Gamma;t.Gamma.length>0&&(i=t.Gamma[0]);var a=Math.log(i)/Math.log(10);a&&this.gammaSlider.setValue(a)}t.MinPercent&&this.minPercentText.set("value",t.MinPercent),t.MaxPercent&&this.maxPercentText.set("value",t.MaxPercent),t.Statistics&&t.Statistics.length&&this._loadStretchStats(t.Statistics)}},_loadStretchRenderer:function(e){if(this._isStretchRenderer(e)){this._stretchReadFromRenderingRule=!1;var t=e._convertStretchTypeEnumToIndex(e.stretchType);if(this.stretchMethodList.set("value",t.toString()),this._onStretchMethodChange(),e.numberOfStandardDeviations&&this.numStdDevText.set("value",e.numberOfStandardDeviations),this.draCheckbox.checked=!!e.dra,e.useGamma){var s=e.gamma;e.gamma.length>0&&(s=e.gamma[0]);var i=Math.log(s)/Math.log(10);i&&this.gammaSlider.setValue(i)}e.minPercent&&this.minPercentText.set("value",e.minPercent),e.maxPercent&&this.maxPercentText.set("value",e.maxPercent),e.statistics&&e.statistics.length&&this._loadStretchStats(e.statistics)}},_loadStretchStats:function(e){if(e&&e.length){var t=[];i.forEach(e,function(e){e&&e.length&&t.push({esriRenderingRuleStretchMin:e[0],esriRenderingRuleStretchMax:e[1],esriRenderingRuleStretchMean:e[2],esriRenderingRuleStretchStdv:e[3]})}),this._updateStretchStatsGrid(t),this._setStretchStatsGridVisibility()}},_getRenderingRuleNameFromStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){var t=e.functionArguments,s=t.Raster;return s&&s.functionName||null}},_fillStretchMethodList:function(){this.stretchMethodList.removeOption(this.stretchMethodList.getOptions()),this.stretchMethodList.addOption([{value:"0",label:this._i18n.widgets.renderingRule.noneStretchAlias},{value:"5",label:this._i18n.widgets.renderingRule.minMaxStretchAlias},{value:"3",label:this._i18n.widgets.renderingRule.stdDevStretchAlias},{value:"6",label:this._i18n.widgets.renderingRule.percentClipStretchAlias}]),this.stretchMethodList.set("value","0"),this._onStretchMethodChange()},_onDRAChange:function(){this.symbologyType===this._symbologyTypes.stretch&&"0"!==this.stretchMethodList.value&&(this._updateStretchStatsGrid(),this._setStretchStatsGridVisibility())},_setStretchStatsGridVisibility:function(){var e=this.stretchMethodList.value,t="0"!==e&&!this.draCheckbox.checked&&this._stretchStatsData&&this._stretchStatsData.length?"":"none";n.toggle(this.stretchStatsBlock,"esriRenderingRuleDisabledGrid","6"===e),this.stretchStatsBlock.style.display=t},_getCurrentServiceInfo:function(){var e=this._rasterFunctionStore&&this._rasterFunctionStore.get(this.rasterFunctionList.value);return this.rasterFunctionList.value===this._defaultBandCombinationFncName?this.layer:e&&e.serviceInfo?e.serviceInfo:this.layer},_updateStretchStatsGrid:function(e){if(this._stretchStatsGrid){if(!e||"number"==typeof e||"string"==typeof e){var t,s,a,n,r=this._getCurrentServiceInfo(),l=r&&r.bandCount,o={},u=["minValues","maxValues","meanValues","stdvValues"],c=0,m=1,y=2;e=[],i.forEach(u,function(e){o[e]=r&&r[e]?r[e]:this.layer[e]?this.layer[e]:new Array(l)},this),this.rasterFunctionList.value===this._defaultBandCombinationFncName&&l>=3&&(s=this._redBandIdStore&&this._redBandIdStore.get(this.bandIdsRedList.value),a=this._greenBandIdStore&&this._greenBandIdStore.get(this.bandIdsGreenList.value),n=this._blueBandIdStore&&this._blueBandIdStore.get(this.bandIdsBlueList.value),c=s?s.index:c,m=a?a.index:m,y=n?n.index:y),t=l>=3?[c,m,y]:[c],i.forEach(t,function(t,s){e.push({id:s,esriRenderingRuleStretchMin:o.minValues[t],esriRenderingRuleStretchMax:o.maxValues[t],esriRenderingRuleStretchMean:o.meanValues[t],esriRenderingRuleStretchStdv:o.stdvValues[t]})})}e=this._sanitizeStretchStatsData(e);var f=new d(new h({data:e,idProperty:"id"}));this._stretchStatsGrid.set("store",f),this._stretchStatsData=e}},_onSymbologyTypeChange:function(e){if(this.layer){this.symbologyType=e;var t=this.layer.renderer,s=this.layer.renderingRule,i=this._getStretchRenderingRule(s),a=this._isSelectedRenderingRule(s);this._showBlocks([]),e===this._symbologyTypes.classify?(this._showBlocks([this.classifyBlock,this.classifyGridBlock]),this._isClassBreaksRenderer(t)&&a?this._setupClassifyGridDefaults():this._updateClassifyGrid()):e===this._symbologyTypes.uniqueValues?(this._showBlocks([this.uniqueValuesBlock,this.uniqueValuesGridBlock]),this._isUniqueValueRenderer(t)&&a?this._setupUniqueValuesGridDefaults():this._updateUniqueValuesGrid()):e===this._symbologyTypes.stretch&&(a?this._isStretchRenderer(t)?this._loadStretchStats(t.statistics):i&&i.functionArguments?this._loadStretchStats(i.functionArguments.Statistics):this._updateStretchStatsGrid():this._updateStretchStatsGrid(),this._showBlocks([this.stretchBlock]))}},_onClassifyFieldChange:function(){this.classifyMethodSelect.value===this._classifyMethods.definedInterval&&this._setDefaultIntervalSize(),this._updateClassifyGrid()},_onClassifyMethodChange:function(e){this.classifyMethodSelect.value!==this._classifyMethods.manualInterval&&(this.classifyMethodSelect.value===this._classifyMethods.definedInterval&&this._setDefaultIntervalSize(),this._handleClassifyIntervalVisibility(e),this._updateClassifyGrid())},_handleClassifyIntervalVisibility:function(e){e===this._classifyMethods.definedInterval?(a.set(this.classifyIntervalsBlock,"display","table-row"),this.classifyNClassesInput.set("disabled",!0)):(a.set(this.classifyIntervalsBlock,"display","none"),this.classifyNClassesInput.set("disabled",!1))},_showBlocks:function(e){i.forEach(this._symbologyBlocks,function(t){i.indexOf(e,t)>-1?(n.remove(t,"esriRenderingRuleHidden"),n.add(t,"esriRenderingRuleVisible")):(n.remove(t,"esriRenderingRuleVisible"),n.add(t,"esriRenderingRuleHidden"))}),this._setColorRampVisibility()},_onRasterFunctionChange:function(){var e=this.rasterFunctionList.get("value");if(e){var t=this._rasterFunctionStore.get(e).description,s=this._isVectorData(this._getCurrentServiceInfo());this._setupRFTDefaults(),this.rasterFunctionList.set("title",t),s?this._showVectorWarningIcon():this._hideVectorWarningIcon();var i=this.layer.id;this._setColorRampVisibility(),e===this._defaultBandCombinationFncName?(this.rasterFunctionRow.width="",this.layer.bandCount>1?(this._showBandIds(),this._pendingDfds[i]?this._disableBandIds():this._enableBandIds()):this._hideBandIds()):(this.domNode.clientWidth>0&&(this.rasterFunctionRow.width=this.domNode.clientWidth),this._hideBandIds()),e===this._defaultBandCombinationFncName||this.layer.version>=10.3?(this.imageEnhancementLabel.style.display="",this.stretchMethodLabel.style.display="",this.stretchDescLabel.style.display="",this.stretchMethodList.domNode.style.display="",this._onStretchMethodChange()):this._hideStretch()}},_isVectorData:function(e){var t=e&&e.serviceDataType;return"esriImageServiceDataTypeVector-UV"===t||"esriImageServiceDataTypeVector-MagDir"===t},_setClassifyColorRamp:function(){this.colorRampSelect.setSelected("Yellow to Red")},_setUniqueValuesColorRamp:function(){this._uniqueValuesColorRamp?this.colorRampSelect.setSelected(this._uniqueValuesColorRampName):this.colorRampSelect.setSelected("Aspect")},_setStretchColorRamp:function(){this.colorRampSelect.reset()},_updateUniqueValuesGrid:function(e,t){if(this._uniqueValuesGrid&&(e=e&&e.length&&e[0].esriRenderingRuleUniqueValuesSymbol?e:this._getUniqueValuesGridData(t))&&e.length){void 0===e[0].id&&i.forEach(e,function(e,t){e.id=t});var s=new u(new h({data:e,idProperty:"id"}));this._uniqueValuesGrid.set("store",s),this._uniqueValuesSymbolData=e,this._hideUniqueValuesLoadingMsg()}},_updateClassifyGrid:function(e,t){if(this._classifyGrid&&(e=e&&e.length&&e[0].esriRenderingRuleClassifySymbol?e:this._getClassifyGridData(t))&&e.length){var s=e[0]?e[0].maxValue-e[0].minValue:this.classifyIntervalInput.value;void 0===e[0].id&&i.forEach(e,function(e,t){e.id=t});var a=new d(new h({data:e,idProperty:"id"}));this._classifyGrid.set("store",a),this._classifySymbolData=e,this.classifyIntervalInput.attr("value",s,!1),this.classifyNClassesInput.attr("value",e.length,!1),this._hideClassifyLoadingMsg()}},_openColorPickerPopup:function(e){if(!this._colorPickerOpen){e.stopPropagation(),this._colorPicker||(this._colorPicker=new C({showTransparencySlider:!1}),this._colorPicker.startup());var s,a,n=e.target;this._colorPicker.set("color",n.style.backgroundColor,!1),q.open({popup:this._colorPicker,around:n,orient:["below","above"]}),this._colorPickerOpen=!0,s=m(document.body,"click",t.hitch(this,function(e){this._colorPicker.domNode.contains(e.target)||e.target===this._colorPicker.domNode||(a.remove(),s.remove(),q.close(this._colorPicker),this._colorPickerOpen=!1)})),a=m(this._colorPicker,"color-change",t.hitch(this,function(e){s.remove(),a.remove();var r=e.color,l=this.symbologyType===this._symbologyTypes.classify?parseInt(n.id.replace("EsriRenderingRuleEditorClassifyGrid",""),10):parseInt(n.id.replace("EsriRenderingRuleUniqueValuesGrid",""),10);q.close(this._colorPicker),this._colorPickerOpen=!1,"no-color"===r?n.style.background="rgba(0,0,0,0)":(r.a=1,n.style.background="rgba("+r.r+", "+r.g+","+r.b+", 255)"),this.symbologyType===this._symbologyTypes.classify?i.some(this._classifySymbolData,t.hitch(this,function(e){if(e.id===l)return e.esriRenderingRuleClassifySymbol={r:r.r,g:r.g,b:r.b,a:r.a}})):i.some(this._uniqueValuesSymbolData,t.hitch(this,function(e){if(e.id===l)return e.esriRenderingRuleUniqueValuesSymbol={r:r.r,g:r.g,b:r.b,a:r.a}}))}))}},_onColorRampChange:function(){return this.symbologyType===this._symbologyTypes.uniqueValues?this._updateUniqueValuesGrid(null,!0):this.symbologyType===this._symbologyTypes.classify?this._updateClassifyGrid(null,!0):void 0},_onStretchMethodChange:function(){if(!(this.stretchMethodList.getOptions.length<1)){var e=this.stretchMethodList.get("value");switch("0"===e?this._hideStretchOptions(!0):this._hideStretchOptions(!1),"6"!==e||this.draCheckbox.checked||this._updateStretchStatsGrid(),this._setColorRampVisibility(),this._setStretchStatsGridVisibility(),e){case"0":this.stretchMethodNoneDescBlock.style.display="";break;case"3":this.numStdDevBlock.style.display="";break;case"5":this.stretchMethodMinMaxDescBlock.style.display="";break;case"6":this.minMaxPercentDescBlock.style.display="",this.minPercentBlock.style.display="",this.maxPercentBlock.style.display=""}}},_onClickApplyRenderingRule:function(){this.rasterFunctionList.get("value")!==this._defaultBandCombinationFncName?this._onRasterFunctionApply():this._onBandIdsApply()},_onClickResetRenderingRule:function(){this.layer&&(this.layer.renderingRule=null,this.layer.bandIds=null,this.layer.renderer=null,this._setupDefaults(),this._onClickApplyRenderingRule())},_onRasterFunctionApply:function(){if(!this._donotSaveChanges&&this.layer){var e,t=[];this.layer.setBandIds(t,!0);var s=new p;s.functionName=this.rasterFunctionList.get("value");var i=this._getStretchFunction();this.layer.version>=10.3?this.symbologyType===this._symbologyTypes.stretch&&this._stretchReadFromRenderingRule?i&&(i.functionArguments.Raster=s,this._colorRampVisible&&"none"!==this.colorRampSelect.value?(e=this._getColorMapFunction(),e.functionArguments.Raster=i,this.layer.setRenderingRule(e)):this.layer.setRenderingRule(i)):(this._onRendererApply(!0),this.layer.setRenderingRule(s)):(this.layer.setRenderer(null,!0),this.layer.setRenderingRule(s))}},_onBandIdsApply:function(){if(!this._donotSaveChanges&&this.layer){var e=new p({functionName:"none"});if(!this._redBandIdStore||!this.bandIdsGreenList||!this.bandIdsBlueList)return this.layer.setRenderingRule(e,!0),void this._onRendererApply(!1);var t=[],s=this._redBandIdStore.get(this.bandIdsRedList.value),i=this._greenBandIdStore.get(this.bandIdsGreenList.value),a=this._blueBandIdStore.get(this.bandIdsBlueList.value);s&&i&&a&&(t.push(s.index),t.push(i.index),t.push(a.index)),this.layer.setRenderingRule(e,!0),this._onRendererApply(!0),this.layer.setBandIds(t)}},_onRendererApply:function(e){!this._donotSaveChanges&&this.layer&&(this.symbologyType===this._symbologyTypes.classify?this._onClassifyApply(e):this.symbologyType===this._symbologyTypes.uniqueValues?this._onUniqueValuesApply(e):this._onStretchApply(e))},_onStretchApply:function(e){if(!this._donotSaveChanges&&this.layer)if(this._stretchReadFromRenderingRule){var t,s=this._getStretchFunction();this._colorRampVisible&&"none"!==this.colorRampSelect.value?(t=this._getColorMapFunction(),t.functionArguments.Raster=s,this.layer.setRenderingRule(t)):this.layer.setRenderingRule(s,e)}else{if("0"===this.stretchMethodList.value&&(!this._colorRampVisible||"none"==this.colorRampSelect.value))return this.layer.setRenderer(null,e);var i=new F,a=this.stretchMethodList.get("value");i.stretchType=i._convertStretchTypeIndexToEnum(parseInt(a,10)),i.dra=!!this.draCheckbox.checked;var n=Math.exp(this.gammaSlider.value*Math.log(10));n=parseFloat(parseFloat(n).toFixed(2));var r=[];r.push(n),this.layer.bandCount>1&&(r.push(n),r.push(n)),6==a&&(i.minPercent=this.minPercentText.value,i.maxPercent=this.maxPercentText.value),3==a&&(i.numberOfStandardDeviations=this.numStdDevText.value),i.statistics=this._getStretchStats(),i.gamma=r,i.useGamma=!0,i.outputPixelType="U8",this._colorRampVisible&&"none"!==this.colorRampSelect.value&&(i.colorRamp=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName)),this.layer.setRenderer(i,e)}},_getStretchStats:function(){var e=this._getCurrentServiceInfo().bandCount,t=[],s=this._stretchStatsData;if(e&&!this.draCheckbox.checked&&"6"!==this.stretchMethodList.value&&"0"!==this.stretchMethodList.value&&this._isStretchGridDataValid()){var i;for(i=0;i<Math.min(e,3);i++)t.push([s[i].esriRenderingRuleStretchMin,s[i].esriRenderingRuleStretchMax,s[i].esriRenderingRuleStretchMean,s[i].esriRenderingRuleStretchStdv]);return t}return[]},_onUniqueValuesApply:function(e){var t=new M,s=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName);s&&(t.authoringInfo={},t.authoringInfo.colorRamp=s.toJson()),t.infos=this._getUniqueValueInfos(this._uniqueValuesSymbolData),t.attributeField=this.uniqueValuesFieldSelect.value,this.layer.setRenderer(t,e)},_getUniqueValueInfos:function(e){var t,s=[];return i.forEach(e,function(e){t=e.esriRenderingRuleUniqueValuesSymbol,(isNaN(t.r)||isNaN(t.g)||isNaN(t.b))&&(t={r:0,g:0,b:0,a:0});var i=new T("solid",null,new B(t));s.push({value:e.esriRenderingRuleUniqueValuesValue,label:e.esriRenderingRuleUniqueValuesLabel.toString(),symbol:i})}),s},_onClassifyApply:function(e){var t,s;s=this._convertColorRamps(this.colorRampSelect.colorRamp,this.colorRampSelect.colorRampName),t=new x({field:this.classifyFieldSelect.value,showInAscendingOrder:!0,classificationMethod:this.classifyMethodSelect.value}),s&&(t.authoringInfo={},t.authoringInfo.colorRamp=s.toJson()),t.infos=this._getClassBreakInfos(),t.minimumBreak=t.infos.minValue,t.attributeField=this.classifyFieldSelect.value,this.layer.setRenderer(t,e)},_getClassBreakInfos:function(){var e,t,s=[];return i.forEach(this._classifySymbolData,function(i,a){e=i.esriRenderingRuleClassifySymbol,(isNaN(e.r)||isNaN(e.g)||isNaN(e.b))&&(e={r:0,g:0,b:0,a:0}),t=new T("solid",null,new B(e)),s.push({minValue:i.minValue,maxValue:i.maxValue,label:i.esriRenderingRuleClassifyLabel,symbol:t})}),s},_getStretchFunction:function(){var e=this.stretchMethodList.get("value"),t=null;return"0"!==e&&(t=new p,t.functionName="Stretch",this._buildStretchFunction(t)),t},_buildStretchFunction:function(e){e.functionName="Stretch";var t=this.stretchMethodList.get("value"),s={};s.StretchType=parseInt(t,10),s.DRA=!!this.draCheckbox.checked;var i=Math.exp(this.gammaSlider.value*Math.log(10));i=parseFloat(parseFloat(i).toFixed(2));var a=[];a.push(i),this.layer.bandCount>1&&(a.push(i),a.push(i)),s.Gamma=a,s.UseGamma=!0,"3"===t?(s.NumberOfStandardDeviations=this.numStdDevText.value,e.outputPixelType="U8"):"6"===t?(s.MinPercent=parseFloat(this.minPercentText.value),s.MaxPercent=parseFloat(this.maxPercentText.value),e.outputPixelType="U8"):"5"===t&&(e.outputPixelType="U8"),s.Statistics=this._getStretchStats(),e.functionArguments=s},_onGammaChange:function(e){var t=this._gammaSliderTooltip;if(t&&this.symbologyTypeSelect.value===this._symbologyTypes.stretch){var s=Math.exp(e*Math.log(10));t.label=s?parseFloat(s).toFixed(2):e,t.open("gammaSliderID")}},_onGammaMouseLeave:function(){this.gammaTooltipClose()},_disableBandIds:function(){this.bandIdsRedList.set("disabled",!0),this.bandIdsGreenList.set("disabled",!0),this.bandIdsBlueList.set("disabled",!0),this.bandIdsLabel.style.color="Gray"},_enableBandIds:function(){this.bandIdsRedList.set("disabled",!1),this.bandIdsGreenList.set("disabled",!1),this.bandIdsBlueList.set("disabled",!1),""===this.bandIdsRedList.value&&this.bandIdsRedList.attr("value","1",!1),""===this.bandIdsGreenList.value&&this.bandIdsGreenList.attr("value","2",!1),""===this.bandIdsBlueList.value&&this.bandIdsBlueList.attr("value","3",!1),this._isStretchRenderer(this.layer.renderer)||this._getStretchFunction(this.layer.renderingRule)||this._updateStretchStatsGrid(),this.bandIdsLabel.style.color="Black"},_showBandIds:function(){this.bandIdsLabelBlock.style.display="",this.bandIdsBlock.style.display="",this.bandIdsMsgBlock.style.display=""},_hideBandIds:function(){this.bandIdsLabelBlock.style.display="none",this.bandIdsBlock.style.display="none",this.bandIdsMsgBlock.style.display="none"},_hideStretch:function(){this.imageEnhancementLabel.style.display="none",this.stretchDescLabel.style.display="none",this.stretchMethodLabel.style.display="none",this.stretchMethodList.domNode.style.display="none",this._hideStretchOptions(!0)},_hideStretchOptions:function(e){var t="";e&&(t="none"),this.gammaBlock.style.display=t,this.draBlock.style.display=t,this.stretchMethodNoneDescBlock.style.display="none",this.stretchMethodMinMaxDescBlock.style.display="none",this.numStdDevBlock.style.display="none",this.minMaxPercentDescBlock.style.display="none",this.minPercentBlock.style.display="none",this.maxPercentBlock.style.display="none",this.stretchStatsBlock.style.display="none"},_getDefaultRedBandIndex:function(){var e;return this._redBandIdStore&&(e=this._redBandIdStore.get("Red")),e||(e=1),e},_getClassifyGridData:function(e){this.classifyMethod=this.classifyMethodSelect.value===this._classifyMethods.manualInterval?this.classifyMethod:this.classifyMethodSelect.value;var t=Math.min(this.classifyNClassesInput.value,this.classifyNClassesInput.constraints&&this.classifyNClassesInput.constraints.max),s=this.colorRampSelect.colorRamp,a=this.classifyIntervalInput.value,n=this.classifyFieldSelect.value;if(this._classifySymbolData||(e=!1),this.layer&&this.classifyMethod&&t&&s){var r=e?this._classifySymbolData:this._getClassBreaks(this.classifyMethod,t,n,a);if(r){var l,o=k.convertColorRampToColormap(s,r.length),h=e?this._classifySymbolData:[];return t=r.length,i.forEach(r,function(s,i){l={r:o[i][1],g:o[i][2],b:o[i][3],a:1},e?h[i].esriRenderingRuleClassifySymbol=l:h.push({esriRenderingRuleClassifySymbol:l,minValue:s.minValue,maxValue:s.maxValue,serviceMaxValue:i===t-1?s.maxValue:r[i+1].maxValue,esriRenderingRuleClassifyLabel:this._createLabelString(s.minValue,s.maxValue)})},this),h}}},_getClassBreaks:function(e,t,s,a){var n,r,l,o=this._cachedHistogramsList&&this._cachedHistogramsList[this.layer.id]?this._cachedHistogramsList[this.layer.id][this.rasterFunctionList.value]:null,h=this._cachedRATList&&this._cachedRATList[this.layer.id]?this._cachedRATList[this.layer.id][this.rasterFunctionList.value]:null;if(this.layer&&(h||o)){if(h){var u=h.features,d=[];return u.sort(this._getSortFeaturesFun(s)),n=r=u[0].attributes[s],i.forEach(u,function(e){e.attributes.Count&&d.push(e.attributes.Count),l=e.attributes[s],l<n&&(n=l),l>r&&(r=l)}),a&&(r-n)/a>16&&(a=(r-n)/16),V.calculateClassBreaks(u,null,s,null,null,e,t,null,d,a)}return o&&o.length&&o[0].dataPoints&&o[0].counts?(n=o[0].dataPoints[0],r=o[0].dataPoints[o[0].dataPoints.length-1],a&&(r-n)/a>16&&(a=(r-n)/16),V.calculateClassBreaks(null,o[0].dataPoints,null,null,null,e,t,null,o[0].counts,a)):void 0}},_getSortFeaturesFun:function(e){return function(t,s){return t=t.attributes[e],s=s.attributes[e],t-s}},_getUniqueValuesGridData:function(e){var t=this._getCurrentServiceInfo(),s=t&&t.hasRasterAttributeTable?t.hasRasterAttributeTable:this.layer.hasRasterAttributeTable,a=this.layer.rasterAttributeTable,n=this.rasterFunctionList.value,r=this._cachedHistogramsList&&this._cachedHistogramsList[this.layer.id]?this._cachedHistogramsList[this.layer.id][this.rasterFunctionList.value]:null,l=r&&r.length&&r[0].dataPoints;n!==this._defaultBandCombinationFncName&&this._cachedRATList[this.layer.id]&&this._cachedRATList[this.layer.id][n]&&(a=this._cachedRATList[this.layer.id][n]);var o,h,u,d,c,m,y=this.colorRampSelect.colorRamp,f=this.uniqueValuesFieldSelect.value,g=y&&y.colorRamps?y.colorRamps.length:1,p=[],R=[],b=0,v=0;if(e?R=o=this._uniqueValuesSymbolData:s?(o=a.features,o=this._sortFeatures(o,f)):l&&(o=r[0].dataPoints),y&&o&&f){for(v=0;v<g;v++)p[v]={},p[v].start=b,p[v].end=b+1/g,b=p[v].end;return i.forEach(o,function(t,s){if(y!==this._uniqueValuesColorRamp)c=(s+.5)/o.length,i.forEach(p,function(i,a){if(c>=i.start&&c<i.end)if(m=(c-i.start)/(i.end-i.start),p.length>1?(h=S.getDojoColor(y.colorRamps[a].fromColor),u=S.getDojoColor(y.colorRamps[a].toColor)):(h=S.getDojoColor(y.fromColor),u=S.getDojoColor(y.toColor)),d=k.interpolateLabColor(h,u,m),e)o[s].esriRenderingRuleUniqueValuesSymbol=S.correctRGBLimits(d);else{var n=l?Math.round(t):t.value;R.push({esriRenderingRuleUniqueValuesSymbol:S.correctRGBLimits(d),esriRenderingRuleUniqueValuesValue:n,esriRenderingRuleUniqueValuesLabel:_.isDefined(n)?n.toString():"",features:l?t:t.features})}},this);else if(t.features&&t.features[0]){var a=this._getFeatureRGBValue(t.features[0].attributes);e?t.esriRenderingRuleUniqueValuesSymbol={r:a[0],g:a[1],b:a[2],a:1}:R.push({esriRenderingRuleUniqueValuesSymbol:{r:a[0],g:a[1],b:a[2],a:1},esriRenderingRuleUniqueValuesValue:t.value,esriRenderingRuleUniqueValuesLabel:_.isDefined(t.value)?t.value.toString():"",features:t.features})}},this),R}},_areFieldValuesUnique:function(e,t){var s=[];return!i.some(t,function(t){if(s.indexOf(t.attributes[e])>-1)return!0;s.push(t.attributes[e])})},_sortFeatures:function(e,s){if(e&&s){e=t.clone(e);var a=[],n=[];return this._areFieldValuesUnique(s,e)||e.sort(t.hitch(this,function(e,t){if("string"==typeof e.attributes[s]){var i=e.attributes[s],a=t.attributes[s];return this._isRangeValue(i,a)&&(i=parseFloat(i.split("-")[0]),a=parseFloat(a.split("-")[0])),i<a?-1:1}return e.attributes[s]-t.attributes[s]})),i.forEach(e,function(e,t){var i=e.attributes[s];t>0&&n.indexOf(i)>-1?a[n.indexOf(i)].features.push(e):(n.push(i),a.push({value:i,features:[e]}))}),a}},_isRangeValue:function(e,t){return(e.indexOf("-")>=0||t.indexOf("-")>=0)&&!isNaN(parseFloat(e.split("-")[0]))},_getColorRGB:function(e){return{r:e[0],g:e[1],b:e[2]}},_isStretchGridDataValid:function(){var e,t=this._stretchStatsData;return!(!t||!t.length)&&i.some(t,function(t){for(var s in t)if(e=t[s],t.hasOwnProperty(s)&&"id"!==s&&void 0!==e&&null!==e&&!isNaN(e))return!0})},_sanitizeStretchStatsData:function(e){if(e)return i.forEach(e,function(e){for(var t in e)void 0===e[t]&&(e[t]=null)}),e},_convertColorRamps:function(e,t){if(e){var s=null;if(e.type&&"multipart"==e.type.toLowerCase()){s=new I;var a=[];i.forEach(e.colorRamps,function(e){var t=new L;t.algorithm="hsv",t.fromColor=new B(e.fromColor),t.toColor=new B(e.toColor),a.push(t)}),s.colorRamps=a}else s=new L,s.algorithm="hsv",s.fromColor=new B(e.fromColor),s.toColor=new B(e.toColor);return s.name=t,s}},gammaTooltipClose:function(){this._gammaSliderTooltip&&this._gammaSliderTooltip.close()}});return c("extend-esri")&&t.setObject("dijit.RenderingRule",E,g),E});