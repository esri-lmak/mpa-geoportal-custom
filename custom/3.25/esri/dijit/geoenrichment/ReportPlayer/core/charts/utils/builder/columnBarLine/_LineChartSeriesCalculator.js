// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartTypes","../../ChartLineStyles","../../ChartLineMarkers","../../AxisUtil","../utils/TooltipInfoBuilder","../ChartPlots","esri/dijit/geoenrichment/utils/ColorUtil","./_AxisBuilder","./_PointLabelUtil","./_StatsBuilder"],function(e,i,r,a,t,s,n,o,l,u,m,p){var S={calcLineStyle:function(e,s,n,o){var u=o.comparisonInfo,m=o.themeSettings,p=o.visualProperties,S=i.calcColorForPoint({point:null,seriesItem:e,pointIndex:0,seriesIndex:s,numSeries:n.length,chartType:r.LINE,themeSettings:m,isComparisonSeries:e.isComparisonSeries,comparisonInfo:u,isMultiFeature:o.isMultiFeatureChart}),c=e.lineThickness||p.lineThickness||1,h=p.fillLineArea?p.lineAreaOpacity:1,I=e.lineStyle||a.SOLID,d=void 0;if(e.isComparisonSeries&&u?(u.lineThickness&&(c=u.lineThickness),u.lineStyle&&(I=u.lineStyle),d=u.lineMarker?t.getMarkerPath(u.lineMarker):i.getComparisonSymbol()):o.viewModel.isGraphicStyle&&(d=e.lineMarker&&t.getMarkerPath(e.lineMarker)||t.getMarkerPathAt(s)),h<1&&S){var S=l.toColor(S);S.a=h}return{color:S,width:c,style:a.toGFXValue(I),marker:d}}};return{calcSeriesLine:function(i){function t(e){return e}var l=i.chart,c=i.chartType,h=i.visualProperties,I=i.seriesItems,d=1===I.length,y=i.seriesItemsWithComparison||I,x=i.isSecondaryPlot,f=i.reverseXY||c===r.VERTICAL_LINE,g=i.comparisonInfo,v=i.themeSettings,k=i.viewModel,V=[],P=new p({visualProperties:h,seriesItems:y,viewModel:k,currentFeatureIndex:i.currentFeatureIndex,isMultiFeatureChart:i.isMultiFeatureChart,comparisonFeatureAttributes:i.comparisonFeatureAttributes,chartType:c,isSecondaryPlot:x,oppositeDirections:i.oppositeDirections}),A=i.primaryPlotStat&&i.primaryPlotStat.pointIndexToTooltipsHash||{},C=P.getTotalStats();if(y.forEach(function(e,r){if(e.points.length){var s=S.calcLineStyle(e,t(r),y,i),u={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:x?o.SECONDARY:void 0,fill:h.fillLineArea?s.color:"transparent",stroke:{color:s.color,width:s.width,style:s.style},marker:s.marker,markerStroke:{color:s.color,width:s.width,style:a.toGFXValue(a.SOLID)},outline:!1}},p=P.gettatisticsForSeriesAt(t(r));e.points.forEach(function(a,t){function s(){return x&&i.oppositeDirections&&1===r?-1:1}function o(){return x&&!i.oppositeDirections&&2===i.primarySeries.length?0===r?-.15:.15:0}if(!a.hidden){var S=p.values[t],I=S||0,v=t+1;x||m.updatePointIndexToLabelMap(l,v,r,a,k);var V=i.isMultiFeatureChart&&C.crossSeriesStats[t],P={originalValue:S,isUnavailableData:isNaN(S),unsortedIndex:t,originalIndex:a.originalIndex||t,seriesIndex:r,name:m.getPointLabel(a,k),valuesSumsInSeries:p.absSumInSeries,point:a};f?(P.x=I*s(),P.y=v+o(),P.valueProp="x"):(P.x=v+o(),P.y=I*s(),P.valueProp="y"),h.showValuesAsWeightInStack?P[f?"x":"y"]=100*p.weightsInStack[t]:h.yAxis.showValuesAsWeightsInSeries&&(P[f?"x":"y"]/=p.absSumInSeries/100);var T=n.getTooltipInfo({yValue:S,pointLabel:m.getPointLabel(y[0].points[t]||a,k),seriesLabel:e.label,minInSeriesValue:p.minInSeries,maxInSeriesValue:p.maxInSeries,sumInSeriesValue:p.sumInSeries,absSumInSeriesValue:p.absSumInSeries,avgInSeriesValue:p.avgInSeries,weightInStack:p.weightsInStack&&p.weightsInStack[t],minInAreasValue:V&&V.min,maxInAreasValue:V&&V.max,sumInAreasValue:V&&V.sum,absSumInAreasValue:V&&V.absSum,avgInAreasValue:V&&V.avg,visualProperties:h,chartType:c,isMultiFeature:i.isMultiFeatureChart,conditionalStyling:null,fieldInfo:a.fieldInfo,isThisAreaSpecific:g&&!i.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:d,decimals:a.value&&a.value.decimals,fill:u.params.fill,stroke:u.params.stroke.color,marker:u.params.marker}),M=A[v]=A[v]||[];M.push(T),T.getGroup=function(){return M},P.tooltip=T,u.data.push(P)}}),V.push(u)}},this),x){if(i.primaryPlotStat){i.primaryPlotStat.minYValue=Math.min(C.minYValue,i.primaryPlotStat.minYValue),i.primaryPlotStat.maxYValue=Math.max(C.maxYValue,i.primaryPlotStat.maxYValue);var T=s.getPrettifyYAxisParameters(i.primaryPlotStat.minYValue,i.primaryPlotStat.maxYValue,{baseLineValue:h.yAxis.baseLineValue,renderColumnBarsInOppositeDirections:i.oppositeDirections,previewBelowZero:!k.dynamicReportInfo,nonZeroInclusive:h.yAxis.nonZeroInclusive});e.mixin(l.axes.y.opt,{majorTickStep:T.majorTickStep,minorTickStep:T.minorTickStep,min:T.min,max:T.max})}if(1===i.primarySeries.length){var M=f?"y":"x",b=[];i.primarySeries[0].data.forEach(function(e){var i=V[0].data[e.unsortedIndex];i[M]=e.x,b.push(i)}),V[0].data=b}}else u.prettifyYAxis(C.minYValue,C.maxYValue,l,h,c,v,k);return V}}});