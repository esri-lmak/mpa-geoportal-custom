// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/promise/all","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","dojo/dom-construct","dojo/dom-geometry","esri/graphic","esri/arcgis/utils","esri/graphicsUtils","esri/dijit/HomeButton","./layers/MapContentBuilder","./legend/LegendBuilder","./MapLoadTracker","./StaticMap","./WebMapsUtil","./Popup","./Projector","./mobile/MobilePanUtil","../../../dataProvider/supportClasses/AreaDataUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/UrlUtil"],function(e,t,a,n,r,i,o,s,l,c,d,u,p,m,f,I,h,g,_,x,M,v,y){var j=1.5,C=e(null,{_mapInfos:null,_mapDivId:0,_mapImageInfos:null,renderMapsFromCalculators:!1,constructor:function(e){t.mixin(this,e),this.reset()},setArcgisUrl:function(e){e&&(l.arcgisUrl=y.combine(e,"/sharing/rest/content/items"))},reset:function(){this._mapInfos={},this._mapImageInfos=null},collectAreaMaps:function(e){var t=[];e=e||0;var a=this._mapInfos[e];for(var n in a){var r=a[n],i=r.node;if(i.parentNode){var s=o.position(i);t.push({areaIndex:e,node:i,x:s.x,y:s.y,position:-1,map:r.map,legend:r.legend,itemId:r.itemId})}}return t.sort(function(e,t){return e.x-t.x}),t.sort(function(e,t){return e.y-t.y}),t.forEach(function(e,t){e.position=t}),t},collectAllAreasMaps:function(){var e=[];for(var t in this._mapInfos)e=e.concat(this.collectAreaMaps(t));return e},setFallbackMapImageInfos:function(e){if(!e)return void(this._mapImageInfos=null);this._mapImageInfos={},e.forEach(function(e){var t=e.areaIndex||0;(this._mapImageInfos[t]=this._mapImageInfos[t]||{})[e.itemId]=e},this)},createMap:function(e,t){return t.areaIndex=t.areaIndex||0,r(this._doCreateMap(e,t),function(e){return t.waitForLoad?e&&r(m.waitForLoad(e.map),function(){return e}):e})},_doCreateMap:function(e,t){var a=this;if(this.renderMapsFromCalculators&&t.calculatorFieldName){var i=x.getAreaDataValue({fieldName:t.calculatorFieldName,fieldData:t.fieldData,featureIndex:this.currentFeatureIndex});if(i)return this._createStaticMap({url:v.base64DataToDataURL(i)},e,t)}return r(I.getItem(t.webMapId),function(r){if(!r)return(new n).reject(new Error("Can't load an item or the item is incorrect."));var i=new n;try{a._createMapFromItem(r,e,t).then(i.resolve,i.reject)}catch(e){i.reject(e),console.log(e)}return i.promise}).otherwise(this._createFallbackStaticMap.bind(this,t,e))},_createMapFromItem:function(e,t,a){var o=this,s=M.isMobileDevice();return I.createMap(e,t,{defaultBasemapId:a.defaultBasemapId,additionalLayerInfos:a.additionalLayerInfos,mapOptions:{extent:a.extent||c.graphicsExtent(a.features).expand(a.expandFactor||j),sliderPosition:!1===a.sliderPosition?"none":a.sliderPosition||"top-right",infoWindow:new h({getPlayerZoomScale:function(){return o.getPlayerZoomScale(t)}},i.create("div")),isMapNavigation:!s}}).then(function(e){var i=e&&e.map;return i?r(o._setInitialExtent(i,a),function(){return r(u.addLayersToMap(i,{features:a.features,featureIndexToAreaIndexMap:a.featureIndexToAreaIndexMap,analysisAreas:a.analysisAreas,locatorPointsControllers:a.locatorPointsControllers,stdPolygonsControllers:a.stdPolygonsControllers,thisAreasHighlightController:a.thisAreasHighlightController,geClient:a.geClient,countryID:a.countryID,hierarchy:a.hierarchy,additionalLayerInfos:a.additionalLayerInfos,calculatorFieldName:a.calculatorFieldName,attachmentsStore:a.attachmentsStore}),function(){s&&_.setUpMapPan(i,a.onPanContainer),void 0===t.__mapDivId&&(t.__mapDivId=o._mapDivId++);var e={node:t,map:i,itemId:a.webMapId,legend:null};p.createLegend(i,t,a.legendController,{onCreated:function(t){e.legend=t},onDestroyed:function(){delete e.legend}});var n=new d({map:i}).placeAt(t);return n.startup(),n.own(i.on("before-unload",function(){n.destroy()})),(o._mapInfos[a.areaIndex]=o._mapInfos[a.areaIndex]||{})[t.__mapDivId]=e,e})}):(new n).reject(new Error("Can't create a map."))})},_setInitialExtent:function(e,t){return r(t.extent||function(){return a(t.features.map(function(t){return g.needProject(t.geometry,e)?r(g.projectGeometries(t.geometry,e),function(e){return new s(e)}):t})).then(function(e){return c.graphicsExtent(e).expand(t.expandFactor||j)})}(),function(t){return g.needProject(t,e)?r(g.projectGeometries(t,e),function(t){return e.setExtent(t)}):e.setExtent(t)})},_createFallbackStaticMap:function(e,t){var a=this._mapImageInfos&&this._mapImageInfos[e.areaIndex]&&this._mapImageInfos[e.areaIndex][e.webMapId];return this._createStaticMap(a,t,e)},_createStaticMap:function(e,t,a){var n=e&&new f(e,t);return n&&n.load().then(function(){return n.loaded?{node:t,map:n,itemId:a.webMapId,legend:null}:null})},getPlayerZoomScale:function(e){}});return C.EXPAND_FACTOR=j,C});