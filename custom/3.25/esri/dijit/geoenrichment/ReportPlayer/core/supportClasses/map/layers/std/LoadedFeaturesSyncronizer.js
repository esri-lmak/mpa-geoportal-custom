// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","esri/graphic","esri/layers/GraphicsLayer","esri/geometry/jsonUtils","esri/renderers/jsonUtils","esri/renderers/SimpleRenderer","esri/dijit/PopupTemplate","./DefaultSymbolRenderer","./FeatureGeometryLoader","./LabelsLayer","esri/dijit/geoenrichment/ReportPlayer/countryConfig","../../../../../dataProvider/supportClasses/AreasInfoTemplateBuilder","esri/dijit/geoenrichment/utils/SymbolUtil"],function(e,r,t,o,a,i,l,n,s,u,h,y,c,d,g,f){return e(null,{controller:null,layerSorter:null,map:null,countryID:null,hierarchy:null,calculatorFieldName:null,_levelIdToLayerCache:null,_shownFeaturesCache:null,_isDestroyed:!1,_layersPreloaded:!1,constructor:function(e){r.mixin(this,e),this._levelIdToLayerCache={},this._shownFeaturesCache={}},syncWithShownFeatures:function(){if(this._isDestroyed)return void console.log(new Error("Attempt to use syncronizer after destroying."));var e=this.controller.getShownFeatureAttributes();this._preloadAllLayers();var r=this._shownFeaturesCache;this._shownFeaturesCache={},e&&e.forEach(function(e){var t=this._getAttrsKey(e);this._shownFeaturesCache[t]=e,r[t]||this._addFeatureByAttributes(e)},this);for(var t in r)this._shownFeaturesCache[t]||this._removeFeatureByAttributes(r[t])},_getAttrsKey:function(e){return e.StdGeographyLevel+";"+e.StdGeographyID},loadAllFeatures:function(){var e=this;return o(this.controller.getAllFeatureAttributes().map(function(r){return e._getGeometryJsonByAttributes(r)}))},_addFeatureByAttributes:function(e){var o=this,i=e.StdGeographyLevel,y=(e.StdGeographyID,e.StdGeographyName),c=this._getLayerForLevelId(i),d=c&&c.graphicsLayer,m=c&&c.labelsLayer;if(d){var p=this.controller.getAttributeFields().map(function(r){return{label:r.label,value:r.formatFunction(e[r.name])}}),L=new u({title:y||"",fieldInfos:[],description:g.buildAttributesTable(null,p)}),v=new a({attributes:e,geometry:null});v.setInfoTemplate(L);var _;if(!d.renderer){var S=this.controller.getRendererJson(this.calculatorFieldName),b=S?n.fromJson(r.clone(S)):h.getDefaultStdRenderer(),F=b.getSymbol(v);_=f.simpleFillSymbolToPictureFillSymbol(F).then(function(e){d.setRenderer(new s(e||F))});var I=this.controller.getLabelRendererJson(this.calculatorFieldName);I?m.setRenderer(new s(n.fromJson(r.clone(I)).getSymbol(v))):m.setVisualSettings({color:F.color.toCss()})}t(this._getGeometryJsonByAttributes(e),function(r){r&&(v.setGeometry(l.fromJson(r)),t(_,function(){o._shownFeaturesCache[o._getAttrsKey(e)]&&d.add(v)}))})}},_getGeometryJsonByAttributes:function(e){var r=this,t=e.StdGeographyLevel,o=e.StdGeographyID,a="stdGeometry_"+this.map.spatialReference.wkid,i=e[a]&&JSON.parse(e[a]);return i||y.canLoad()&&y.getFeatureGeometry({countryID:this.countryID,hierarchy:this.hierarchy,levelId:t,featureId:o,outSR:{wkid:this.map.spatialReference.wkid}}).then(function(t){return r._isDestroyed?null:(e[a]=JSON.stringify(t),t)})},_removeFeatureByAttributes:function(e){var r=this._levelIdToLayerCache[e.StdGeographyLevel],t=r&&r.graphicsLayer;if(t){var o=t.graphics.filter(function(r){return r.attributes.StdGeographyID===e.StdGeographyID})[0];o&&t.remove(o)}},_preloadAllLayers:function(){if(!this._layersPreloaded){var e={};(this.controller.getAllFeatureAttributes()||[]).forEach(function(r){e[r.StdGeographyLevel]=1}),Object.keys(e).forEach(this._getLayerForLevelId.bind(this)),this._layersPreloaded=!0}},_getLayerForLevelId:function(e){if(!this._levelIdToLayerCache[e]){if(!this._canShowLayerForLevelId(e))return null;var r=new i;this._provideNameForLayer(r,e),this.layerSorter.registerLayerInfo({layer:r,type:this.layerSorter.STD_POLYGONS,preferredIndex:this.controller.getLayerIndex(this.calculatorFieldName,e),geometryType:"esriGeometryPolygon"});var t=new c;t.setLabelField("StdGeographyName"),t.setSourceGraphicsLayer(r),t.setVisualSettings(c.getDefaultVisualSettings(e)),this.layerSorter.registerLayerInfo({layer:t,type:this.layerSorter.STD_POLYGON_LABELS,preferredIndex:this.controller.getLayerIndex(this.calculatorFieldName,e),geometryType:"esriGeometryPoint"}),this._levelIdToLayerCache[e]={graphicsLayer:r,labelsLayer:t},this.onLayerCreated(r,e)}return this._levelIdToLayerCache[e]},_canShowLayerForLevelId:function(e){var r=this.controller.getRendererJson(this.calculatorFieldName);if(r){var t=r.uniqueValueInfos.filter(function(r){return r.value===e})[0];if(t&&!t.symbol.color[3]&&(!t.symbol.outline||!t.symbol.outline.color[3]))return!1}return!0},_provideNameForLayer:function(e,r){e.name=d.getGeographiesModel().getLevelPluralName(r),e.onVisibilityChange()},onLayerCreated:function(e,r){},destroy:function(){this._isDestroyed=!0,this.controller=null,this._levelIdToLayerCache=null}})});