// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/aspect","dojo/on","esri/dijit/geoenrichment/when","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/query","./SimpleInfographicViewModes","../../grid/coreUtils/GridDataUtil","./dataDrilling/DataDrillingLibrary","../utils/InfographicJsonUtil","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DnDUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/TooltipUtil","esri/dijit/geoenrichment/utils/WaitingUtil","../../sections/SectionTypes","../../supportClasses/ViewModes","./DataDrillingBackgroundUtil","./DataDrillingExportUtil","dojo/i18n!esri/nls/jsapi"],function(t,i,e,n,o,a,l,r,s,c,d,h,u,g,D,f,m,p,S,w,_,y,v){v=v.geoenrichment.dijit.ReportPlayer.Infographics;var I={w:700,h:600,minW:400,minH:500},P=t(null,{_drillingSections:null,_drillingSectionsButtons:null,postCreate:function(){var t=this;this.inherited(arguments),e(this.backToMainViewButton,"click",function(){t._setViewMode(s.VIEW_MAIN,!0)}),g.isMobileDevice()&&this.own(e(window,"resize, orientationchange",function(){t._setViewMode(s.VIEW_MAIN,!1)})),f.hide([this.exportButton,this.printButton]),this.viewModel.dynamicReportInfo&&(y.canExportDataDrilling(this)&&(m.setTooltipToNode(this.exportButton,v.exportInfographic),f.show(this.exportButton),e(this.exportButton,"click",function(){y.exportDataDrilling(t)})),y.canPrintDataDrilling(this)&&(m.setTooltipToNode(this.printButton,v.printInfographic),f.show(this.printButton),e(this.printButton,"click",function(){y.printDataDrilling(t)})))},_getCountryID:function(){return this.viewModel.dynamicReportInfo.infographicOptions.countryID},_addDataDrillingHandlers:function(t,i){var e=this;this.onShowWaiting(n(d.init({variableProvider:this.viewModel.dynamicReportInfo.templateVariableProvider,countryID:this.viewModel.dynamicReportInfo.countryID}),function(){var n=c.getFieldInfo(i.getFirstCell()),o=h.getDataDrilling(e._currentInfographicJson,n.templateName),a=o&&o.sectionJson?o:null,l=o&&o.isStandard&&d.getDrillingOptions(e._getCountryID(),o.standardId||n),r=l&&l[0];(a||r)&&(t.getTables().forEach(function(t){t.getFieldCells().forEach(function(t){m.setTooltipToNode(t.domNode,null)})}),e._setUpDataDrillingButton(t,function(t){var i=e._setViewMode(s.VIEW_DATA_DRILLING,!0,t);a?e._renderCustomSectionJson({customDDPanelInfo:a,fieldInfo:n,animationPromise:i}):e._loadStandardDataDrillingView({fieldInfo:n,optionName:r.name,calcState:null,sectionVisualState:null,animationPromise:i})}))}))},_setUpDataDrillingButton:function(t,i){function n(){var i=a.create("div",{class:"simpleInfographic_drillDataButton"},t.domNode);a.create("div",{class:"dijitInline simpleInfographic_drillDataButtonIcon esriGESpaceAfterBig"},i);var e=a.create("div",{class:"dijitInline simpleInfographic_drillDataButtonLabel",innerHTML:v.drillForMoreData},i),n=[];t.getTables().forEach(function(t){n.push(t.domNode)});var o=f.uniteNodeBoxes(n,t.domNode);l.set(i,{left:o.x+"px",top:o.y+"px",width:o.w+"px",height:o.h+"px",lineHeight:o.h+"px"});var r=i.clientWidth;return r>o.w&&l.set(i,"left",o.x-(r-o.w)/2+"px"),e.style.maxWidth=r-50+"px",e.style.whiteSpace="normal",e.style.lineHeight="20px",s._drillingSectionsButtons.push({destroy:function(){a.destroy(i)}}),i}function o(t){r.style.opacity=t?1:0,d=t,c&&c.remove()}var r,s=this;if(g.isMobileDevice()){var c,d=!1;D.addNoDragClickHandler(t.domNode,function(){d||(r=r||n(),o(!0),setTimeout(function(){c=D.addNoDragClickHandler(r,function(){o(!1),i(r)}),e.once(document.body,"touchend",function(){o(!1)})}))},{detectLongPress:!0,longPressTimeout:750,ignoreReleaseIfLongPressHappened:!0,longPressCallback:function(){r=r||n(),o(!0),i(r),setTimeout(function(){o(!1)})}})}else t.own(e.once(this.domNode,"mouseover",function(){r=r||n(),e(r,"click",function(){i(r)})}))},_dataDrillingState:null,_loadStandardDataDrillingView:function(t){var i=t.fieldInfo,e=t.optionName,o=t.calcState,a=t.sectionVisualState,l=t.animationPromise,r=this;return this._dataDrillingState={fieldInfo:i,optionName:e,calcState:o,sectionVisualState:a},this._destroyDrillingSections(),this._showDDProgress(!0),n(function(){var t=r._getDataDrillingPanelDimensions(),a=h.getDataDrilling(r._currentInfographicJson,i.templateName),l=d.getDrillingOptionInfo(r._getCountryID(),a.standardId||i,e,t.w,t.h,o),s=l.enrichInfos;return n(s&&s.length&&r.viewModel.enrichFieldData(s),function(){return l})}(),function(t){return n(r._renderStandardOptionInfo({drillingDataOptionInfo:t,fieldInfo:i,animationPromise:l,optionName:e,calcState:o,sectionVisualState:a}),function(){r._showDDProgress(!1)})})},_renderStandardOptionInfo:function(t){var i,e=t.drillingDataOptionInfo,o=t.fieldInfo,a=t.animationPromise,l=t.optionName,r=(t.calcState,t.sectionVisualState),s=this;this._destroyDrillingSections();var c=this._getDataDrillingPanelSectionParams();return c.json={type:S.DETAILS,stack:[e.tableJson]},c.calculationStatesGroup=e.calculationStatesGroup,c.onCalculationStateChanged=function(t){s._loadStandardDataDrillingView({fieldInfo:o,optionName:l,calcState:t,sectionVisualState:i.getVisualState(),animationPromise:null})},n(a,function(){return u.delay(function(){return i=s._createDataDrillingSection(c),i.fitContentNicely(),i.domNode.style.opacity="0.01",n(i.getContentFullPromise(),function(){return u.delay(function(){i.setVisualState(r),i.domNode.style.opacity="",i.notifyShown()},100)})})})},_renderCustomSectionJson:function(t){var i=t.customDDPanelInfo,e=(t.fieldInfo,t.animationPromise),o=(t.calcState,t.sectionVisualState),a=this;this._destroyDrillingSections(),this._dataDrillingState=null;var l,r=this._getDataDrillingPanelSectionParams();return r.json=i.sectionJson,this._showDDProgress(!0),n(e,function(){return u.delay(function(){return l=a._createDataDrillingSection(r),l.fitContentNicely(),l.domNode.style.opacity="0.01",n(l.getContentFullPromise(),function(){return u.delay(function(){l.setVisualState(o),l.domNode.style.opacity="",l.notifyShown(),a._showDDProgress(!1)})})})})},_getDataDrillingPanelSectionParams:function(){var t={};return t.class="infographicContainer_dataDrillingSection",t.initialWidth=this._getDataDrillingPanelDimensions().w,t.initialHeight=this._getDataDrillingPanelDimensions().h,t.viewModel=this.viewModel,t.theme=this.theme,t.parentWidget=this,t.isDataDrillingView=!0,t.currentFeatureIndex=this.currentFeatureIndex||0,t.initialViewMode=w.PREVIEW_VALUES,a.empty(this.dynamicSettingsToolbarRoot),t.dynamicSettingsToolbarRoot=this.dynamicSettingsToolbarRoot,t},_createDataDrillingSection:function(t){var e=this._getDataDrillingPanelDimensions(),n=this.viewModel.layoutBuilder.createElement("section",t,this.drilledDataViewDivScaler);return this._drillingSections.push(n),o[r(".sectionDynamicSettings_settingsButton",this.dataDrillingViewDiv)[0]?"add":"remove"](this.dataDrillingViewDiv,"hasChartSettingsButton"),this._setUpDDPanelBackgroundColor(),e.scale&&(n.notifyPanelScaleChanged(e.scale),this._applyScaleToDataDrillingToolbarButtons(e.buttonScale||e.scale),i.after(n,"onDynamicSettingsButtonsCreated",function(){this._applyScaleToDataDrillingToolbarButtons(e.buttonScale||e.scale)}.bind(this))),n},_applyScaleToDataDrillingToolbarButtons:function(t){var i=1/t,e=[],n=r(".sectionDynamicSettings_buttonBar",this.dynamicSettingsToolbarRoot)[0];if(n)for(var o=0;o<n.children.length;o++)e.push(n.children[o]);e.push(this.exportButton),e.push(this.printButton),e.push(this.backToMainViewButton),e.forEach(function(t,e){if(t.style.transformOrigin=this.viewModel.showDataDrillingInsidePanel?"100% 0":"100% 100%",t.style.transform="scale("+i+")",t.style["webkit-transform"]="scale("+i+")",e>0){var n=(this.viewModel.showDataDrillingInsidePanel?5:26)*i;n+=32*(i-1),t.style.marginLeft=n+"px"}},this)},_setUpDDPanelBackgroundColor:function(){var t=this.viewModel.getDocumentDefaultStyles(this.theme),i=t.backgroundImage&&t.backgroundImage.data;this.viewModel.showDataDrillingInsidePanel&&!i||_.setUpDDPanelBackgroundColor({viewModel:this.viewModel,theme:this.theme,infographicJson:this._currentInfographicJson,node:this.dataDrillingViewDiv})},_getDataDrillingPanelDimensions:function(){if(this.viewModel.showDataDrillingInsidePanel){var t=1/this.parentWidget.parentWidget.parentWidget.parentWidget.getPanelScale(),i=this.width/t,e=this.height/t,n=I.minW>i,o=I.minH>e;return this.dataDrillingViewDiv.style.overflowX=n?"auto":"hidden",this.dataDrillingViewDiv.style.overflowY=o?"auto":"hidden",{scale:t,buttonScale:1/t,w:Math.max(i,I.minW)-(o?f.getScrollbarSize().w/t:0),h:Math.max(e,I.minH)-(n?f.getScrollbarSize().h/t:0)}}var a={w:document.body.clientWidth-(g.isLandscape()?80:40),h:document.body.clientHeight-80},t=Math.max(.7,Math.min(1,a.w/I.minW,a.h/I.minH));return g.isMobileDevice()?{w:a.w/t,h:a.h/t,scale:t,yOffset:10,animateFromCenter:!0}:{w:Math.min(a.w/t,I.w),h:Math.min(a.h/t,I.h),scale:t,yOffset:a.h-30>I.h?0:15}},_showDDProgress:function(t){var i=this.viewModel.showDataDrillingInsidePanel?this.domNode:this.dataDrillingViewDiv;p[t?"showProgress":"removeProgress"](i)},_getDataDrillingState:function(){return this._dataDrillingState},_setDataDrillingState:function(t){t&&this._loadStandardDataDrillingView({fieldInfo:t.fieldInfo,optionName:t.optionName,calcState:t.calcState,sectionVisualState:t.sectionVisualState,animationPromise:null})},_destroyDrillingSections:function(){this._drillingSections=this._drillingSections||[],this._drillingSections.forEach(function(t){t.destroy()}),this._drillingSections.length=0,this.domNode&&a.empty(this.drilledDataViewDivScaler)},_destroyDrillingSectionsButtons:function(){this._drillingSectionsButtons=this._drillingSectionsButtons||[],this._drillingSectionsButtons.forEach(function(t){t.destroy()}),this._drillingSectionsButtons.length=0}});return P.DATA_DRILLING_BOX_ZOOM=I,P});