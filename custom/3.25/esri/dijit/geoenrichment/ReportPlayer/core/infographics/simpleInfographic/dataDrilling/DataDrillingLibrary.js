// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/lang","./_FieldInfoBuilder","../../../supportClasses/tableJson/TableJsonUtil","../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil","../../../../dataProvider/supportClasses/dataCollections/DataCollectionsLoader","./_config","./EnrichUtil"],function(e,t,a,r,i,n,s){function o(e){return"string"==typeof e?e.split(",").map(function(e){return e+"/"}):e}function l(){return d=d||n.collectSubstitutionVariables()}var u={};s.ddLibrary=u,u.getDrillingOptions=function(e,t,a){if(t){var i=function(){var i;if("string"==typeof t){var s=n.getById(e+"."+t);return s?[s]:null}i=t;var o=i.usedFields||a&&a(i);if(o=o&&o.map(function(e){return e.toUpperCase()}),!i.variableID&&!o)return null;var l=i.variableID&&i.variableID.toUpperCase(),u=n.LIBRARY[e];for(var f in u){var c=f.toUpperCase(),d=r.createFieldNameFromVariable(f).toUpperCase();if(function(e,t){return!(!l||-1===l.indexOf(e))||o&&o.some(function(a){return-1!==a.indexOf(e)||-1!==a.indexOf(t)})}(c,d))return u[f]}return null}();return i&&i.forEach(function(e){u._provideStateData(e)}),i}},u.getDrillingOptionByStandardId=function(e,t){},u.getDrillingOptionInfo=function(t,r,i,n,o,l,f){var c=u.getDrillingOptions(t,r,f),d=c&&c.filter(function(e){return e.name===i})[0];if(!d)return null;!l&&d.defaultState&&(l=d.defaultState),l=l&&l.charAt(0)||"n";var v;d.calcGroup&&(v=e.clone(d.calcGroup),v.value=l+"/");var p=d.stateData[l],h=a.createSingleCellTable({fieldInfo:p.fieldInfo,width:n,height:o});return{calculationStatesGroup:v,tableJson:e.clone(h),enrichInfos:s._getStandardEnrichInfosForTableInfo(d,!0)}},u._provideStateData=function(a){if(!a.stateData){var r=a.states?e.clone(a.fieldInfo):a.fieldInfo;a.stateData={n:{fieldInfo:a.fieldInfo}},a.fieldInfo.isChart&&u._updateChartJsonForState(a.fieldInfo.chartJson,"n",a.stateSettings&&a.stateSettings.n),a.states&&(a.states=o(a.states),a.states.forEach(function(t){var i=t.charAt(0);if("n"!==i){var n=e.clone(r);a.stateData[i]={fieldInfo:n},n.isChart&&u._updateChartJsonForState(n.chartJson,i,a.stateSettings&&a.stateSettings[i])}}),a.calcGroup=u.createCalculationStatesGroup(a.states));for(var i in a.stateData){var n=a.stateData[i];n.fieldInfo.isChart&&n.fieldInfo.chartJson.seriesItems.forEach(function(e){e.points.forEach(function(a){t.provideFieldInfoForChartPoint(a,e,1===n.fieldInfo.chartJson.seriesItems.length,i,n.fieldInfo.chartJson.comparisonInfo&&n.fieldInfo.chartJson.comparisonInfo.calculatorName)})})}delete a.states,delete a.stateSettings,delete a.fieldInfo}},u._updateChartJsonForState=function(t,a,r){r&&r.title?t.visualProperties.title.text=r&&r.title:"n"!==a&&(t.visualProperties.title.text+=" ("+n.STATE_LOCALIZATION_MAP_SHORT[a]+")"),t.visualProperties.yAxis&&(t.visualProperties.yAxis.title=r&&r.yAxisTitle||("n"===a?"":n.STATE_LOCALIZATION_MAP[a]),"i"===a&&(t.visualProperties.yAxis.baseLineValue=100)),"n"!==a&&(t.visualProperties.dataLabelsDecimals="p"===a?1:0),"p"===a&&(t.visualProperties.dataLabelsShowValuePercentSymbol=!0,t.visualProperties.yAxis&&(t.visualProperties.yAxis.showPercentSymbol=!0,t.visualProperties.yAxis.showSymbolForAllLabels=!0)),r&&r.isCurrency&&(t.visualProperties.dataLabelsShowValueCurrencySymbol=!0,t.visualProperties.yAxis&&(t.visualProperties.yAxis.showCurrencySymbol=!0,t.visualProperties.yAxis.showSymbolForAllLabels=!0)),e.mixin(t.visualProperties,r&&r.visualProps)},u.createCalculationStatesGroup=function(e){if(e)return e=o(e),{states:{ids:e,names:e.slice(),labels:e.map(function(e){return n.STATE_LOCALIZATION_MAP_SHORT[e.charAt(0)]})},value:e[0]}};var f,c,d;return u.init=function(e){if(!e||!e.countryID)return void(f=!0);var t=e.countryID,a=t+";"+(e.hierarchy||"census");if(f&&c===a)return f;c=a;var r=l(),s={};if(!r[t])return void(f=!0);if(!i.canLoad()){if(e.variableProvider){var o={fields:r[t].fields,variables:[]};s[t]=o,r[t].variables.forEach(function(t){var a=e.variableProvider.getVariableVintage(t);o.variables.push({fullName:t,vintage:a||"N/A"})}),n.replaceSubstitutionVariables(s)}return void(f=!0)}var u=r[t].fields,d=r[t].variables;return f=i.loadVariables({countryID:t,hierarchy:e.hierarchy||"census",outFields:u,forceLowerCase:!0}).then(function(e){var a={fields:u,variables:[]};d.forEach(function(t){var r=e.fullNameToVariableCache[t];r.fullName=t,a.variables.push(r)}),s[t]=a}).then(function(){n.replaceSubstitutionVariables(s)})},u.getSubstitutionVariables=function(e){var t=l()[e];return t&&t.variables},u});