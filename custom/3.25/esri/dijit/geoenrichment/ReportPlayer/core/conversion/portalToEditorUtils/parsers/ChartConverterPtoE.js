// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/ColorUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/JsonXmlConverter","../../ConversionUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartJsonUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendSymbols","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartDataLabelsTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartBarThickness","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartSorting","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartLineStyles","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartLineMarkers","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/GaugeLabelPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleLabelPlacements","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleDirections","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/plots/supportClasses/WaffleFlowStyles","./_FieldInfoBuilder","dojo/i18n!esri/nls/jsapi"],function(e,t,a,i,r,l,o,n,s,u,c,g,d,p,b,h,f,y,S,m,L){function w(e,t){var a=Number(e);return isNaN(a)?void 0:t?t(a):a}function v(e,t){return w(e,t.revisionVersion>=1.7?r.ptToPx:null)}function C(e){return r.ptToPxObj(r.parseStyleString(e))}function P(e,t,a){return i.queryJson(e,"series",!0)[0].tags.map(function(a){if(!a.tags)return null;a.attributes=a.attributes||{};var n={_originalAttrs:a.attributes,label:a.attributes.Text||"",color:B(a.attributes.color),points:a.tags.map(function(r,n){r.attributes=r.attributes||{};var s=(e.attributes.type===o.GAUGE||e.attributes.type===o.WAFFLE)&&n===a.tags.length-1,u=r.tags&&r.tags[0],c=u&&u.attributes&&u.attributes.f,g=c&&m.getCalculatorOrScriptFieldInfo(c,t);if(g||s){if(s&&(g=null),g&&g.isMissing){var d=r.attributes.Text;if(!d&&t.variableProvider.isPlayerOnly){var p=t.variableProvider.toCalculator(g.templateName);d=p&&p.variable.alias}g.alias=d?d+" ("+L.missingVariable+")":L.missingVariable}var b=r.attributes.CaptionField,h=b&&m.getCalculatorOrScriptFieldInfo(b,t),f=i.queryJson(r,"pointIcon")[0],y=f&&t.parsers.getParser("field").parseField(f.tags[0],f,null,t);return l.createChartPoint(g,r.attributes.Text||"",B(r.attributes.color),y,h)}}).filter(function(e){return!!e})};if(o.isLineLike(e.attributes.type)){n.lineStyle=p.isSupported(a.attributes.lineStyle)?a.attributes.lineStyle:void 0,n.lineMarker=b.isSupported(a.attributes.lineMarker)?a.attributes.lineMarker:void 0;var s=i.queryJson(a,"multiFeatureLineStyles")[0];s&&(n.multiFeatureLineStyles=[],s.tags.forEach(function(e){var t={};e.attributes&&(t.color=e.attributes.color,t.lineStyle=p.isSupported(e.attributes.lineStyle)?e.attributes.lineStyle:void 0,t.lineMarker=b.isSupported(e.attributes.lineMarker)?e.attributes.lineMarker:void 0,t.lineThickness=w(e.attributes.lineThickness,r.ptToPx)),n.multiFeatureLineStyles.push(t)}))}return n}).filter(function(e){return e&&e.points&&!!e.points.length})}function k(t,a,i){var r={gridLines:t.gridlines,gridLinesCentered:t.gridlinesCentered,gridLinesOpacity:w(t.gridlinesOpacity),gridLinesColor:B(t.gridlinesColor),gridLinesThickness:v(t.gridlinesThickness,i),gridLinesStyle:p.isSupported(t.gridlinesStyle)?t.gridlinesStyle:void 0,gridStripes:t.gridStripes,gridStripesColor:B(t.gridStripesColor),gridStripesColorAlt:B(t.gridStripesColorAlt)};return a&&e.mixin(r,{hideBaseLine:void 0!==t.baseLine?!t.baseLine:t.hideBaseLine,baseLineColor:B(t.baseLineColor),baseLineOpacity:w(t.baseLineOpacity),baseLineThickness:v(t.baseLineThickness,i),baseLineStyle:p.isSupported(t.baseLineStyle)?t.baseLineStyle:void 0,baseLineValue:w(t.baseLineValue)}),r}function T(e){return{dataLabels:c.toSupportedValue(e.dataLabels),dataLabelsShowLabelUnder:e.dataLabelsShowLabelUnder,dataLabelsDecimals:x(e.CustomPercentFormat||e.CustomValueFormat),dataLabelsStyle:C(e.dataLabelsStyle),dataLabelsLabelStyle:C(e.dataLabelsLabelStyle?e.dataLabelsLabelStyle:e.dataLabelsStyle),dataLabelsAltColor:B(e.dataLabelsAltColor),dataLabelsEnableAltColor:e.dataLabelsEnableAltColor,dataLabelsInside:e.dataLabelsInside,dataLabelsStackedInColumns:e.dataLabelsStackedInColumns,dataLabelsHorizontalAlign:e.dataLabelsHorizontalAlign,dataLabelsVerticalAlign:e.dataLabelsVerticalAlign,dataLabelsShowValuePercentSymbol:e.dataLabelsShowValuePercentSymbol,dataLabelsShowValueCurrencySymbol:e.dataLabelsShowValueCurrencySymbol,dataLabelsAngle:w(e.dataLabelsAngle),dataLabelsMaxWidth:w(e.dataLabelsMaxWidth,r.ptToPx)}}function A(e){var t=i.queryJson(e,"BackImage")[0];return t&&t.tags&&t.tags[0].text?a.base64DataToDataURL(t.tags[0].text):null}function x(e){return"string"!=typeof e?0:(e=e.replace("%",""),"0"===e?0:e.replace("0.","").length)}function B(e){return e&&"string"==typeof e&&(e=6===e.length&&-1===e.indexOf("#")?"#"+e:t.toCSSColor(e)),e}L=L.geoenrichment.dijit.ReportPlayer.ReportPlayer;var I={};return I.portalToEditor=function(t,a,c){if(!o.isSupported(t.attributes.type))throw new Error("Chart type is not supported.");var m,L=i.queryJson(t,"comparisonInfo")[0];if(L){var x=L.attributes.name,I=c.templateJson.metadata.comparisonCalculatorsHash[x];I&&(m={calculatorName:x,chartType:L.attributes.chartType,color:L.attributes.color,lineThickness:v(L.attributes.lineThickness,c),lineStyle:p.isSupported(L.attributes.lineStyle)?L.attributes.lineStyle:void 0,lineMarker:b.isSupported(L.attributes.lineMarker)?L.attributes.lineMarker:void 0,levels:I.levels})}var O=P(t,c,m);if(!O.length)return null;var V=t.attributes,R=i.queryJson(t,"chartTitle")[0],F=i.queryJson(t,"legend")[0],M=i.queryJson(t,"xAxis")[0],j=i.queryJson(t,"yAxis")[0],J=i.queryJson(t,"chartIcon"),W=i.queryJson(t,"floatingIcon"),D=i.queryJson(t,"floatingText"),G=i.queryJson(t,"trigger"),q=i.queryJson(t,"filter")[0];R.attributes=R.attributes||{};var N=M&&M.attributes,E=j&&j.attributes,H=N,U=E;c.isGraphicReport&&c.revisionVersion<1.3&&(H=E,U=N);var _=M&&M.tags&&M.tags[0].attributes&&M.tags[0].attributes,z=j&&j.tags&&j.tags[0].attributes&&j.tags[0].attributes,X=A(t),Z={isChart:!0,type:V._type||V.type,isMultiFeatureChart:!!V.isMultiFeatureChart,seriesItems:O,visualProperties:e.mixin({width:r.ptToPx(V.width),height:r.ptToPx(V.height),marginTop:w(V.marginTop,r.ptToPx),marginRight:w(V.marginRight,r.ptToPx),marginBottom:w(V.marginBottom,r.ptToPx),marginLeft:w(V.marginLeft,r.ptToPx),backgroundColor:B(V.backColor),panelBackgroundColor:B(V.panelBackgroundColor),barBorders:V.barBorders,view3D:!!V.view3D,origin:w(V.origin),backgroundImageData:X,title:{text:R.attributes.text,align:R.attributes.align&&R.attributes.align.toLowerCase(),style:C(R.attributes.style),verticalShift:w(R.attributes.verticalShift,r.ptToPx)},xAxis:N&&e.mixin({show:"None"!==N.placement,hideLine:void 0!==N.line?!N.line:N.hideLine,showTicks:N.ticks,ticksInside:N.ticksInside||void 0,hideLabels:N.hideLabels||void 0,placement:"OtherSide"===N.placement?"OtherSide":void 0,title:_&&_.text,titleStyle:_&&C(_.style),style:C(N.style),labelsAngle:w(N.labelsAngle),lineColor:B(N.lineColor)},k(H,!1,c)),yAxis:E&&e.mixin({show:"None"!==E.placement,hideLine:void 0!==E.line?!E.line:E.hideLine,showTicks:E.ticks,ticksInside:E.ticksInside,hideLabels:E.hideLabels||void 0,placement:"OtherSide"===E.placement?"OtherSide":void 0,title:z&&z.text,titleStyle:z&&C(z.style),style:C(E.style),labelsAngle:w(E.labelsAngle),lineColor:B(E.lineColor),showPercentSymbol:E.showPercentSymbol,showCurrencySymbol:E.showCurrencySymbol,showSymbolForAllLabels:E.showSymbolForAllLabels,showValuesAsWeightsInSeries:E.showValuesAsWeightsInSeries,nonZeroInclusive:E.nonZeroInclusive},k(U,!0,c)),isStacked:V.isStacked,showValuesAsWeightInStack:V.showValuesAsWeightInStack,columnBarGap:w(V.columnBarGap,r.ptToPx),columnBarOpacity:w(V.columnBarOpacity),renderColumnBarsInOppositeDirections:V.renderColumnBarsInOppositeDirections,showColumnBarBackground:V.showColumnBarBackground,columnBarBackgroundColor:B(V.columnBarBackgroundColor),columnBarBackgroundOpacity:w(V.columnBarBackgroundOpacity),columnBarLineOpacity:w(V.columnBarLineOpacity),columnBarLineColor:B(V.columnBarLineColor),columnBarLineThickness:w(V.columnBarLineThickness,r.ptToPx),columnBarLineStyle:p.isSupported(V.columnBarLineStyle)?V.columnBarLineStyle:void 0,fillOpacity:w(V.fillOpacity),outlineOpacity:w(V.outlineOpacity),outlineColor:B(V.outlineColor),outlineThickness:w(V.outlineThickness,r.ptToPx),outlineStyle:p.isSupported(V.outlineStyle)?V.outlineStyle:void 0,fillLineArea:V.fillLineArea,lineAreaOpacity:V.lineAreaOpacity,donutHolePercent:w(V.donutHolePercent),donutGap:w(V.donutGap),donutArcPercent:w(V.donutArcPercent),gaugeHolePercent:w(V.gaugeHolePercent),gaugeRangeMin:w(V.gaugeRangeMin),gaugeRangeMax:w(V.gaugeRangeMax),gaugeGap:w(V.gaugeGap),gaugeStartAngle:w(V.gaugeStartAngle),gaugeArcPercent:w(V.gaugeArcPercent),gaugeLabelStyle:C(V.gaugeLabelStyle),gaugeLabelPlacement:V.gaugeLabelPlacement?h.toSupportedValue(V.gaugeLabelPlacement):void 0,gaugeShowArrow:V.gaugeShowArrow||void 0,gaugeArrowLineColor:B(V.gaugeArrowLineColor),gaugeArrowFillColor:B(V.gaugeArrowFillColor),gaugeConditionalStylingOthers:void 0!==V.gaugeConditionalStylingIgnoreOthers?V.gaugeConditionalStylingIgnoreOthers:V.gaugeConditionalStylingOthers||void 0,gaugeConditionalStylingLabel:V.gaugeConditionalStylingLabel||void 0,gaugeShowFromToLabels:V.gaugeShowFromToLabels||void 0,gaugeFromLabelStyle:C(V.gaugeFromLabelStyle),gaugeToLabelStyle:C(V.gaugeToLabelStyle),waffleDirection:V.waffleDirection?y.toSupportedValue(V.waffleDirection):void 0,waffleFlowStyle:S.isSupported(V.waffleFlowStyle)?V.waffleFlowStyle:void 0,waffleShowWholePictures:V.waffleShowWholePictures||void 0,waffleStretchIconsToFill:V.waffleStretchIconsToFill||void 0,waffleRangeMin:w(V.waffleRangeMin),waffleRangeMax:w(V.waffleRangeMax),waffleLabelPlacement:V.waffleLabelPlacement?f.toSupportedValue(V.waffleLabelPlacement):void 0,waffleLabelOffset:w(V.waffleLabelOffset,r.ptToPx),waffleHideValue:V.waffleHideValue||void 0,waffleHideLabel:V.waffleHideLabel||void 0,waffleShowLabelAbove:V.waffleShowLabelAbove||void 0,waffleValueStyle:C(V.waffleValueStyle),waffleLabelStyle:C(V.waffleLabelStyle),waffleColumnSpace:w(V.waffleColumnSpace,r.ptToPx),waffleRowSpace:w(V.waffleRowSpace,r.ptToPx),waffleConditionalStylingOthers:void 0!==V.waffleConditionalStylingIgnoreOthers?V.waffleConditionalStylingIgnoreOthers:V.waffleConditionalStylingOthers||void 0,waffleConditionalStylingValue:V.waffleConditionalStylingValue||void 0,waffleConditionalStylingLabel:V.waffleConditionalStylingLabel||void 0,waffleNumIcons:w(V.waffleNumIcons),waffleNumRows:w(V.waffleNumRows),waffleNumColumns:w(V.waffleNumColumns),ringBackgroundColor:B(V.ringBackgroundColor),ringBackgroundOpacity:w(V.ringBackgroundOpacity),columnBarShowWholePictures:void 0!==V.showWholePictures?V.showWholePictures:V.columnBarShowWholePictures,showAxisIcons:V.showAxisIcons,showChartIcons:V.showChartIcons,sorting:d.isSupported(V.sorting)?V.sorting:void 0},T(V))},K=w(O[0]._originalAttrs.thickness);if(o.isColumnBarLike(V.type)?Z.visualProperties.columnThickness=K>1?g.LARGE:K<1?g.SMALL:g.MEDIUM:o.isLineLike(V.type)&&(Z.visualProperties.lineThickness=v(K,c),O.forEach(function(e){e._originalAttrs.thickness!==K&&(e.lineThickness=w(e._originalAttrs.thickness,r.ptToPx))})),O.forEach(function(e){delete e._originalAttrs}),F){var Q=F&&F.attributes||{};Z.visualProperties.legend={type:n.toSupportedValue(Q.type)},Z.visualProperties.legend.type===n.MIN_MAX?e.mixin(Z.visualProperties.legend,{minMax:{placement:s.toSupportedValue(Q.placement),placementOffset:w(Q.placementOffset),titleStyle:C(Q.titleStyle),minVariableLabelStyle:C(Q.minVariableLabelStyle),maxVariableLabelStyle:C(Q.maxVariableLabelStyle)}}):e.mixin(Z.visualProperties.legend,{series:{placement:s.toSupportedValue(Q.placement),placementOffset:w(Q.placementOffset),hasBorder:Q.hasBorder,labelParts:Q.labelParts,style:C(Q.style),symbol:u.isSupported(Q.symbol)?Q.symbol:void 0,hideOthers:Q.hideOthers||void 0,showComparison:Q.showComparison||void 0}})}c.revisionVersion<1.2&&(void 0!==Z.visualProperties.donutGap&&(Z.visualProperties.donutGap/=2*Math.PI),void 0!==Z.visualProperties.gaugeGap&&(Z.visualProperties.gaugeGap/=2*Math.PI)),J&&J.length&&(Z.visualProperties.chartIcons=J.map(function(e){return e.tags&&e.tags[0]?c.parsers.getParser("field").parseField(e.tags[0],e,null,c):null})),W&&W.length&&(Z.visualProperties.floatingIcons=W.map(function(e){return c.parsers.getParser("section").parseTable(e.tags[0],c)})),D&&D.length&&(Z.visualProperties.floatingTexts=D.map(function(e){return c.parsers.getParser("section").parseTable(e.tags[0],c)})),G&&G.length&&(Z.visualProperties.conditionalStyling=c.parsers.getParser("field").parseFieldTrigger(G[0])),q&&(Z.visualProperties.filter=c.parsers.getParser("filter").getFilter(q)),Z.comparisonInfo=m;var Y={};return a.attributes&&a.attributes.style&&e.mixin(Y,r.parseStyleString(a.attributes.style)),r.ptToPxObj(Y),l.provideDefaultValueForMissing(Z,{font:Y}),c.postProcessChartJson(t,Z),Z},I});