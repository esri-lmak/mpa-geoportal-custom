// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","esri/dijit/geoenrichment/Deferred","esri/dijit/geoenrichment/when","esri/dijit/geoenrichment/promise/all","./supportClasses/AnalysisAreaJsonUtil","./supportClasses/AnalysisAreaUtil","esri/dijit/geoenrichment/ReportPlayer/countryConfig"],function(e,r,a,t,o,i,n,s,l){function c(){var r=new t;return e(["./supportClasses/attachments/AttachmentsStoreSerializer","./supportClasses/GEUtil","../core/supportClasses/templateJsonUtils/TemplateJsonSerializer","../core/supportClasses/templateJsonUtils/TemplateJsonAnalyzer","../core/infographics/simpleInfographic/dataDrilling/EnrichUtil","../core/infographics/utils/InfographicJsonUtil","../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider","../core/infographics/InfographicTypes","../core/infographics/simpleInfographic/dataDrilling/DataDrillingLibrary","./commands/mapToImage/MapToURLUtil","esri/dijit/geoenrichment/utils/ProjectionUtil"],function(e,a,t,o,i,n,s,l,c,I,D){p=e,f=a,u=t,m=o,g=i,h=n,d=s,v=l,b=c,y=I,A=D,r.resolve()}),r.promise}var p,f,u,m,g,h,d,v,b,y,A;return r(null,{reportDataToJson:function(e,r){var t=this;return r=r||{},c().then(function(){return o(r.loadDataDrillingData&&t._serializeDataDrilling(e),function(){return o(e.attachmentsStore&&p.getAttachmentsStoreJson(e.attachmentsStore,e.analysisAreas.length),function(o){var i=a.mixin({},e.config);!1!==r.forceFixedDataMode&&delete i.geoenrichmentUrl;var s={isClassic:e.isClassic,isMultiFeature:e.isMultiFeature,reportType:e.reportType,reportTitle:e.reportTitle,templateJson:u.serialize(e.templateJson),reportObject:t._prepareReportObjectJson(e.reportObject),fieldData:e.fieldData,analysisAreas:n.areasToJson(e.analysisAreas),combinedAreasInfo:e.combinedAreasInfo&&n.combinedAreasInfoToJson(e.combinedAreasInfo),reverseAnalysisAreasOnMap:e.reverseAnalysisAreasOnMap,infographicOptions:e.infographicOptions&&e.infographicOptions.toJson(),attachmentsStore:o,templateVariableProvider:e.templateVariableProvider&&e.templateVariableProvider.toJson(),config:i,countryConfig:l.toJson(),mapImageInfos:r.mapImageInfos,customLogo:e.customLogo};return console.log("_SerializationSupport.js => reportDataJson"),console.log(s),s})})})},_prepareReportObjectJson:function(e){var r={};for(var a in e)e[a]&&"object"!=typeof e[a]&&(r[a]=e[a]);return r},_serializeDataDrilling:function(e){var r=g.getEnrichInfosForTemplateJson(e.infographicOptions.countryID,e.templateJson),t=[];t.push(this.enrichFieldData(r,a.mixin({analysisAreas:e.analysisAreas,fieldData:e.fieldData},e.config))),t.push(this._enrichInfographicVariables(e,r));var o={};r&&r.forEach(function(e){e.isChart||e.isGeneral?e.fields.forEach(function(e){e.mapTo&&(o[e.mapTo]=1)}):e.isInfographic&&(e.fieldInfos?e.fieldInfos.forEach(function(e){e.hasVariable&&e.fullName&&(o[e.fullName]=1)}):e.variables&&e.variables.forEach(function(e){o[e]=1}))});var n=m.collectVariablesStats(e.templateJson);for(var s in n)o[s]=1;var l=b.getSubstitutionVariables(e.config.countryID);return l&&l.forEach(function(e){o[e]=1}),t.push(e.templateVariableProvider.tryFetchDataVintageInfo(e.config,o)),i(t)},_enrichInfographicVariables:function(e,r){var a=e.infographicOptions;return o(a.getOptions().getItems(a.countryID),function(){var o=[];return r.forEach(function(r){r.isInfographic&&r.variables&&e.analysisAreas.forEach(function(e,i){a.setCurrentAnalysisAreaIndex(i);var n=new t,s=a.createGeoenrichment({currentFeatureIndex:i});s.onDone=function(){n.resolve()},s.country=a.countryID;var l=v.supportsComparison(r.type);s.setGeoLevels(l?h.getSubLevels(r):null,l?h.getHighestLevel(r):null),s.setVariables(r.variables),s.setStudyArea(a.studyArea),o.push(n.promise)})}),i(o)})},reportDataFromJson:function(e){var r=this;return c().then(function(){var a=e.fieldData;a.featureData&&(a.areaData=a.featureData.map(function(e){return{mainCalculator:{data:e}}}),delete a.featureData);var t={isClassic:e.isClassic,isMultiFeature:e.isMultiFeature,reportType:e.reportType,reportTitle:e.reportTitle,templateJson:u.deserialize(e.templateJson),reportObject:e.reportObject,fieldData:a,analysisAreas:n.areasFromJson(e.analysisAreas),combinedAreasInfo:e.combinedAreasInfo&&n.combinedAreasInfoFromJson(e.combinedAreasInfo)||{},reverseAnalysisAreasOnMap:e.reverseAnalysisAreasOnMap,infographicOptions:e.infographicOptions&&r._infographicOptionsProvider.getInfographicOptionsFromJson(e.infographicOptions),attachmentsStore:e.attachmentsStore&&p.getAttachmentsStoreFromJson(e.attachmentsStore),templateVariableProvider:e.templateVariableProvider&&new d(e.templateVariableProvider),config:e.config||{},mapImageInfos:e.mapImageInfos,customLogo:e.customLogo};return s.populateCombinedAreasInfo(t.combinedAreasInfo,t.analysisAreas),f.setGeoenrichmentUrl(t.config.geoenrichmentUrl),t.config.geometryServiceUrl&&A.setGeometryServiceUrl(t.config.geometryServiceUrl),t.config.printMapTaskUrl&&y.setPrintMapTaskUrl(t.config.printMapTaskUrl),l.fromJson(e.countryConfig),t})}})});