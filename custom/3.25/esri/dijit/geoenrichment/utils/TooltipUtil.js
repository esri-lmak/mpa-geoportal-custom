// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/on","dojo/mouse","dojo/sniff","dijit/Tooltip","dijit/place","./DeviceUtil","./DnDUtil","./DomUtil","./MouseUtil","dojo/domReady!"],function(o,e,t,i,s,n,l,r,d,a,c,u,p,h,T){function v(){}var f={},N=o(a._MasterTooltip,{_customClasses:null,addCustomClasses:function(o){o&&(t.add(this.domNode,o),this._customClasses=o)},show:function(o,t,s,n,l,r,d){if(!this.aroundNode||this.aroundNode!==t||this.containerNode.innerHTML!=o){if("playing"==this.fadeOut.status())return void(this._onDeck=arguments);"string"==typeof o?this.containerNode.innerHTML=o:(this.containerNode.innerHTML="",i.place(o.domNode,this.containerNode)),l&&this.set("textDir",l),this.containerNode.align=n?"right":"left";var u=c.around(this.domNode,t,s&&s.length?s:a.defaultPosition,!n,e.hitch(this,"orient")),p=u.aroundNodePos;"M"==u.corner.charAt(0)&&"M"==u.aroundCorner.charAt(0)?(this.connectorNode.style.top=p.y+(p.h-this.connectorNode.offsetHeight>>1)-u.y+"px",this.connectorNode.style.left=""):"M"==u.corner.charAt(1)&&"M"==u.aroundCorner.charAt(1)?this.connectorNode.style.left=p.x+(p.w-this.connectorNode.offsetWidth>>1)-u.x+"px":(this.connectorNode.style.left="",this.connectorNode.style.top=""),this.domNode.style.opacity="0",this.fadeIn.play(),this.isShowingNow=!0,this.aroundNode=t,this.onMouseEnter=r||v,this.onMouseLeave=d||v}},orient:function(o,e,t,i,n){this.connectorNode.style.top="";var l=i.h,r=i.w;o.className="dijitTooltip "+{"MR-ML":"dijitTooltipRight","ML-MR":"dijitTooltipLeft","TM-BM":"dijitTooltipAbove","BM-TM":"dijitTooltipBelow","BL-TL":"dijitTooltipBelow dijitTooltipABLeft","TL-BL":"dijitTooltipAbove dijitTooltipABLeft","BR-TR":"dijitTooltipBelow dijitTooltipABRight","TR-BR":"dijitTooltipAbove dijitTooltipABRight","BR-BL":"dijitTooltipRight","BL-BR":"dijitTooltipLeft"}[e+"-"+t],this.addCustomClasses(this._customClasses),this.domNode.style.width="auto";var a=s.position(this.domNode);(d("ie")||d("trident"))&&(a.w+=2);var c=Math.min(Math.max(r,1),a.w);if(s.setMarginBox(this.domNode,{w:c}),"B"==t.charAt(0)&&"B"==e.charAt(0)){var u=s.position(o),p=this.connectorNode.offsetHeight;if(u.h>l){var h=l-(n.h+p>>1);this.connectorNode.style.top=h+"px",this.connectorNode.style.bottom=""}else this.connectorNode.style.bottom=Math.min(Math.max(n.h/2-p/2,0),u.h-p)+"px",this.connectorNode.style.top=""}else this.connectorNode.style.top="",this.connectorNode.style.bottom="";return Math.max(0,a.w-r)}}),m={show:function(o,e,t,i){t=t&&t.map(function(o){return{after:"after-centered",before:"before-centered"}[o]||o});var s=new N;return s.addCustomClasses(i),s.show(o,e,t),s}};f.setTooltipToNode=function(o,e,t){function i(){!s&&f.showTooltipForNode(o,e,t)}if(t=t||{},o&&(f.hideTooltipForNode(o),o.__setTooltipToNodeMouseEnterHandle&&o.__setTooltipToNodeMouseEnterHandle.remove(),e)){var s=!1;return u.isMobileDevice()?o.__setTooltipToNodeMouseEnterHandle=p.addNoDragClickHandler(o,i):o.__setTooltipToNodeMouseEnterHandle=l(o,r.enter,i),{remove:function(){e=null,f.hideTooltipForNode(o)},suspend:function(){f.hideTooltipForNode(o),s=!0},resume:function(){s=!1}}}},f.showTooltipForNode=function(o,e,i){function s(){f.hideTooltipForNode(o);var e=Array.isArray(i.classes)?i.classes.join(" "):i.classes;e=(e||"")+" esriGETooltip",i.notRestricted&&(e+=" notRestricted"),o._shownTooltip=d=m.show(n,o,i.position||["after","before"],e)}if(o){f.hideTooltipForNode(o);var n="function"==typeof e?e():e;if(n){i.textAlign&&(n="<div class='"+("start"===i.textAlign?"esriGEStart":"end"===i.textAlign?"esriGEEnd":"")+"'>"+n+"</div>"),t.add(o,"esriGESimpleTextTooltip");var d;s();var a=f.hideTooltipForNode.bind(f,o);return u.isMobileDevice()?o.__setTooltipToNodeMouseLeaveHandle=l(document.body,"touchstart",function(e){T.isMouseOver(o,{event:e})||a()}):o.__setTooltipToNodeMouseLeaveHandle=l.once(o,r.leave,function(){!i.stayOnHover&&a()}),i.ignoreNodeRemoval||(o.__setTooltipToNodeInLayoutHandle=setInterval(function(){!h.isNodeInLayout(o)&&a()},300)),u.isMobileDevice()||(o.__setTooltipToNodeMouseOverHandle=setInterval(function(){(!i.stayOnHover||!T.isMouseOver(d.domNode))&&!T.isMouseOver(o)&&a()},300),o.__setTooltipToNodeClickHandle=l(o,"click",function(e){i.hideOnClick?a():!o._shownTooltip&&s()}),i.stayOnHover&&(o.__setTooltipToNodeMouseLeaveMasterHandle=l(d.domNode,r.leave,a))),o._shownTooltip}}},f.hideTooltipForNode=function(o){o&&(delete o.title,t.remove(o,"esriGESimpleTextTooltip"),o._shownTooltip&&o._shownTooltip.destroy(),delete o._shownTooltip,o.__setTooltipToNodeMouseLeaveHandle&&o.__setTooltipToNodeMouseLeaveHandle.remove(),clearInterval(o.__setTooltipToNodeInLayoutHandle),clearInterval(o.__setTooltipToNodeMouseOverHandle),o.__setTooltipToNodeClickHandle&&o.__setTooltipToNodeClickHandle.remove(),o.__setTooltipToNodeMouseLeaveMasterHandle&&o.__setTooltipToNodeMouseLeaveMasterHandle.remove())};var _,M;return f.autoTooltip=function(o){l(o,".TrimWithEllipses:mouseover",function(){function o(){_=null,M&&(M.tooltip.destroy(),M.mouseOutH.remove(),M.mouseMoveH.remove(),M=null)}this!==_&&this.offsetWidth<this.scrollWidth&&(o(),_=this,M={tooltip:m.show(_.textContent,_,["above","below"]),mouseOutH:l.once(_,"mouseout, mousedown, touchstart",o),mouseMoveH:l(document.body,"mousemove",function(){T.isMouseOver(_)||o()})})})},f.showClosableTooltip=function(o){var e=f._createClosableTooltip(o.message,o.tooltipClass,o.position);return f._placeClosableTooltip(e,o.node,o.timeout,o.position,o.onClosed)},f.removeClosableTooltip=function(o){o&&o._removeFunc&&o._removeFunc()},f._createClosableTooltip=function(o,e,s){function n(){var o=i.create("div",{class:"esriGEClosableTooltipTip"},a);t.add(o,"right"===s?"esriGEClosableTooltipTipRight":"esriGEClosableTooltipTipLeft")}function l(){r=i.create("div",{class:"esriGEClosableTooltipBody"},a),i.create("div",{innerHTML:o,class:"esriGEClosableTooltipLabel"},r),d=i.create("div",{class:"esriGEClosableTooltipCloseButton"},r)}var r,d,a=i.create("div",{class:"esriGEClosableTooltip esriGENonSelectable "+(e||"")},document.body);return"right"!==s?(l(),n()):(n(),l()),a.style.position="fixed",{tooltip:a,body:r,closeButton:d}},f._placeClosableTooltip=function(o,e,t,i,r){function d(){var t=s.position(e),i=t.x+";"+t.y+";"+t.w+";"+t.h;if(i!==a){a=i;var l=s.getMarginBox(o.tooltip);n.set(o.tooltip,{left:(c?t.x+t.w:t.x-l.w)+"px",top:t.y+t.h/2-l.h/2+"px"})}}var a,c="rtl"===document.dir&&"right"!==i||"rtl"!==document.dir&&"right"===i;d();var u,p,T,v,f,N=function(){u&&clearTimeout(u),p&&clearInterval(p),T&&clearInterval(T),v&&v.remove(),o.tooltip.parentNode&&o.tooltip.parentNode.removeChild(o.tooltip)};return p=setInterval(function(){h.isNodeInLayout(e)||(f=!1,N()),h.isNodeVisible(e)&&h.isNodeOnscreen(e)?(f=!0,h.show(o.tooltip)):(f=!1,h.hide(o.tooltip))},300),T=setInterval(function(){f&&d()},0),t&&(u=setTimeout(N,t)),v=l(o.closeButton,"click",function(){N(),r&&r()}),o.tooltip._removeFunc=N,o.tooltip},f});