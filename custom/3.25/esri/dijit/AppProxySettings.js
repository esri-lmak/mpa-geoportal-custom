// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","../kernel","dojo/uacss","dijit/_WidgetBase","../arcgis/AppProxyManager","../arcgis/utils","dojo/i18n!../nls/jsapi","dojo/Deferred","dojo/on","dojo/promise/all","dojo/query","dojo/string","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/store/Memory","dijit/form/CheckBox","dijit/form/Select","dijit/form/NumberSpinner","dgrid/OnDemandGrid","dgrid/editor","dojo/domReady!"],function(i,e,t,r,s,o,n,a,h,c,d,u,l,p,m,g,_,f,x,y,v,w,b,P){function j(i){return"second"===i?1:"minute"===i?60:"hour"===i?3600:"day"===i?86400:U}function S(i){return 1===i?"second":60===i?"minute":3600===i?"hour":86400===i?"day":I}var I="none",U=0,M=c.widgets.appProxySettings,A=t([v],{destroy:function(){if(this._destroyed||this._beingDestroyed)return void this.closeDropDown();this.inherited(arguments)}}),D=t([n],{declaredClass:"esri.dijit.AppProxySettings",_subscriberDomains:[/demographics\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/route\w*\.arcgis\.com/i,/logistics\w*\.arcgis\.com/i,/analysis\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i,/sentinel\w*\.arcgis\.com/i,/oceans\w*\.arcgis\.com/i,/tiledbasemaps\w*\.arcgis\.com/i],_premiumDomains:[/traffic\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/hydro\w*\.arcgis\.com/i,/naip\w*\.arcgis\.com/i,/livefeeds\w*\.arcgis\.com/i,/demographics\w*\.arcgis\.com/i,/landscape\w*\.arcgis\.com/i,/historical\w*\.arcgis\.com/i,/earthobs\w*\.arcgis\.com/i],defaults:{webmaps:[],proxyManagerOptions:{appid:""},proxies:[]},constructor:function(i){this._editing=!1,this.css={container:"esriAppProxySettings"};var e=r.mixin({},this.defaults,i);this.set(e),this.appProxyManager=new a(this.proxyManagerOptions),this.appProxyManager.loaded?this._init():u.once(this.appProxyManager,"load",r.hitch(this,function(){this._init()}))},startup:function(){this.inherited(arguments),this.loaded?this._createTable():u.once(this,"load",r.hitch(this,function(){this._createTable()}))},resize:function(){this._grid&&this._grid.resize()},isSubscriber:function(i){return e.some(this._subscriberDomains,function(e){return i.search(e)>-1})},isPremium:function(i){return e.some(this._premiumDomains,function(e){return i.search(e)>-1})},_queryForSecureServices:function(i){return h.getItem(i).then(r.hitch(this,this._parseMap)).then(r.hitch(this,function(i){var t=this._mapsProxies;return e.forEach(i,r.hitch(this,function(i){t.push(i)})),i}))},_loaded:function(){this.set("loaded",!0),this.emit("load")},_itemInApp:function(i,t){return e.some(this._mapsProxies,function(e){if(e[i]===t.url)return e.title=t.title,!0})},_parseUrl:function(i){var e=document.createElement("a");return e.href=i,e},_checkItem:function(i){var e=new d,t=this._parseUrl(i.url);return this.isPremium(t.host)||this.isSubscriber(t.host)?e.resolve({sourceUrl:i.url,id:i.id,title:i.title,proxyId:null,proxied:!1}):e.resolve(),e.promise},_parseMap:function(i){if(i&&i.itemData){var t=i.itemData.operationalLayers,s=[];return e.forEach(t,r.hitch(this,function(i){this._itemInApp("sourceUrl",i)||s.push(this._checkItem(i))})),l(s).then(function(i){var t=[];return e.forEach(i,function(i){i&&t.push(i)}),t})}var o=new d;return o.resolve(),o.promise},_getWebmapsProxies:function(){this._mapsProxies=this.proxies;for(var i=[],e=0,t=this.webmaps.length;e<t;e++)i.push(this._queryForSecureServices(this.webmaps[e]));return l(i)},_webmapsChanged:function(){var i=new d;return this.webmaps&&this.webmaps.length?this._getWebmapsProxies().then(r.hitch(this,function(){this.set("proxies",this._mapsProxies),i.resolve()})):i.resolve(),i.promise},_init:function(){var i=this.appProxyManager.proxies;e.forEach(i,r.hitch(this,function(i,e){if(!i.hasOwnProperty("title")){var t=this._parseUrl(i.sourceUrl);t&&t.host&&(i.title=m.substitute(M.untitled,{url:t.host}))}i.hasOwnProperty("proxied")||(i.proxied=!0,i.id="AppProxy"+e)})),this.proxies=i,this.webmaps&&this.webmaps.length?this._webmapsChanged().then(r.hitch(this,function(){this._loaded()})):this._loaded()},_createTable:function(){this._memoryStore=new x({data:this.proxies});var i=f.create("div",{className:this.css.container},this.domNode),e=t([b]);this._grid=new e({store:this._memoryStore,columns:{proxied:P({label:"",field:"proxied",canEdit:r.hitch(this,this._canToggleProxied),editor:y,get:r.hitch(this,this._getProxied),formatter:r.hitch(this,this._getFieldValue),editorArgs:{value:!0}}),title:{label:M.premiumContent,get:this.title},requestLimit:P({label:M.requestLimit,field:"requestLimit",get:this._getHitsPerInterval,formatter:r.hitch(this,this._getFieldValue),canEdit:r.hitch(this,this._canUpdateField),editor:w,editorArgs:{constraints:{min:0},style:"width:75%;"}}),interval:P({label:M.interval,field:"interval",get:this._getInterval,formatter:r.hitch(this,this._getFieldValue),canEdit:r.hitch(this,this._canUpdateField),editor:A,editorArgs:{style:"width:75%;",options:[{value:"none",label:M.intervalNone},{value:"second",label:M.intervalSecond},{value:"minute",label:M.intervalMinute},{value:"hour",label:M.intervalHour},{value:"day",label:M.intervalDay}]}})}},i),this._grid.startup(),this.own(u(this._grid,"dgrid-datachange",r.hitch(this,function(i){function e(){this._editing=!1,this._grid.refresh()}var t=i.cell,s=t&&t.column&&t.column.field,o=i.value,n=t&&t.row&&t.row.data;s&&(n[s]=o);var a,h={proxyId:n.proxyId,proxyUrl:n.proxyUrl,sourceUrl:n.sourceUrl,proxied:n.proxied,hitsPerInterval:this._getHitsPerInterval(n),intervalSeconds:j(n.interval)};a=h.proxied?h.proxyId?this.appProxyManager.updateProxy(h).then(r.hitch(this,function(i){i&&(this._updateProxy(n,i),this.emit("update-proxy",n))})):this.appProxyManager.createProxies([h]).then(r.hitch(this,function(i){i&&(this._updateProxy(n,i),this.emit("create-proxy",n))})):this.appProxyManager.deleteProxies([h]).then(r.hitch(this,function(i){i&&(this._updateProxy(n,i),this.emit("delete-proxy",n))})),this._editing=!0,this._grid.refresh(),a.then(r.hitch(this,e)).otherwise(r.hitch(this,e))})))},_getFieldValue:function(i){return this._editing?'<span class="esriAppProxyLoading"></span>':i},_canUpdateField:function(i){return!this._editing&&this._getProxied(i)},_canToggleProxied:function(){return!this._editing},_updateProxy:function(i,t){this._memoryStore&&e.some(t,r.hitch(this,function(e){if(e.sourceUrl===i.sourceUrl){var t=r.mixin(i,{proxied:i.proxied,proxyId:i.proxied?e.proxyId:void 0});return i=t,this._memoryStore.put(t,{overwrite:!0}),!0}}))},_getProxied:function(i){return i&&!!i.proxied},_getInterval:function(i){var e=i.interval||S(i.intervalSeconds);return i&&e&&i.proxied?e:I},_getHitsPerInterval:function(i){var e="number"==typeof i.requestLimit?i.requestLimit:i.hitsPerInterval;return i&&e&&i.proxied?e:0},_setWebmapsAttr:function(i){var e=i.slice();this._set("webmaps",e),this._created&&this._memoryStore&&this._webmapsChanged()},_setProxiesAttr:function(i){var e=i.slice();this._set("proxies",e),this._created&&this._memoryStore&&(this._memoryStore.setData(this.proxies),this._grid.set("store",this._memoryStore))}});return o("extend-esri")&&r.setObject("dijit.AppProxySettings",D,s),D});