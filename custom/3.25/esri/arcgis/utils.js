// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["require","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/Deferred","dojo/_base/json","dojo/_base/url","dojo/on","dojo/DeferredList","dojo/dom-construct","dojo/sniff","dojox/gfx/_base","../kernel","../config","../Color","../lang","../request","../SpatialReference","../map","../urlUtils","../geometry/Point","../geometry/ScreenPoint","../geometry/Extent","../geometry/webMercatorUtils","../symbols/jsonUtils","../renderers/jsonUtils","../dijit/PopupTemplate","../dijit/Popup","../tasks/query","../tasks/GeometryService","../layers/ArcGISTiledMapServiceLayer","../layers/FeatureLayer","dojo/i18n!../nls/jsapi"],function(e,i,r,a,n,t,o,s,l,c,f,p,u,d,y,m,b,h,g,v,I,S,D,L,w,x,M,k,_,E,O,R,P){function C(e,i){return e.match(i+"$")==i}function T(e){var i=Re.arcgisUrl+"/"+e.itemId+"/data";return b({url:i,content:{f:"json"},callbackParamName:"callback"},{disableIdentityLookup:!0,_preLookup:!0})}function j(e,i){var r={f:"json"};return i&&(r.token=i),b({url:e,content:r,callbackParamName:"callback"},{disableIdentityLookup:!0})}function A(e){!e.layerDefinition||e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.labelingInfo||(e.showLabels=!1),e.itemProperties.layerDefinition&&(e.layerDefinition?(e.layerDefinition.drawingInfo||(e.layerDefinition.drawingInfo=e.itemProperties.layerDefinition.drawingInfo),m.isDefined(e.layerDefinition.definitionExpression)||(e.layerDefinition.definitionExpression=e.itemProperties.layerDefinition.definitionExpression),m.isDefined(e.layerDefinition.minScale)||(e.layerDefinition.minScale=e.itemProperties.layerDefinition.minScale),m.isDefined(e.layerDefinition.maxScale)||(e.layerDefinition.maxScale=e.itemProperties.layerDefinition.maxScale)):e.layerDefinition=e.itemProperties.layerDefinition),!e.itemProperties.popupInfo||e.popupInfo||e.disablePopup||(e.popupInfo=e.itemProperties.popupInfo),m.isDefined(e.itemProperties.showLabels)&&!m.isDefined(e.showLabels)&&(e.showLabels=e.itemProperties.showLabels),m.isDefined(e.itemProperties.showLegend)&&!m.isDefined(e.showLegend)&&(e.showLegend=e.itemProperties.showLegend),m.isDefined(e.itemProperties.refreshInterval)&&!m.isDefined(e.refreshInterval)&&(e.refreshInterval=e.itemProperties.refreshInterval)}function F(e){A(e),e.itemProperties.layerDefinition&&e.layerDefinition&&(!m.isDefined(e.layerDefinition.maximumTrackPoints)&&m.isDefined(e.itemProperties.layerDefinition.maximumTrackPoints)&&(e.layerDefinition.maximumTrackPoints=e.itemProperties.layerDefinition.maximumTrackPoints),!e.layerDefinition.definitionGeometry&&e.itemProperties.layerDefinition.definitionGeometry&&(e.layerDefinition.definitionGeometry=e.itemProperties.layerDefinition.definitionGeometry)),e.itemProperties.purgeOptions&&!e.purgeOptions&&(e.purgeOptions=e.itemProperties.purgeOptions)}function U(e,i){var a=new n,t=e.itemData,o=[],s=[];if(r.forEach(t.operationalLayers,function(e){if(e.itemId&&!e.type){var i=e.url.toLowerCase();i.indexOf("/featureserver")>-1||i.indexOf("/mapserver/")>-1?(s.push(e),o.push(T(e))):i.indexOf("/mapserver")>-1&&-1===i.indexOf("/mapserver/")&&(!e.layers||!m.isDefined(e.minScale)&&!m.isDefined(e.maxScale))?(s.push(e),o.push(T(e))):i.indexOf("/imageserver")>-1&&!m.isDefined(e.minScale)&&!m.isDefined(e.maxScale)?(s.push(e),o.push(T(e))):i.indexOf("/streamserver")>-1&&(s.push(e),o.push(T(e)))}}),t.baseMap&&t.baseMap.baseMapLayers&&r.forEach(t.baseMap.baseMapLayers,function(e){e.itemId&&"VectorTileLayer"!==e.layerType&&(s.push(e),o.push(T(e)))}),o.length>0){var c=new l(o),f={};c.addCallback(function(i){r.forEach(s,function(e,a){var n=i[a][1];if(n&&!(n instanceof Error)&&(f[e.itemId]=n,!e.type)){var t=e.url.toLowerCase();(t.indexOf("/featureserver")>-1||t.indexOf("/mapserver/")>-1)&&n.layers?r.forEach(n.layers,function(i){(C(t,"/featureserver/"+i.id)||C(t,"/mapserver/"+i.id))&&(e.itemProperties=i,A(e))}):t.indexOf("/streamserver")>-1?(e.itemProperties=n,F(e)):t.indexOf("/mapserver")>-1?(n.layers&&!e.layers&&(e.layers=n.layers),m.isDefined(n.minScale)&&!m.isDefined(e.minScale)&&(e.minScale=n.minScale),m.isDefined(n.maxScale)&&!m.isDefined(e.maxScale)&&(e.maxScale=n.maxScale),m.isDefined(n.refreshInterval)&&!m.isDefined(e.refreshInterval)&&(e.refreshInterval=n.refreshInterval),n.visibleLayers&&!e.visibleLayers&&(e.visibleLayers=n.visibleLayers)):t.indexOf("/imageserver")>-1&&(m.isDefined(n.minScale)&&!m.isDefined(e.minScale)&&(e.minScale=n.minScale),m.isDefined(n.maxScale)&&!m.isDefined(e.maxScale)&&(e.maxScale=n.maxScale),m.isDefined(n.refreshInterval)&&!m.isDefined(e.refreshInterval)&&(e.refreshInterval=n.refreshInterval),!n.popupInfo||e.popupInfo||e.disablePopup||(e.popupInfo=n.popupInfo),n.renderingRule&&!e.renderingRule&&(e.renderingRule=n.renderingRule,n.renderingRule.functionName&&(e.renderingRule.rasterFunction=n.renderingRule.functionName)),n.bandIds&&!e.bandIds&&(e.bandIds=n.bandIds),n.mosaicRule&&!e.mosaicRule&&(e.mosaicRule=n.mosaicRule),n.format&&!e.format&&(e.format=n.format),m.isDefined(n.compressionQuality)&&!m.isDefined(e.compressionQuality)&&(e.compressionQuality=n.compressionQuality),!n.layerDefinition||!n.layerDefinition.definitionExpression||m.isDefined(e.layerDefinition)&&m.isDefined(e.layerDefinition.definitionExpression)||(e.layerDefinition=e.layerDefinition||{},e.layerDefinition.definitionExpression=n.layerDefinition.definitionExpression))}}),e.relatedItemsData=f,a.callback(e)})}else a.callback(e);return a}function W(e,r){var t=new n,o=e.itemData,s=o.baseMap.baseMapLayers[0];if("BingMapsAerial"===s.type||"BingMapsRoad"===s.type||"BingMapsHybrid"===s.type)if(s.portalUrl&&u.id)delete r.bingMapsKey,u.id.checkSignInStatus(v.urlToObject(Re.arcgisUrl).path).then(i.hitch(null,function(e,r,a,n,t){j(s.portalUrl,t.token).then(i.hitch(null,B,e,r,a,n),i.hitch(null,V,e,r,a,n))},e,r,o,t),i.hitch(null,function(e,r,a,n,t){j(s.portalUrl).then(i.hitch(null,B,e,r,a,n),i.hitch(null,V,e,r,a,n))},e,r,o,t));else if(r.bingMapsKey){var l=new Ye({bingMapsKey:r.bingMapsKey,mapStyle:Ye.MAP_STYLE_AERIAL});a.connect(l,"onLoad",i.hitch(this,function(){t.callback([e,r])})),a.connect(l,"onError",function(i){delete r.bingMapsKey,e.itemData=K(o),s=e.itemData.baseMap.baseMapLayers[0],s.errors=[];var a={message:"The owner of the application has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."};s.errors.push(a),t.callback([e,r])})}else{e.itemData=K(o),s=e.itemData.baseMap.baseMapLayers[0],s.errors=[];var c={message:"The owner of the application has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."};s.errors.push(c),t.callback([e,r])}else t.callback([e,r]);return t}function G(e){var i,r,a=new n,t=e.itemData,o=t.baseMap&&t.baseMap.baseMapLayers;if(Qe&&!Qe.supported())for(var s=0;s<o.length;s++){var l=o[s];if(!l.isReference){"VectorTileLayer"===l.layerType&&(i=l.itemId,r=s);break}}return i?ke(i,!1).addBoth(function(e){var i=/^https?:\/\/basemaps(dev)?\.arcgis\.com\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i;e&&e.item&&i.test(e.item.url)&&(o[r]={id:"FB_"+l.id,layerType:"ArcGISTiledMapServiceLayer",opacity:"opacity"in l?l.opacity:1,visibility:!("visibility"in l)||l.visibility,url:"https://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer"}),a.resolve()}):a.resolve(),a}function B(e,r,n,t,o){if(o.bingKey){r.bingMapsKey=o.bingKey;var s=new Ye({bingMapsKey:r.bingMapsKey,mapStyle:Ye.MAP_STYLE_AERIAL});a.connect(s,"onLoad",i.hitch(this,function(){t.callback([e,r])})),a.connect(s,"onError",function(i){delete r.bingMapsKey,e.itemData=K(n);var a=e.itemData.baseMap.baseMapLayers[0];a.errors=[];var o={message:"The owner of the map has not provided a valid Bing Key for the Bing Map it includes. Switching to Esri layers."};a.errors.push(o),t.callback([e,r])})}else V(e,r,n,t)}function V(e,i,r,a){delete i.bingMapsKey,e.itemData=K(r);var n=e.itemData.baseMap.baseMapLayers[0];n.errors=[];var t={message:"The owner of the map has not provided a Bing Key for the Bing Map it includes. Switching to Esri layers."};n.errors.push(t),a.callback([e,i])}function K(e){return"BingMapsAerial"===e.baseMap.baseMapLayers[0].type?e.baseMap={title:"Imagery",baseMapLayers:[{id:"World_Imagery_2017",visibility:!0,opacity:1,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}]}:"BingMapsRoad"===e.baseMap.baseMapLayers[0].type?e.baseMap={title:"Streets",baseMapLayers:[{id:"World_Street_Map_8421",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"}]}:e.baseMap={title:"Imagery with Labels",baseMapLayers:[{id:"World_Imagery_6611",opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"},{id:"World_Boundaries_and_Places_1145",isReference:!0,opacity:1,visibility:!0,url:"https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer"}]},e}function N(e,i,a,n){var t=e.dynamicLayerInfos||e.layerInfos,o=i.layers;if(o&&t)if(n.usePopupManager){var s;r.forEach(t,function(e){var i,r=e.id;if(!e.subLayerIds)for(i=0;i<o.length;i++){var n=o[i];if(n.id===r&&n.popupInfo){s||(s={}),s[r]={infoTemplate:new a(n.popupInfo),layerUrl:n.layerUrl};break}}}),s&&e.setInfoTemplates(s)}else{var l=[],c=[],f=[],p=[],u=[],d=[];r.forEach(t,function(i){var a,n=i.id;if(!i.subLayerIds&&-1!==r.indexOf(e.visibleLayers,n))for(a=0;a<o.length;a++){var t=o[a];if(t.id===n){c.push(n),l.push(t.popupInfo),f.push(t.layerUrl||""),t.layerDefinition&&t.layerDefinition.definitionExpression?p.push(t.layerDefinition.definitionExpression):p.push(""),u.push(m.isDefined(t.minScale)?t.minScale:null),d.push(m.isDefined(t.maxScale)?t.maxScale:null);break}}}),l.length&&(e.__popups=l,e.__popupIds=c,e.__popupUrls=f,e.__popupWhereClauses=p,e.__popupMinScales=u,e.__popupMaxScales=d,e.__resourceInfo=i.resourceInfo)}}function J(e){if(!e)return!1;var i=new o(Re.arcgisUrl).authority;return-1!==e.indexOf(".arcgis.com/")||-1!==e.indexOf(i)}function z(e){return!!e&&(-1!==e.indexOf("/services.arcgisonline.com/")||-1!==e.indexOf("/server.arcgisonline.com/"))}function H(e){return"https:"===location.protocol&&(J(e)||z(e))&&(e=e.replace("http:","https:")),e}function q(e,a,n){var t,o=[];e.displayLevels||(o=r.map(e.resourceInfo.tileInfo.lods,function(e){return e.level})),e.exclusionAreas&&(t=i.clone(e.exclusionAreas),t=r.map(t,function(e){return e.geometry=new D(e.geometry),e}));var s=new O(H(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,displayLevels:e.displayLevels||o,id:e.id,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval,exclusionAreas:t});return n.ignorePopups||N(s,e,a,n),s}function Q(e,i){if(!e||!i||0===i.length)return[];var r,a=","+i+",",n=[],t=",";for(r=0;r<e.length;r++)null!==e[r].subLayerIds?(-1===a.indexOf(","+e[r].id+",")||t.indexOf(","+e[r].id+",")>-1)&&(t+=e[r].subLayerIds.toString()+","):a.indexOf(","+e[r].id+",")>-1&&-1===t.indexOf(","+e[r].id+",")&&n.push(e[r].id);return n}function Y(e,a,n){var t=new We;t.format="png24",e.resourceInfo&&e.resourceInfo.supportedImageFormatTypes&&e.resourceInfo.supportedImageFormatTypes.indexOf("PNG32")>-1&&(t.format="png32");var o=new Pe(H(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,imageParameters:t,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval}),s=e.visibleLayers;if(!e.visibleLayers){var l="",c=o.layerInfos;r.forEach(c,function(e){e.defaultVisibility&&(l+=(l.length>0?",":"")+e.id)}),s=l}if(e.layers&&e.layers.length>0){var f,p,u,d=[],y=[],m=[];r.forEach(e.layers,function(a){var n=a.layerDefinition;if(n&&n.definitionExpression&&(d[a.id]=n.definitionExpression),n&&n.source){if(f=null,u=n.source,"mapLayer"===u.type){var t=r.filter(e.resourceInfo.layers,function(e){return e.id===u.mapLayerId});t.length&&(f=i.mixin(t[0],a))}else f=i.mixin({},a);if(f){if(f.source=u,delete f.popupInfo,f=new Fe(f),e.visibleLayers){var o="string"==typeof e.visibleLayers?e.visibleLayers.split(","):e.visibleLayers;r.indexOf(o,a.id)>-1?f.defaultVisibility=!0:f.defaultVisibility=!1}y.push(f)}}if(n&&null!=n.transparency){var s=n.drawingInfo||{};null==s.transparency&&(s.transparency=n.transparency,n.drawingInfo=s)}n&&n.source&&n.drawingInfo&&(p=new Ke(n.drawingInfo),m[a.id]=p)},this),d.length>0&&o.setLayerDefinitions(d),y.length>0?(o.setDynamicLayerInfos(y,!0),m.length>0&&o.setLayerDrawingOptions(m,!0)):(s=Q(o.layerInfos,s),o.setVisibleLayers(s))}else s=Q(o.layerInfos,s),o.setVisibleLayers(s);return n.ignorePopups||N(o,e,a,n),o}function X(e,i,r){var a=new Ge;if(a.bandIds=e.bandIds,null!=e.format&&(a.format=e.format,null!=e.compressionQuality&&(a.compressionQuality=e.compressionQuality)),e.renderingRule&&e.renderingRule.rasterFunction){var n=new ze(e.renderingRule);a.renderingRule=n}if(e.mosaicRule){var t=new Ne(e.mosaicRule);a.mosaicRule=t}m.isDefined(e.noData)&&(a.noData=e.noData),m.isDefined(e.noDataInterpretation)&&(a.noDataInterpretation=e.noDataInterpretation),m.isDefined(e.interpolation)&&(a.interpolation=e.interpolation);var o,s=!!e.layerType&&"ArcGISImageServiceVectorLayer"===e.layerType;m.isDefined(e.layerType)||(s=e.resourceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===e.resourceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===e.resourceInfo.serviceDataType));var l={resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,imageServiceParameters:a,minScale:e.minScale,maxScale:e.maxScale,refreshInterval:e.refreshInterval};if(o=s?new Te(H(e.url),l):new Ce(H(e.url),l),e.layerDefinition){if(e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer){var c=x.fromJson(e.layerDefinition.drawingInfo.renderer);o.setRenderer(c)}e.layerDefinition.definitionExpression&&o.setDefinitionExpression(e.layerDefinition.definitionExpression,!0)}return!r.ignorePopups&&e.popupInfo&&o.setInfoTemplate(new i(e.popupInfo)),o}function $(e,i,a){var n=[102113,102100,3857],t=a||new h(i[0].layerObject.fullExtent.spatialReference),o=new h(e.resourceInfo.fullExtent.spatialReference);return!(t.wkt!=o.wkt||!(t.wkid==o.wkid||m.isDefined(t.latestWkid)&&t.latestWkid==o.wkid||m.isDefined(o.latestWkid)&&t.wkid==o.latestWkid||m.isDefined(t.latestWkid)&&t.latestWkid==o.latestWkid))||!!(t.wkid&&o.wkid&&r.some(n,function(e){return e===o.wkid})&&r.some(n,function(e){return e===t.wkid}))}function Z(e,i,r){if(!i[0].layerObject.tileInfo)return!1;for(var a=e.resourceInfo.tileInfo,n=i[0].layerObject.tileInfo,t=r.width>r.height?r.width:r.height,o=!1,s=!1,l=0;l<a.lods.length;l++){for(var c=a.lods[l].scale/a.dpi,f=0;f<n.lods.length;f++){var p=n.lods[f].scale/n.dpi;if(Math.abs(p-c)/p<1/t){if(o){s=!0;break}o=!0}}if(s)break}return!!s||!(!o||1!==a.lods.length&&1!==n.lods.length)}function ee(e,n,o,l,c,f){var d,y,b=o._clazz;if("OpenStreetMap"===e.type)d=new Je({id:e.id,opacity:e.opacity,visible:null===e.visibility||void 0===e.visibility||e.visibility});else if("WFS"===e.type){var g={customParameters:e.wfsInfo.customParameters,geometryType:e.layerDefinition.geometryType,id:e.id,labelingInfo:e.layerDefinition.drawingInfo.labelingInfo,maxFeatures:e.wfsInfo.maxFeatures,mode:e.mode,name:e.wfsInfo.name,showLabels:!0,swapXY:e.wfsInfo.swapXY,title:e.title,url:e.url,version:e.wfsInfo.version,visible:e.visibility,wkid:e.layerDefinition.spatialReference.wkid};d=new $e,d.fromJson(g,function(){m.isDefined(e.opacity)&&d.setOpacity(e.opacity),m.isDefined(e.visibility)&&d.setVisibility(e.visibility),(e.minScale||e.maxScale)&&d.setScaleRange(e.minScale,e.maxScale),d.renderer=x.fromJson(e.layerDefinition.drawingInfo.renderer),!o.ignorePopups&&e.popupInfo&&d.setInfoTemplate(new b(e.popupInfo)),d.emit("fromJsonComplete")})}else if("WMS"===e.type){var I=[],S=[];r.forEach(e.layers,function(e){S.push(new ei({name:e.name,title:e.title,legendURL:e.legendURL||e.legendUrl,queryable:e.queryable,showPopup:e.showPopup})),I.push(e.name)},this),e.visibleLayers&&(I=e.visibleLayers);var L=new D(e.extent[0][0],e.extent[0][1],e.extent[1][0],e.extent[1][1],new h({wkid:4326})),k={customLayerParameters:e.customLayerParameters,customParameters:e.customParameters,extent:L,layerInfos:S,version:e.version,maxWidth:e.maxWidth,maxHeight:e.maxHeight,featureInfoFormat:e.featureInfoFormat,getFeatureInfoURL:e.featureInfoUrl,getMapURL:e.mapUrl,spatialReferences:e.spatialReferences,title:e.title,copyright:e.copyright,minScale:e.minScale||0,maxScale:e.maxScale||0,format:e.format};d=new Ze(e.url,{id:e.id,visibleLayers:I,format:"png",transparent:!e.firstLayer,opacity:e.opacity,visible:null===e.visibility||e.visibility,resourceInfo:k,refreshInterval:e.refreshInterval}),d.spatialReference.wkid=k.spatialReferences[0]}else if("KML"===e.type){if(y=e.url,u.id){var _=u.id.findCredential(v.urlToObject(Re.arcgisUrl).path);if(_){var E=Re.arcgisUrl.substring(Re.arcgisUrl.indexOf("//")+2,Re.arcgisUrl.indexOf("/",Re.arcgisUrl.indexOf("//")+3)),O=E.split("."),P=O[O.length-2]+"."+O[O.length-1],C=y.indexOf(P);C>-1&&(y="https://"+E+y.substring(C+P.length),y+="?token="+_.token)}}d=new Be(y,{id:e.id,visible:null===e.visibility||e.visibility,outSR:l,refreshInterval:e.refreshInterval}),a.connect(d,"onLoad",function(){(e.opacity||0===e.opacity)&&d.setOpacity(e.opacity),m.isDefined(e.minScale)&&m.isDefined(e.maxScale)&&d.setScaleRange(e.minScale,e.maxScale),e.visibleFolders&&r.forEach(d.folders,function(i){r.indexOf(e.visibleFolders,i.id)>-1?d.setFolderVisibility(i,!0):d.setFolderVisibility(i,!1)},this)})}else if("WebTiledLayer"===e.type)d=new Xe(e.templateUrl,{id:e.id,visible:null===e.visibility||e.visibility,opacity:e.opacity,copyright:e.copyright,fullExtent:e.fullExtent&&new D(e.fullExtent),initialExtent:e.fullExtent&&new D(e.fullExtent),subDomains:e.subDomains,tileInfo:e.tileInfo?new qe(e.tileInfo):null,refreshInterval:e.refreshInterval,wmtsInfo:e.wmtsInfo}),(m.isDefined(e.minScale)||m.isDefined(e.maxScale))&&(d.loaded?d.setScaleRange(e.minScale,e.maxScale):a.connect(d,"onLoad",function(){d.setScaleRange(e.minScale,e.maxScale)}));else if("GeoRSS"===e.type)d=new Ue(e.url,{id:e.id,opacity:e.opacity,outSpatialReference:l,refreshInterval:e.refreshInterval}),a.connect(d,"onLoad",function(){!1===e.visibility&&d.hide(),m.isDefined(e.minScale)&&m.isDefined(e.maxScale)&&d.setScaleRange(e.minScale,e.maxScale);var i=d.getFeatureLayers();r.forEach(i,function(r){e.pointSymbol&&"esriGeometryPoint"===r.geometryType?(r.renderer.symbol=w.fromJson(e.pointSymbol),1===i.length&&(d.pointSymbol=w.fromJson(e.pointSymbol))):e.lineSymbol&&"esriGeometryPolyline"===r.geometryType?(r.renderer.symbol=w.fromJson(e.lineSymbol),1===i.length&&(d.polylineSymbol=w.fromJson(e.lineSymbol))):e.polygonSymbol&&"esriGeometryPolygon"===r.geometryType&&(r.renderer.symbol=w.fromJson(e.polygonSymbol),1===i.length&&(d.polygonSymbol=w.fromJson(e.polygonSymbol)))})});else if("CSV"==e.type&&e.url){var T={layerDefinition:e.layerDefinition,columnDelimiter:e.columnDelimiter,id:e.id?e.id:null,visible:null===e.visibility||e.visibility,opacity:e.opacity,refreshInterval:e.refreshInterval};e.locationInfo&&(T.latitudeFieldName=e.locationInfo.latitudeFieldName,T.longitudeFieldName=e.locationInfo.longitudeFieldName),!o.ignorePopups&&e.popupInfo&&(T.infoTemplate=new b(e.popupInfo)),d=new Ae(e.url,T)}else if("VectorTileLayer"===e.layerType&&e.styleUrl)d=new Qe(e.styleUrl,{id:e.id,minScale:e.minScale,maxScale:e.maxScale,opacity:e.opacity,visible:e.visibility});else if(e.layerDefinition&&!e.url){var j=t.fromJson(t.toJson(e));delete j.id,delete j.opacity,delete j.visibility,d=new R(j,{id:e.id,opacity:e.opacity,visible:e.visibility,outFields:["*"],autoGeneralize:!0}),!o.ignorePopups&&j.popupInfo&&d.setInfoTemplate(new b(j.popupInfo)),ne(d)}else if("BingMapsAerial"===e.type||"BingMapsRoad"===e.type||"BingMapsHybrid"===e.type)if(o.bingMapsKey){var A=Ye.MAP_STYLE_AERIAL_WITH_LABELS;"BingMapsAerial"===e.type?A=Ye.MAP_STYLE_AERIAL:"BingMapsRoad"===e.type&&(A=Ye.MAP_STYLE_ROAD),d=new Ye({bingMapsKey:o.bingMapsKey,mapStyle:A,opacity:e.opacity,id:e.id}),a.connect(d,"onError",i.hitch(this,function(e){e.errors=e.errors||[];var i={message:"This application does not have a valid Bing Key for the Bing layer that is included in this map. [type:"+e.type+"]"};e.errors.push(i)},e))}else{e.errors=e.errors||[];var F={message:"This application does not provide a Bing Key for the Bing layer that is included in this map. [type:"+e.type+"]"};e.errors.push(F)}else if(e.resourceInfo&&(e.resourceInfo.mapName||""===e.resourceInfo.mapName))d=!0===e.resourceInfo.singleFusedMapCache&&(e.baseMapLayer||$(e,n,l)&&Z(e,c,f))?q(e,b,o):Y(e,b,o);else if(e.resourceInfo&&e.resourceInfo.pixelSizeX)d=!0===e.resourceInfo.singleFusedMapCache&&(e.baseMapLayer||$(e,n,l)&&Z(e,c,f))?q(e,b,o):X(e,b,o);else if(e.resourceInfo&&"Feature Layer"===e.resourceInfo.type){e.capabilities&&(e.resourceInfo.capabilities=e.capabilities);var U;if(!1===o.editable?U=!1:o.privileges&&-1===r.indexOf(o.privileges,"features:user:edit")&&u.id&&u.id.findCredential(e.url)&&(U=!1),d=new R(H(e.url),{resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id,mode:e.mode===R.MODE_SELECTION?R.MODE_SELECTION:R.MODE_AUTO,editable:U,outFields:["*"],autoGeneralize:!0,refreshInterval:e.refreshInterval}),!o.ignorePopups&&e.popupInfo&&d.setInfoTemplate(new b(e.popupInfo)),e.layerDefinition){if(e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer){var W=x.fromJson(e.layerDefinition.drawingInfo.renderer);W.isMaxInclusive=!0,d.setRenderer(W)}if(e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.labelingInfo){var G=r.map(e.layerDefinition.drawingInfo.labelingInfo,function(e){return new Ve(e)});d.setLabelingInfo(G)}e.layerDefinition.definitionExpression&&d.setDefinitionExpression(e.layerDefinition.definitionExpression),m.isDefined(e.layerDefinition.minScale)&&d.setMinScale(e.layerDefinition.minScale),m.isDefined(e.layerDefinition.maxScale)&&d.setMaxScale(e.layerDefinition.maxScale)}ne(d)}else if(e.resourceInfo&&e.resourceInfo.streamUrls){var B,V,K,N={resourceInfo:e.resourceInfo,opacity:e.opacity,visible:e.visibility,id:e.id};e.layerDefinition&&(V=e.layerDefinition.drawingInfo,e.layerDefinition.definitionGeometry&&(B=B||{},B.geometry=e.layerDefinition.definitionGeometry),m.isDefined(e.layerDefinition.definitionExpression)&&(B=B||{},B.where=e.layerDefinition.definitionExpression),m.isDefined(e.layerDefinition.maximumTrackPoints)&&(N.maximumTrackPoints=e.layerDefinition.maximumTrackPoints)),B&&(N.filter=B),e.purgeOptions&&(N.purgeOptions=e.purgeOptions),d=new He(H(e.url),N),V&&V.renderer&&(K=V.renderer,d.setRenderer(x.fromJson(K))),!o.ignorePopups&&e.popupInfo&&d.setInfoTemplate(new b(e.popupInfo)),e.layerDefinition&&(m.isDefined(e.layerDefinition.minScale)&&d.setMinScale(e.layerDefinition.minScale),m.isDefined(e.layerDefinition.maxScale)&&d.setMaxScale(e.layerDefinition.maxScale)),s.once(d,"error",function(i){e.errors.push({message:"Error loading stream layer. Check websocket url"})})}if(d&&(d.arcgisProps={title:e.title},e.baseMapLayer&&(e.isReference?(d.attr("data-reference",!0),d._basemapGalleryLayerType="reference"):d._basemapGalleryLayerType="basemap"),d instanceof R&&e.layerDefinition&&e.layerDefinition.featureReduction&&"cluster"===e.layerDefinition.featureReduction.type)){var J=e.layerDefinition.featureReduction;J.clusterSize&&(J.clusterSize=p.pt2px(J.clusterSize)),J.clusterRadius&&(J.clusterRadius=p.pt2px(J.clusterRadius)),J.popupInfo&&(J.infoTemplate=new M(J.popupInfo),delete J.popupInfo),d.setFeatureReduction(J)}return d}function ie(e,i,a,n,t){r.forEach(e,function(r){r.layerObject=ee(r,e,i,a,n,t)});var o=r.filter(e,function(e){return!e.isReference}),s=r.filter(e,function(e){return!!e.isReference});return e=o.concat(s)}function re(e){var i=null,r=e[0];return r.url&&!r.type?r.resourceInfo.spatialReference&&(i=new h,r.resourceInfo.spatialReference.wkid&&(i.wkid=r.resourceInfo.spatialReference.wkid),r.resourceInfo.spatialReference.wkt&&(i.wkt=r.resourceInfo.spatialReference.wkt)):r.type&&(r.type.indexOf("BingMaps")>-1||"OpenStreetMap"==r.type?i=new h({wkid:102100}):"WMS"==r.type&&(i=new h({wkid:r.spatialReferences[0]}))),i}function ae(e,i,a,n,t,o,s,l){return r.forEach(i,function(i){i.url&&!i.type&&(i.resourceInfo=e[i.deferredsPos][1],delete i.deferredsPos)}),o=o||re(i),i=ie(i,a,o,s,l),t.callback(i),t}function ne(e){if(!window.CanvasRenderingContext2D&&e.renderer&&"esri.renderer.HeatmapRenderer"===e.renderer.declaredClass){var i={type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}};e.setRenderer(x.fromJson(i))}}function te(e,i){var r=H(e);return b({url:r,content:{f:"json"},callbackParamName:"callback",error:function(e,a){e.message?e.message+=" [url:"+r+"]":e.message="[url:"+r+"]",i.push(e),d.defaults.io.errorHandler(e,a)}})}function oe(e){var i=Re.arcgisUrl+"/"+e.itemId+"/data";return b({url:i,content:{f:"json"},callbackParamName:"callback",error:function(r,a){r.message?r.message+=" [url:"+i+"]":r.message="[url:"+i+"]",e.errors=e.errors||[],e.errors.push(r),d.defaults.io.errorHandler(r,a)}})}function se(e,a,o){var s=new n;if(!(o.featureCollection&&o.featureCollection.layers||o.layers)){console.log("Invalid Feature Collection item data [item id: "+e.itemId+"]: ",o),e.errors=e.errors||[];var l={message:"Invalid Feature Collection item data. [item id: "+e.itemId+"]"};return e.errors.push(l),s.errback(),s}return o.layers&&(o.featureCollection={layers:o.layers},delete o.layers,m.isDefined(o.showLegend)&&(o.featureCollection.showLegend=o.showLegend,delete o.showLegend)),le(e,o.featureCollection,a).then(function(a){o.featureCollection=a,e.featureCollection&&e.featureCollection.layers?r.forEach(o.featureCollection.layers,function(r,a){var n=e.featureCollection.layers[a];n.popupInfo||n.layerDefinition?n.layerDefinition?(m.isDefined(n.layerDefinition.minScale)&&m.isDefined(n.layerDefinition.maxScale)&&(n.layerDefinition.minScale!==r.layerDefinition.minScale||n.layerDefinition.maxScale!==r.layerDefinition.maxScale)&&(delete r.layerDefinition.minScale,delete r.layerDefinition.maxScale),n.layerDefinition.drawingInfo&&t.toJson(n.layerDefinition.drawingInfo)!==t.toJson(r.layerDefinition.drawingInfo)&&delete r.layerDefinition.drawingInfo,n.layerDefinition.showLegend!==r.layerDefinition.showLegend&&delete r.layerDefinition.showLegend,n.layerDefinition=i.mixin(n.layerDefinition,r.layerDefinition)):n.layerDefinition=r.layerDefinition:(n.popupInfo=r.popupInfo,n.layerDefinition=r.layerDefinition),n.featureSet=r.featureSet,n.nextObjectId=r.nextObjectId}):(e.featureCollection=e.featureCollection||{},e.featureCollection=i.mixin(e.featureCollection,o.featureCollection)),s.callback(e)}),s}function le(i,a,t){var o=new n;return e(["./csv"],function(e){var n=[];r.forEach(a.layers,function(i){if(i.featureSet&&i.featureSet.features&&i.featureSet.features.length&&i.featureSet.features[0].geometry&&i.featureSet.features[0].geometry.spatialReference){i.deferredsPos=n.length;var r=i.featureSet.features[0].geometry.spatialReference;n.push(e.projectFeatureCollection(i,t,r))}}),new l(n).addCallback(function(){r.forEach(a.layers,function(e){if(m.isDefined(e.deferredsPos)){if(n[e.deferredsPos].results&&n[e.deferredsPos].results.length)e=n[e.deferredsPos].results[0];else{console.log("Errors projecting feature collection. ["+i.title+" - "+e.layerDefinition.name+"]"),e.errors=e.errors||[];var r={message:"Errors projecting feature collection. ["+i.title+" - "+e.layerDefinition.name+"]"};e.errors.push(r)}delete e.deferredsPos}}),o.callback(a)})}),o}function ce(a,t,o,c,f){var p,u=new n,d=new n,y=[];return r.forEach(a.operationalLayers,function(e){e.itemId&&"Feature Collection"==e.type&&y.push(oe(e).then(i.hitch(null,se,e,o)))}),0===y.length?fe(a,t,o,c,d,f):(p=new l(y),p.addCallback(function(e){fe(a,t,o,c,d,f)})),d.then(function(e){if(y=[],r.forEach(e,function(e){var i;e=e.layerObject,e instanceof R&&!e.loaded&&!e.loadError?(i=new n,s.once(e,"load, error",function(){i.callback(e)}),y.push(i)):e&&"esri.layers.WFSLayer"===e.declaredClass&&!e.loadError&&(i=new n,s.once(e,"fromJsonComplete, error",function(r){i.callback(e)}),y.push(i))}),y.length){var i=new n;return p=new l(y),p.addCallback(function(){i.callback(e)}),i.promise}return e}).then(function(i){var a=[];r.forEach(i,function(e){var i=e.layerObject;i instanceof R?i.loaded&&i.labelingInfo&&(e.showLabels||i._collection?a.push(i):i.setShowLabels&&i.setShowLabels(!1)):i&&"esri.layers.WFSLayer"===i.declaredClass&&i.loaded&&i.labelingInfo&&a.push(i)}),a.length?e(["../layers/LabelLayer"],function(e){var n=new e;r.forEach(a,function(e){n.addFeatureLayer(e)}),i.push({layerObject:n}),u.callback(i)}):u.callback(i)}),u}function fe(e,i,a,n,t,o){var s=[],c=[],f=[];if(r.forEach(e.operationalLayers,function(e,i){if(e.featureCollection&&e.featureCollection.layers){var a=e.featureCollection.layers.length;r.forEach(e.featureCollection.layers,function(n,t){var o=!0;e.visibleLayers&&-1==r.indexOf(e.visibleLayers,t)&&(o=!1),n.visibility=e.visibility&&o,n.opacity=e.opacity,n.id=(e.id||"operational"+i)+"_"+t,e.title&&(1!==a&&n.layerDefinition.name&&e.title!==n.layerDefinition.name?n.title=e.title+" - "+n.layerDefinition.name:n.title=e.title),f.push(n)},this)}else f.push(e)}),r.forEach(e.baseMap.baseMapLayers,function(e,i){e.baseMapLayer=!0,e.id=e.id||"base"+i,s.push(e)}),r.forEach(f,function(e,i){e.id=e.id||"operational"+i,s.push(e)}),r.forEach(s,function(e){e.url&&!e.type&&(e.deferredsPos=c.length,e.errors=e.errors||[],c.push(te(e.url,e.errors)))}),0===c.length)a=a||re(s),s=ie(s,i,a,n,o),t.callback(s);else{new l(c).addCallback(function(e){ae(e,s,i,c,t,a,n,o)})}return t}function pe(e,i,a,n){var t,o=e.minScale,s=e.maxScale;if(a.version<=10.1&&i){for(t=i.length-1;t>=0;t--)if(i[t].id==n){if(0==o&&i[t].minScale>0?o=i[t].minScale:o>0&&0==i[t].minScale?o=a.minScale:o>0&&i[t].minScale>0&&(o=Math.min(o,i[t].minScale)),s=Math.max(a.maxScale||0,i[t].maxScale||0),a.setScaleRange(o,s),!(i[t].parentLayerId>-1))break;n=i[t].parentLayerId}}else if(a.version>10.1){var l=e.layerInfos;r.forEach(l,function(e){e.id==n&&(0==o&&e.minScale>0?o=e.minScale:o>0&&0==e.minScale||o>0&&e.minScale>0&&(o=Math.min(o,e.minScale)),s=Math.max(s||0,e.maxScale||0))}),a.setScaleRange(o,s)}}function ue(e,n,t,o){var s=e.url,l=e.__popups,c=e.__popupIds,f=e.__popupUrls,p=e.__popupWhereClauses,u=e.__popupMinScales,d=e.__popupMaxScales,y=e.__resourceInfo,b=[];if(r.forEach(l,function(i,o){if(i){var l,h=[];if(r.forEach(i.fieldInfos,function(e){"shape"!==e.fieldName.toLowerCase()&&h.push(e.fieldName)}),e.dynamicLayerInfos&&e.dynamicLayerInfos.length>0){var g=r.filter(e.dynamicLayerInfos,function(e){return c[o]==e.id})[0].source;l=new R(s+"/dynamicLayer",{parentLayer:e,id:e.id+"_"+c[o],source:g,outFields:h,mode:R.MODE_SELECTION,infoTemplate:i&&new t(i),drawMode:!1,visible:e.visible,autoGeneralize:!0});var v=function(i,r){if(p[i].length>0&&r.setDefinitionExpression(p[i]),m.isDefined(u[i])||m.isDefined(d[i]))if(m.isDefined(e.minScale)||m.isDefined(e.maxScale)){var a=e.minScale,t=e.maxScale;0==a&&u[i]>0?a=u[i]:a>0&&0==u[i]||a>0&&u[i]>0&&(a=Math.min(a,u[i])),t=Math.max(t||0,d[i]||0),r.setScaleRange(a,t)}else r.setScaleRange(u[i],d[i]);else pe(e,n||y.layers,r,c[i])};l.loaded?v(o,l):a.connect(l,"onLoad",function(e){v(o,l)})}else{var I,S=null,D=s+"/"+c[o];if(f[o].length)D=f[o];else if(n)for(I=0;I<n.length;I++)if(n[I].id===c[o]){S=n[I];break}l=new R(H(D),{parentLayer:e,id:e.id+"_"+c[o],outFields:h,mode:R.MODE_SELECTION,infoTemplate:i&&new t(i),drawMode:!1,visible:e.visible,resourceInfo:S,autoGeneralize:!0}),l.loaded?(p[o].length>0&&l.setDefinitionExpression(p[o]),pe(e,n||y.layers,l,c[o])):a.connect(l,"onLoad",function(i){p[o].length>0&&l.setDefinitionExpression(p[o]),pe(e,n||y.layers,i,c[o])})}b.push(l)}}),b.length>0){var h=function(e,i){r.forEach(e,function(e){i?e.show():e.hide()})};a.connect(e,"onVisibilityChange",i.hitch(this,h,b));var g=function(e,i,a){e.id===a.id&&r.forEach(i,function(e){o.removeLayer(e)})}
;a.connect(o,"onLayerRemove",i.hitch(this,g,e,b))}return delete e.__popups,delete e.__popupIds,delete e.__popupUrls,delete e.__popupWhereClauses,delete e.__popupMinScales,delete e.__popupMaxScales,delete e.__resourceInfo,b}function de(e){return b({url:H(e.url+"/layers"),content:{f:"json"},callbackParamName:"callback",error:function(){}})}function ye(e,i,a){var n=[];r.forEach(e,function(e){var i=e.__popups;i&&i.length>1&&e.version>=10&&(e.__deferredsPos=n.length,n.push(de(e)))});var t=[];if(n.length>0){new l(n).addCallback(function(n){r.forEach(e,function(e){if(e.__popups&&e.__popups.length>0)if(e.__deferredsPos||0===e.__deferredsPos){var r=n[e.__deferredsPos][1];t=t.concat(ue(e,r.layers,a,i)),delete e.__deferredsPos}else t=t.concat(ue(e,null,a,i))}),i.addLayers(t)})}else r.forEach(e,function(e){e.__popups&&e.__popups.length>0&&(t=t.concat(ue(e,null,a,i)))}),i.addLayers(t)}function me(e){r.forEach(e,function(e){var i=e.layer;if(i.toJson){var a=i.toJson();a.featureSet&&i.name&&i.name.indexOf("Text")>-1&&r.forEach(a.featureSet.features,function(e,r){if(e.attributes.TEXT){var a=i.graphics[r];a.symbol.setText(e.attributes.TEXT),e.symbol.horizontalAlignment&&(a.symbol.align=e.symbol.horizontalAlignment),a.setSymbol(a.symbol),a.setAttributes(e.attributes)}},this)}})}function be(e){var i=6;return r.forEach(e,function(e){var a=e.renderer;if(a)if("esri.renderer.SimpleRenderer"===a.declaredClass){var n=a.symbol;n&&n.xoffset&&(i=Math.max(i,Math.abs(n.xoffset))),n&&n.yoffset&&(i=Math.max(i,Math.abs(n.yoffset)))}else"esri.renderer.UniqueValueRenderer"!==a.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==a.declaredClass||r.forEach(a.infos,function(e){var r=e.symbol;r&&r.xoffset&&(i=Math.max(i,Math.abs(r.xoffset))),r&&r.yoffset&&(i=Math.max(i,Math.abs(r.yoffset)))})}),i}function he(e){return e&&e.isFeatureReductionActive&&e.isFeatureReductionActive()}function ge(e){var i=this,a=i.infoWindow,t=e.graphic;if(i.loaded){a.hide(),a.clearFeatures();var o=[];if(r.forEach(i.graphicsLayerIds,function(e){var r=i.getLayer(e);r&&r instanceof R&&r.loaded&&r.visible&&(r.clearSelection(),r.infoTemplate&&!r.suspended&&o.push(r))}),r.forEach(i.layerIds,function(e){var r=i.getLayer(e);r&&-1!==r.declaredClass.indexOf("ArcGISImageServiceLayer")&&r.loaded&&r.visible&&r.infoTemplate&&o.push(r)}),t=t&&t.getInfoTemplate()?t:null,o.length||t){var s=be(o),l=e.screenPoint,c=i.toMap(new S(l.x-s,l.y+s)),f=i.toMap(new S(l.x+s,l.y-s)),p=new D(c.x,c.y,f.x,f.y,i.spatialReference),u=new _;u.geometry=p,u.timeExtent=i.timeExtent;var d=!0,y=r.map(o,function(i){var a=he(i);i=a?i.getFeatureReductionLayer():i;var t;if(-1!==i.declaredClass.indexOf("ArcGISImageServiceLayer")){u.geometry=e.mapPoint,d=!1;var o={};o.rasterAttributeTableFieldPrefix="Raster.",o.returnDomainValues=!0,t=i.queryVisibleRasters(u,o),t.addCallback(function(){return i.getVisibleRasters()})}else if("function"==typeof i.selectFeatures)t=i.selectFeatures(u),t.addCallback(function(){return i.getSelectedFeatures()});else{t=new n;var s=r.filter(i.graphics,function(e){return e&&e.visible&&p.intersects(e.geometry)});t.resolve(s)}return t});if(t){var m=new n;m.callback([t]),y.splice(0,0,m)}if(!r.some(y,function(e){return-1===e.fired})){var b=t?1:0;if(r.forEach(o,function(e){-1!==e.declaredClass.indexOf("ArcGISImageServiceLayer")?b+=e.getVisibleRasters().length:b+=e.getSelectedFeatures().length}),!b)return}a.setFeatures(y),a.show(e.mapPoint,{closestFirst:d})}}}function ve(e,i){var r,n=i.mapOptions||{};n.infoWindow||(r=new k({visibleWhenEmpty:!1},c.create("div")),n.infoWindow=r),m.isDefined(n.showInfoWindowOnClick)||i.usePopupManager||(n.showInfoWindowOnClick=!1);var t=new g(e,n);return a.connect(t,"onLayersAddResult",me),t}function Ie(e,i,n,t,o,s){var l,c,f,p;t.map?(l=t.map,c=t.clickEventHandle,f=t.clickEventListener,p=t.errors):(l=ve(t,o),o.ignorePopups||o.disableClickBehavior||o.usePopupManager||(c=a.connect(l,"onClick",ge),f=ge)),l.addLayers(e),o.ignorePopups||o.usePopupManager||ye(e,l,o._clazz);var u=p||[];r.forEach(i,function(e){e.errors&&(u=u.concat(e.errors))},this),l.loaded?s.callback({map:l,itemInfo:n,errors:u,clickEventHandle:c,clickEventListener:f}):a.connect(l,"onLoad",function(){s.callback({map:l,itemInfo:n,errors:u,clickEventHandle:c,clickEventListener:f})})}function Se(e,a,n,t,o){var s=[];if(r.forEach(o,function(e){i.isArray(e.layerObject)?r.forEach(e.layerObject,function(e){s.push(e)}):s.push(e.layerObject)}),"BingMapsAerial"===o[0].type||"BingMapsRoad"===o[0].type||"BingMapsHybrid"===o[0].type)var l=setInterval(function(){if(o[0].layerObject&&o[0].layerObject.loaded)clearInterval(l),De(e,a,n,t,o,s);else if(o[0].errors){clearInterval(l);var i="";o[0].errors&&o[0].errors.length&&(i=" ("+o[0].errors[0].message+")"),t.errback(new Error(P.arcgis.utils.baseLayerError+i))}},10);else if(!s[0]&&o[0].baseMapLayer){var c="";o[0].errors&&o[0].errors.length&&(c=" ("+o[0].errors[0].message+")"),t.errback(new Error(P.arcgis.utils.baseLayerError+c))}else De(e,a,n,t,o,s)}function De(e,a,n,t,o,s){try{var l=n.mapOptions||{};n.mapOptions=l;var c=e.itemData;!l.backgroundColor&&c.background&&c.background.color&&null!=c.background.color[0]&&(l.backgroundColor=y.toDojoColor(c.background.color)),s=r.filter(s,m.isDefined);var f=s[0].spatialReference;if(l.extent)return void Ie(s,o,e,a,n,t);if(l.center&&(null!=l.zoom||l.scale)&&(i.isArray(l.center)&&(l.center=new I(l.center)),L.canProject(l.center,f)))return void Ie(s,o,e,a,n,t);var p=e.item;if(p&&p.extent&&p.extent.length){var u=new D(p.extent[0][0],p.extent[0][1],p.extent[1][0],p.extent[1][1],new h({wkid:4326}));if(4326===f.wkid)l.extent=u,Ie(s,o,e,a,n,t);else if(900913===f.wkid||102100===f.wkid||102113===f.wkid||3857===f.wkid)u.xmin=Math.max(u.xmin,-180),u.xmax=Math.min(u.xmax,180),u.ymin=Math.max(u.ymin,-89.99),u.ymax=Math.min(u.ymax,89.99),l.extent=L.geographicToWebMercator(u),Ie(s,o,e,a,n,t);else if(n.geometryServiceURL||d.defaults.geometryService){var b;b=n.geometryServiceURL?new E(n.geometryServiceURL):d.defaults.geometryService,b.project([u],f,function(i){var r=i[0];l.extent=l.extent||r,Ie(s,o,e,a,n,t)},function(){Ie(s,o,e,a,n,t)})}else t.errback(new Error(P.arcgis.utils.geometryServiceError))}else Ie(s,o,e,a,n,t)}catch(e){t.errback(e)}}function Le(e){var i=[],a=e.operationalLayers;return r.forEach(a,function(e){e.featureCollection?i.push({featureCollection:e.featureCollection,visibility:e.visibility,title:e.title}):e.layerObject&&i.push({layer:e.layerObject,visibility:e.visibility,title:e.title})}),i}function we(e){var i=[],a=e.baseMap.baseMapLayers;return e.operationalLayers&&(a=a.concat(e.operationalLayers)),r.forEach(a,function(e){var a={};if(e.featureCollection&&"CSV"!==e.type)!0===e.featureCollection.showLegend&&r.forEach(e.featureCollection.layers,function(r){if(!1!==r.showLegend){var n=r.layerObject.renderer;a={layer:r.layerObject,title:e.title,defaultSymbol:!!(n&&n.defaultSymbol&&n.defaultLabel)},e.featureCollection.layers.length>1&&(a.title+=" - "+r.layerDefinition.name),i.push(a)}});else if(e.baseMapLayer&&!0===e.showLegend&&e.layerObject||!e.baseMapLayer&&!1!==e.showLegend&&e.layerObject&&!(e.layerObject instanceof R&&e.layerObject.mode===R.MODE_SELECTION)){var n=e.layerObject.renderer,t=e.layerObject.declaredClass,o=!(n&&!(n&&n.defaultSymbol&&n.defaultLabel));if((e.layerObject.version<10.1&&("esri.layers.ArcGISDynamicMapServiceLayer"===t||"esri.layers.ArcGISTiledMapServiceLayer"===t)||"esri.layers.ArcGISImageServiceLayer"===t)&&(o=!0),a={layer:e.layerObject,title:e.title,defaultSymbol:o},e.layers){var s=r.map(r.filter(e.layers,function(e){return!1===e.showLegend}),function(e){return e.id});s.length&&(a.hideLayers=s)}i.push(a)}}),i}function xe(i,a){function t(e,i){r.forEach(e,function(e,r){switch(e){case ii:Pe=i[r];break;case ri:Ce=i[r];break;case ai:Te=i[r];break;case ni:je=i[r];break;case ti:Ae=i[r];break;case oi:Fe=i[r];break;case si:Ue=i[r];break;case li:We=i[r];break;case ci:Ge=i[r];break;case fi:Be=i[r];break;case pi:Ve=i[r];break;case ui:Ke=i[r];break;case di:Ne=i[r];break;case yi:Je=i[r];break;case mi:ze=i[r];break;case bi:He=i[r];break;case hi:qe=i[r];break;case gi:Qe=i[r];break;case vi:Ye=i[r];break;case Ii:Xe=i[r];break;case Si:$e=i[r];break;case Di:Ze=i[r];break;case Li:ei=i[r]}})}var o=new n,s=i.itemData,l=[];s.baseMap&&s.baseMap.baseMapLayers&&(l=l.concat(s.baseMap.baseMapLayers)),s.operationalLayers&&(l=l.concat(s.operationalLayers));for(var c=r.map(l,function(e){return e&&e.layerType}),f=[],p=[],u=!1,d=0;d<c.length;d++){switch(c[d]){case"ArcGISFeatureLayer":-1===r.indexOf(f,pi)&&f.push(pi);break;case"ArcGISImageServiceLayer":case"ArcGISTiledImageServiceLayer":-1===r.indexOf(f,ri)&&(f.push(ri),p.push(ci),p.push(di),p.push(mi));break;case"ArcGISImageServiceVectorLayer":-1===r.indexOf(f,ai)&&(f.push(ai),p.push(ci),p.push(di),p.push(mi));break;case"ArcGISMapServiceLayer":case"ArcGISTiledMapServiceLayer":-1===r.indexOf(f,ii)&&(f.push(ii),p.push(oi),p.push(li),p.push(ui));break;case"ArcGISStreamLayer":-1===r.indexOf(f,bi)&&f.push(bi);break;case"BingMapsAerial":case"BingMapsHybrid":case"BingMapsRoad":-1===r.indexOf(f,vi)&&f.push(vi);break;case"CSV":-1===r.indexOf(f,ti)&&(f.push(ti),p.push(ni));break;case"GeoRSS":-1===r.indexOf(f,si)&&f.push(si);break;case"KML":-1===r.indexOf(f,fi)&&f.push(fi);break;case"OpenStreetMap":-1===r.indexOf(f,yi)&&f.push(yi);break;case"VectorTileLayer":-1===r.indexOf(f,gi)&&f.push(gi);break;case"WebTiledLayer":-1===r.indexOf(f,Ii)&&(f.push(Ii),p.push(hi));break;case"WFS":-1===r.indexOf(f,Si)&&f.push(Si);break;case"WMS":-1===r.indexOf(f,Di)&&(f.push(Di),p.push(Li));break;default:u=!0}if(u)break}return u&&(f=wi,p=xi),f.length?e(f,function(){t(f,arguments),p.length?e(p,function(){t(p,arguments),o.resolve()}):o.resolve()}):o.resolve(),o}function Me(e,a,t,o){var s=o.itemData;s.baseMap&&s.baseMap.baseMapLayers&&s.baseMap.baseMapLayers.length&&(s.baseMap.baseMapLayers[0].firstLayer=!0);var l=a.layerMixins,c=l&&l.length;if(c){var f=function(e){for(var r=0;r<c;r++){var a=l[r];if(a.mixin)if(a.hasOwnProperty("id")){if(e.id===a.id){i.mixin(e,a.mixin);break}}else if(e.url===a.url){i.mixin(e,a.mixin);break}}};r.forEach(s.baseMap&&s.baseMap.baseMapLayers,f),r.forEach(s.operationalLayers,f)}xe(o,a).then(function(){return G(o,a)}).then(function(){return W(o,a)}).then(function(a){var o=a[0],s=a[1];if(o.itemData.operationalLayers&&0!==o.itemData.operationalLayers.length){var l=new n,c=o.itemData.baseMap.baseMapLayers.slice(),f=r.filter(o.itemData.baseMap.baseMapLayers,function(e){return!e.isReference}),p={item:o.item,itemData:{baseMap:{baseMapLayers:f}}};o.itemData.baseMap.baseMapLayers=r.filter(o.itemData.baseMap.baseMapLayers,function(e){return e.isReference}),U(p,s).addCallback(function(r){ce(r.itemData,s).addCallback(i.hitch(null,Se,r,e,s,l))}),l.then(function(e){U(o,s).addCallback(function(i){ce(i.itemData,s,e.map.spatialReference,f,e.map).addCallback(function(r){i.itemData.baseMap.baseMapLayers=c,Se(i,e,s,t,r)})})},i.hitch(t,t.errback))}else U(o,s).addCallback(function(r){ce(r.itemData,s).addCallback(i.hitch(null,Se,r,e,s,t))})})}function ke(e,i){void 0===i&&(i=!0),Re._arcgisUrl&&Re._arcgisUrl.length>0&&(Re.arcgisUrl=Re._arcgisUrl);var r=Re.arcgisUrl+"/"+e,a={},t=new n;return b({url:r,content:{f:"json"},callbackParamName:"callback",load:function(e){if(a.item=e,!i)return void t.callback(a);b({url:r+"/data",content:{f:"json"},callbackParamName:"callback",load:function(e){a.itemData=e,t.callback(a)},error:function(e){t.errback(e)}})},error:function(e){t.errback(e)}}),t}function _e(e,r,a){var t=new n;a=a||{};var o=a.infoTemplateClass;return a._clazz=o&&(i.isObject(o)?o:i.getObject(o))||M,i.isString(e)?ke(e).addCallback(i.hitch(null,Me,r,a,t)).addErrback(i.hitch(t,t.errback)):Me(r,a,t,e),t.addCallback(function(e){var r=e.map;r&&(r.tables=i.getObject("itemInfo.itemData.tables",!1,e)||[])}),t}function Ee(e){return e&&e.itemInfo&&e.itemInfo.itemData?Le(e.itemInfo.itemData):[]}function Oe(e){return e&&e.itemInfo&&e.itemInfo.itemData?we(e.itemInfo.itemData):[]}var Re,Pe,Ce,Te,je,Ae,Fe,Ue,We,Ge,Be,Ve,Ke,Ne,Je,ze,He,qe,Qe,Ye,Xe,$e,Ze,ei,ii="../layers/ArcGISDynamicMapServiceLayer",ri="../layers/ArcGISImageServiceLayer",ai="../layers/ArcGISImageServiceVectorLayer",ni="./csv",ti="../layers/CSVLayer",oi="../layers/DynamicLayerInfo",si="../layers/GeoRSSLayer",li="../layers/ImageParameters",ci="../layers/ImageServiceParameters",fi="../layers/KMLLayer",pi="../layers/LabelClass",ui="../layers/LayerDrawingOptions",di="../layers/MosaicRule",yi="../layers/OpenStreetMapLayer",mi="../layers/RasterFunction",bi="../layers/StreamLayer",hi="../layers/TileInfo",gi="../layers/VectorTileLayer",vi="../virtualearth/VETiledLayer",Ii="../layers/WebTiledLayer",Si="../layers/WFSLayer",Di="../layers/WMSLayer",Li="../layers/WMSLayerInfo",wi=[ii,ri,ai,ti,si,fi,pi,yi,bi,gi,vi,Ii,Si,Di],xi=[ni,oi,li,ci,ui,di,mi,hi,Li];return Re={arcgisUrl:v.getProtocolForWebResource()+"//www.arcgis.com/sharing/rest/content/items",getItem:ke,createMap:_e,getLayerList:Ee,getLegendLayers:Oe,_arcgisUrl:null,_getItemProps:U,_getItemData:T,_getBingKey:j,_portalUrlResponse:B,_portalUrlFailure:V,_processFSItemProperties:A,_processSSItemProperties:F,_getLayers:ce,_preBuildLayerObjects:ae,_buildLayerObjects:ie,_preCreateMap:Se,_getMapSR:re,_createMap:Ie,_addSelectionLayers:ye,_createSelectionFeatureLayers:ue,_getServiceInfo:te,_getFeatureCollectionItem:oe,_mergeFeatureCollectionItem:se,_projectFeatureCollection:le,_getLayersInfo:de,_initLayer:ee,_loadAsCached:q,_loadAsDynamic:Y,_processPopups:N,_onLayersAddResult:me,_sameSpatialReferenceAsBasemap:$,_sameTilingSchemeAsBasemap:Z,_showPopup:ge,_calculateClickTolerance:be,_getVisibleFeatureLayers:Q,_updateLayerScaleInfo:pe,_checkUrl:H,_isHostedService:J,_isAgolService:z,_getLegendLayers:we},i.setObject("arcgis.utils",Re,u),Re});