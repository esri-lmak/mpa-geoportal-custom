// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();define(["require","exports","../../../graphic","./Adapted","./AttributeFilter","./OrderBy","../support/FeatureSet","../support/IdSet","../support/OrderbyClause","../support/sha","../support/shared","../support/sqlUtils","../support/sqlUtils","../support/stats","../support/StatsField","../../polyfill/promiseUtils","../../polyfill/sql/WhereClause","../../../SpatialReference","../../../layers/Field","../../polyfill/sql/FieldsIndex"],function(e,t,i,r,n,a,s,l,o,d,u,f,p,c,h,g,_,y,m,b){"use strict";var v=function(e){function t(t){var i=e.call(this,t)||this;return i._decodedStatsfield=[],i._decodedGroupbyfield=[],i._candosimplegroupby=!0,i.phsyicalgroupbyfields=[],i.objectIdField="GENID",i._internalObjectIdField="GENID",i._adaptedFields=[],i.declaredClass="esri.arcade.featureset.actions.Aggregate",i._uniqueIds=1,i._maxQuery=10,i._maxProcessing=10,i._parent=t.parentfeatureset,i._config=t,i}return __extends(t,e),t.prototype.isTable=function(){return!0},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then(function(e){return t._wset=e,t._wset}):g.resolve(this._wset)},t.prototype._isInFeatureSet=function(e){return u.IdState.InFeatureSet},t.prototype.nextUniqueName=function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t},t.prototype.convertToEsriFieldType=function(e){return e},t.prototype._initialiseFeatureSet=function(){var e={},t=!1,i=1,n=this._parent?this._parent.getFieldsIndex():new b([]);for(this.objectIdField="GENID";!1===t;){for(var a=!1,s=0;s<this._config.groupbyfields.length;s++)if(this._config.groupbyfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}if(!1===a)for(var s=0;s<this._config.statsfields.length;s++)if(this._config.statsfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){a=!0;break}!1===a?t=!0:(this.objectIdField="GENID"+i.toString(),i++)}for(var l=0,o=this._config.statsfields;l<o.length;l++){var d=o[l],c=new h;c.field=d.name,c.tofieldname=d.name,c.workingexpr=d.expression instanceof _.WhereClause?d.expression:_.WhereClause.create(d.expression,n),c.typeofstat=d.statistic.toUpperCase(),this._decodedStatsfield.push(c)}this._decodedGroupbyfield=[];for(var g=0,v=this._config.groupbyfields;g<v.length;g++){var d=v[g],F={name:d.name,singlefield:null,tofieldname:d.name,expression:d.expression instanceof _.WhereClause?d.expression:_.WhereClause.create(d.expression,n)};this._decodedGroupbyfield.push(F)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(var w=0,S=this._parent.fields;w<S.length;w++){var d=S[w];e[d.name.toUpperCase()]=1}this.types=null}else this.geometryType=u.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new y({wkid:4326});this.fields=[];var I=new h;I.field=this.nextUniqueName(e),I.tofieldname=this.objectIdField,I.workingexpr=_.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),I.typeofstat="MIN",this._decodedStatsfield.push(I);for(var x=0,D=this._decodedGroupbyfield;x<D.length;x++){var k=D[x],A=new m;if(k.name=this.nextUniqueName(e),A.name=k.tofieldname,A.alias=A.name,f.isSingleField(k.expression)){var C=this._parent.getField(p.toWhereClause(k.expression,u.FeatureServiceDatabaseType.Standardised));if(!C)throw new Error("Field is not present for Aggregation");k.name=C.name,k.singlefield=C.name,this.phsyicalgroupbyfields.push(C.name),A.type=C.type}else A.type=this.convertToEsriFieldType(p.predictType(k.expression,this._parent.fields)),this.phsyicalgroupbyfields.push(k.name),this._adaptedFields.push(new r.SqlExpressionAdapted(A,k.expression)),this._candosimplegroupby=!1;this.fields.push(A)}if(this._adaptedFields.length>0)for(var E=0,G=this._parent.fields;E<G.length;E++){var d=G[E];this._adaptedFields.push(new r.OriginalField(d))}for(var s=0;s<this._decodedStatsfield.length;s++){var A=new m,C=null,k=this._decodedStatsfield[s];k.field=this.nextUniqueName(e),k.tofieldname===this.objectIdField&&(this._internalObjectIdField=k.field),A.name=k.tofieldname,A.alias=A.name;var T=null!==k.workingexpr&&f.isSingleField(k.workingexpr)?p.toWhereClause(k.workingexpr,u.FeatureServiceDatabaseType.Standardised):"";switch(this._decodedStatsfield[s].typeofstat){case"SUM":if(""!==T){if(!(C=this._parent.getField(T)))throw new Error("Field is not present for Aggregation");A.type=C.type}else A.type="double";break;case"MIN":case"MAX":if(""!==T){if(!(C=this._parent.getField(T)))throw new Error("Field is not present for Aggregation");A.type=C.type}else A.type="double";break;case"COUNT":A.type="integer";break;case"STDEV":case"VARIANCE":case"MEAN":case"AVERAGE":if(""!==T&&!(C=this._parent.getField(T)))throw new Error("Field is not present for Aggregation");A.type="double"}this.fields.push(A)}},t.prototype._canDoAggregates=function(e,t,i,r,n){return g.resolve(!1)},t.prototype._getFeatures=function(e,t,i,r){var n=this,a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);var s=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,s,r)?this._expandPagedSet(e,s,0,0,r).then(function(a){return n._getFeatures(e,t,i,r)}):g.resolve("success")},t.prototype._getFilteredSet=function(e,t,i,s,d){var u=this;if(""!==e)return g.resolve(new l([],[],!0,null));var p=null,c={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then(function(){if(null!==i)for(var e=0;e<u._decodedStatsfield.length;e++)if(!0===f.scanForField(i,u._decodedStatsfield[e].tofieldname)){c.nowhereclause=!0,i=null;break}if(null!==s){c.ordered=!0;for(var e=0;e<u._decodedStatsfield.length;e++)if(!0===s.scanForField(u._decodedStatsfield[e].tofieldname)){s=null,c.ordered=!1;break}for(var t=0,r=u._decodedGroupbyfield;t<r.length;t++){var n=r[t];if(null===n.singlefield&&!0===s.scanForField(n.tofieldname)){s=null,c.ordered=!1;break}}}return!1===u._candosimplegroupby?g.resolve(!1):u._parent._canDoAggregates(u.phsyicalgroupbyfields,u._decodedStatsfield,"",null,null)}).then(function(e){if(e){var t=null;return i&&(t=u._reformulateWhereClauseWithoutGroupByFields(i)),u._parent._getAggregatePagesDataSourceDefinition(u.phsyicalgroupbyfields,u._decodedStatsfield,"",null,t,s,u._internalObjectIdField).then(function(e){return u._checkCancelled(d),p=!0===c.nowhereclause?new l(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===c.ordered&&e._ordered,u._clonePageDefinition(e.pagesDefinition)):new l(e._candidates.slice(0),e._known.slice(0),!0===c.ordered&&e._ordered,u._clonePageDefinition(e.pagesDefinition))})}var f=u._parent;if(u._adaptedFields.length>0&&(f=new r.AdaptedFeatureSet({parentfeatureset:u._parent,adaptedFields:u._adaptedFields,extraFilter:null})),!0===c.nowhereclause)p=new l(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:u._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new a({parentfeatureset:f,orderbyclause:new o(u.phsyicalgroupbyfields.join(",")+","+u._parent.objectIdField+" ASC")})}});else{var h=f;null!==i&&(h=new n({parentfeatureset:h,whereclause:i})),p=new l(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:u._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new a({parentfeatureset:h,orderbyclause:new o(u.phsyicalgroupbyfields.join(",")+","+u._parent.objectIdField+" ASC")})}})}return p})},t.prototype._reformulateWhereClauseWithoutStatsFields=function(e){for(var t=0,i=this._decodedStatsfield;t<i.length;t++){var r=i[t];e=p.reformulateWithoutField(e,r.tofieldname,p.toWhereClause(r.workingexpr,u.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex())}return e},t.prototype._reformulateWhereClauseWithoutGroupByFields=function(e){for(var t=0,i=this._decodedGroupbyfield;t<i.length;t++){var r=i[t];r.tofieldname!==r.name&&(e=p.reformulateWithoutField(e,r.tofieldname,p.toWhereClause(r.expression,u.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()))}return e},t.prototype._clonePageDefinition=function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)},t.prototype._refineSetBlock=function(e,t,i){var r=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery,i))return this._expandPagedSet(e,this._maxQuery,0,0,i).then(function(n){return r._refineSetBlock(e,t,i)});this._checkCancelled(i);var n=e._candidates.length;this._refineKnowns(e,t);e._candidates.length;return e._candidates.length,g.resolve(e)}catch(e){return g.reject(e)}},t.prototype._expandPagedSet=function(e,t,i,r,n){return this._expandPagedSetFeatureSet(e,t,i,r,n)},t.prototype._getPhysicalPage=function(e,t,r){var n=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?this._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r):this._getAgregagtePhysicalPage(e,t,r).then(function(e){for(var t=0,r=e;t<r.length;t++){for(var a=r[t],s={geometry:a.geometry,attributes:{}},l=0,o=n._decodedGroupbyfield;l<o.length;l++){var d=o[l];s.attributes[d.tofieldname]=a.attributes[d.name]}for(var u=0,f=n._decodedStatsfield;u<f.length;u++){var d=f[u];s.attributes[d.tofieldname]=a.attributes[d.field]}n._featureCache[s.attributes[n.objectIdField]]=new i(s)}return e.length})},t.prototype._sequentialGetPhysicalItem=function(e,t,i){var r=this;return null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(i)),!0===e.pagesDefinition.internal.fullyResolved?g.resolve("success"):0===t?g.resolve("success"):e.pagesDefinition.internal.iterator.next().then(function(n){if(null===n)return null!==e.pagesDefinition.internal.workingItem?r._calculateAndAppendAggregateItemDeferred(e.pagesDefinition.internal.workingItem).then(function(t){return e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(t),e.pagesDefinition.internal.fullyResolved=!0,"success"}):(e.pagesDefinition.internal.fullyResolved=!0,"success");var a=r._generateAggregateHash(n);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[n],id:a};else{if(a!==e.pagesDefinition.internal.workingItem.id)return r._calculateAndAppendAggregateItemDeferred(e.pagesDefinition.internal.workingItem).then(function(s){return e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(s),t-=1,e.pagesDefinition.internal.workingItem={features:[n],id:a},r._sequentialGetPhysicalItem(e,t,i)});e.pagesDefinition.internal.workingItem.features.push(n)}return r._sequentialGetPhysicalItem(e,t,i)})},t.prototype._calculateFieldStat=function(e,t,i){for(var r=[],n=0;n<e.features.length;n++)if(null!==t.workingexpr){var a=t.workingexpr.calculateValue(e.features[n]);null!==a?r.push(a):"COUNT"!==t.typeofstat&&r.push(a)}else r.push(null);switch(t.typeofstat){case"MIN":i.attributes[t.tofieldname]=c.calculateStat("min",r,-1);break;case"MAX":i.attributes[t.tofieldname]=c.calculateStat("max",r,-1);break;case"SUM":i.attributes[t.tofieldname]=c.calculateStat("sum",r,-1);break;case"COUNT":i.attributes[t.tofieldname]=r.length;break;case"VARIANCE":i.attributes[t.tofieldname]=c.calculateStat("variance",r,-1);break;case"STDEV":i.attributes[t.tofieldname]=c.calculateStat("stdev",r,-1);break;case"MEAN":case"AVERAGE":i.attributes[t.tofieldname]=c.calculateStat("mean",r,-1)}return!0},t.prototype._calculateAndAppendAggregateItemDeferred=function(e){try{for(var t={attributes:{},geometry:null},r=0,n=this._decodedGroupbyfield;r<n.length;r++){var a=n[r],s=a.singlefield?e.features[0].attributes[a.singlefield]:a.expression.calculateValue(e.features[0]);t.attributes[a.tofieldname]=s}for(var l=0,o=this._decodedStatsfield;l<o.length;l++){var d=o[l];this._calculateFieldStat(e,d,t)}for(var u=[],f=0;f<this._decodedStatsfield.length;f++)u.push(this._calculateFieldStat(e,this._decodedStatsfield[f],t));return this._featureCache[t.attributes[this.objectIdField]]=new i({attributes:t.attributes,geometry:t.geometry}),g.resolve(t.attributes[this.objectIdField])}catch(e){return g.reject(e)}},t.prototype._generateAggregateHash=function(e){for(var t="",i=0,r=this._decodedGroupbyfield;i<r.length;i++){var n=r[i],a=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null===a||void 0===a?":":":"+a.toString()}return new d(t,"TEXT").getHash("SHA-1","B64")},t.prototype._stat=function(e,t,i,r,n,a,s){return g.resolve({calculated:!1})},t}(s);return s._featuresetFunctions.groupby=function(e,t){return new v({parentfeatureset:this,groupbyfields:e,statsfields:t})},v});