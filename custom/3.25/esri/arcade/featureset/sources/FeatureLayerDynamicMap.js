// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(e){for(var t,r=1,a=arguments.length;r<a;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},__assign.apply(this,arguments)};define(["require","exports","../../../graphic","../../../request","../../Attachment","../support/FeatureSet","../support/IdSet","../support/sha","../support/shared","../support/sqlUtils","../support/stats","../../polyfill/promiseUtils","../../../layers/FeatureLayer","../../../tasks/query","../../../tasks/QueryTask","../../../tasks/StatisticDefinition"],function(e,t,r,a,i,n,s,l,o,u,d,p,c,y,f,h){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;if(r.declaredClass="esri.layers.featureset.sources.FeatureLayerDynamic",r._removeGeometry=!1,r._overrideFields=null,r.formulaCredential=null,r._pageJustIds=!1,r._requestStandardised=!1,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,!1===r._layer.loaded)throw new Error("Can only create FeatureSets from Loaded FeatureLayers. Use FeatureLayer or FeatureCollection classes");return void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return __extends(t,e),t.prototype._maxQueryRate=function(){return o.defaultMaxRecords},t.prototype.convertQueryToLruCacheKey=function(e){var t=o.stableStringify(e.toJson());return new l(t,"TEXT").getHash("SHA-1","B64")},t.prototype.end=function(){return this._layer},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=p.create(function(t,r){e._initialiseFeatureSet(),t(e)})),this._loadPromise},t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype._initialiseFeatureSet=function(){if(!this._layer.getMap())throw new Error("Can only use featuresets with layers attached to map");null==this.spatialReference&&(this.spatialReference=this._layer.getMap().spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0);var e=this._layer.getOutFields();if(1===e.length&&"*"===e[0]);else{for(var t=[],r=0,a=this.fields;r<a.length;r++){var i=a[r];if("esriFieldTypeOID"===i.type)t.push(i);else for(var n=0,s=e;n<s.length;n++){var l=s[n];if(l.toLowerCase()===i.name.toLowerCase()){t.push(i);break}}}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{for(var t=[],u=[],d=0,p=this.fields;d<p.length;d++){var i=p[d];if("esriFieldTypeOID"===i.type)t.push(i),u.push(i.name);else for(var c=0,y=this._overrideFields;c<y.length;c++){var l=y[c];if(l.toLowerCase()===i.name.toLowerCase()){t.push(i),u.push(i.name);break}}}this.fields=t,this._overrideFields=u}if(this._layer){var f=this._layer.version;!0===this._layer.useStandardizedQueries?(this._databaseType=o.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==f&&null!==f&&f>=10.61&&(this._databaseType=o.FeatureServiceDatabaseType.Standardised)):void 0!==f&&null!==f&&(f>=10.5&&(this._databaseType=o.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),f>=10.61&&(this._databaseType=o.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return o.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e,t){return p.resolve(e)},t.prototype._candidateIdTransform=function(e){return e},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then(function(){return t._getFilteredSet("",null,null,null,e)}).then(function(e){return t._wset=e,e}):p.resolve(this._wset)},t.prototype._runDatabaseProbe=function(e){var t=this;return p.create(function(r,a){try{t._ensureLoaded().then(function(){try{var i=new y;i.where=e.replace("OBJECTID",t._layer.objectIdField),t.executeQuery(i,"executeForIds").then(function(e){r(!0)},function(e){try{r(!1)}catch(e){a(e)}})}catch(e){a(e)}})}catch(e){a(e)}})},t.prototype.pbfSupportedForQuery=function(e){return this._layer._canFetchPBFForQuery(e)},t.prototype.executeQuery=function(e,t){var r=new f(this._layerUrl()),a="execute"===t&&this.pbfSupportedForQuery(e);a&&(e.quantizationParameters={mode:"edit"});var i=null;if(this.recentlyUsedQueries){var n=this.convertQueryToLruCacheKey(e);i=this.recentlyUsedQueries.getFromCache(n),i&&i.isRejected()&&(i=null,this.recentlyUsedQueries.removeFromCache(n)),null===i&&(i=!0!==a?r[t](e):r[t](e,null,null,{format:"pbf"}),this.recentlyUsedQueries.addToCache(n,i))}return null===i&&(i=!0!==a?r[t](e):r[t](e,null,null,{format:"pbf"})),i},t.prototype._canUsePagination=function(){return void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsPagination},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype._getFilteredSet=function(e,t,r,a,i){var n=this;return this.databaseType().then(function(l){if(n.isTable()&&t&&null!==e&&""!==e){return new s([],[],!0,null)}if(n._canUsePagination())return n._getFilteredSetUsingPaging(e,t,r,a,i);var o="",d=!1;null!==a&&void 0!==n._layer.advancedQueryCapabilities&&null!==n._layer.advancedQueryCapabilities&&!0===n._layer.advancedQueryCapabilities.supportsOrderBy&&(o=a.constructClause(),d=!0);var p=new y;return n._requestStandardised&&(p.sqlFormat="standard"),p.where=null===r?null===t?"1=1":"":u.toWhereClause(r,l),p.spatialRelationship=n._makeRelationshipEnum(e),p.outSpatialReference=n.spatialReference,p.orderByFields=""!==o?o.split(","):null,p.geometry=null===t?"":t,p.relationParam=n._makeRelationshipParam(e),n.executeQuery(p,"executeForIds").then(function(e){return null===e&&(e=[]),n._checkCancelled(i),new s([],e,d,null)})})},t.prototype._expandPagedSet=function(e,t,r,a,i){return this._expandPagedSetFeatureSet(e,t,r,a,i)},t.prototype._getFilteredSetUsingPaging=function(e,t,r,a,i){var n=this;try{var l="",o=!1;return null!==a&&void 0!==this._layer.advancedQueryCapabilities&&null!==this._layer.advancedQueryCapabilities&&!0===this._layer.advancedQueryCapabilities.supportsOrderBy&&(l=a.constructClause(),o=!0),this.databaseType().then(function(a){var d=null===r?null===t?"1=1":"":u.toWhereClause(r,a);n._layer.getDefinitionExpression()&&(d=""!==d?"(("+n._layer.getDefinitionExpression()+") AND ("+d+"))":n._layer.getDefinitionExpression());var p=n._maxQueryRate();void 0!==n._layer.maxRecordCount&&n._layer.maxRecordCount<p&&(p=n._layer.maxRecordCount);var c=null;if(!0===n._pageJustIds)c=new s([],["GETPAGES"],o,{spatialRel:n._makeRelationshipEnum(e),relationParam:n._makeRelationshipParam(e),outFields:n._layer.objectIdField,resultRecordCount:p,resultOffset:0,geometry:null===t?"":t,where:d,orderByFields:l,returnGeometry:"false",returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}});else{var y=!0;!0===n._removeGeometry&&(y=!1);var f=null!==n._overrideFields?n._overrideFields:n._fieldsIncludingObjectId(n._layer.getOutFields());c=new s([],["GETPAGES"],o,{spatialRel:n._makeRelationshipEnum(e),relationParam:n._makeRelationshipParam(e),outFields:f.join(","),resultRecordCount:p,resultOffset:0,geometry:null===t?"":t,where:d,orderByFields:l,returnGeometry:y,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}})}return n._expandPagedSet(c,p,0,1,i).then(function(e){return c})})}catch(e){return p.reject(e)}},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,r){var a=this;try{var i=e.pagesDefinition.internal.lastRetrieved,n=i,s=new y;return this._requestStandardised&&(s.sqlFormat="standard"),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParam=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastRetrieved,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,this.executeQuery(s,"execute").then(function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastRetrieved!==i)return"done";for(var s=0;s<t.features.length;s++)void 0===t.features[s].geometry&&(t.features[s].geometry=null),e.pagesDefinition.internal.set[n+s]=t.features[s].attributes[a._layer.objectIdField];if(!1===a._pageJustIds)for(var s=0;s<t.features.length;s++)a._featureCache[t.features[s].attributes[a._layer.objectIdField]]=t.features[s];return t.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+e.pagesDefinition.resultRecordCount,"done"})}catch(e){return p.reject(e)}},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,a=0,i=t;a<i.length;a++){if(i[a].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,r,a){var i=this,n=[];try{if(-1!==t&&void 0===this._featureCache[t]&&n.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate(),a))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,a).then(function(n){return i._getFeatures(e,t,r,a)});for(var s=0,l=e._lastFetchedIndex;l<e._known.length;l++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[l]]){var o=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var u=this._layer._mode;if(void 0!==u._featureMap[e._known[l]]){var d=u._featureMap[e._known[l]];null!==d&&(o=!0,this._featureCache[e._known[l]]=d)}}if(!1===o&&(e._known[l]!==t&&n.push(e._known[l]),n.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===n.length)break}if(0===n.length)return p.resolve("success");try{var c=new y;return this._requestStandardised&&(c.sqlFormat="standard"),c.objectIds=n,c.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.getOutFields()),c.returnGeometry=!0,!0===this._removeGeometry&&(c.returnGeometry=!1),c.outSpatialReference=this.spatialReference,this.executeQuery(c,"execute").then(function(e){if(i._checkCancelled(a),void 0!==e.error)return p.reject(new Error(e.error));for(var t=0;t<e.features.length;t++)void 0===e.features[t].geometry&&(e.features[t].geometry=null),i._featureCache[e.features[t].attributes[i._layer.objectIdField]]=e.features[t];return"success"})}catch(e){return p.reject(e)}}catch(e){return p.reject(e)}},t.prototype._layerUrl=function(){return this._layer.url},t.prototype._getDistinctPages=function(e,t,r,a,i,n,s,l,o){var d=this;return this._ensureLoaded().then(function(){for(var c=r.parseTree.column,f=0;f<d._layer.fields.length;f++)if(d._layer.fields[f].name.toLowerCase()===c.toLowerCase()){c=d._layer.fields[f].name;break}return d.databaseType().then(function(f){var h=new y;d._requestStandardised&&(h.sqlFormat="standard");var _=null===n?null===i?"1=1":"":u.toWhereClause(n,f);return d._layer.getDefinitionExpression()&&(_=""!==_?"(("+d._layer.getDefinitionExpression()+") AND ("+_+"))":d._layer.getDefinitionExpression()),h.where=_,h.spatialRelationship=d._makeRelationshipEnum(a),h.relationParam=d._makeRelationshipParam(a),h.geometry=null===i?null:i,h.returnDistinctValues=!0,h.returnGeometry=!1,h.outFields=[c],d.executeQuery(h,"execute").then(function(u){if(d._checkCancelled(o),!u.hasOwnProperty("features"))return p.reject(new Error("Unnexected Result querying statistics from layer"));for(var y=!1,f=0;f<d._layer.fields.length;f++)if(d._layer.fields[f].name===c){"esriFieldTypeDate"===d._layer.fields[f].type&&(y=!0);break}for(var f=0;f<u.features.length;f++){if(y){var h=u.features[f].attributes[c];null!==h?l.push(new Date(h)):l.push(h)}else l.push(u.features[f].attributes[c]);if(l.length>=s)break}return 0===u.features.length?l:u.features.length===d._layer.maxRecordCount&&l.length<s?d._getDistinctPages(e+u.features.length,t,r,a,i,n,s,l,o).then(function(e){return{calculated:!0,result:e}}):l})})})},t.prototype._distinctStat=function(e,t,r,a,i,n,s){return this._getDistinctPages(0,e,t,r,a,i,n,[],s).then(function(e){return{calculated:!0,result:e}})},t.prototype.isTable=function(){return!1},t.prototype._countstat=function(e,t,r,a,i){var n=this;return this.databaseType().then(function(e){var i=new y;if(n._requestStandardised&&(i.sqlFormat="standard"),n.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var s=null===a?null===r?"1=1":"":u.toWhereClause(a,e);n._layer.getDefinitionExpression()&&(s=""!==s?"(("+n._layer.getDefinitionExpression()+") AND ("+s+"))":n._layer.getDefinitionExpression()),i.where=s,i.where=s,i.spatialRelationship=n._makeRelationshipEnum(t),i.relationParam=n._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1;new f(n._layerUrl());return n.executeQuery(i,"executeForCount").then(function(e){return{calculated:!0,result:e}})})},t.prototype._stats=function(e,t,r,a,i,n,s){var l=this;return this._ensureLoaded().then(function(){var o=l._layer.advancedQueryCapabilities&&!0===l._layer.advancedQueryCapabilities.supportsSqlExpression,c=l._layer.advancedQueryCapabilities&&!0===l._layer.advancedQueryCapabilities.supportsStatistics,f=l._layer.advancedQueryCapabilities&&!0===l._layer.advancedQueryCapabilities.supportsDistinct;return"count"===e?f?l._countstat(e,r,a,i,s):{calculated:!1}:!1===c||!1===u.isSingleField(t)&&!1===o||!1===t.isStandardized?""!==r||null!==i?{calculated:!1}:l._manualStat(e,t,n,s):"distinct"===e?!1===f?""!==r||null!==i?{calculated:!1}:l._manualStat(e,t,n,s):l._distinctStat(e,t,r,a,i,n,s):l.databaseType().then(function(n){if(l.isTable()&&a&&null!==r&&""!==r)return{calculated:!0,result:null};var s=new y;l._requestStandardised&&(s.sqlFormat="standard");var o=null===i?null===a?"1=1":"":u.toWhereClause(i,n);l._layer.getDefinitionExpression()&&(o=""!==o?"(("+l._layer.getDefinitionExpression()+") AND ("+o+"))":l._layer.getDefinitionExpression()),s.where=o,s.spatialRelationship=l._makeRelationshipEnum(r),s.relationParam=l._makeRelationshipParam(r),s.geometry=null===a?null:a;var c=new h;c.statisticType=d.decodeStatType(e),c.onStatisticField=u.toWhereClause(t,n),c.outStatisticFieldName="ARCADE_STAT_RESULT";var f="ARCADE_STAT_RESULT";return s.returnGeometry=!1,s.outStatistics=[c],l.executeQuery(s,"execute").then(function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return p.reject(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){f=e.fields[r].name,"esriFieldTypeDate"===e.fields[r].type&&(t=!0);break}if(t){var a=e.features[0].attributes[f];return null!==a&&(a=new Date(e.features[0].attributes[f])),{calculated:!0,result:a}}return{calculated:!0,result:e.features[0].attributes[f]}})})})},t.prototype._stat=function(e,t,r,a,i,n,s){return this._stats(e,t,r,a,i,n,s)},t.prototype._canDoAggregates=function(e,t,r,a,i){var n=this;return this._ensureLoaded().then(function(e){var r=!1,a=n._layer.advancedQueryCapabilities&&!0===n._layer.advancedQueryCapabilities.supportsSqlExpression;if(void 0!==n._layer.advancedQueryCapabilities&&null!==n._layer.advancedQueryCapabilities&&!0===n._layer.advancedQueryCapabilities.supportsStatistics&&!0===n._layer.advancedQueryCapabilities.supportsOrderBy&&(r=!0),r)for(var i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized?r=!1:!1===u.isSingleField(t[i].workingexpr)&&!1===a&&(r=!1));return!1!==r})},t.prototype._makeRelationshipEnum=function(e){return e.indexOf("esriSpatialRelRelation")>=0?"esriSpatialRelRelation":e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,a,i,n,l){var o=this;return this._ensureLoaded().then(function(d){return o.databaseType().then(function(d){var p="",c=!1,y=!1;null!==n&&void 0!==o._layer.advancedQueryCapabilities&&null!==o._layer.advancedQueryCapabilities&&!0===o._layer.advancedQueryCapabilities.supportsOrderBy&&(p=n.constructClause(),y=!0),void 0!==o._layer.advancedQueryCapabilities&&null!==o._layer.advancedQueryCapabilities&&!1===o._layer.advancedQueryCapabilities.supportsPagination&&(y=!1,c=!0,p=o._layer.objectIdField);for(var f=[],_=0;_<t.length;_++){var g=new h;g.onStatisticField=null!==t[_].workingexpr?u.toWhereClause(t[_].workingexpr,d):"",g.outStatisticFieldName=t[_].field,g.statisticType=t[_].toStatisticsName(),f.push(g)}""===p&&(p=e.join(","));var v=o._maxQueryRate();void 0!==o._layer.maxRecordCount&&o._layer.maxRecordCount<v&&(v=o._layer.maxRecordCount);var m=null===i?null===a?"1=1":"":u.toWhereClause(i,d);return o._layer.getDefinitionExpression()&&(m=""!==m?"(("+o._layer.getDefinitionExpression()+") AND ("+m+"))":o._layer.getDefinitionExpression()),new s([],["GETPAGES"],y,{groupbypage:!0,spatialRel:o._makeRelationshipEnum(r),relationParam:o._makeRelationshipParam(r),outFields:["*"],useOIDpagination:c,generatedOid:l,resultRecordCount:v,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:f,geometry:null===a?null:a,where:m,orderByFields:p,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,fullyResolved:!1}})})})},t.prototype._getAgregagtePhysicalPage=function(e,t,a){var i=this;try{var n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var s=e.pagesDefinition.internal.lastRetrieved,l=s,o=new y;return this._requestStandardised&&(o.sqlFormat="standard"),o.where=n,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParam=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastRetrieved,o.returnGeometry=e.pagesDefinition.returnGeometry,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship?p.resolve([]):this.executeQuery(o,"execute").then(function(t){if(i._checkCancelled(a),!t.hasOwnProperty("features"))return p.reject(new Error("Unnexected Result querying aggregates from layer"));var n=[];if(e.pagesDefinition.internal.lastRetrieved!==s)return[];for(var o=0;o<t.features.length;o++)void 0===t.features[o].geometry&&(t.features[o].geometry=null),e.pagesDefinition.internal.set[l+o]=t.features[o].attributes[e.pagesDefinition.generatedOid];for(var o=0;o<t.features.length;o++)n.push(new r({attributes:t.features[o].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:t.features.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+e.pagesDefinition.resultRecordCount,n})}catch(e){return p.reject(e)}},t.create=function(e,r,a){return new t({layer:new c({url:e,outFields:null===r?["*"]:r}),spatialReference:a})},t.prototype._queryAttachments=function(e){var t=this,r=__assign({},e,{f:"json"});return r.objectIds.length>0&&(r.objectIds=r.objectIds.join(",")),r.size&&(r.size=r.size.join(",")),r.attachmentTypes&&(r.attachmentTypes=r.attachmentTypes.join(",")),p.create(function(e,i){a({url:t._layer._url.path+"/queryAttachments",content:r,callbackParamName:"callback",load:function(t){var r={};if(t&&t.attachmentGroups)for(var a=0,i=t.attachmentGroups;a<i.length;a++){var n=i[a];void 0===r[n.parentObjectId]&&(r[n.parentObjectId]=[]);for(var s=0,l=n.attachmentInfos;s<l.length;s++){var o=l[s];r[n.parentObjectId].push({id:o.id,globalId:o.globalId,name:o.name,contentType:o.contentType,size:o.size})}}e(r)},error:function(e){i(e)}})})},t.prototype.queryAttachments=function(e,t,r,a){var n=this;if(this._layer.hasAttachments){var s={objectIds:[e]};return(t&&t>0||r&&r>0)&&(s.size=[t&&t>0?t:0,r&&r>0?r:t+1]),a&&a.length>0&&(s.attachmentTypes=a),this._queryAttachments(s).then(function(t){var r=[];if(t&&t[e]){var a=n._layer._url.path;t[e].forEach(function(t){var n=a+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new i(t.id,t.name,t.contentType,t.size,n))})}return r})}return p.resolve([])},t.prototype.serviceUrl=function(){return o.extractServiceUrl(this._layer._url.path)},t.prototype.relationshipMetaData=function(){return this._layer.relationships},t}(n)});