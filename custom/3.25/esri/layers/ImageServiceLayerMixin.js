// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/json","dojo/_base/config","dojo/_base/connect","dojo/has","dojo/io-query","dojo/DeferredList","../kernel","../config","../lang","../request","../deferredUtils","../urlUtils","../geometry/Extent","../geometry/Point","../geometry/Polygon","./MosaicRule","./RasterFunction","./DimensionalDefinition","./Raster","./PixelBlock","./pixelFilters/VectorFieldPixelFilter","./rasterFormats/ImageCanvasDecoder","./TimeInfo","./Field","../graphic","../tasks/ImageServiceIdentifyTask","../tasks/ImageServiceIdentifyParameters"],function(e,t,i,n,r,s,a,l,o,u,h,c,f,d,m,g,p,R,_,v,b,x,T,y,F,I,D,C,P,w,V){var A=e(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_rasterFunctionServiceInfoProps:["bandCount","pixelType","hasRasterAttributeTable","hasHistograms","minValues","maxValues","meanValues","stdvValues","serviceDataType"],_pixelTypeRanges:{U1:[0,1],U2:[0,3],U4:[0,15],U8:[0,255],S8:[-128,127],U16:[0,65535],S16:[-32768,32767]},_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0,"spatial-reference-change":!0,"renderer-change":!0},constructor:function(e,t){this.useMapTime=!t||!t.hasOwnProperty("useMapTime")||!!t.useMapTime},_initialize:function(e,i){this._url=g.urlToObject(e),this.raster=new T(this._url.path),this._rasterFunctionTemplateInfos={},this._customRenderingRuleId={},this.infoTemplate=i&&i.infoTemplate;var n=i&&i.imageServiceParameters;this.format=n&&n.format,this.compressionTolerance=n&&n.compressionTolerance?n.compressionTolerance:.01,this.interpolation=n?n.interpolation:null,this.compressionQuality=n?n.compressionQuality:null,this.bandIds=n?n.bandIds:null,this.mosaicRule=n?n.mosaicRule:null,this.renderingRule=n?n.renderingRule:null,this.renderer=n?n.renderer:null,this.useMapDimensionValue=!i||!i.hasOwnProperty("useMapDimensionValue")||!!i.useMapDimensionValue,this.hasImageFilter=i&&i.hasImageFilter,this.activeMapDimensions=i&&i.activeMapDimensions,this._params=t.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},n?n.toJson():{}),this.pixelFilter=i&&i.pixelFilter,this.pixelData=null,this.originalPixelData=null,this.hasDataChanged=!0,this._requestDataHandler=t.hitch(this,this._requestDataHandler),this._requestDataErrorHandler=t.hitch(this,this._requestDataErrorHandler),this._rasterReadPromise=null,this._initLayer=t.hitch(this,this._initLayer),this._queryVisibleRastersHandler=t.hitch(this,this._queryVisibleRastersHandler),this._visibleRasters=[],this._rasterAttributeTableFields=[],this._rasterAttributeTableFeatures=[],this._renderingRuleAttributeTable={},this._useRenderingRuleAttributeTable=!1,this._loadCallback=i&&i.loadCallback,n&&n.renderer&&(n.renderer.outputUnit||n.renderer.inputUnit)&&(this.vectorFieldPixelFilter=new F,this.vectorFieldPixelFilter.setUnits(n.renderer.inputUnit,n.renderer.outputUnit));var r=i&&i.resourceInfo;r?this._initLayer(r):d({url:this._url.path,content:t.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}),this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(e,i){if(null!==e&&void 0!==e){this._findCredential();(this.credential&&this.credential.ssl||e&&e._ssl)&&this._useSSL();var r=this.minScale,s=this.maxScale;t.mixin(this,e),this.minScale=r,this.maxScale=s,this.initialExtent=this.fullExtent=this.extent=new p(e.extent),this.spatialReference=this.initialExtent.spatialReference,this.pixelSizeX=parseFloat(this.pixelSizeX),this.pixelSizeY=parseFloat(this.pixelSizeY);var a,l,o=this.minValues,u=this.maxValues,h=this.meanValues,c=this.stdvValues,d=this.bands=[];for(a=0,l=this.bandCount;a<l;a++)d[a]={min:o[a],max:u[a],mean:h[a],stddev:c[a]};var m=this.timeInfo;this.timeInfo=m&&m.timeExtent?new D(m):null;var g=this.fields=[],R=e.fields;if(R)for(a=0;a<R.length;a++)g.push(new C(R[a]));if(this._updateInfoTemplateFields(this.fields),this.version=e.currentVersion,!this.version){var _;_="fields"in e||"objectIdField"in e||"timeInfo"in e?10:9.3,this.version=_}f.isDefined(e.minScale)&&!this._hasMin&&this.setMinScale(e.minScale),f.isDefined(e.maxScale)&&!this._hasMax&&this.setMaxScale(e.maxScale);var b={};if(e.defaultMosaicMethod?(b.method=e.defaultMosaicMethod,b.operation=e.mosaicOperator,b.sortField=e.sortField,b.sortValue=e.sortValue):b.method=v.METHOD_NONE,this.defaultMosaicRule=new v(b),this.defaultMosaicRule.ascending=!0,this._useRenderingRuleAttributeTable=this.version>10&&"esriImageServiceDataTypeThematic"===this.serviceDataType,this._setDefaultRenderingRule(!0),this.renderingRule&&this.getRenderingRuleServiceInfo(this.renderingRule).then(t.hitch(this,function(e){e.hasRasterAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:this.renderingRule}).then(t.hitch(this,function(){!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh()}))})),this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0),this.version>10&&this.hasRasterAttributeTable){this.getRasterAttributeTable().then(t.hitch(this,function(e){e&&(e.features&&e.fields&&(this.rasterAttributeTable=t.clone(e)),e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=t.clone(e.features)),e.fields&&e.fields.length>0&&(this._rasterAttributeTableFields=t.clone(e.fields)),this.renderingRule||!this.renderer||"esri.renderer.ClassBreaksRenderer"!==this.renderer.declaredClass&&"esri.renderer.UniqueValueRenderer"!==this.renderer.declaredClass||this.refresh())}))}this._initVectorPixelFilter(),this.version>=10.3&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&this.getRasterFunctionInfos().then(t.hitch(this,function(e){if(e&&e.length){this.rasterFunctionInfos=e;var t,i=[];n.forEach(e,function(e){if(e){var n=e.functionType;t=t||1===n||2===n,i.push(e.name)}},this),this._hasItemLevelRFT=t,this._rasterFunctionNames=i,t&&(this._initVectorPixelFilter(),this.refresh())}})),this.loaded=!0,this._setDefaultFilter(),this.onLoad(this);var x=this._loadCallback;x&&(delete this._loadCallback,x(this))}},_updateInfoTemplateFields:function(e){if(e&&!(e.length<1)&&this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.fieldInfos&&!(this.infoTemplate.info.fieldInfos.length<1)){var t,i,n,r;for(r=this.infoTemplate.info.fieldInfos,t=0;t<e.length;t++)for(n=e[t],i=0;i<r.length;i++)if(r[i].fieldName.toLowerCase()===n.name.toLowerCase()&&r[i].fieldName!==n.name){r[i].fieldName=n.name;break}}},getKeyProperties:function(e){var t=this._url.path+"/keyProperties",n=new i(m._dfdCanceller),a={f:"json"};if(e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson())),this.version>10)n._pendingDfd=d({url:t,content:a,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)});else{var l=new Error("Layer does not have key properties");l.log=!!s.isDebug,n.errback(l)}return n},getRasterAttributeTable:function(e){var t=this._url.path+"/rasterAttributeTable",n=new i(m._dfdCanceller),a={f:"json"},l=this.hasRasterAttributeTable;if(e&&e.renderingRule&&(a.renderingRule=r.toJson(e.renderingRule.toJson()),l=!0),this.version>10&&l)n._pendingDfd=d({url:t,content:a,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)});else{var o=new Error("Layer does not support raster attribute table");o.log=!!s.isDebug,n.errback(o)}return n},getRenderingRuleAttributeTable:function(e){var n=new i(m._dfdCanceller);if(!e||!e.renderingRule){var r=new Error("Rendering rule is not specified");return n.errback(r),n}var s=e.renderingRule,a=this._getRenderingRuleId(s);return this._renderingRuleAttributeTable&&a&&this._renderingRuleAttributeTable.hasOwnProperty(a)?n.resolve(this._renderingRuleAttributeTable[a]):n=this.getRasterAttributeTable({renderingRule:s}).then(t.hitch(this,function(e){var i;return e&&e.features&&e.features.length&&e.fields&&e.fields.length&&(i={features:t.clone(e.features),fields:t.clone(e.fields)},a&&(this._renderingRuleAttributeTable[a]=i)),i})),n},_initVectorPixelFilter:function(){var e,i;if(this._hasItemLevelRFT&&this.renderingRule&&(e=this._getItemLevelRenderingRule(this.renderingRule)),i=e||this.renderingRule)return this.getRenderingRuleServiceInfo(i).then(t.hitch(this,function(e){e&&this._isVectorData(e)&&!f.isDefined(this.pixelFilter)&&"esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&(this.vectorFieldPixelFilter=this.vectorFieldPixelFilter||new F,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===e.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,this.getKeyProperties().then(t.hitch(this,this._setFlowRepresentation)),this._applyVectorResamplingType(e.serviceDataType))}))},_applyVectorResamplingType:function(e){if(e){var t=this.renderingRule;if(t&&"Resample"===t.functionName){(t.functionArguments||{}).ResamplingType="esriImageServiceDataTypeVector-UV"===e?7:10,this.setRenderingRule(new b(t.toJson()))}}},_getRasterAttributeTableFeatures:function(){var e=new i;if(this._rasterAttributeTableFeatures&&this._rasterAttributeTableFeatures.length>0)return e.resolve(this._rasterAttributeTableFeatures),e;if(this.version>10&&this.hasRasterAttributeTable){var n=this.getRasterAttributeTable();return n.then(t.hitch(this,function(e){e&&e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=t.clone(e.features))})),n}return e.resolve(this._rasterAttributeTableFeatures),e},_getRenderingRuleAttributeTableFeatures:function(e){var t=e&&e.renderingRule;if(!t){var n=new i,r=new Error("Rendering rule is not specified");return n.errback(r),n}return this.getRenderingRuleAttributeTable({renderingRule:t}).then(function(e){return e&&e.features})},getCustomRasterFields:function(e){var i=e?e.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix,r=this.version>=10.3?"esriFieldTypeDouble":"esriFieldTypeString",s={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:r},a={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:r},l={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},o=this.fields?t.clone(this.fields):[],u=o.length;if(o[u]=a,this.version>=10.4&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRenderingRuleAProcessingTemplate({functionName:"none"}))&&(u++,o[u]=l),(this.capabilities&&this.capabilities.toLowerCase().indexOf("catalog")>-1||this.fields&&this.fields.length>0)&&(u++,o[u]=s),f.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var h={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},c={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"};u++,o[u]=h,u++,o[u]=c}var d=this._rasterAttributeTableFields,m=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);if(m&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(m)&&(d=this._renderingRuleAttributeTable[m].fields),d&&d.length>0){var g=n.filter(d,function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()}),p=n.map(g,function(e){var n=t.clone(e);return n.name=i+e.name,n});o=o.concat(p)}var R=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;return this.version>=10.4&&this.rasterFunctionInfos&&n.forEach(this.rasterFunctionInfos,function(e){if(e&&e.name&&"none"!==e.name.toLowerCase()){var t={name:R+e.name.replace(/ /gi,"_"),alias:e.name,domain:null,editable:!1,type:"esriFieldTypeDouble"};o.push(t)}}),o},_applyTimeToMultidimensionalCRF:function(e,i){var n=this.timeInfo&&this.timeInfo.startTimeField;if((i=i||this._params.time)&&n&&this._isMultidimensionalCRF()){e=t.clone(e||this.defaultMosaicRule)||new v,e.multidimensionalDefinition=e.multidimensionalDefinition||[];var r=e.multidimensionalDefinition.filter(function(e){return e.dimensionName===n}),s=i.split(",").map(function(e){return parseInt(e,10)});r.length>0?e.multidimensionalDefinition.forEach(function(e){e.dimensionName===n&&(e.isSlice=1===s.length,e.values=1===s.length?s:[s])}):e.multidimensionalDefinition.push(new x({dimensionName:n,isSlice:1===s.length,values:1===s.length?s:[s]}))}return e},_prepareGetImageParameters:function(e,i,n,s){if(s=f.isDefined(s)?s:this._params,this.renderer||this._hasItemLevelRFT&&this.renderingRule){var a=this.getExportImageRenderingRule();s.renderingRule=a?r.toJson(a.toJson()):null}var l=this.getExportImageMosaicRule(s);s.mosaicRule=l?r.toJson(l.toJson()):null;var o=e.spatialReference.wkid||r.toJson(e.spatialReference.toJson(!1));delete s._ts,t.mixin(s,{bbox:e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,imageSR:o,bboxSR:o,size:i+","+n},this.disableClientCaching?{_ts:(new Date).getTime()}:{}),delete s.compressionTolerance,s.format&&"LERC"===s.format.toUpperCase()&&(s.compressionTolerance=this.compressionTolerance),s.token=this._getToken()},getImageUrl:function(e,i,n,r,s){s=f.isDefined(s)?s:this._params,this._prepareGetImageParameters(e,i,n,s);var a=t.clone(s);this._cleanupRequestParams(a);var l=this._url.path+"/exportImage?",u=g.addProxy(l+o.objectToQuery(t.mixin(a,{f:"image"}))),h=a.token;u.length>c.defaults.io.postLength||this.useMapImage?this._jsonRequest=d({url:l,content:t.mixin(a,{f:"json"}),callbackParamName:"callback",load:function(e,t){var i=e.href;h&&(i+=-1===i.indexOf("?")?"?token="+h:"&token="+h),r(g.addProxy(i))},error:this._errorHandler}):r(u)},onRenderingChange:function(){},onMosaicRuleChange:function(){},onRendererChange:function(){},setInterpolation:function(e,t){this.interpolation=this._params.interpolation=e,t||this.refresh(!0)},setCompressionQuality:function(e,t){this.compressionQuality=this._params.compressionQuality=e,t||this.refresh(!0)},setCompressionTolerance:function(e,t){this.compressionTolerance=e,t||this.refresh(!0)},setBandIds:function(e,t){var i=!1;this.bandIds!==e&&(i=!0),this.bandIds=e,this._params.bandIds=e.join(","),i&&!t&&this.onRenderingChange(),t||this.refresh(!0)},setDefaultBandIds:function(e){this.bandIds=this._params.bandIds=null,e||this.refresh(!0)},setDisableClientCaching:function(e){this.disableClientCaching=e},setMosaicRule:function(e,t){var i=!1;this.mosaicRule!==e&&(i=!0),this.mosaicRule=e,this._params.mosaicRule=r.toJson(e.toJson()),i&&!t&&this.onMosaicRuleChange(),t||this.refresh(!0)},getRasterFunctionInfos:function(){if(this.version<10.3||!this.rasterFunctionInfos||!this.rasterFunctionInfos.length)return void console.log("Layer doesn't support /rasterFunctionInfos resource.");var e=this._url.path+"/rasterFunctionInfos";return d({url:e,content:{f:"json"},handleAs:"json",load:function(e){return e&&e.rasterFunctionInfos}})},setRenderingRule:function(e,t){var i=!1;this.renderingRule!==e&&(i=!0),this.renderingRule=e,this._params.renderingRule=e?r.toJson(e.toJson()):null,this._useRenderingRuleAttributeTable&&this.getRenderingRuleAttributeTable({renderingRule:e}),i&&this.onRenderingChange(),this._setDefaultFilter(),t||this.refresh(!0)},setImageFormat:function(e,t){this.format=this._params.format=e,this._setDefaultFilter(),t||this.refresh(!0)},setInfoTemplate:function(e){this.infoTemplate=e,this._updateInfoTemplateFields(this.fields)},setDefinitionExpression:function(e,t){var i=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?i=this.defaultMosaicRule.toJson():i.method=v.METHOD_NONE),i.where=e;var n=new v(i);return this.setMosaicRule(n,t),this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(e){this.pixelFilter=e,this._isDefaultPixelFilter=!1},getPixelData:function(e){if(e){return this._useBrowserDecoding()&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData}return this.pixelData},getExportImageRenderingRule:function(){var e;return this._hasItemLevelRFT&&this.renderingRule&&(e=this._getServiceLevelRenderingRule(this.renderingRule)),e=e||this.renderingRule,this._isItemLevelRasterFunction(this.renderingRule)&&(e=void 0),this._combineRenderingRule(this._convertRendererToRenderingRule(this.renderer),e)},getExportImageMosaicRule:function(){var e,t=this.mosaicRule;return this._hasItemLevelRFT&&this.renderingRule&&(e=this._getItemLevelRenderingRule(this.renderingRule)),e&&(t=t||this.defaultMosaicRule||new v,t.itemRenderingRule=e),t=this._applyTimeToMultidimensionalCRF(t)},redraw:function(){this.hasDataChanged=!1,this._setPixelData(this.originalPixelData)},getHistograms:function(){var e=new i(m._dfdCanceller);if(this.hasHistograms)e._pendingDfd=d({url:this._url.path+"/histograms",content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),e._pendingDfd.then(function(t){e.callback(t)},function(t){e.errback(t)});else{var t=new Error("Layer does not have histograms.");t.log=!!s.isDebug,e.errback(t)}return e},computeHistograms:function(e){var n=new i(m._dfdCanceller);if(this.currentVersion>=10.1){e=e||{};var r=e.geometry||this.fullExtent,a=(e.geometry||this.fullExtent).toJson(),l="extent"===r.type?"esriGeometryEnvelope":"esriGeometryPolygon",o=e.renderingRule||this.renderingRule||this.defaultRenderingRule;o=o?o.toJson():null;var u=e.mosaicRule||this.mosaicRule||this.defaultMosaicRule;u=u?u.toJson():null;var h=e.pixelSize||{x:this.pixelSizeX,y:this.pixelSizeY};n._pendingDfd=d({url:this._url.path+"/computeHistograms",content:t.mixin({f:"json",geometry:JSON.stringify(a),geometryType:l,renderingRule:JSON.stringify(o),mosaicRule:JSON.stringify(u),pixelSize:JSON.stringify(h),callbackParamName:"callback"}),handleAs:"json"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)})}else{var c=new Error("Layer doesn't support computeHistograms.");c.log=!!s.isDebug,n.errback(c)}return n},getRenderingRuleServiceInfo:function(e){var r=new m._fixDfd(new i(m._dfdCanceller));if(!e){var s=new Error("Rendering rule is not specified");return r.errback(s),r}var a=this._getRenderingRuleId(e);return a&&this._rasterFunctionTemplateInfos[a]?(r.resolve(this._rasterFunctionTemplateInfos[a]),r):d({url:this._url.path,content:t.mixin(t.mixin({f:"json",renderingRule:JSON.stringify(e.toJson())},this._url.query)),callbackParamName:"callback",load:t.hitch(this,function(e){var t={};return n.forEach(this._rasterFunctionServiceInfoProps,function(i){t[i]=e[i]}),this._rasterFunctionTemplateInfos[a]=t,t}),error:this._errorHandler})},queryVisibleRasters:function(e,r,s,a){var l,o=this._map,u=m._fixDfd(new i(m._dfdCanceller));this._visibleRasters=[];var h,c,f=!0,d=!0,g=null,p=this.infoTemplate?this.infoTemplate.info:null,_=p?t.clone(this.infoTemplate.info.fieldInfos):null;if(r=r||{},p&&this.infoTemplate.info.mediaInfos&&this.infoTemplate.info.mediaInfos.length){var v=[];n.forEach(this.infoTemplate.info.mediaInfos,function(e){var t=e&&e.value&&e.value.fields||[];v=v.concat(t)}),v.length&&n.forEach(_,function(e){e&&v.indexOf(e.fieldName)>-1&&(e.visible=!0)})}if(_&&_.length>0)for(f=!1,h=0;h<_.length;h++)if((c=_[h])&&c.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(c.visible||p.title&&p.title.toLowerCase().indexOf(c.fieldName.toLowerCase())>-1)){f=!0;break}this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("returnTopmostRaster")&&(g=this.infoTemplate.info.layerOptions.returnTopmostRaster?1:null),_&&_.length>0&&(d=!1,n.some(_,function(e){if(e&&e.fieldName.toLowerCase()===this._rasterFieldPrefix.toLowerCase()+"itempixelvalue"&&e.visible)return d=!0,!0},this));var x=this._removeVisualizationStretchFunction(this.renderingRule),T=x&&x.functionName,y=[];if(this.version>=10.4){var F=!1;if(this.rasterFunctionInfos&&_){var I=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;n.forEach(this.rasterFunctionInfos,function(e){var t=I+e.name.replace(/ /gi,"_");n.some(_,function(e){return e.visible&&e.fieldName===t})&&(F=F||T&&T===e.name,y.push(new b({rasterFunction:e.name})))})}x&&!F&&y.push(x)}var D=new V;if(D.geometry=e.geometry,D.returnGeometry=this._map.spatialReference.equals(this.spatialReference),D.returnCatalogItems=f,D.timeExtent=e.timeExtent,D.returnPixelValues=d,D.maxItemCount=g||e.maxItemCount,this._params.time&&this.mosaicRule?(l=t.clone(this.mosaicRule),l=this._filterOutTimeDimension(l),D.mosaicRule=l):D.mosaicRule=this.mosaicRule||null,this._isMultidimensionalCRF()&&D.timeExtent&&(D.mosaicRule=this._applyTimeToMultidimensionalCRF(D.mosaicRule,D.timeExtent.toJson().join(",")),delete D.timeExtent),D.renderingRule=this.version<10.4&&x||null,D.renderingRules=y||null,this.version<10.61&&(D.returnPixelValues=void 0,D.maxItemCount=void 0),o){var C=(o.extent.xmax-o.extent.xmin)/o.width,P=(o.extent.ymax-o.extent.ymin)/o.height,A=o.extent.spatialReference,S=new R(C,P,A);D.pixelSize=S}r.requestParams=D;var M=this,k=new w(this.url);return(u._pendingDfd=k.execute(D)).addCallbacks(function(e){M._queryVisibleRastersHandler(e,r,s,a,u)},function(e){M._resolve([e],null,a,u,!0)}),u},_queryVisibleRastersHandler:function(e,i,s,a,l){function o(){var e,r,a,o,c,d,m,g,_,b,x,T,D=this.getCustomRasterFields(i),C=this._getDomainFields(D),P=!!i&&i.returnDomainValues,w=i&&i.rasterAttributeTableFieldPrefix,V=this._getRenderingRuleId(this.renderingRule),A=V&&this._rasterFunctionTemplateInfos[V];this.renderingRule&&(this._useRenderingRuleAttributeTable||A)?(x=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),T=R):x=this._getRasterAttributeTableFeatures(),x.then(t.hitch(this,function(i){for(e=0;e<h.length;e++){if(N=h[e],r=N.attributes[F],N.setInfoTemplate(this.infoTemplate),N._layer=this,R){if(b=R.replace(/ /gi,"").split(","),a=R,o=b,u&&u.length>=e&&(a=u[e].replace(/ /gi,", "),o=u[e].split(" ")),N.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=o,N.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=b,v&&(N.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=v.replace(/ /gi,"").split(",")),this.pixelFilter){var x=new y({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});n.forEach(o,function(e){x.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})}),this.pixelFilter({pixelBlock:x,extent:new p(0,0,0,0,this._map.spatialReference)}),"esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType||(N.attributes[this._rasterFieldPrefix+"Magnitude"]=x.pixels[0][0],N.attributes[this._rasterFieldPrefix+"Direction"]=x.pixels[1][0])}n.forEach(I,function(e){N.attributes[e.name]=e.value});var D=T||a;if(i&&i.length>0&&(c=n.filter(i,function(e){if(e&&e.attributes)return e.attributes.hasOwnProperty("Value")?e.attributes.Value==D:e.attributes.VALUE==D}),c.length>0&&(d=t.clone(c[0]),w&&d))){_={};for(m in d.attributes)d.attributes.hasOwnProperty(m)&&(g=w+m,_[g]=d.attributes[m]);d.attributes=_,N.attributes=t.mixin(N.attributes,d.attributes)}}P&&C&&C.length>0&&n.forEach(C,function(e){if(e){var t=N.attributes[e.name];if(f.isDefined(t)){var i=this._getDomainValue(e.domain,t);f.isDefined(i)&&(N.attributes[e.name]=i)}}},this),J.push(N),this._visibleRasters.push(N)}this._resolve([J,null,!0],null,s,l)}))}var u,h,c,m,g,R=e.value,v=e.value,b=0,x=0,T=this,F=this.objectIdField,I=[],D=i.requestParams.renderingRules,C=e.processedValues,w=this.renderingRule&&r.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());if(D&&C&&D.length===C.length){var V=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;n.forEach(D,function(e,t){if(e.functionName){var i={name:V+e.functionName.replace(/ /gi,"_"),value:C[t].replace(/ /gi,"").split(",")};I.push(i),w&&w===r.toJson(e.toJson())&&(R=C[t])}})}if(m=!(this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords"))||this.infoTemplate.info.layerOptions.showNoDataRecords,e.catalogItems){var A,S,M=0,k=e.catalogItems.features.length,L=0;if(h=new Array(k),u=new Array(k),c=new Array(k),e.properties&&e.properties.Values){var E=e.properties.Values.length;for(b=0;b<E;b++)e.properties.Values[b].toLowerCase().indexOf("nodata")>-1&&L++;for(A=E-L,b=0;b<E;b++)g=!0,e.properties.Values[b].toLowerCase().indexOf("nodata")>-1?(S=A++,m||(g=!1,h.length--,u.length--,c.length--)):S=M++,g&&(h[S]=e.catalogItems.features[b],u[S]=e.properties.Values[b],c[S]=h[S].attributes[F])}else{for(b=0;b<k;b++)h[b]=e.catalogItems.features[b],c[b]=h[b].attributes[F];u=null}}this._visibleRasters=[];var N,j=R.toLowerCase().indexOf("nodata")>-1;if(j&&!m&&(h=[],u=[],c=[]),R&&!h&&!j){F="ObjectId",h=[];var O={};O.ObjectId=0,N=new P(new p(this.fullExtent),null,O),h.push(N)}var J=[];if(!h)return void this._resolve([J,null,null],null,s,l);!this._map.spatialReference.equals(this.spatialReference)&&c&&c.length>0?d({url:this._url.path+"/query",content:{f:"json",objectIds:c.join(","),returnGeometry:!0,outSR:r.toJson(T._map.spatialReference.toJson()),outFields:F},handleAs:"json",callbackParamName:"callback",load:function(e){if(0===e.features.length)return void T._resolve([J,null,null],null,s,l);for(b=0;b<e.features.length;b++)for(x=0;x<h.length;x++)h[x].attributes[F]==e.features[b].attributes[F]&&(h[x].geometry=new _(e.features[b].geometry),h[x].geometry.setSpatialReference(T._map.spatialReference));o.call(T)},error:function(e){T._resolve([J,null,null],null,s,l)}}):o.call(this)},getVisibleRasters:function(){var e,t=this._visibleRasters,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},_getDomainFields:function(e){if(e){var t=[];return n.forEach(e,function(e){if(e.domain){var i={};i.name=e.name,i.domain=e.domain,t.push(i)}}),t}},_getDomainValue:function(e,t){if(e&&e.codedValues){var i;return n.some(e.codedValues,function(e){return e.code===t&&(i=e.name,!0)}),i}},_requestData:function(e,i,n){this._rasterReadPromise&&this._rasterReadPromise.cancel();var r=t.clone(e),s=r._normalize(!0);this._prepareGetImageParameters(s,i,n);var a=t.clone(this._params);this._cleanupRequestParams(a),a.extent=r,a.format=a.format||(this.version>=10.3?"lerc":"jpgpng"),"lerc"===a.format.toLowerCase()&&!a.lercVersion&&this.version>=10.5&&(a.lercVersion=2),this._params.time&&this._isMultidimensionalCRF()&&delete a.time;var l=this._useBrowserDecoding(),o=null;l&&(o=new I({ctx:this._context}));var u={imageServiceParameters:a,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:o?t.hitch(o,"decode"):null};this._rasterReadPromise=this.raster.read(u,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(e){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=e,this.hasDataChanged=!0,this._setPixelData(e))},_setPixelData:function(e){var t=this._clonePixelData(e);this.pixelFilter&&this.pixelFilter(t),this.pixelData=t,this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(e){if(null===e||void 0===e)return e;var i={};e.extent&&(i.extent=t.clone(e.extent));var n=e.pixelBlock;return null===n||void 0===n?i:(i.pixelBlock=n.clone(),i)},_setDefaultFilter:function(){},_getPixelBlockFromCanvas:function(e,t,i){var n,r,s,a=e.getImageData(0,0,t,i).data,l=t*i,o=0,u=0,h=new Uint8Array(l),c=new Uint8Array(l),f=new Uint8Array(l),d=new Uint8Array(l),m=1/0,g=1/0,p=1/0,R=-1/0,_=-1/0,v=-1/0;for(o=0;o<l;o++)n=a[u++],r=a[u++],s=a[u++],m=m<n?m:n,R=R>n?R:n,g=g<r?g:r,_=_>r?_:r,p=p<s?p:s,v=v>s?v:s,h[o]=n,c[o]=r,f[o]=s,d[o]=1&a[u++];return new y({width:t,height:i,pixels:[h,c,f],pixelType:"U8",mask:d,statistics:[{minValue:m,maxValue:R},{minValue:g,maxValue:_},{minValue:p,maxValue:v}]})},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||this.format.toLowerCase().indexOf("png")>-1)},getMultidimensionalInfo:function(){var e=this._url.path+"/multiDimensionalInfo",n=new i(m._dfdCanceller);if(this._multidimensionalInfo)return n.resolve(this._multidimensionalInfo),n;if(this.version>=10.3&&this.hasMultidimensions)n._pendingDfd=d({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(t.hitch(this,function(e){this._multidimensionalInfo=e.multidimensionalInfo,n.callback(e.multidimensionalInfo)}),function(e){n.errback(e)});else{var r=new Error("Layer does not support multidimensional info");r.log=!!s.isDebug,n.errback(r)}return n},getDefaultMultidimensionalDefinition:function(){var e,n,r,s,a,l=[],o=new i(m._dfdCanceller);return this._defaultMultidimensionalDefinition?(o.resolve(t.clone(this._defaultMultidimensionalDefinition)),o):(o._pendingDfd=this.getMultidimensionalInfo(),o._pendingDfd.then(t.hitch(this,function(i){e=i,n="",r=e.variables[0].dimensions;for(s in r)r.hasOwnProperty(s)&&"StdTime"!==r[s].name&&(a=r[s],l.push(new x({variableName:n,dimensionName:a.name,isSlice:!a.hasRanges,values:[this._getDefaultDimensionValue(a)]})));this._defaultMultidimensionalDefinition=l,o.callback(t.clone(l))}),function(e){o.errback(e)}),o)},_getDefaultDimensionValue:function(e){if(e&&e.values&&e.values.length){var t,i,n,r,s=1/0;if(e.hasRanges)return e.values[0];if(e.name&&"stdz"===e.name.toLowerCase()){for(r=0;r<e.values.length&&(n=e.values[r],i=Math.abs(n-0),i<s&&(s=i,t=n),0!==i);r++);return t}return e.extent[0]}},_setDefaultMultidimensionalDefinition:function(e){var i,n={};this.getDefaultMultidimensionalDefinition().then(t.hitch(this,function(r){i=r,i.length>0&&(this.mosaicRule?(n=t.clone(this.mosaicRule),n.multidimensionalDefinition=i):this.defaultMosaicRule?(n=t.clone(this.defaultMosaicRule),n.multidimensionalDefinition=i):n=new v({multidimensionalDefinition:i}),this.setMosaicRule(n,e))}))},_setDefaultRenderingRule:function(e){var t={},i=this.renderingRule;if(!i&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&!this.bandIds&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())t.rasterFunction=this.rasterFunctionInfos[0].name;else if("esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&this.version>10.3&&(!i||"Resample"!==i.functionName)){var n="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;t.rasterFunction="Resample",t.rasterFunctionArguments={ResamplingType:n,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}},i&&(t.rasterFunctionArguments.Raster=i.toJson())}t.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new b(t),this.setRenderingRule(this.defaultRenderingRule,e))},_cleanupRequestParams:function(e){if(!e)return e;if(e.time&&e.mosaicRule){var t=new v(r.fromJson(e.mosaicRule));t=this._filterOutTimeDimension(t),e.mosaicRule=r.toJson(t.toJson())}var i,n=["displayOnPan","drawMode","styling","id","opacity","visible","resourceInfo","useMapDimensionValue","extent","renderer"];for(i in n)e.hasOwnProperty(n[i])&&delete e[n[i]];return e},_filterOutTimeDimension:function(e){if(this._isMultidimensionalCRF())return e;if(e&&e.multidimensionalDefinition&&e.multidimensionalDefinition.length>0){var t=n.filter(e.multidimensionalDefinition,function(e){return"StdTime"!==e.dimensionName});e.multidimensionalDefinition=t}return e},_removeVisualizationStretchFunction:function(e){var t=e&&e.functionName;if(!t||"stretch"!==t.toLowerCase())return e;var i=e.functionArguments.Raster
;if(i&&i.functionName){if(n.some(this.rasterFunctionInfos,function(e){return i.functionName===e.name}))return i}return e},_isMultidimensionalCRF:function(){return this.version>=10.71&&this.hasMultidimensions&&this.timeInfo&&!(this.objectIdField&&this.fields&&this.fields.length>1)},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType},_isVectorData:function(e){e=e||this;var t=e&&e.serviceDataType;return"esriImageServiceDataTypeVector-UV"===t||"esriImageServiceDataTypeVector-MagDir"===t},_isRenderingRuleAProcessingTemplate:function(e){var t=e&&e.functionName;return!(!t||e.functionArguments)&&n.some(t&&(this.rasterFunctionInfos||[]),function(e){return e&&e.name&&e.name.toLowerCase()===t.toLowerCase()})},_getRenderingRuleId:function(e){var t=e&&e.functionName;if(t){if(this._isRenderingRuleAProcessingTemplate(e))return t;var i=this._customRenderingRuleId[t];if(i){if(i!==e){for(var n in this._customRenderingRuleId)if(this._customRenderingRuleId[n]===e)return n;for(var r=0;this._customRenderingRuleId[s];)r+=1;var s=t+r;this._customRenderingRuleId[s]=e}}else this._customRenderingRuleId[t]=e;return t}},_createPixelData:function(e){var t=new y({width:2,height:2,pixels:e,pixelType:this.pixelType,statistics:e}),i=this.fullExtent.getCenter();return{pixelBlock:t,extent:new p(i.x,i.y,i.x+this.pixelSizeX,i.y+this.pixelSizeY,this.spatialReference)}},_convertRendererToRenderingRule:function(e){var t=e&&e.declaredClass;if(!t||"esri.renderer.UniqueValueRenderer"!==t&&"esri.renderer.ClassBreaksRenderer"!==t&&"esri.renderer.StretchRenderer"!==t)return null;var i=null;return"esri.renderer.StretchRenderer"===t?i=e.toRenderingRule({convertToColormap:this.version<10.6}):"esri.renderer.ClassBreaksRenderer"===t?i=this._convertClassifyRenderer(e):"esri.renderer.UniqueValueRenderer"===t&&(i=this._convertUniqueValueRenderer(e)),i},_getValueField:function(e){if(e&&e.length){var t,i;return n.some(e,function(e){if((i=e.name)&&"value"===i.toLowerCase())return t=i,!0}),t}},_convertClassifyRenderer:function(e){var t,i,r,s,a,l,o,u,h=[],c=[],f=[],d=[],m=this.renderingRule&&this._getRenderingRuleId(this.renderingRule),g=this.hasRasterAttributeTable;if(m&&(g=this._rasterFunctionTemplateInfos[m]?this._rasterFunctionTemplateInfos[m].hasRasterAttributeTable:this.hasRasterAttributeTable,s=this._renderingRuleAttributeTable[m],u=this._rasterFunctionTemplateInfos[m]),r=s&&s.features?s.features:this._rasterAttributeTableFeatures,a=s&&s.fields?s.fields:this._rasterAttributeTableFields,l=this._getValueField(a),g&&r){n.forEach(e.infos,function(t,i){var s,a=t.symbol.color;a.a&&n.forEach(r,function(n){((s=n.attributes[e.attributeField])>=t.minValue&&s<t.maxValue||i===e.infos.length-1&&s>=t.minValue)&&d.push([n.attributes[l],a.r,a.g,a.b])},this)},this),o=u&&u.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(d,o);var p=new b;p.functionName="Colormap",p.functionArguments={},p.functionArguments.Colormap=d,p.variableName="Raster",t=p}else{n.forEach(e.infos,function(e,t){i=e.symbol&&e.symbol.color,i.a?(0===t?h.push.call(h,e.minValue,e.maxValue+1e-4):h.push.call(h,e.minValue+1e-4,e.maxValue+1e-4),c.push(t),d.push([t,i.r,i.g,i.b])):f.push(e.minValue,e.maxValue)}),o=u&&u.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(d,o);var R=new b;R.functionName="Remap",R.functionArguments={InputRanges:h,OutputValues:c,NoDataRanges:f},R.variableName="Raster";var _=new b;_.functionName="Colormap",_.functionArguments={Colormap:d,Raster:R},t=_}return t},_convertUniqueValueRenderer:function(e){var t,i,r,s,a,l,o=[],u=this.renderingRule&&this._getRenderingRuleId(this.renderingRule);u&&(this._rasterFunctionTemplateInfos[u]?this._rasterFunctionTemplateInfos[u].hasRasterAttributeTable:this.hasRasterAttributeTable,i=this._renderingRuleAttributeTable[u],l=this._rasterFunctionTemplateInfos[u]),t=i&&i.features?i.features:this._rasterAttributeTableFeatures,s=i&&i.fields?i.fields:this._rasterAttributeTableFields,r=s&&s.length?this._getValueField(s):"Value",n.forEach(e.infos,function(i){var s=i.symbol.color;s.a&&(e.attributeField!==r&&t?n.forEach(t,function(t){t.attributes[e.attributeField]==i.value&&o.push([t.attributes[r],s.r,s.g,s.b])},this):o.push([i.value,s.r,s.g,s.b]))},this),a=l&&l.pixelType||this.pixelType,this._adjustColormapToPixelTypeRange(o,a);var h=new b;return h.functionName="Colormap",h.functionArguments={},h.functionArguments.Colormap=o,h.variableName="Raster",h},_adjustColormapToPixelTypeRange:function(e,t){var i=this._pixelTypeRanges[t];return i&&e.push([Math.floor(i[0]-1),0,0,0],[Math.ceil(i[1]+1),0,0,0]),e},_combineRenderingRule:function(e,i){if(!e||!i)return e||i;var n=function(e){var t=e.Raster;return t=t&&"esri.layers.RasterFunction"===t.declaredClass?n(t.functionArguments):e},r=t.clone(e);if("none"!==i.functionName.toLocaleLowerCase()){n(r.functionArguments).Raster=i}return r},_isItemLevelRasterFunction:function(e){var t=e&&e.functionName;if(!t||!this._hasItemLevelRFT)return!1;var i=!1;return n.some(this.rasterFunctionInfos,function(e){if(e&&e.name===t)return 1!==e.functionType&&2!==e.functionType||(i=!0),!0}),i},_getServiceLevelRenderingRule:function(e){if(!this._hasItemLevelRFT||!e)return e;for(var t,i=new b(e.toJson()),n=i,r=n.functionArguments;;){if(!((t=r&&r.Raster)&&t.functionArguments&&t.functionArguments.Raster)){this._isItemLevelRasterFunction(t)&&delete r.Raster;break}n=t,r=n.functionArguments}return i},_getItemLevelRenderingRule:function(e){if(!this._hasItemLevelRFT||!e)return null;if(this._isItemLevelRasterFunction(e))return e;for(var t,i=new b(e.toJson()),n=i.functionArguments;;){if(!((t=n&&n.Raster)&&t.functionArguments&&t.functionArguments.Raster)){if(this._isItemLevelRasterFunction(t))return t;break}i=t,n=i.functionArguments}},_resolve:function(e,t,i,n,r){t&&this[t].apply(this,e),i&&i.apply(null,e),n&&m._resDfd(n,e,r)},_toggleTime:function(){var e=this._map;this.timeInfo&&this.useMapTime&&e&&!this.suspended?(this._timeConnect||(this._timeConnect=a.connect(e,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(e.timeExtent)):(a.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},setUseMapTime:function(e,t){this.useMapTime=e,this._toggleTime(),!t&&this._map&&this.refresh(!0)},_setTime:function(e){this._params&&(this._params.time=e?e.toJson().join(","):null)},_onTimeExtentChangeHandler:function(e){this.suspended||(this._setTime(e),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()}});return l("extend-esri")&&t.setObject("layers.ImageServiceLayerMixin",A,h),A});