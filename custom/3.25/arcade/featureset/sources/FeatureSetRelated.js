// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();define(["require","exports","../../../graphic","../support/FeatureSet","../support/IdSet","../support/shared","../support/sqlUtils","../../polyfill/promiseUtils","../../../tasks/RelationshipQuery"],function(e,t,r,i,n,a,s,o,l){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",r._findObjectId=-1,r._requestStandardised=!1,r._removeGeometry=!1,r._overrideFields=null,r.featureObjectId=null,r.relatedLayer=null,r.relationship=null,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,r._findObjectId=t.objectId,r.featureObjectId=t.objectId,r.relationship=t.relationship,r.relatedLayer=t.relatedLayer,void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return __extends(t,e),t.prototype._maxQueryRate=function(){return a.defaultMaxRecords},t.prototype.end=function(){return this._layer},t.prototype.optimisePagingFeatureQueries=function(e){},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=o.create(function(t,r){o.all([e._layer.load(),e.relatedLayer.load()]).then(function(){e._initialiseFeatureSet(),t(e)},r)})),this._loadPromise},t.prototype._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{for(var e=[],t=[],r=0,i=this.fields;r<i.length;r++){var n=i[r];if("oid"===n.type)e.push(n),t.push(n.name);else for(var s=0,o=this._overrideFields;s<o.length;s++){var l=o[s];if(l.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}}}this.fields=e,this._overrideFields=t}var u=this._layer.nativeSource();if(u.source&&u.source.layerDefinition)if(!0===u.source.layerDefinition.useStandardizedQueries)this._databaseType=a.FeatureServiceDatabaseType.Standardised;else{var d=u.source.layerDefinition.currentVersion;void 0!==d&&null!==d&&d>=10.5&&(this._databaseType=a.FeatureServiceDatabaseType.Standardised,this._requestStandardised=!0)}this.objectIdField=this.relatedLayer.objectIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this._databaseType=this.relatedLayer._databaseType,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types},t.prototype.isTable=function(){return this.relatedLayer.isTable()},t.prototype._isInFeatureSet=function(e){return a.IdState.InFeatureSet},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then(function(){return t._getFilteredSet("",null,null,null,e)}).then(function(e){return t._wset=e,e}):o.resolve(this._wset)},t.prototype._changeFeature=function(e){for(var t={},i=0,n=this.fields;i<n.length;i++){var a=n[i];t[a.name]=e.attributes[a.name]}return new r({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})},t.prototype.queryRelatedCapabilities=function(e){throw new Error("Query Related Meta Data Not Implemented Yet")},t.prototype._getFilteredSet=function(e,t,r,i,a){var o=this;return this.databaseType().then(function(u){if(o.isTable()&&t&&null!==e&&""!==e){return new n([],[],!0,null)}var d=o._layer.nativeSource(),c=o.queryRelatedCapabilities(d);if(c.supportsPagination)return o._getFilteredSetUsingPaging(e,t,r,i,a);var p="",f=!1;null!==i&&!0===c.supportsOrderBy&&(p=i.constructClause(),f=!0);var y=new l;return y.objectIds=[o._findObjectId],y.definitionExpression=null===r?"1=1":s.toWhereClause(r,u),o._requestStandardised&&(y.sqlFormat="standard"),y.outSpatialReference=o.spatialReference,y.orderByFields=""!==p?p.split(","):null,d.queryRelatedFeatures(y).then(function(r){o._checkCancelled(a);for(var i=r[o._findObjectId]?r[o._findObjectId].features:[],s=[],l=0;l<i.length;l++)o._featureCache[i[l].attributes[o._layer.objectIdField]]=i[l],s.push(i[l].attributes[o._layer.objectIdField]);var u=t&&null!==e&&""!==e,d=u?[]:s;return new n(u?s:[],d,f,null)})})},t.prototype.nativeCapabilities=function(){return this._layer.nativeSource()},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,i=0,n=t;i<n.length;i++){if(n[i].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFilteredSetUsingPaging=function(e,t,r,i,a){var l=this;try{var u="",d=!1,c=this._layer.nativeSource(),p=this.queryRelatedCapabilities(c);return null!==i&&!0===p.supportsOrderBy&&(u=i.constructClause(),d=!0),this._layer.databaseType().then(function(i){var o=null===r?"1=1":s.toWhereClause(r,i),p=l._maxQueryRate();void 0!==c.maxRecordCount&&c.maxRecordCount<p&&(p=c.maxRecordCount);var f=t&&null!==e&&""!==e,y=null,h=!0;!0===l._removeGeometry&&(h=!1);var _=null!==l._overrideFields?l._overrideFields:l._fieldsIncludingObjectId(l.relatedLayer.fields?l.relatedLayer.fields.map(function(e){return e.name}):["*"]),v=f?[]:["GETPAGES"];return y=new n(f?["GETPAGES"]:[],v,d,{outFields:_.join(","),resultRecordCount:p,resultOffset:0,objectIds:[l._findObjectId],where:o,orderByFields:u,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,fullyResolved:!1}}),l._expandPagedSet(y,p,0,1,a).then(function(){return y})})}catch(e){return o.reject(e)}},t.prototype._expandPagedSet=function(e,t,r,i,n){return this._expandPagedSetFeatureSet(e,t,r,i,n)},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,r){var i=this;try{var n=e.pagesDefinition.internal.lastRetrieved,a=n,s=this._layer.nativeSource(),u=new l;return!0===this._requestStandardised&&(u.sqlFormat="standard"),u.relationshipId=this.relationship.id,u.objectIds=e.pagesDefinition.objectIds,u.resultOffset=e.pagesDefinition.internal.lastRetrieved,u.resultRecordCount=e.pagesDefinition.resultRecordCount,u.outFields=e.pagesDefinition.outFields.split(","),u.definitionExpression=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,s.queryRelatedFeatures(u).then(function(t){if(i._checkCancelled(r),e.pagesDefinition.internal.lastRetrieved!==n)return"done";for(var s=t[i._findObjectId]?t[i._findObjectId].features:[],o=0;o<s.length;o++)e.pagesDefinition.internal.set[a+o]=s[o].attributes[i._layer.objectIdField];for(var o=0;o<s.length;o++)i._featureCache[s[o].attributes[i._layer.objectIdField]]=s[o];return s.length!==e.pagesDefinition.resultRecordCount&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+e.pagesDefinition.resultRecordCount,"done"})}catch(e){return o.reject(e)}},t.prototype._makeRelationshipEnum=function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getFeatures=function(e,t,r,i){var n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);for(var a=e._lastFetchedIndex;a<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[a]]&&(e._known[a]!==t&&n.push(e._known[a]),n.length>r)));a++);return 0===n.length?o.resolve("success"):o.reject(new Error("Unaccounted for Features. Not in Feature Collection"))},t.prototype._refineSetBlock=function(e,t,r){return o.resolve(e)},t.prototype._stat=function(e,t,r,i,n,a,s){return o.resolve({calculated:!1})},t.prototype._canDoAggregates=function(e,t,r,i,n){return o.resolve(!1)},t.prototype.canBeBigDataFeatureSet=function(){return!1},t.prototype.shouldBeResolvedAsBigData=function(){return!1},t.prototype.relationshipMetaData=function(){return this.relatedLayer.relationshipMetaData()},t.prototype.serviceUrl=function(){return this.relatedLayer.serviceUrl()},t.prototype.queryAttachments=function(e,t,r,i){return this.relatedLayer.queryAttachments(e,t,r,i)},t}(i)});